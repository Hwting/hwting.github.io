<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wang&#39;T博客</title>
  
  <subtitle>_入网络深似海,从此节操是路人.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.idcsec.com/"/>
  <updated>2018-10-29T14:15:04.592Z</updated>
  <id>http://www.idcsec.com/</id>
  
  <author>
    <name>Wang&#39;T</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用Prometheus的blackbox_exporter进行网络监控</title>
    <link href="http://www.idcsec.com/2018/10/28/%E4%BD%BF%E7%94%A8Prometheus%E7%9A%84blackbox-exporter%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7/"/>
    <id>http://www.idcsec.com/2018/10/28/使用Prometheus的blackbox-exporter进行网络监控/</id>
    <published>2018-10-27T16:44:00.000Z</published>
    <updated>2018-10-29T14:15:04.592Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/img/20181028004809.png" alt="monitoring"></p><p>使用Prometheus的blackbox_exporter进行网络监控<br><img src="http://showdoc.zhph.lan/Public/Uploads/2018-10-15/5bc3e8988eaba.png" alt=""></p><ul><li>Prometheus提供了一个blackbox_exporter可以实现网络监控，支持http、dns、tcp、icmp等监控。</li></ul><p>其中9115是这个exporter的http端点的监听端口，blackbox.yml是它的配置文件，需要在其中使用blackbox_exporter的http、dns、tcp、icmp等prober定制配置出各种监测模块(module)。关于blackbox_exporter的配置具体参考Blackbox exporter configuration和Blackbox exporter configuration Exmaple。下面的例子是一个最基本的配置：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">modules</span>:</span><br><span class="line">  <span class="attribute">http_2xx</span>:  # http 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">  <span class="attribute">http_post_2xx</span>: # http post 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">method</span>: POST</span><br><span class="line">  <span class="attribute">tcp_connect</span>: # tcp 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: tcp</span><br><span class="line">  <span class="attribute">ping</span>: # icmp 检测模块</span><br><span class="line">    <span class="attribute">prober</span>: icmp</span><br><span class="line">    <span class="attribute">timeout</span>: <span class="number">5s</span></span><br><span class="line">    <span class="attribute">icmp</span>:</span><br><span class="line">      <span class="attribute">preferred_ip_protocol</span>: <span class="string">"ip4"</span></span><br><span class="line">      <span class="attribute">dns</span>:</span><br><span class="line">       <span class="attribute">transport_protocol</span>: <span class="string">"tcp"</span></span><br><span class="line">       <span class="attribute">preferred_ip_protocol</span>: <span class="string">"ip4"</span></span><br><span class="line">       <span class="attribute">query_name</span>: <span class="string">"kubernetes.default.svc.cloud.ctrm"</span>  # 利用这个域名来检查 dns 服务器</span><br><span class="line">       <span class="attribute">query_type</span>: <span class="string">"A"</span>  # 如果是 kube-dns ，一定要加入这个</span><br></pre></td></tr></table></figure></p><p>在Prometheus的配置文件中配置使用ping module：<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'ping_all'</span></span><br><span class="line"></span>    scrape_interval: 1m</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [ping]</span><br><span class="line">    static_configs:</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>        -<span class="ruby"> <span class="number">192.168</span>.<span class="number">1.2</span></span><br><span class="line"></span>       labels:</span><br><span class="line">         instance: node2</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>        -<span class="ruby"> <span class="number">192.168</span>.<span class="number">1.3</span></span><br><span class="line"></span>       labels:</span><br><span class="line">         instance: node3</span><br><span class="line">    relabel_configs:</span><br><span class="line">      -<span class="ruby"> <span class="symbol">source_labels:</span> [__address_<span class="number">_</span>]</span><br><span class="line"></span>        target_label: __param_target</span><br><span class="line">      -<span class="ruby"> <span class="symbol">target_label:</span> __address_<span class="number">_</span></span><br><span class="line"></span>        replacement: 127.0.0.1:9115 # black_exporter服务器的地址</span><br></pre></td></tr></table></figure></p><p>测试<br>curl “<a href="http://127.0.0.1:9115/probe?module=ping&amp;target=192.168.1.2" target="_blank" rel="external">http://127.0.0.1:9115/probe?module=ping&amp;target=192.168.1.2</a>“<br>http检测<br>Blackbox 配置了 http_2xx 模块，所以这里只需要在 Prometheus的配置文件中配置使用http_2xx module<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'blackbox'</span></span><br><span class="line"></span>  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">  static_configs:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="symbol">http:</span>/<span class="regexp">/prometheus.io    # Target to probe with http.</span><br><span class="line"></span></span>      -<span class="ruby"><span class="regexp"> https:/</span><span class="regexp">/prometheus.io   # Target to probe with https.</span><br><span class="line"></span></span>      -<span class="ruby"><span class="regexp"> http:/</span><span class="regexp">/example.com:8080 # Target to probe with http on port 8080.</span><br><span class="line"></span></span>  relabel_configs:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> source_labels: [__address__]</span><br><span class="line"></span></span>      target_label: __param_target</span><br><span class="line">    -<span class="ruby"><span class="regexp"> source_labels: [__param_target]</span><br><span class="line"></span></span>      target_label: instance</span><br><span class="line">    -<span class="ruby"><span class="regexp"> target_label: __address__</span><br><span class="line"></span></span>      replacement: 127.0.0.1:9115  # The blackbox exporter's real hostname:port</span><br></pre></td></tr></table></figure></p><p>dns监控<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">"kubernetes-service-dns"</span></span><br><span class="line"></span>  metrics_path: /probe # 不是 metrics，是 probe</span><br><span class="line">  params:</span><br><span class="line">    module: [dns] # DNS 模块</span><br><span class="line">  static_configs:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>    -<span class="ruby"> kube-<span class="symbol">dns:</span><span class="number">53</span> <span class="comment"># 不要省略端口号</span></span><br><span class="line"></span>  relabel_configs:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">source_labels:</span> [__address_<span class="number">_</span>]</span><br><span class="line"></span>    target_label: __param_target</span><br><span class="line">  -<span class="ruby"> <span class="symbol">source_labels:</span> [__param_target]</span><br><span class="line"></span>    target_label: instance</span><br><span class="line">  -<span class="ruby"> <span class="symbol">target_label:</span> __address_<span class="number">_</span></span><br><span class="line"></span>    replacement: blackbox # 服务地址，和上面的 Service 定义保持一致</span><br></pre></td></tr></table></figure></p><p>/-/reload(curl -XPOST ip:prom端口/-/reload）使配置生效<br>可以使用 probe_success{job=”kubernetes-service-dns”} 查看结果<br>如果HTTP服务启用了安全认证，Blockbox Exporter内置了对basic_auth的支持，可以直接设置相关的认证信息即可：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http_basic_auth_example</span>:</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">timeout</span>: <span class="number">5s</span></span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">method</span>: POST</span><br><span class="line">      <span class="attribute">headers</span>:</span><br><span class="line">        <span class="attribute">Host</span>: <span class="string">"login.example.com"</span></span><br><span class="line">      <span class="attribute">basic_auth</span>:</span><br><span class="line">        <span class="attribute">username</span>: <span class="string">"username"</span></span><br><span class="line">        <span class="attribute">password</span>: <span class="string">"mysecret"</span></span><br></pre></td></tr></table></figure></p><p>对于使用了Bear Token的服务也可以通过bearer_token配置项直接指定令牌字符串，或者通过bearer_token_file指定令牌文件。</p><p>对于一些启用了HTTPS的服务，但是需要自定义证书的服务，可以通过tls_config指定相关的证书信息：<br><figure class="hljs highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_custom_ca_example:</span><br><span class="line">   prober: http</span><br><span class="line">   http:</span><br><span class="line">     <span class="keyword">method</span>: <span class="type">GET</span></span><br><span class="line">     tls_config:</span><br><span class="line">       ca_file: <span class="string">"/certs/my_cert.crt"</span></span><br></pre></td></tr></table></figure></p><p>自带 metrics 端点的服务<br>有的服务，例如 prometheus 或者 blackbox，以及 kube-dns、etcd 等， 都是自有 /metrics 提供指标输出的，这种服务对 Blackbox + Prometheus 组合是非常方便的。<br>只要给服务的注解部分加入几个标签：<br>kubernetes-pods<br>对于pod的监测也是需要加注解：<br><figure class="hljs highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">prometheus.io/host</span>: <span class="string">calico-etcd # 服务名称</span></span><br><span class="line"><span class="attribute">prometheus.io/port</span>: <span class="string">"6666" # metrics 端口</span></span><br><span class="line"><span class="attribute">prometheus.io/scrape</span>: <span class="string">"true" # 抓取开关</span></span><br><span class="line"><span class="attribute">prometheus.io/path</span>: <span class="string">"/metrics"默认为/metric</span></span><br></pre></td></tr></table></figure></p><h1 id="u5B8C_u6574_u7684kubernetes_u90E8_u7F72_u6587_u4EF6"><a href="#u5B8C_u6574_u7684kubernetes_u90E8_u7F72_u6587_u4EF6" class="headerlink" title="完整的kubernetes部署文件"></a>完整的kubernetes部署文件</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">blackbox-exporter-deploy.yaml </span><br><span class="line"><span class="string">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="string">kind:</span> Deployment</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  namespace:</span> monitoring</span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  selector:</span></span><br><span class="line"><span class="label">    matchLabels:</span></span><br><span class="line"><span class="label">      app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="label">  template:</span></span><br><span class="line"><span class="label">    metadata:</span></span><br><span class="line"><span class="label">      labels:</span></span><br><span class="line"><span class="label">        app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">    spec:</span></span><br><span class="line"><span class="label">      restartPolicy:</span> Always</span><br><span class="line"><span class="label">      containers:</span></span><br><span class="line">      - <span class="string">name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">        image:</span> prom/blackbox-<span class="string">exporter:</span>v0<span class="number">.12</span><span class="number">.0</span></span><br><span class="line"><span class="label">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="label">        ports:</span></span><br><span class="line">        - <span class="string">name:</span> blackbox-port</span><br><span class="line"><span class="label">          containerPort:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">        readinessProbe:</span></span><br><span class="line"><span class="label">          tcpSocket:</span></span><br><span class="line"><span class="label">            port:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="label">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="label">        resources:</span></span><br><span class="line"><span class="label">          requests:</span></span><br><span class="line"><span class="label">            memory:</span> <span class="number">50</span>Mi</span><br><span class="line"><span class="label">            cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="label">          limits:</span></span><br><span class="line"><span class="label">            memory:</span> <span class="number">60</span>Mi</span><br><span class="line"><span class="label">            cpu:</span> <span class="number">200</span>m</span><br><span class="line"><span class="label">        volumeMounts:</span></span><br><span class="line">        - <span class="string">name:</span> config</span><br><span class="line"><span class="label">          mountPath:</span> <span class="regexp">/etc/</span>blackbox_exporter</span><br><span class="line"><span class="label">        args:</span></span><br><span class="line">        - --config.file=<span class="regexp">/etc/</span>blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --web.listen-address=:<span class="number">9115</span></span><br><span class="line"><span class="label">      volumes:</span></span><br><span class="line">      - <span class="string">name:</span> config</span><br><span class="line"><span class="label">        configMap:</span></span><br><span class="line"><span class="label">          name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">      nodeSelector:</span></span><br><span class="line"><span class="label">        prometheus:</span> <span class="string">"core"</span></span><br><span class="line"><span class="label">      tolerations:</span></span><br><span class="line">      - <span class="string">key:</span> <span class="string">"node-role.kubernetes.io/master"</span></span><br><span class="line"><span class="label">        effect:</span> <span class="string">"NoSchedule"</span></span><br><span class="line">---</span><br><span class="line"><span class="string">apiVersion:</span> v1</span><br><span class="line"><span class="string">kind:</span> Service</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  labels:</span></span><br><span class="line"><span class="label">    app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  name:</span> blackbox-exporter</span><br><span class="line"><span class="label">  namespace:</span> monitoring</span><br><span class="line"><span class="label">  annotations:</span></span><br><span class="line">    prometheus.io/<span class="string">scrape:</span> <span class="string">'true'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  type:</span> NodePort</span><br><span class="line"><span class="label">  selector:</span></span><br><span class="line"><span class="label">    app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  ports:</span></span><br><span class="line">  - <span class="string">name:</span> blackbox</span><br><span class="line"><span class="label">    port:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">    targetPort:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">    protocol:</span> TCP</span><br></pre></td></tr></table></figure><h1 id="prometheus_u7684_u914D_u7F6E_u6587_u4EF6"><a href="#prometheus_u7684_u914D_u7F6E_u6587_u4EF6" class="headerlink" title="prometheus的配置文件"></a>prometheus的配置文件</h1><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'blackbox'</span></span><br><span class="line"></span>   metrics_path: /probe</span><br><span class="line">   params:</span><br><span class="line">     module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">   static_configs:</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>       -<span class="ruby"> <span class="symbol">http:</span>/<span class="regexp">/prometheus.io    # Target to probe with http.</span><br><span class="line"></span></span>       -<span class="ruby"><span class="regexp"> https:/</span><span class="regexp">/prometheus.io   # Target to probe with https.</span><br><span class="line"></span></span>       -<span class="ruby"><span class="regexp"> http:/</span><span class="regexp">/example.com:8080 # Target to probe with http on port 8080.</span><br><span class="line"></span></span>   relabel_configs:</span><br><span class="line">     -<span class="ruby"><span class="regexp"> source_labels: [__address__]</span><br><span class="line"></span></span>       target_label: __param_target</span><br><span class="line">     -<span class="ruby"><span class="regexp"> source_labels: [__param_target]</span><br><span class="line"></span></span>       target_label: instance</span><br><span class="line">     -<span class="ruby"><span class="regexp"> target_label: __address__</span><br><span class="line"></span></span>       replacement: blackbox-exporter:9115  # The blackbox exporter's real hostname:port</span><br></pre></td></tr></table></figure><p><img src="/img/20181028013940.png" alt="monitoring"></p><h1 id="prometheus_u7684_u914D_u7F6E_u6587_u4EF6alermanager_u62A5_u8B66_u89C4_u5219"><a href="#prometheus_u7684_u914D_u7F6E_u6587_u4EF6alermanager_u62A5_u8B66_u89C4_u5219" class="headerlink" title="prometheus的配置文件alermanager报警规则"></a>prometheus的配置文件alermanager报警规则</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: sitealer</span><br><span class="line">  rules:</span><br><span class="line">  - alert: 网站异常</span><br><span class="line">    expr: up&#123;job=<span class="string">"blackbox"</span>&#125; == <span class="number">0</span>  or  probe_success&#123;job=<span class="string">"blackbox"</span>&#125; == <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span>: <span class="number">10</span>s</span><br><span class="line">    labels:</span><br><span class="line">      severity: critica</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"网站 &#123;&#123; $labels.target &#125;&#125; 访问异常"</span></span><br></pre></td></tr></table></figure><p><img src="/img/20181028012307.png" alt="monitoring"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/img/20181028004809.png&quot; alt=&quot;monitoring&quot;&gt;&lt;/p&gt;
&lt;p&gt;使用Prometheus的blackbox_exporter进行网络监控&lt;br&gt;&lt;img src=&quot;http://showdoc.zhph.lan/Pub
      
    
    </summary>
    
      <category term="prometheus" scheme="http://www.idcsec.com/categories/prometheus/"/>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/prometheus/kubernetes/"/>
    
    
      <category term="blackbox-exporter" scheme="http://www.idcsec.com/tags/blackbox-exporter/"/>
    
      <category term="prometheus" scheme="http://www.idcsec.com/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>使用Prometheus监控Oracle系统展示到Grafana</title>
    <link href="http://www.idcsec.com/2018/10/27/%E4%BD%BF%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7Oracle%E7%B3%BB%E7%BB%9F%E5%B1%95%E7%A4%BA%E5%88%B0Grafana/"/>
    <id>http://www.idcsec.com/2018/10/27/使用Prometheus监控Oracle系统展示到Grafana/</id>
    <published>2018-10-27T13:58:00.000Z</published>
    <updated>2018-10-30T07:54:13.828Z</updated>
    
    <content type="html"><![CDATA[<p>oracledb_exporter参考：<br><a href="https://github.com/iamseth/oracledb_exporter" target="_blank" rel="external">https://github.com/iamseth/oracledb_exporter</a><br>本文直接把oracledb_exporter部署在k8s环境。docker部署方式更为简单<br>我们使用Prometheus在Grafana上为Oracle实现监控仪表板。由于Oracle不支持http通信，它由Oracle Exporter获取指标，它将Oracle的内容发送到Prometheus，并将Prometheus内容输出到Grafana。<br><img src="/img/oracle1.jpg" alt="crt"><br>Oracle DB→Oracle Exporter→Prometheus→Grafana</p><p>Oracle Exporter需要将Oracle与Prometheus连接。Oracle Exporter将有关Oracle的信息传递给Prometheus。<br>创建yaml对象</p><h1 id="u90E8_u7F72oracle-export"><a href="#u90E8_u7F72oracle-export" class="headerlink" title="部署oracle-export"></a>部署oracle-export</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f - </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  name: oracle-<span class="keyword">export</span>-dm</span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  <span class="keyword">template</span>:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image:  wtingdocker/oracledb_exporter:latest</span><br><span class="line">        name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">        command:</span><br><span class="line">        - <span class="string">"/oracledb_exporter"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">9161</span></span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: DATA_SOURCE_NAME</span><br><span class="line">          value: <span class="string">"system/oracle@ip:1521/sid"</span>  <span class="preprocessor">#改成自己的数据库信息 定义DATA_SOURCE_NAME变量</span></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">9161</span></span><br><span class="line">    targetPort: <span class="number">9161</span></span><br><span class="line">  selector:</span><br><span class="line">    app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="u4FEE_u6539prometheus-yml_u6587_u4EF6"><a href="#u4FEE_u6539prometheus-yml_u6587_u4EF6" class="headerlink" title="修改prometheus.yml文件"></a>修改prometheus.yml文件</h1><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">scrape_configs</span>:</span><br><span class="line">  - <span class="attribute">job_name</span>: <span class="string">'oracle-endpoint'</span></span><br><span class="line">    <span class="attribute">static_configs</span>:</span><br><span class="line">    - <span class="attribute">targets</span>:</span><br><span class="line">      - <span class="attribute">oracle-export-X-X</span>:<span class="number">9161</span></span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">target</span>: <span class="string">'192.168.1.X'</span></span><br><span class="line">        <span class="attribute">descr</span>: <span class="string">'XX数据库'</span></span><br></pre></td></tr></table></figure><p>重新加载prometheus配置文件<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  apply <span class="operator">-f</span> configmap.yaml</span><br></pre></td></tr></table></figure></p><p>重新启动prometheus容器以使修改后的内容生效<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">http:</span><span class="comment">//192.168.7.X:30680/-/reload</span></span><br></pre></td></tr></table></figure></p><h1 id="Grafana_u5C55_u793A"><a href="#Grafana_u5C55_u793A" class="headerlink" title="Grafana展示"></a>Grafana展示</h1><p>访问oracle-export端口验证Oracle和Prometheus连接<br><img src="/img/20181027225036.png" alt="oracle1"><br><img src="/img/20181027225445.png" alt="oracle1"><br>Grafana添加Prometheus数据库源<br><img src="/img/0181027230136.png" alt="oracle2"></p><p>仪表板导入3333可以根据自己的需要添加export提供的metrics 展示以及通过alertmanager告警<br><img src="/img/20181027230648.png" alt="oracle2"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;oracledb_exporter参考：&lt;br&gt;&lt;a href=&quot;https://github.com/iamseth/oracledb_exporter&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/iamseth/
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
      <category term="prometheus" scheme="http://www.idcsec.com/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes ingress配置HTTPS/TLS证书</title>
    <link href="http://www.idcsec.com/2018/09/29/kubernetes-ingress%E9%85%8D%E7%BD%AEHTTPS-TLS%E8%AF%81%E4%B9%A6/"/>
    <id>http://www.idcsec.com/2018/09/29/kubernetes-ingress配置HTTPS-TLS证书/</id>
    <published>2018-09-29T15:14:00.000Z</published>
    <updated>2018-09-29T15:15:31.953Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="external">Ingress是Kubernetes中的一个概念，用于</a>将入站连接路由到不同的服务。这可以通过不同方式实现。<br>生成证书文件<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days <span class="number">2920</span> -newkey rsa:<span class="number">2048</span> -keyout tls<span class="class">.key</span> -out tls<span class="class">.crt</span> -subj <span class="string">"/CN=*.idcsec.com/O=nginxsvc"</span></span><br></pre></td></tr></table></figure></p><p>导入证书文件到k8s secret<br><figure class="hljs highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> secret tls <span class="keyword">https</span>-secret <span class="comment">--key tls.key --cert tls.crt</span></span><br></pre></td></tr></table></figure></p><p>或者使用yaml<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">apiVersion:</span> v1</span><br><span class="line"><span class="string">kind:</span> Secret</span><br><span class="line"><span class="string">type:</span> kubernetes.io/tls</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> mytlssecret</span><br><span class="line"><span class="string">data:</span></span><br><span class="line">  tls.<span class="string">crt:</span> &lt;base64 encoded cert&gt;</span><br><span class="line">  tls.<span class="string">key:</span> &lt;base64 encoded key&gt;</span><br></pre></td></tr></table></figure></p><p>配置ingress<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Ingress</span><br><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: test</span><br><span class="line">  <span class="attribute">annotations</span>:</span><br><span class="line">    ingress.kubernetes.io/<span class="attribute">ssl-redirect</span>: <span class="string">"False"</span>  #设置是否强制跳转 false| true</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">tls</span>:</span><br><span class="line">  - <span class="attribute">hosts</span>: </span><br><span class="line">    - www.idcsec.com</span><br><span class="line">    <span class="attribute">secretName</span>: https-secret</span><br><span class="line">  <span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">host</span>:  www.idcsec.com</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">paths</span>:</span><br><span class="line">      - <span class="attribute">path</span>: /</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: test</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure></p><p>校验证书信息<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> tls<span class="class">.crt</span>  -noout -text</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/kubernetes/ingress-nginx/tree/master/docs/examples/auth/client-certs" target="_blank" rel="external">Client Certificate Authentication</a><br><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#creating-the-ca-authentication-secret" target="_blank" rel="external">TLS证书</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/concepts/services-networking/ingress/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Ingress是Kubernetes中的一个概念，用于&lt;/a&gt;
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="ingress-nginx" scheme="http://www.idcsec.com/tags/ingress-nginx/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes ingres-nginx高级配置</title>
    <link href="http://www.idcsec.com/2018/09/29/kubernetes-ingres-nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"/>
    <id>http://www.idcsec.com/2018/09/29/kubernetes-ingres-nginx高级配置/</id>
    <published>2018-09-29T15:03:00.000Z</published>
    <updated>2018-09-29T15:10:09.660Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u901A_u8FC7configmap_u4FEE_u6539nginx_controller_u7684_u4E00_u4E9B_u5168_u5C40_u53D8_u91CF"><a href="#u901A_u8FC7configmap_u4FEE_u6539nginx_controller_u7684_u4E00_u4E9B_u5168_u5C40_u53D8_u91CF" class="headerlink" title="通过configmap修改nginx controller的一些全局变量"></a>通过configmap修改nginx controller的一些全局变量</h2><p>通过启动nginx controller的yaml文件，其实我们可以看出来，在启动controller的时候，向启动命令传递了一大堆参数，包括–default-backend-service以及–apiserver-host等。更多的参数，可以直接参考<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/multiple-ingress.md" target="_blank" rel="external">相关文档</a></p><p>nginx controller本质上就是一个nginx代理，这个代理使用了一大堆nginx默认参数启动。而在某些特定场景下，这些我们需要定制这些参数以更适用于我们的需求。在controller启动的时候，提供了一个–configmap的参数，我们可以将需要定制的参数保存到一个configmap中，并在controller启动的时候，来读取这个configmap，获取其值，应用到controller中。具体哪些值可以通过configmap来传递，可以直接参考<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md" target="_blank" rel="external">相关文档</a><br><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md" target="_blank" rel="external">https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md</a></p><h1 id="u4E00_u3001_u4F7F_u7528ConfigMap"><a href="#u4E00_u3001_u4F7F_u7528ConfigMap" class="headerlink" title="一、使用ConfigMap"></a>一、使用ConfigMap</h1><p>确保指定启动Ingress控制器时要使用的configmaps资源。</p><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: ConfigMap </span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: nginx-configuration</span><br><span class="line">  <span class="attribute">namespace</span>: ingress-nginx</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: ingress-nginx</span><br><span class="line"><span class="attribute">data</span>:</span><br><span class="line">  <span class="attribute">client-header-buffer-size</span>: <span class="string">"4k"</span></span><br><span class="line">  <span class="attribute">proxy-connect-timeout</span>: <span class="string">"40"</span></span><br><span class="line">  <span class="attribute">proxy-read-timeout</span>: <span class="string">"110"</span></span><br><span class="line">  <span class="attribute">proxy-send-timeout</span>: <span class="string">"110"</span></span><br></pre></td></tr></table></figure><p>创建配置资源：<br><figure class="hljs highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> kubectl apply -f nginx-configuration.yaml</span><br><span class="line"> kubectl get cm nginx-configuration -<span class="keyword">n</span> ingress-nginx  -o yaml</span><br><span class="line">[root@k8s-<span class="keyword">m</span> ~]# kubectl  exec -it     nginx-ingress-controller-5f947cc79f-86cvc      -<span class="keyword">n</span> ingress-nginx -- <span class="keyword">cat</span> /etc/nginx/nginx.<span class="keyword">conf</span> | grep    client_header_buffer_size</span><br><span class="line">trueclient_header_buffer_size       4k;</span><br></pre></td></tr></table></figure></p><h3 id="u4FEE_u6539nginx-controller_u7684yml_u6587_u4EF6nginx-ingress-daemonset-yaml_u542F_u52A8_u53C2_u6570_u5982_u4E0B_uFF1A"><a href="#u4FEE_u6539nginx-controller_u7684yml_u6587_u4EF6nginx-ingress-daemonset-yaml_u542F_u52A8_u53C2_u6570_u5982_u4E0B_uFF1A" class="headerlink" title="修改nginx-controller的yml文件nginx-ingress-daemonset.yaml启动参数如下："></a>修改nginx-controller的yml文件nginx-ingress-daemonset.yaml启动参数如下：</h3><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">args:</span></span><br><span class="line"></span>    -<span class="ruby"> /nginx-ingress-controller</span><br><span class="line"></span>    -<span class="ruby"> --default-backend-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/default-http-backend</span><br><span class="line"></span>    -<span class="ruby"> --configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/nginx-configuration /<span class="regexp">/例如</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> --tcp-services-configmap=$(POD_NAMESPACE)/tcp</span>-services</span><br><span class="line"></span>    -<span class="ruby"> --udp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/udp-services</span><br><span class="line"></span>    -<span class="ruby"> --publish-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/ingress-nginx</span><br><span class="line"></span>    -<span class="ruby"> --annotations-prefix=nginx.ingress.kubernetes.io</span></span><br></pre></td></tr></table></figure><ul><li>如需要生效重启nginx-ingress-controller pod *<h1 id="u4E8C_u3001_u4F7F_u7528Annotations"><a href="#u4E8C_u3001_u4F7F_u7528Annotations" class="headerlink" title="二、使用Annotations"></a>二、使用Annotations</h1>如果只想自定义特定Ingress资源的配置，可以使用Annotations。<figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Ingress</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: cafe-ingress-with-annotations</span><br><span class="line">  <span class="attribute">annotations</span>:</span><br><span class="line">    nginx.org/<span class="attribute">proxy-connect-timeout</span>: <span class="string">"30s"</span></span><br><span class="line">    nginx.org/<span class="attribute">proxy-read-timeout</span>: <span class="string">"20s"</span></span><br><span class="line">    nginx.org/<span class="attribute">client-max-body-size</span>: <span class="string">"4m"</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">host</span>: cafe.example.com</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">paths</span>:</span><br><span class="line">      - <span class="attribute">path</span>: /tea</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: tea-svc</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br><span class="line">      - <span class="attribute">path</span>: /coffee</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: coffee-svc</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure></li></ul><p>Annotations配置优先于ConfigMap<br><a href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization" target="_blank" rel="external">https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization</a><br><a href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization" target="_blank" rel="external">https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization</a></p><h1 id="u9650_u901F"><a href="#u9650_u901F" class="headerlink" title="限速"></a>限速</h1><p>Annotations<code>ingress.kubernetes.io/limit-connections</code>和<code>ingress.kubernetes.io/limit-rps</code>定义可由单个客户端IP地址打开的连接的限制。这可用于缓解<a href="https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus" target="_blank" rel="external">DDoS攻击</a>。</p><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/limit-connections：单个IP地址允许的并发连接数。</span><br><span class="line"></span><br><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/limit-rps：每秒可从给定IP接受的连接数。</span><br><span class="line"></span><br><span class="line">如果在单个Ingress规则中指定两个Annotations，`limit-rps`则优先。</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;u901A_u8FC7configmap_u4FEE_u6539nginx_controller_u7684_u4E00_u4E9B_u5168_u5C40_u53D8_u91CF&quot;&gt;&lt;a href=&quot;#u901A_u8FC7configmap_u4FEE_u65
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="ingress-nginx" scheme="http://www.idcsec.com/tags/ingress-nginx/"/>
    
  </entry>
  
  <entry>
    <title>etcdv3 集群基本操作使用</title>
    <link href="http://www.idcsec.com/2018/09/21/etcdv3-%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8/"/>
    <id>http://www.idcsec.com/2018/09/21/etcdv3-集群基本操作使用/</id>
    <published>2018-09-21T15:40:27.000Z</published>
    <updated>2018-09-21T15:40:59.478Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/coreos/etcd" target="_blank" rel="external">etcd</a>是一个开源的分布式键值对数据库，他的每一个节点都有一份数据的copy，当有节点故障时保证了高可用性。etcd使用<a href="https://raft.github.io/" target="_blank" rel="external">Raft</a>算法来保证一致性。</p><p>etcd的apiv3在使用命令时需要在前面加上ETCDCTL_API=3<br>集群成员<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=<span class="number">3</span> etcdctl member <span class="built_in">list</span></span><br></pre></td></tr></table></figure></p><p>更新一个节点ip<br><figure class="hljs highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl <span class="keyword">member</span> list</span><br><span class="line">etcdctl <span class="keyword">member</span> update memberID http:<span class="comment">//ip:2380</span></span><br></pre></td></tr></table></figure></p><p>删除一个节点<br><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member <span class="keyword">list</span>  </span><br><span class="line">etcdctl member <span class="built_in">remove</span> memberID  </span><br><span class="line">etcdctl member <span class="keyword">list</span>  </span><br><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> etcd //在相关节点上kill掉etcd进程</span><br></pre></td></tr></table></figure></p><p>测试增加一个新节点<br>注意：添加已经删除的需要将etcd3的rm -rf /var/lib/etcd/*必须删除<br>移除节点<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  list -w table</span><br><span class="line">ETCDCTL_API=3  etcdctl --endpoints=https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  remove 7d17ab970f6de141</span></span><br></pre></td></tr></table></figure></p><p>添加节点<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member add  etcd3 --peer-urls="https:/</span><span class="regexp">/192.168.7.92:2380" /</span><span class="regexp">/查看新增成员列表，etcd3状态为unstarted</span><br><span class="line">rm -rf /var</span><span class="regexp">/lib/etcd</span><span class="regexp">/*  /</span><span class="regexp">/etcd3上面操作</span><br><span class="line">vi  /etc</span><span class="regexp">/systemd/system</span><span class="regexp">/etcd.service  /</span><span class="regexp">//etcd</span>3上面操作 修改--initial-cluster-state=existing 不改报错 streaming request ignored (<span class="constant">ID</span> mismatch got <span class="number">7</span>d17ab970f6de141 want <span class="number">58662</span>caff7c6e081)</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl  restart   etcd  /<span class="regexp">//etcd</span>3上面操作</span><br><span class="line"><span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  list -w table</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;etcd&lt;/a&gt;是一个开源的分布式键值对数据库，他的每一个节点都有一份数据的copy，当有节点故障时保证了高可用性。etcd使用&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>kubernetesk kubelet证书到期解决方法</title>
    <link href="http://www.idcsec.com/2018/09/21/kubernetesk-kubelet%E8%AF%81%E4%B9%A6%E5%88%B0%E6%9C%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    <id>http://www.idcsec.com/2018/09/21/kubernetesk-kubelet证书到期解决方法/</id>
    <published>2018-09-21T15:31:00.000Z</published>
    <updated>2018-09-21T15:36:40.515Z</updated>
    
    <content type="html"><![CDATA[<p>kubelete 证书默认有效期一年<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L -o <span class="regexp">/bin/</span>cfssl-certinfo <span class="string">https:</span><span class="comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line">chmod a+x <span class="regexp">/bin/</span>cfssl-certinfo</span><br><span class="line"> cfssl-certinfo -cert <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.crt</span><br></pre></td></tr></table></figure></p><p><img src="/img/kubelet1.png" alt="crt"></p><h1 id="u65B9_u6CD5_u4E00"><a href="#u65B9_u6CD5_u4E00" class="headerlink" title="方法一"></a>方法一</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">备份 mkdir  <span class="regexp">~/sslback &amp;&amp; mv /</span>etc<span class="regexp">/kubernetes/</span>kubelet.kubeconfig  <span class="regexp">~/sslback/</span></span><br><span class="line">使用admin证书文件替换</span><br><span class="line">cp <span class="regexp">~/.kube/</span>config <span class="regexp">/etc/</span>kubernetes/kubelet.kubeconfig </span><br><span class="line">systemctl  restart kubelet &amp;&amp; systemctl  status  kubelet</span><br></pre></td></tr></table></figure><h1 id="u65B9_u6CD5_u4E8C_kubelet_u91CD_u65B0_u8BF7_u6C42_u8BC1_u4E66"><a href="#u65B9_u6CD5_u4E8C_kubelet_u91CD_u65B0_u8BF7_u6C42_u8BC1_u4E66" class="headerlink" title="方法二 kubelet重新请求证书"></a>方法二 kubelet重新请求证书</h1><p>手动签发<br>在 kubelet 首次启动后，如果用户 Token 没问题，并且 RBAC 也做了相应的设置，那么此时在集群内应该能看到 kubelet 发起的 CSR 请求 ，必须通过后kubernetes 系统才会将该 Node 加入到集群。<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在证书过期node删除kubelet相关证书文件</span><br><span class="line">rm -rf <span class="regexp">/etc/</span>kubernetes/kubelet.kubeconfig</span><br><span class="line">rm -rf <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.*</span><br><span class="line">systemctl  restart kubelet &amp;&amp; systemctl  status  kubelet</span><br><span class="line">自动生成了kubelet kubeconfig 文件和公私钥</span><br><span class="line">查看未授权的CSR请求</span><br><span class="line">kubectl get csr</span><br><span class="line">通过CSR 请求：</span><br><span class="line">kubectl certificate approve csr-<span class="number">404</span>fc</span><br><span class="line">查看重新生成的证书文件</span><br><span class="line">ll <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.*</span><br><span class="line">kubectl  get nodes --show-labels</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;kubelete 证书默认有效期一年&lt;br&gt;&lt;figure class=&quot;hljs highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="tls" scheme="http://www.idcsec.com/tags/tls/"/>
    
  </entry>
  
  <entry>
    <title>prometheus alertmanager邮件告警</title>
    <link href="http://www.idcsec.com/2018/09/19/prometheus-alertmanager%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/"/>
    <id>http://www.idcsec.com/2018/09/19/prometheus-alertmanager邮件告警/</id>
    <published>2018-09-19T06:43:00.000Z</published>
    <updated>2018-10-30T07:50:58.680Z</updated>
    
    <content type="html"><![CDATA[<p>prometheus将监测到的异常事件发送给alertmanager，alertmanager发送异常事件的通知（邮件、webhook等）</p><ul><li>参考<br><a href="https://prometheus.io/docs/alerting/configuration/" target="_blank" rel="external">https://prometheus.io/docs/alerting/configuration/</a><br><a href="https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html" target="_blank" rel="external">https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html</a><br><a href="https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml" target="_blank" rel="external">https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml</a><br><a href="https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl" target="_blank" rel="external">https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl</a><br>k8s部署prometheus<br>略<br>k8s部署alertmanager<br>修改Prometheus配置文件我prometheus.yml<figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">global</span>:</span><br><span class="line">  <span class="attribute">scrape_interval</span>:     <span class="number">15s</span></span><br><span class="line">  <span class="attribute">evaluation_interval</span>: <span class="number">15s</span></span><br><span class="line"><span class="attribute">alerting</span>:</span><br><span class="line">  <span class="attribute">alertmanagers</span>:</span><br><span class="line">    - <span class="attribute">static_configs</span>:</span><br><span class="line">        - <span class="attribute">targets</span>: [<span class="string">"alertmanager:9093"</span>]#AlertManager 地址与端口</span><br></pre></td></tr></table></figure></li></ul><h1 id="configMap-yaml_u6587_u4EF6"><a href="#configMap-yaml_u6587_u4EF6" class="headerlink" title="configMap.yaml文件"></a>configMap.yaml文件</h1><p>随便注释一部分具体参数参考官方</p><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: ConfigMap</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">    <span class="attribute">name</span>: alertmanager</span><br><span class="line">    <span class="attribute">namespace</span>: monitoring</span><br><span class="line"><span class="attribute">data</span>:</span><br><span class="line">  config.<span class="attribute">yml</span>: |-</span><br><span class="line">    <span class="attribute">global</span>:</span><br><span class="line">      <span class="attribute">smtp_smarthost</span>:  <span class="string">'smtp.idcsec.com:25'</span> # Email SMTP 服务器信息</span><br><span class="line">      <span class="attribute">smtp_from</span>:  <span class="string">'root@idcsec.com'</span></span><br><span class="line">      <span class="attribute">smtp_auth_username</span>:   <span class="string">'root@idcsec.com'</span></span><br><span class="line">      <span class="attribute">smtp_auth_password</span>:  <span class="string">'pwd'</span></span><br><span class="line">      <span class="attribute">resolve_timeout</span>: <span class="number">10</span>m</span><br><span class="line">      <span class="attribute">smtp_require_tls</span>: false          #是否开启 TLS</span><br><span class="line">    <span class="attribute">route</span>:                       # 路由规则配置将不同告警发送给指定人</span><br><span class="line">      <span class="attribute">group_by</span>: [<span class="string">'alertname'</span>]         # 告警压缩规则</span><br><span class="line">      <span class="attribute">repeat_interval</span>: <span class="number">24</span>h</span><br><span class="line">      <span class="attribute">receiver</span>: monitoring       #默认发送到 <span class="built_in">`monitoring`</span>，该 monitoring 必须存在，否则报错退出</span><br><span class="line">       <span class="attribute">routes</span>:               # 子路由告警级别分别发给不同的接收器</span><br><span class="line">       - <span class="attribute">match</span>:</span><br><span class="line">          <span class="attribute">team</span>:dba      #匹配prometheus的rule_files文件中的labels</span><br><span class="line">         <span class="attribute">receiver</span>: db-team-email   receiver接收器名称 全局唯一</span><br><span class="line">         <span class="attribute">continue</span>: true               # 默认告警匹配成功第一个 receivers 会退出匹配，开启 continue 参数后会继续匹配 receivers 列表</span><br><span class="line">         </span><br><span class="line">    <span class="attribute">receivers</span>:                         # 接收器</span><br><span class="line">    - <span class="attribute">name</span>: <span class="string">'monitoring'</span></span><br><span class="line">      <span class="attribute">email_configs</span>:</span><br><span class="line">      - <span class="attribute">send_resolved</span>: true  #告警恢复后否发送通知，这里选择发送</span><br><span class="line">       <span class="attribute">to</span>: <span class="string">'test@idcsec.com'</span> #接收邮件<span class="string">'A@.com,B@com'</span></span><br><span class="line">    - <span class="attribute">name</span>: <span class="string">'db-team-email'</span></span><br><span class="line">      <span class="attribute">email_configs</span>:</span><br><span class="line">      - <span class="attribute">send_resolved</span>: true</span><br><span class="line">       <span class="attribute">to</span>:<span class="string">'xxx@xxx.com'</span></span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="alertmanager-yaml_u6587_u4EF6"><a href="#alertmanager-yaml_u6587_u4EF6" class="headerlink" title="alertmanager.yaml文件"></a>alertmanager.yaml文件</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: <span class="string">"3"</span></span><br><span class="line">  creationTimestamp: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">  generation: <span class="number">3</span></span><br><span class="line">  labels:</span><br><span class="line">    app: alertmanager</span><br><span class="line">  name: alertmanager</span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">  resourceVersion: <span class="string">"43603292"</span></span><br><span class="line">  selfLink: /apis/extensions/v1beta1/namespaces/monitoring/deployments/alertmanager</span><br><span class="line">  uid: c3c75e6c-<span class="number">94</span>c2-<span class="number">11e8</span>-b5ba-<span class="number">1866</span>daeddaa4</span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: <span class="number">1</span></span><br><span class="line">      maxUnavailable: <span class="number">1</span></span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  <span class="keyword">template</span>:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">      name: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - -config.file=/etc/alertmanager/config.yml</span><br><span class="line">        - -storage.path=/alertmanager</span><br><span class="line">        image: alertmanager:v0<span class="number">.7</span><span class="number">.1</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: alertmanager</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">9093</span></span><br><span class="line">          name: alertmanager</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        terminationMessagePath: /dev/termination-<span class="built_in">log</span></span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/alertmanager</span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: /etc/alertmanager-templates</span><br><span class="line">          name: templates-volume</span><br><span class="line">        - mountPath: /alertmanager</span><br><span class="line">          name: alertmanager</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: <span class="keyword">default</span>-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      terminationGracePeriodSeconds: <span class="number">30</span></span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: <span class="number">420</span></span><br><span class="line">          name: alertmanager</span><br><span class="line">        name: config-volume</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: <span class="number">420</span></span><br><span class="line">          name: alertmanager-templates</span><br><span class="line">        name: templates-volume</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: alertmanager</span><br><span class="line">status:</span><br><span class="line">  availableReplicas: <span class="number">1</span></span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">    lastUpdateTime: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">    message: Deployment has minimum availability.</span><br><span class="line">    reason: MinimumReplicasAvailable</span><br><span class="line">    status: <span class="string">"True"</span></span><br><span class="line">    type: Available</span><br><span class="line">  observedGeneration: <span class="number">3</span></span><br><span class="line">  readyReplicas: <span class="number">1</span></span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  updatedReplicas: <span class="number">1</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>部署Prometheus alertmanager相关配置文件<br>在prometheus.yml中指定规则文件（可使用通配符，如rules/*.rules）这使用 rules.yaml</p><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> <span class="constant">ConfigMap</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line">  <span class="symbol">name:</span> prometheus-config</span><br><span class="line">  <span class="symbol">labels:</span></span><br><span class="line">    <span class="symbol">name:</span>  prometheus-config</span><br><span class="line">  <span class="symbol">namespace:</span> monitoring</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line">  prometheus.<span class="symbol">yml:</span> |</span><br><span class="line">    <span class="symbol">global:</span></span><br><span class="line">      <span class="symbol">scrape_interval:</span>     <span class="number">15</span>s</span><br><span class="line">      <span class="symbol">evaluation_interval:</span> <span class="number">15</span>s</span><br><span class="line">    <span class="symbol">alerting:</span></span><br><span class="line">      <span class="symbol">alertmanagers:</span></span><br><span class="line">        - <span class="symbol">static_configs:</span></span><br><span class="line">            - <span class="symbol">targets:</span> [<span class="string">"alertmanager:9093"</span>] <span class="comment"># AlertManager 地址与端口</span></span><br><span class="line">    <span class="symbol">rule_files:</span></span><br><span class="line">     - <span class="string">"rules.yml"</span></span><br><span class="line">    <span class="symbol">scrape_configs:</span></span><br><span class="line">    ..........</span><br><span class="line">  </span><br><span class="line">rules.<span class="symbol">yml:</span> |-</span><br><span class="line">    <span class="symbol">groups:</span></span><br><span class="line">    - <span class="symbol">name:</span> noah_pod.rules</span><br><span class="line">      <span class="symbol">rules:</span></span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_cpu_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> (sum by(name)(rate(container_cpu_usage_seconds_total&#123;image!=<span class="string">""</span>&#125;[<span class="number">5</span>m]))*<span class="number">100</span>) &gt; <span class="number">10</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">5</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">          <span class="symbol">service:</span> pods</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> <span class="constant">CPU</span> 资源利用率大于 <span class="number">75</span>% , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> <span class="constant">Dev</span> <span class="constant">CPU</span> 负载告警</span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_memory_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> sort_desc(avg by(name)(irate(container_memory_usage_bytes&#123;name!=<span class="string">""</span>&#125;[<span class="number">5</span>m]))*<span class="number">100</span>) &gt; <span class="number">1024</span>*<span class="number">10</span>^<span class="number">3</span>*<span class="number">2</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">10</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> <span class="constant">Memory</span> 资源利用率大于 <span class="number">2</span>G , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> <span class="constant">Dev</span> <span class="constant">Memory</span> 负载告警</span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_network_receive_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> sum by (name)(irate(container_network_receive_bytes_total&#123;container_name=<span class="string">"POD"</span>&#125;[<span class="number">1</span>m])) &gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">50</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">10</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> network_receive 资源利用率大于 <span class="number">50</span>M , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> network_receive 负载告警</span><br><span class="line">    - <span class="symbol">name:</span> <span class="constant">Oracle</span>.rules</span><br><span class="line">      <span class="symbol">rules:</span></span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Oracledb</span>-status</span><br><span class="line">        <span class="symbol">expr:</span> oracledb_up&#123;job=<span class="string">"oracle-198"</span>&#125;  == <span class="number">0</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">60</span>s</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critica</span><br><span class="line">          <span class="symbol">team:</span>dba</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">summary:</span> 数据库 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125;</span> 告警</span><br><span class="line">          <span class="symbol">description:</span> <span class="string">"数据库 &#123;&#123; $labels.instance &#125;&#125; 异常 (当前值: &#123;&#123; $value &#125;&#125;"</span></span><br></pre></td></tr></table></figure><p>更新prometheus的配置需要让重新读取，有两种方法：<br>1、通过HTTP API向/-/reload发送POST请求，例：curl -X POST <a href="http://ip:9090/-/reload" target="_blank" rel="external">http://ip:9090/-/reload</a><br>2、向prometheus进程发送SIGHUP信号<br><img src="/img/p1.png" alt="crt"><br><img src="/img/p2.png" alt="crt"><br><img src="/img/p3.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;prometheus将监测到的异常事件发送给alertmanager，alertmanager发送异常事件的通知（邮件、webhook等）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;参考&lt;br&gt;&lt;a href=&quot;https://prometheus.io/docs/alerting/configuration/&quot;&gt;https://prometheus.io/docs/alerting/configuration/&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html&quot;&gt;https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml&quot;&gt;https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl&quot;&gt;https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl&lt;/a&gt;&lt;br&gt;k8s部署prometheus&lt;br&gt;略&lt;br&gt;k8s部署alertmanager&lt;br&gt;修改Prometheus配置文件我prometheus.yml&lt;figure class=&quot;hljs highlight less&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;global&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;scrape_interval&lt;/span&gt;:     &lt;span class=&quot;number&quot;&gt;15s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;evaluation_interval&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;15s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;alerting&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;alertmanagers&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;attribute&quot;&gt;static_configs&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        - &lt;span class=&quot;attribute&quot;&gt;targets&lt;/span&gt;: [&lt;span class=&quot;string&quot;&gt;&quot;alertmanager:9093&quot;&lt;/span&gt;]#AlertManager 地址与端口&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;configMap-yaml_u6587_u4EF6&quot;&gt;&lt;a href=&quot;#configMap-yaml_u6587_u4EF6&quot; class=&quot;headerlink&quot; title=&quot;configMap.yaml文件&quot;&gt;&lt;/a&gt;configMap.yaml文件&lt;/h1&gt;&lt;p&gt;随便注释一部分具体参数参考官方&lt;/p&gt;
&lt;figure class=&quot;hljs highlight less&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;apiVersion&lt;/span&gt;: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;kind&lt;/span&gt;: ConfigMap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;metadata&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: alertmanager&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;namespace&lt;/span&gt;: monitoring&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;data&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config.&lt;span class=&quot;attribute&quot;&gt;yml&lt;/span&gt;: |-&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;global&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;smtp_smarthost&lt;/span&gt;:  &lt;span class=&quot;string&quot;&gt;&#39;smtp.idcsec.com:25&#39;&lt;/span&gt; # Email SMTP 服务器信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;smtp_from&lt;/span&gt;:  &lt;span class=&quot;string&quot;&gt;&#39;root@idcsec.com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;smtp_auth_username&lt;/span&gt;:   &lt;span class=&quot;string&quot;&gt;&#39;root@idcsec.com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;smtp_auth_password&lt;/span&gt;:  &lt;span class=&quot;string&quot;&gt;&#39;pwd&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resolve_timeout&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;smtp_require_tls&lt;/span&gt;: false          #是否开启 TLS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;route&lt;/span&gt;:                       # 路由规则配置将不同告警发送给指定人&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;group_by&lt;/span&gt;: [&lt;span class=&quot;string&quot;&gt;&#39;alertname&#39;&lt;/span&gt;]         # 告警压缩规则&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;repeat_interval&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;receiver&lt;/span&gt;: monitoring       #默认发送到 &lt;span class=&quot;built_in&quot;&gt;`monitoring`&lt;/span&gt;，该 monitoring 必须存在，否则报错退出&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;attribute&quot;&gt;routes&lt;/span&gt;:               # 子路由告警级别分别发给不同的接收器&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       - &lt;span class=&quot;attribute&quot;&gt;match&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;team&lt;/span&gt;:dba      #匹配prometheus的rule_files文件中的labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;attribute&quot;&gt;receiver&lt;/span&gt;: db-team-email   receiver接收器名称 全局唯一&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;attribute&quot;&gt;continue&lt;/span&gt;: true               # 默认告警匹配成功第一个 receivers 会退出匹配，开启 continue 参数后会继续匹配 receivers 列表&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;receivers&lt;/span&gt;:                         # 接收器&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;monitoring&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;email_configs&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - &lt;span class=&quot;attribute&quot;&gt;send_resolved&lt;/span&gt;: true  #告警恢复后否发送通知，这里选择发送&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;attribute&quot;&gt;to&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;test@idcsec.com&#39;&lt;/span&gt; #接收邮件&lt;span class=&quot;string&quot;&gt;&#39;A@.com,B@com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;db-team-email&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;email_configs&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - &lt;span class=&quot;attribute&quot;&gt;send_resolved&lt;/span&gt;: true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;attribute&quot;&gt;to&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&#39;xxx@xxx.com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="alertmanager" scheme="http://www.idcsec.com/tags/alertmanager/"/>
    
      <category term="prometheus" scheme="http://www.idcsec.com/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>解决ingress-nginx反向代理在监听非80端口时候跳转问题以及Nginx</title>
    <link href="http://www.idcsec.com/2018/09/16/%E8%A7%A3%E5%86%B3ingress-nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%9C%A8%E7%9B%91%E5%90%AC%E9%9D%9E80%E7%AB%AF%E5%8F%A3%E6%97%B6%E5%80%99%E8%B7%B3%E8%BD%AC%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8ANginx/"/>
    <id>http://www.idcsec.com/2018/09/16/解决ingress-nginx反向代理在监听非80端口时候跳转问题以及Nginx/</id>
    <published>2018-09-16T14:05:00.000Z</published>
    <updated>2018-09-16T15:00:45.783Z</updated>
    
    <content type="html"><![CDATA[<ul><li>解决方法比较多主要根据自己的环境找到合适的解决方式，ingress-nginx默认监听443,80，这里的环境主要是因为路由器映射到非80端口导致跳转的Heather的Request丢失端口跳转到了默认的80<br>参考<br><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" target="_blank" rel="external">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect</a><br><a href="https://www.nginx.com/resources/wiki/start/topics/examples/fullexample2/" target="_blank" rel="external">https://www.nginx.com/resources/wiki/start/topics/examples/fullexample2/</a><br><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-redirect" target="_blank" rel="external">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-redirect</a><h1 id="nginx_u914D_u7F6E"><a href="#nginx_u914D_u7F6E" class="headerlink" title="nginx配置"></a>nginx配置</h1><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream tomcat &#123;</span><br><span class="line">    server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9090</span> weight=<span class="number">1</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name example.com *.example.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_next_upstream http_502 http_504 error timeout invalid_header;</span><br><span class="line"></span><br><span class="line">      proxy_set_header Host  <span class="variable">$host</span>:<span class="variable">$server</span>_port;</span><br><span class="line">      proxy_set_header X-Real-IP <span class="variable">$remote</span>_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For <span class="variable">$proxy</span>_add_x_forwarded_for;</span><br><span class="line">      proxy_redirect http://<span class="variable">$host</span> http://<span class="variable">$host</span>:<span class="variable">$server</span>_port;//由于是路由器上面配置映射非<span class="number">80</span>端口到<span class="number">80</span>端口这里就不能使用<span class="variable">$server</span>_port需要直接写端口号</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="ingress-nginx_u914D_u7F6E"><a href="#ingress-nginx_u914D_u7F6E" class="headerlink" title="ingress-nginx配置"></a>ingress-nginx配置</h1><p>默认ingress-nginx 代理重定向是OFF<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master ~]<span class="preprocessor"># kubectl exec -it nginx-ingress-controller-<span class="number">1971110253</span>-<span class="number">0</span>rcjw  -n kube-system -- cat /etc/nginx/nginx.conf   | grep <span class="string">"proxy_redirect"</span> | head -n <span class="number">1</span></span></span><br><span class="line">            proxy_redirect                          off;</span><br></pre></td></tr></table></figure></p><h1 id="ingress_u4EE3_u7406_u91CD_u5B9A_u5411_u914D_u7F6E"><a href="#ingress_u4EE3_u7406_u91CD_u5B9A_u5411_u914D_u7F6E" class="headerlink" title="ingress代理重定向配置"></a>ingress代理重定向配置</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kind:</span> Ingress</span><br><span class="line"><span class="string">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">  annotations:</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-redirect-<span class="string">from:</span> <span class="string">"test.cn:9090"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-redirect-<span class="string">to:</span> <span class="string">"test.cn:9090"</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  rules:</span></span><br><span class="line">  - <span class="string">host:</span>  $&#123;projectUrl&#125;</span><br><span class="line"><span class="label">    http:</span></span><br><span class="line"><span class="label">      paths:</span></span><br><span class="line">      - <span class="string">path:</span> /</span><br><span class="line"><span class="label">        backend:</span></span><br><span class="line"><span class="label">          serviceName:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">          servicePort:</span> <span class="number">80</span></span><br><span class="line">  - <span class="string">host:</span> $&#123;projectUrl<span class="regexp">/test.loca/</span>test.cn&#125;</span><br><span class="line"><span class="label">    http:</span> </span><br><span class="line"><span class="label">      paths:</span> </span><br><span class="line">      - <span class="string">path:</span> /</span><br><span class="line"><span class="label">        backend:</span></span><br><span class="line"><span class="label">          serviceName:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><ul><li>重点</li></ul><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/proxy-redirect-from: <span class="string">"idcsec.com"</span></span><br><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/proxy-redirect-to: <span class="string">"idcsec.com"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;解决方法比较多主要根据自己的环境找到合适的解决方式，ingress-nginx默认监听443,80，这里的环境主要是因为路由器映射到非80端口导致跳转的Heather的Request丢失端口跳转到了默认的80&lt;br&gt;参考&lt;br&gt;&lt;a href=&quot;http://n
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="ingress-nginx" scheme="http://www.idcsec.com/tags/ingress-nginx/"/>
    
      <category term="nginx" scheme="http://www.idcsec.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>HARBOR仓库安装部署</title>
    <link href="http://www.idcsec.com/2018/09/14/HARBOR%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://www.idcsec.com/2018/09/14/HARBOR仓库安装部署/</id>
    <published>2018-09-14T11:45:00.000Z</published>
    <updated>2018-09-14T15:04:37.548Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Harbor__u4ECB_u7ECD"><a href="#Harbor__u4ECB_u7ECD" class="headerlink" title="<strong> Harbor 介绍</strong>"></a><strong> Harbor 介绍</strong></h1><p>Harbor 是 Vmwar 公司开源的 企业级的 Docker Registry 管理项目<br>它主要 提供 Dcoker Registry 管理UI，可基于角色访问控制, AD/LDAP 集成，日志审核等功能，完全的支持中文。<br>Harbor 的所有组件都在 Dcoker 中部署，所以 Harbor 可使用 Docker Compose 快速部署。<br>安装方式:<br>-在线安装程序：安装程序从Docker hub下载Harbor的图像。因此，安装程序的尺寸非常小。</p><p>-脱机安装程序：当主机没有Internet连接时使用此安装程序。安装程序包含预先构建的图像，因此其大小更大。</p><h2 id="harbor__u90E8_u7F72"><a href="#harbor__u90E8_u7F72" class="headerlink" title="harbor 部署"></a>harbor 部署</h2><p>开源项目地址：<a href="https://github.com/vmware/harbor" target="_blank" rel="external">https://github.com/vmware/harbor</a><br>官方安装说明：<a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a></p><h1 id="Docker_u5B89_u88C5"><a href="#Docker_u5B89_u88C5" class="headerlink" title="Docker安装"></a>Docker安装</h1><h2 id="u5378_u8F7D_u8001docker_u7248_u672C"><a href="#u5378_u8F7D_u8001docker_u7248_u672C" class="headerlink" title="卸载老docker版本"></a>卸载老docker版本</h2><figure class="hljs highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker <span class="string">\</span></span><br><span class="line">                  docker-client <span class="string">\</span></span><br><span class="line">                  docker-client-latest <span class="string">\</span></span><br><span class="line">                  docker-common <span class="string">\</span></span><br><span class="line">                  docker-latest <span class="string">\</span></span><br><span class="line">                  docker-latest-logrotate <span class="string">\</span></span><br><span class="line">                  docker-logrotate <span class="string">\</span></span><br><span class="line">                  docker-selinux <span class="string">\</span></span><br><span class="line">                  docker-engine-selinux <span class="string">\</span></span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure><h3 id="u5B89_u88C5_docker_repository"><a href="#u5B89_u88C5_docker_repository" class="headerlink" title="安装 docker repository"></a>安装 docker repository</h3><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -<span class="keyword">y</span> yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --<span class="built_in">add</span>-repo \</span><br><span class="line">    http<span class="variable">s:</span>//download.docker.<span class="keyword">com</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">$ yum <span class="keyword">list</span> docker-<span class="keyword">ce</span> --showduplicates | <span class="built_in">sort</span> -<span class="keyword">r</span></span><br><span class="line">$ sudo yum install docker-<span class="keyword">ce</span> -<span class="keyword">y</span></span><br><span class="line">$ systemctl   start docker</span><br></pre></td></tr></table></figure><p>安装docker-compose<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro harbor-<span class="number">1.5</span><span class="number">.3</span>]<span class="preprocessor"># yum install python2-pip -y &amp;&amp; yum install docker-compose -y</span></span><br></pre></td></tr></table></figure></p><h4 id="u4FEE_u6539docker_u52A0_u901F"><a href="#u4FEE_u6539docker_u52A0_u901F" class="headerlink" title="修改docker加速"></a>修改docker加速</h4><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [ <span class="string">"https://registry.docker-cn.com"</span>,], </span><br><span class="line">  <span class="string">"max-concurrent-downloads"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-level"</span>: <span class="string">"warn"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"10m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="u90E8_u7F72harbor"><a href="#u90E8_u7F72harbor" class="headerlink" title="部署harbor"></a>部署harbor</h1><h2 id="u4E0B_u8F7D_u5B89_u88C5_u5305_u5E76_u89E3_u538B_uFF1A"><a href="#u4E0B_u8F7D_u5B89_u88C5_u5305_u5E76_u89E3_u538B_uFF1A" class="headerlink" title="下载安装包并解压："></a>下载安装包并解压：</h2><figure class="hljs highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># wget https://storage.googleapis.com/harbor-releases/release-1.6.0/harbor-online-installer-v1.6.0.tgz</span></span><br><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># tar -zxvf harbor-online-installer-v1.6.0.tgz</span></span><br><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># vi harbor/harbor.cfg</span></span><br></pre></td></tr></table></figure><h3 id="u4FEE_u6539harbor_u914D_u7F6E"><a href="#u4FEE_u6539harbor_u914D_u7F6E" class="headerlink" title="修改harbor配置"></a>修改harbor配置</h3><figure class="hljs highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[root@Pro ~]</span><span class="comment"># vi harbor/harbor.cfg </span></span><br><span class="line"><span class="comment"># hostname 设置访问地址，支持IP，域名，主机名，禁止设置127.0.0.1</span></span><br><span class="line"><span class="setting">hostname =<span class="value">harbor.idcsec.com</span></span></span><br><span class="line"><span class="comment"># 访问协议，可设置 http,https</span></span><br><span class="line"><span class="setting">ui_url_protocol = <span class="value">http</span></span></span><br><span class="line"><span class="comment"># harbor WEB UI登陆使用的密码</span></span><br><span class="line"><span class="setting">harbor_admin_password = <span class="value">Harbor12345</span></span></span><br><span class="line"><span class="comment"># 认证方式，这里支持多种认证方式，默认是 db_auth ，mysql数据库存储认证。</span></span><br><span class="line"><span class="comment"># 支持 ldap 以及 本地文件存储方式。</span></span><br><span class="line"><span class="setting">auth_mode = <span class="value">db_auth</span></span></span><br><span class="line"><span class="comment"># mysql root 账户的 密码</span></span><br><span class="line"><span class="setting">db_password = <span class="value">root123</span></span></span><br><span class="line"><span class="setting">self_registration= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">use_compressed_js= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">max_job_workers= <span class="value"><span class="number">10</span></span></span></span><br><span class="line"><span class="setting">verify_remote_cert= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">customize_crt= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="comment">#其他的参数可以保持默认</span></span><br></pre></td></tr></table></figure><p><strong> 配置存储后端（可选）</strong><br>默认情况下，Harbor将图像存储在本地文件系统中。在生产环境中，您可以考虑使用其他存储后端而不是本地文件系统，如S3，OpenStack Swift，Ceph等。您需要更新的是storage文件中的部分common/templates/registry/config.yml</p><h4 id="u5B89_u88C5harbor"><a href="#u5B89_u88C5harbor" class="headerlink" title="安装harbor"></a>安装harbor</h4><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro ~]<span class="preprocessor"># ./harbor/install.sh </span></span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker-compose ps</span></span><br><span class="line">       Name                     Command               State                                Ports                              </span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                      </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      <span class="number">5432</span>/tcp                                                        </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                      </span><br><span class="line">harbor-<span class="built_in">log</span>           /bin/sh -c /usr/local/bin/ ...   Up      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1514</span>-&gt;<span class="number">10514</span>/tcp                                       </span><br><span class="line">harbor-ui            /harbor/start.sh                 Up                                                                      </span><br><span class="line">nginx                nginx -g daemon off;             Up      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">443</span>-&gt;<span class="number">443</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4443</span>-&gt;<span class="number">4443</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      <span class="number">6379</span>/tcp                                                        </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      <span class="number">5000</span>/tcp</span><br></pre></td></tr></table></figure><h5 id="u767B_u5F55_u4ED3_u5E93"><a href="#u767B_u5F55_u4ED3_u5E93" class="headerlink" title="登录仓库"></a>登录仓库</h5><figure class="hljs highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="property">@Pro</span> harbor]<span class="comment"># docker login  http://harbor.idcsec.com</span></span><br><span class="line"><span class="attribute">Username</span>: admin</span><br><span class="line"><span class="attribute">Password</span>: </span><br><span class="line">Error response <span class="keyword">from</span> <span class="attribute">daemon</span>: Get <span class="attribute">https</span>:<span class="pi">//harbor.idcsec.com/v2/: dial tcp 47.94.253.198:443: connect: connection refused</span><br><span class="line">//</span>配置的是http，docker login默认走的是https.</span><br><span class="line">[root<span class="property">@Pro</span> ~]<span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://registry.docker-cn.com"</span>, <span class="string">"https://docker.mirrors.ustc.edu.cn"</span>], </span><br><span class="line"> <span class="string">"insecure-registries"</span>:[<span class="string">"harbor.idcsec.com"</span>],</span><br><span class="line">  <span class="string">"max-concurrent-downloads"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-level"</span>: <span class="string">"warn"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"10m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root<span class="property">@Pro</span> harbor]<span class="comment"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span></span><br></pre></td></tr></table></figure><h1 id="u6D4B_u8BD5push_u955C_u50CF_u5230harbor"><a href="#u6D4B_u8BD5push_u955C_u50CF_u5230harbor" class="headerlink" title="测试push镜像到harbor"></a>测试push镜像到harbor</h1><figure class="hljs highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro harbor]<span class="preprocessor"># docker login harbor.idcsec.com</span></span><br><span class="line"><span class="label">Username:</span> admin</span><br><span class="line"><span class="label">Password:</span> </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line"><span class="label">https:</span>//docs.docker.com/engine/reference/commandline/login/<span class="preprocessor">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker pull busybox</span></span><br><span class="line">Using default tag: latest</span><br><span class="line"><span class="label">latest:</span> Pulling from library/busybox</span><br><span class="line"><span class="number">8</span>c5a7da1afbc: Pull complete </span><br><span class="line"><span class="label">Digest:</span> sha256:cb63aa0641a885f54de20f61d152187419e8f6b159ed11a251a09d115fdff9bd</span><br><span class="line"><span class="label">Status:</span> Downloaded newer image for busybox:latest</span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker tag  busybox:latest harbor.idcsec.com/pro/busybox:latest</span></span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker push   harbor.idcsec.com/pro/busybox:latest</span></span><br><span class="line">The <span class="keyword">push</span> refers to repository [harbor.idcsec.com/pro/busybox]</span><br><span class="line"><span class="label">f9d9e4e6e2f0:</span> Pushed </span><br><span class="line"><span class="label">latest:</span> digest: sha256:<span class="number">5e8</span>e0509e829bb8f990249135a36e81a3ecbe94294e7a185cc14616e5fad96bd size: <span class="number">527</span></span><br></pre></td></tr></table></figure><p><img src="/img/harbor1.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Harbor__u4ECB_u7ECD&quot;&gt;&lt;a href=&quot;#Harbor__u4ECB_u7ECD&quot; class=&quot;headerlink&quot; title=&quot;&lt;strong&gt; Harbor 介绍&lt;/strong&gt;&quot;&gt;&lt;/a&gt;&lt;strong&gt; Harbor 介绍&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;Harbor 是 Vmwar 公司开源的 企业级的 Docker Registry 管理项目&lt;br&gt;它主要 提供 Dcoker Registry 管理UI，可基于角色访问控制, AD/LDAP 集成，日志审核等功能，完全的支持中文。&lt;br&gt;Harbor 的所有组件都在 Dcoker 中部署，所以 Harbor 可使用 Docker Compose 快速部署。&lt;br&gt;安装方式:&lt;br&gt;-在线安装程序：安装程序从Docker hub下载Harbor的图像。因此，安装程序的尺寸非常小。&lt;/p&gt;
&lt;p&gt;-脱机安装程序：当主机没有Internet连接时使用此安装程序。安装程序包含预先构建的图像，因此其大小更大。&lt;/p&gt;
&lt;h2 id=&quot;harbor__u90E8_u7F72&quot;&gt;&lt;a href=&quot;#harbor__u90E8_u7F72&quot; class=&quot;headerlink&quot; title=&quot;harbor 部署&quot;&gt;&lt;/a&gt;harbor 部署&lt;/h2&gt;&lt;p&gt;开源项目地址：&lt;a href=&quot;https://github.com/vmware/harbor&quot;&gt;https://github.com/vmware/harbor&lt;/a&gt;&lt;br&gt;官方安装说明：&lt;a href=&quot;https://github.com/vmware/harbor/blob/master/docs/installation_guide.md&quot;&gt;https://github.com/vmware/harbor/blob/master/docs/installation_guide.md&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;Docker_u5B89_u88C5&quot;&gt;&lt;a href=&quot;#Docker_u5B89_u88C5&quot; class=&quot;headerlink&quot; title=&quot;Docker安装&quot;&gt;&lt;/a&gt;Docker安装&lt;/h1&gt;&lt;h2 id=&quot;u5378_u8F7D_u8001docker_u7248_u672C&quot;&gt;&lt;a href=&quot;#u5378_u8F7D_u8001docker_u7248_u672C&quot; class=&quot;headerlink&quot; title=&quot;卸载老docker版本&quot;&gt;&lt;/a&gt;卸载老docker版本&lt;/h2&gt;&lt;figure class=&quot;hljs highlight livescript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo yum remove docker &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-client &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-client-latest &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-common &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-latest &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-latest-logrotate &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-logrotate &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-selinux &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-engine-selinux &lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  docker-engine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;u5B89_u88C5_docker_repository&quot;&gt;&lt;a href=&quot;#u5B89_u88C5_docker_repository&quot; class=&quot;headerlink&quot; title=&quot;安装 docker repository&quot;&gt;&lt;/a&gt;安装 docker repository&lt;/h3&gt;&lt;figure class=&quot;hljs highlight vim&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum install -&lt;span class=&quot;keyword&quot;&gt;y&lt;/span&gt; yum-utils \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  device-mapper-persistent-data \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  lvm2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum-config-manager \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    --&lt;span class=&quot;built_in&quot;&gt;add&lt;/span&gt;-repo \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    http&lt;span class=&quot;variable&quot;&gt;s:&lt;/span&gt;//download.docker.&lt;span class=&quot;keyword&quot;&gt;com&lt;/span&gt;/linux/centos/docker-&lt;span class=&quot;keyword&quot;&gt;ce&lt;/span&gt;.repo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ yum &lt;span class=&quot;keyword&quot;&gt;list&lt;/span&gt; docker-&lt;span class=&quot;keyword&quot;&gt;ce&lt;/span&gt; --showduplicates | &lt;span class=&quot;built_in&quot;&gt;sort&lt;/span&gt; -&lt;span class=&quot;keyword&quot;&gt;r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum install docker-&lt;span class=&quot;keyword&quot;&gt;ce&lt;/span&gt; -&lt;span class=&quot;keyword&quot;&gt;y&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ systemctl   start docker&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安装docker-compose&lt;br&gt;&lt;figure class=&quot;hljs highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@Pro harbor-&lt;span class=&quot;number&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.3&lt;/span&gt;]&lt;span class=&quot;preprocessor&quot;&gt;# yum install python2-pip -y &amp;amp;&amp;amp; yum install docker-compose -y&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;u4FEE_u6539docker_u52A0_u901F&quot;&gt;&lt;a href=&quot;#u4FEE_u6539docker_u52A0_u901F&quot; class=&quot;headerlink&quot; title=&quot;修改docker加速&quot;&gt;&lt;/a&gt;修改docker加速&lt;/h4&gt;&lt;figure class=&quot;hljs highlight xquery&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;vim /etc/docker/daemon.json &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;registry-mirrors&quot;&lt;/span&gt;: [ &lt;span class=&quot;string&quot;&gt;&quot;https://registry.docker-cn.com&quot;&lt;/span&gt;,], &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;max-concurrent-downloads&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;log-driver&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;json-file&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;log-level&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;warn&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;log-opts&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;max-size&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;10m&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;max-file&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="docker" scheme="http://www.idcsec.com/categories/docker/"/>
    
    
      <category term="docker" scheme="http://www.idcsec.com/tags/docker/"/>
    
      <category term="harbor" scheme="http://www.idcsec.com/tags/harbor/"/>
    
      <category term="k8s" scheme="http://www.idcsec.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes基于StorageClass的NFS动态卷</title>
    <link href="http://www.idcsec.com/2018/08/16/kubernetes%E5%9F%BA%E4%BA%8EStorageClass%E7%9A%84NFS%E5%8A%A8%E6%80%81%E5%8D%B7/"/>
    <id>http://www.idcsec.com/2018/08/16/kubernetes基于StorageClass的NFS动态卷/</id>
    <published>2018-08-16T14:19:00.000Z</published>
    <updated>2018-09-16T03:00:55.899Z</updated>
    
    <content type="html"><![CDATA[<p>NFS搭建略..</p><h1 id="u521B_u5EFAnfs_u6587_u4EF6"><a href="#u521B_u5EFAnfs_u6587_u4EF6" class="headerlink" title="创建nfs文件"></a>创建nfs文件</h1><p>安装部署<br><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="keyword">opt</span>/k8s-nfs-storage</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"/opt/k8s-nfs-storage *(rw,no_root_squash,no_all_squash,sync)"</span> &gt; /etc/exports</span><br><span class="line">exportfs  -vr</span><br></pre></td></tr></table></figure></p><p>所需要的yaml文件github：<br>修改deployment文件并部署deployment.yaml<br>需要修改的地方只有NFS服务器所在的IP地址（192.168.7.206），以及NFS服务器共享的路径（/opt/k8s-nfs-storage），两处都需要修改为你实际的NFS服务器和共享目录<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: nfs-client-provisioner</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">strategy</span>:</span><br><span class="line">    <span class="attribute">type</span>: Recreate</span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">app</span>: nfs-client-provisioner</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">serviceAccountName</span>: nfs-client-provisioner</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">        - <span class="attribute">name</span>: nfs-client-provisioner</span><br><span class="line">          <span class="attribute">image</span>: <span class="number">192.168</span>.<span class="number">19.111</span>/gc/<span class="attribute">nfs-client-provisioner</span>:latest</span><br><span class="line">          <span class="attribute">volumeMounts</span>:</span><br><span class="line">            - <span class="attribute">name</span>: nfs-client-root</span><br><span class="line">              <span class="attribute">mountPath</span>: /persistentvolumes</span><br><span class="line">          <span class="attribute">env</span>:</span><br><span class="line">            - <span class="attribute">name</span>: PROVISIONER_NAME</span><br><span class="line">              <span class="attribute">value</span>: idcsec.lan/nfs</span><br><span class="line">            - <span class="attribute">name</span>: NFS_SERVER</span><br><span class="line">              <span class="attribute">value</span>: <span class="number">192.168</span>.<span class="number">7.206</span></span><br><span class="line">            - <span class="attribute">name</span>: NFS_PATH</span><br><span class="line">              <span class="attribute">value</span>: /opt/k8s-nfs-storage</span><br><span class="line">      <span class="attribute">volumes</span>:</span><br><span class="line">        - <span class="attribute">name</span>: nfs-client-root</span><br><span class="line">          <span class="attribute">nfs</span>:</span><br><span class="line">            <span class="attribute">server</span>: <span class="number">192.168</span>.<span class="number">7.206</span></span><br><span class="line">            <span class="attribute">path</span>: /opt/k8s-nfs-storage</span><br></pre></td></tr></table></figure></p><p>修改StorageClass文件并部署class.yaml<br>此处可以不修改，或者修改provisioner的名字，需要与上面的deployment的PROVISIONER_NAME名字一致。<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: storage.k8s.io/v1</span><br><span class="line"><span class="attribute">kind</span>: StorageClass</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: k8s-nfs-storage</span><br><span class="line"><span class="attribute">provisioner</span>: idcsec.lan/nf</span><br></pre></td></tr></table></figure></p><p>授权<br>RBAC授权文件在auth目录下面<br>如果您的集群启用了RBAC，必须授权provisioner。<br>设置 k8s-nfs-storage作为默认存储类<br><figure class="hljs highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass  k8s-nfs-storage -p <span class="string">'&#123;"</span>metadata<span class="string">": &#123;"</span>annotations<span class="string">":&#123;"</span><span class="transposed_variable">storageclass.</span><span class="transposed_variable">kubernetes.</span>io/is-default-class<span class="string">":"</span>true<span class="string">"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/nfs1.png" alt="crt"><br>实例：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: apps/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: StatefulSet</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: k8sapp</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">serviceName</span>: <span class="string">"k8sapp"</span></span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">volumeClaimTemplates</span>:</span><br><span class="line">  - <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">name</span>: test </span><br><span class="line">      <span class="attribute">annotations</span>:</span><br><span class="line">        volume.beta.kubernetes.io/<span class="attribute">storage-class</span>: <span class="string">"k8s-nfs-storage"</span></span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">accessModes</span>: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      <span class="attribute">resources</span>:</span><br><span class="line">        <span class="attribute">requests</span>:</span><br><span class="line">          <span class="attribute">storage</span>: <span class="number">2</span>Gi</span><br></pre></td></tr></table></figure></p><p><img src="/img/nfs2.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;NFS搭建略..&lt;/p&gt;
&lt;h1 id=&quot;u521B_u5EFAnfs_u6587_u4EF6&quot;&gt;&lt;a href=&quot;#u521B_u5EFAnfs_u6587_u4EF6&quot; class=&quot;headerlink&quot; title=&quot;创建nfs文件&quot;&gt;&lt;/a&gt;创建nfs文件&lt;/h1
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes1.11安装Helm管理部署Kubernetes应用</title>
    <link href="http://www.idcsec.com/2018/08/14/kubernetes1-11%E5%AE%89%E8%A3%85Helm%E7%AE%A1%E7%90%86%E9%83%A8%E7%BD%B2Kubernetes%E5%BA%94%E7%94%A8/"/>
    <id>http://www.idcsec.com/2018/08/14/kubernetes1-11安装Helm管理部署Kubernetes应用/</id>
    <published>2018-08-14T14:41:00.000Z</published>
    <updated>2018-08-14T14:59:06.937Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Helm__u57FA_u672C_u6982_u5FF5"><a href="#Helm__u57FA_u672C_u6982_u5FF5" class="headerlink" title="Helm 基本概念"></a>Helm 基本概念</h1><p>Helm 可以理解为 Kubernetes 的包管理工具，可以方便地发现、共享和使用为Kubernetes构建的应用，它包含几个基本概念</p><p>Chart：一个 Helm 包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含 Kubernetes 集群中的服务定义，类似 Homebrew 中的 formula，APT 的 dpkg 或者 Yum 的 rpm 文件，<br>Release: 在 Kubernetes 集群上运行的 Chart 的一个实例。在同一个集群上，一个 Chart 可以安装很多次。每次安装都会创建一个新的 release。例如一个 MySQL Chart，如果想在服务器上运行两个数据库，就可以把这个 Chart 安装两次。每次安装都会生成自己的 Release，会有自己的 Release 名称。<br>Repository：用于发布和存储 Chart 的仓库。</p><h1 id="Helm__u7EC4_u4EF6"><a href="#Helm__u7EC4_u4EF6" class="headerlink" title="Helm 组件"></a>Helm 组件</h1><p>Helm 采用客户端/服务器架构，有如下组件组成：</p><p>Helm CLI 是 Helm 客户端，可以在本地执行<br>从最新<code>https://github.com/helm/helm/releases</code>，下载helm-v2.9.1-linux-amd64.tar.gz到本地，解压后把二进制直接放到环境PATH下即可<br>Tiller 是服务器端组件，在 Kubernetes 群集上运行，并管理 Kubernetes 应用程序的生命周期<br>Repository 是 Chart 仓库，Helm客户端通过HTTP协议来访问仓库中Chart的索引文件和压缩包。</p><h1 id="u5B89_u88C5Helm"><a href="#u5B89_u88C5Helm" class="headerlink" title="安装Helm"></a>安装Helm</h1><p>Helm 会利用 “gcr.io/kubernetes-helm/tiller” 镜像在Kubernetes集群上安装配置 Tiller；并且利用 “<a href="https://kubernetes-charts.storage.googleapis.com" target="_blank" rel="external">https://kubernetes-charts.storage.googleapis.com</a>“ 作为缺省的 stable repository 的地址。由于在国内可能无法访问 “gcr.io”, “storage.googleapis.com” 等域名.可以使用阿里云提供的table repository 的地址</p><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz</span></span><br><span class="line">tar -zxvf helm-v2<span class="number">.9</span><span class="number">.1</span>-linux-amd64.tar.gz &amp;&amp;\</span><br><span class="line">cp linux-amd64<span class="regexp">/helm /</span>opt<span class="regexp">/kube/</span>bin<span class="regexp">/ &amp;&amp; chmod +x /</span>opt<span class="regexp">/kube/</span>bin/helm</span><br></pre></td></tr></table></figure><p>执行下面命令安装<br>未使用SSL/TLS认证机制<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$helm init --upgrade -i <span class="number">192.168</span><span class="number">.19</span><span class="number">.111</span>/gc/tiller:v2<span class="number">.5</span><span class="number">.1</span> --stable-repo-url https:<span class="comment">//kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br><span class="line">kubectl get pod --all-namespaces|grep tiller</span><br></pre></td></tr></table></figure></p><p>若要查看在存储库中可用的所有 Helm charts<br><figure class="hljs highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="keyword">search</span>  <span class="comment">//看在存储库中可用的所有 Helm charts</span></span><br><span class="line">helm repo <span class="keyword">update</span>  <span class="comment">//更新charts列表以获取最新版本</span></span><br><span class="line">helm <span class="keyword">list</span> <span class="comment">//查看在群集上安装的Charts列表</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/helm1.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Helm__u57FA_u672C_u6982_u5FF5&quot;&gt;&lt;a href=&quot;#Helm__u57FA_u672C_u6982_u5FF5&quot; class=&quot;headerlink&quot; title=&quot;Helm 基本概念&quot;&gt;&lt;/a&gt;Helm 基本概念&lt;/h1&gt;&lt;p&gt;He
      
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Caliconode-localhostlocaldomainisalreadyusingtheIPv4address问题</title>
    <link href="http://www.idcsec.com/2018/08/14/Caliconode-localhostlocaldomainisalreadyusingtheIPv4address%E9%97%AE%E9%A2%98/"/>
    <id>http://www.idcsec.com/2018/08/14/Caliconode-localhostlocaldomainisalreadyusingtheIPv4address问题/</id>
    <published>2018-08-13T17:08:00.000Z</published>
    <updated>2018-08-13T17:09:07.348Z</updated>
    
    <content type="html"><![CDATA[<p>   Calico报错 Calico node ‘localhost.localdomain’ is already using the IPv4 addressx.x.x.x解决<br>服务器之前改名了hostname没有重启部署完etcd、Calico node。后来重启导致k8sCalico node起不来。<br>报错大楷是由于etcd内存储了之前hostname(localhost.localdomain)的的记录导致现在ip和之前冲突，不能自动删除重建<br>查看日志信息<br><figure class="hljs highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  logs   calico-<span class="keyword">node</span><span class="identifier"></span><span class="title">-8w7tv</span> -c  calico-<span class="keyword">node</span><span class="identifier">  </span><span class="title">-n</span> kube-system -f</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc2.png" alt="crt"></p><p>v3没有ls使用get替代</p><p>查看etcd信息<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$export</span> <span class="constant">ETCDCTL_API</span>=<span class="number">3</span></span><br><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.92:2379,https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  get  /</span> --prefix --keys-only | grep localhost</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc1.png" alt="crt"><br>删除之前存储的信息<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.92:2379,https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  get /</span> --prefix --keys-only | grep localhost | xargs -<span class="constant">I</span> &#123;&#125; etcdctl del &#123;&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc3.png" alt="crt"></p><p>重启caliconode pod恢复正常<br><img src="/img/etc4.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;   Calico报错 Calico node ‘localhost.localdomain’ is already using the IPv4 addressx.x.x.x解决&lt;br&gt;服务器之前改名了hostname没有重启部署完etcd、Calico node。后来重
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes1.11 nginx-ingress安装部署</title>
    <link href="http://www.idcsec.com/2018/08/09/Kubernetes1-11-nginx-ingress%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://www.idcsec.com/2018/08/09/Kubernetes1-11-nginx-ingress安装部署/</id>
    <published>2018-08-09T06:34:00.000Z</published>
    <updated>2018-10-27T13:55:30.878Z</updated>
    
    <content type="html"><![CDATA[<h1 id="u90E8_u7F72Ingress"><a href="#u90E8_u7F72Ingress" class="headerlink" title="部署Ingress"></a>部署Ingress</h1><p>ingress的部署文件在kubernetes Ingress 修改nodeselector 指定nodes上。<br><code>Pod.spec.nodeSelector</code>是通过kubernetes的label-selector机制进行节点选择，由scheduler调度策略<code>MatchNodeSelector</code>进行label匹配，调度pod到目标节点，该匹配规则是强制约束。启用节点选择器的步骤为:</p><h2 id="Node_u6DFB_u52A0label_u6807_u8BB0"><a href="#Node_u6DFB_u52A0label_u6807_u8BB0" class="headerlink" title="Node添加label标记"></a>Node添加label标记</h2><p>查询lable<br><figure class="hljs highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes --show-labels</span><br><span class="line">标记规则：kubectl <span class="keyword">label</span> nodes <span class="variable">&lt;node-name&gt;</span> <span class="variable">&lt;label-key&gt;</span>=<span class="variable">&lt;label-value&gt;</span></span><br><span class="line">kubectl <span class="keyword">label</span> node <span class="number">192.168</span>.<span class="number">7.93</span> role=nginx-ingress</span><br></pre></td></tr></table></figure></p><p><img src="/img/ingress1.png" alt="crt"><br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">镜像v0<span class="number">.17</span><span class="number">.1</span>:docker pull wtingdocker/nginx-ingress-controller</span><br><span class="line">https:<span class="comment">//github.com/kubernetes/ingress-nginx/releases</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="u90E8_u7F72_u90E8_u7F72default_backend__u90E8_u7F72nginx-ingress-controller-yaml"><a href="#u90E8_u7F72_u90E8_u7F72default_backend__u90E8_u7F72nginx-ingress-controller-yaml" class="headerlink" title="部署部署default backend 部署nginx-ingress-controller.yaml"></a>部署部署default backend 部署nginx-ingress-controller.yaml</h2><p>修改<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> kubectl label nodes  <span class="number">192.168</span><span class="number">.7</span><span class="number">.93</span>  kubernetes.io/app=nginx-ingress</span><br><span class="line">nodeSelector:</span><br><span class="line">        kubernetes.io/app: nginx-ingress</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: default-http-backend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      -<span class="ruby"> <span class="symbol">name:</span> default-http-backend</span><br><span class="line"></span>        # Any image is permissible as long as:</span><br><span class="line">        # 1. It serves a 404 page at /</span><br><span class="line">        # 2. It serves 200 on a /healthz endpoint</span><br><span class="line">        image: 192.168.19.111/gc/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        -<span class="ruby"> <span class="symbol">containerPort:</span> <span class="number">8080</span></span><br><span class="line"></span>        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">port:</span> <span class="number">80</span></span><br><span class="line"></span>    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">rules:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>      -<span class="ruby"> endpoints</span><br><span class="line"></span>      -<span class="ruby"> nodes</span><br><span class="line"></span>      -<span class="ruby"> pods</span><br><span class="line"></span>      -<span class="ruby"> secrets</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> nodes</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> services</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">"extensions"</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> ingresses</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">        -<span class="ruby"> events</span><br><span class="line"></span>    verbs:</span><br><span class="line">        -<span class="ruby"> create</span><br><span class="line"></span>        -<span class="ruby"> patch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">"extensions"</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> ingresses/status</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> update</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>      -<span class="ruby"> pods</span><br><span class="line"></span>      -<span class="ruby"> secrets</span><br><span class="line"></span>      -<span class="ruby"> namespaces</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>    resourceNames:</span><br><span class="line">      # Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span><br><span class="line">      # Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span><br><span class="line">      # This has to be adapted if you change either parameter</span><br><span class="line">      # when launching the nginx-ingress-controller.</span><br><span class="line">      -<span class="ruby"> <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> update</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> create</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> endpoints</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">kind:</span> <span class="constant">ServiceAccount</span></span><br><span class="line"></span>    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">kind:</span> <span class="constant">ServiceAccount</span></span><br><span class="line"></span>    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx </span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: '10254'</span><br><span class="line">        prometheus.io/scrape: 'true'</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/app: nginx-ingress</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      containers:</span><br><span class="line">        -<span class="ruby"> <span class="symbol">name:</span> nginx-ingress-controller</span><br><span class="line"></span>          image: 192.168.19.111/gc/nginx-ingress-controller:0.17.1</span><br><span class="line">          args:</span><br><span class="line">            -<span class="ruby"> /nginx-ingress-controller</span><br><span class="line"></span>            -<span class="ruby"> --default-backend-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/default-http-backend</span><br><span class="line"></span>            -<span class="ruby"> --configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/nginx-configuration</span><br><span class="line"></span>            -<span class="ruby"> --tcp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/tcp-services</span><br><span class="line"></span>            -<span class="ruby"> --udp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/udp-services</span><br><span class="line"></span>            -<span class="ruby"> --publish-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/ingress-nginx</span><br><span class="line"></span>            -<span class="ruby"> --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line"></span>        nodeSelector:</span><br><span class="line">         role= "nginx-ingress" </span><br><span class="line">         securityContext:</span><br><span class="line">            capabilities:</span><br><span class="line">                drop:</span><br><span class="line">                -<span class="ruby"> <span class="constant">ALL</span></span><br><span class="line"></span>                add:</span><br><span class="line">                -<span class="ruby"> <span class="constant">NET_BIND_SERVICE</span></span><br><span class="line"></span>            # www-data -&gt; 33</span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            -<span class="ruby"> <span class="symbol">name:</span> <span class="constant">POD_NAME</span></span><br><span class="line"></span>              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            -<span class="ruby"> <span class="symbol">name:</span> <span class="constant">POD_NAMESPACE</span></span><br><span class="line"></span>              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">          -<span class="ruby"> <span class="symbol">name:</span> http</span><br><span class="line"></span>            containerPort: 80</span><br><span class="line">          -<span class="ruby"> <span class="symbol">name:</span> https</span><br><span class="line"></span>            containerPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br></pre></td></tr></table></figure><h3 id="u90E8_u7F72_ingress-nginx-svc-yaml"><a href="#u90E8_u7F72_ingress-nginx-svc-yaml" class="headerlink" title="部署 ingress-nginx.svc.yaml"></a>部署 ingress-nginx.svc.yaml</h3><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: ingress-nginx</span><br><span class="line">  <span class="attribute">namespace</span>: ingress-nginx</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">externalIPs</span>:</span><br><span class="line">  - <span class="number">192.168</span>.<span class="number">7.93</span></span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">  - <span class="attribute">name</span>: http</span><br><span class="line">    <span class="attribute">port</span>: <span class="number">80</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">80</span></span><br><span class="line">    <span class="attribute">protocol</span>: TCP</span><br><span class="line">  - <span class="attribute">name</span>: https</span><br><span class="line">    <span class="attribute">port</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">protocol</span>: TCP</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">app</span>: ingress-nginx</span><br></pre></td></tr></table></figure><p>可以看到ExternalIP的Service也是通过kube-proxy对外暴露的。192.168.7.93是nodeip。 可以通过反向代理HAproxy将边缘路由器或全局统一接入层的负载均衡器将到达公网ip的外网流量转发到内网ip上，外部通过域名访问集群中将会以ingress暴露的所有服务<br><img src="/img/ingress3.png" alt="crt"><br><img src="/img/ingress4.png" alt="crt"><br><img src="/img/ingress5.png" alt="crt"><br>也可以采用 hostNetwork: true 暴露ingress服务端口表示容器使用和宿主机一样的网络<br><code>...spec:      nodeSelector:        kubernetes.io/app: nginx-ingress      hostNetwork: true       serviceAccountName: nginx-ingress-serviceaccount      containers...</code><br><img src="/img/ingress6.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;u90E8_u7F72Ingress&quot;&gt;&lt;a href=&quot;#u90E8_u7F72Ingress&quot; class=&quot;headerlink&quot; title=&quot;部署Ingress&quot;&gt;&lt;/a&gt;部署Ingress&lt;/h1&gt;&lt;p&gt;ingress的部署文件在kubernetes Ingress 修改nodeselector 指定nodes上。&lt;br&gt;&lt;code&gt;Pod.spec.nodeSelector&lt;/code&gt;是通过kubernetes的label-selector机制进行节点选择，由scheduler调度策略&lt;code&gt;MatchNodeSelector&lt;/code&gt;进行label匹配，调度pod到目标节点，该匹配规则是强制约束。启用节点选择器的步骤为:&lt;/p&gt;
&lt;h2 id=&quot;Node_u6DFB_u52A0label_u6807_u8BB0&quot;&gt;&lt;a href=&quot;#Node_u6DFB_u52A0label_u6807_u8BB0&quot; class=&quot;headerlink&quot; title=&quot;Node添加label标记&quot;&gt;&lt;/a&gt;Node添加label标记&lt;/h2&gt;&lt;p&gt;查询lable&lt;br&gt;&lt;figure class=&quot;hljs highlight pf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get nodes --show-labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;标记规则：kubectl &lt;span class=&quot;keyword&quot;&gt;label&lt;/span&gt; nodes &lt;span class=&quot;variable&quot;&gt;&amp;lt;node-name&amp;gt;&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;&amp;lt;label-key&amp;gt;&lt;/span&gt;=&lt;span class=&quot;variable&quot;&gt;&amp;lt;label-value&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;keyword&quot;&gt;label&lt;/span&gt; node &lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;7.93&lt;/span&gt; role=nginx-ingress&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/ingress1.png&quot; alt=&quot;crt&quot;&gt;&lt;br&gt;&lt;figure class=&quot;hljs highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;镜像v0&lt;span class=&quot;number&quot;&gt;.17&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;:docker pull wtingdocker/nginx-ingress-controller&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;https:&lt;span class=&quot;comment&quot;&gt;//github.com/kubernetes/ingress-nginx/releases&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="ingress" scheme="http://www.idcsec.com/tags/ingress/"/>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Heapster安装部署</title>
    <link href="http://www.idcsec.com/2018/08/09/Kubernetes-Heapster%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://www.idcsec.com/2018/08/09/Kubernetes-Heapster安装部署/</id>
    <published>2018-08-09T01:31:00.000Z</published>
    <updated>2018-10-29T14:12:32.239Z</updated>
    
    <content type="html"><![CDATA[<p>默认安装的kubernetes没有统计 CPU 和内存Dashboard图表也没有显示，装上 Heapster 后就可以直观地看到各个组件的资源消耗情况，以及kubectl top 查看 nodes pod资源。Heapster已弃用。请考虑使用 metrics-server 和第三方指标管道来收集Prometheus格式的指标。<br>可以不安装influxdb    </p><h1 id="u6267_u884Cheapster-yaml_u6587_u4EF6"><a href="#u6267_u884Cheapster-yaml_u6587_u4EF6" class="headerlink" title="执行heapster.yaml文件"></a>执行heapster.yaml文件</h1><figure class="hljs highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">修改:</span> <span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">source=</span> <span class="comment">、</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sink、images</span></span><br></pre></td></tr></table></figure><a id="more"></a><figure class="hljs highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">---</span><br><span class="line"></span>apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="header">  namespace: kube-system</span><br><span class="line">---</span></span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line">subjects:</span><br><span class="line"><span class="code">  - kind: ServiceAccount</span></span><br><span class="line"><span class="code">    name: heapster</span></span><br><span class="line"><span class="code">    namespace: kube-system</span></span><br><span class="line">roleRef:</span><br><span class="line"><span class="code">  kind: ClusterRole</span></span><br><span class="line"><span class="code">  name: system:heapster</span></span><br><span class="line"><span class="header">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  replicas: 1</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    matchLabels:</span></span><br><span class="line"><span class="code">      k8s-app: heapster</span></span><br><span class="line"><span class="code">  template:</span></span><br><span class="line"><span class="code">    metadata:</span></span><br><span class="line"><span class="code">      labels:</span></span><br><span class="line"><span class="code">        task: monitoring</span></span><br><span class="line"><span class="code">        k8s-app: heapster</span></span><br><span class="line"><span class="code">    spec:</span></span><br><span class="line"><span class="code">      serviceAccountName: heapster</span></span><br><span class="line"><span class="code">      containers:</span></span><br><span class="line"><span class="code">      - name: heapster</span></span><br><span class="line"><span class="code">        #image: gcr.io/google_containers/heapster-amd64:v1.5.1</span></span><br><span class="line"><span class="code">        image: 192.168.19.111/gc/heapster-amd64:v1.5.1 </span></span><br><span class="line"><span class="code">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="code">        command:</span></span><br><span class="line"><span class="code">        - /heapster</span></span><br><span class="line"><span class="code">        - --source=kubernetes:https://kubernetes.default</span></span><br><span class="line"><span class="header">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086 </span><br><span class="line">---</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  labels:</span></span><br><span class="line"><span class="code">    task: monitoring</span></span><br><span class="line"><span class="code">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line"><span class="code">    # If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line"><span class="code">    #kubernetes.io/cluster-service: 'true'</span></span><br><span class="line"><span class="code">    kubernetes.io/name: Heapster</span></span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  ports:</span></span><br><span class="line"><span class="code">  - port: 80</span></span><br><span class="line"><span class="code">    targetPort: 8082</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    k8s-app: heapster</span></span><br></pre></td></tr></table></figure><p>或者执行<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f <span class="symbol">https:</span>/<span class="regexp">/github.com/kubernetes</span><span class="regexp">/heapster/blob</span><span class="regexp">/master/deploy</span><span class="regexp">/kube-config/standalone</span><span class="regexp">/heapster-controller.yaml</span></span><br></pre></td></tr></table></figure></p><h1 id="u90E8_u7F72influxdb-yaml"><a href="#u90E8_u7F72influxdb-yaml" class="headerlink" title="部署influxdb.yaml"></a>部署influxdb.yaml</h1><figure class="hljs highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">---</span><br><span class="line"></span>apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  replicas: 1</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    matchLabels:</span></span><br><span class="line"><span class="code">      k8s-app: influxdb</span></span><br><span class="line"><span class="code">  template:</span></span><br><span class="line"><span class="code">    metadata:</span></span><br><span class="line"><span class="code">      labels:</span></span><br><span class="line"><span class="code">        task: monitoring</span></span><br><span class="line"><span class="code">        k8s-app: influxdb</span></span><br><span class="line"><span class="code">    spec:</span></span><br><span class="line"><span class="code">      containers:</span></span><br><span class="line"><span class="code">      - name: influxdb</span></span><br><span class="line"><span class="code">        #image: gcr.io/google_containers/heapster-influxdb-amd64:v1.3.3</span></span><br><span class="line"><span class="code">        image: mirrorgooglecontainers/heapster-influxdb-amd64:v1.3.3</span></span><br><span class="line"><span class="code">        volumeMounts:</span></span><br><span class="line"><span class="code">        - mountPath: /data</span></span><br><span class="line"><span class="code">          name: influxdb-storage</span></span><br><span class="line"><span class="code">      volumes:</span></span><br><span class="line"><span class="code">      - name: influxdb-storage</span></span><br><span class="line"><span class="header">        emptyDir: &#123;&#125;</span><br><span class="line">---</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  labels:</span></span><br><span class="line"><span class="code">    task: monitoring</span></span><br><span class="line"><span class="code">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line"><span class="code">    # If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line"><span class="code">    # kubernetes.io/cluster-service: 'true'</span></span><br><span class="line"><span class="code">    kubernetes.io/name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  ports:</span></span><br><span class="line"><span class="code">  - port: 8086</span></span><br><span class="line"><span class="code">    targetPort: 8086</span></span><br><span class="line"><span class="code">    name: http</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="header">    k8s-app: influxdb</span><br><span class="line">---</span></span><br></pre></td></tr></table></figure><p><img src="/img/heap1.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;默认安装的kubernetes没有统计 CPU 和内存Dashboard图表也没有显示，装上 Heapster 后就可以直观地看到各个组件的资源消耗情况，以及kubectl top 查看 nodes pod资源。Heapster已弃用。请考虑使用 metrics-server 和第三方指标管道来收集Prometheus格式的指标。&lt;br&gt;可以不安装influxdb    &lt;/p&gt;
&lt;h1 id=&quot;u6267_u884Cheapster-yaml_u6587_u4EF6&quot;&gt;&lt;a href=&quot;#u6267_u884Cheapster-yaml_u6587_u4EF6&quot; class=&quot;headerlink&quot; title=&quot;执行heapster.yaml文件&quot;&gt;&lt;/a&gt;执行heapster.yaml文件&lt;/h1&gt;&lt;figure class=&quot;hljs highlight brainfuck&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;修改:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;source=&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;、&lt;/span&gt;&lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;literal&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;sink、images&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/categories/kubernetes/"/>
    
    
      <category term="Heapster" scheme="http://www.idcsec.com/tags/Heapster/"/>
    
      <category term="kubernetes" scheme="http://www.idcsec.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Activemq集群搭建ZooKeeper+LevelDB</title>
    <link href="http://www.idcsec.com/2018/07/16/Activemq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BAZooKeeper-LevelDB/"/>
    <id>http://www.idcsec.com/2018/07/16/Activemq集群搭建ZooKeeper-LevelDB/</id>
    <published>2018-07-16T14:19:00.000Z</published>
    <updated>2018-07-29T12:26:07.296Z</updated>
    
    <content type="html"><![CDATA[<p>ZooKeeper搭建<br>略<br>MQ高可用集群部署<br>参考<a href="http://activemq.apache.org/replicated-leveldb-store.html" target="_blank" rel="external">http://activemq.apache.org/replicated-leveldb-store.html</a></p><table><thead><tr><th>ip</th><th>集群通信端口</th><th>openwire端口</th><th>管理端口</th></tr></thead><tbody><tr><td>192.168.1.100</td><td>61619</td><td>61616</td><td>8161</td></tr><tr><td>192.168.1.200</td><td>61619</td><td>61616</td></tr><tr><td>192.168.1.300</td><td>61619</td><td>61616</td></tr></tbody></table><h1 id="u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml"><a href="#u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml" class="headerlink" title="一、修改 vim conf/activemq.xml"></a>一、修改 vim conf/activemq.xml</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">所以节点brokerName必须一致</span><br><span class="line"> &lt;broker xmlns=<span class="string">"http://activemq.apache.org/schema/core"</span> brokerName=<span class="string">"mybroker"</span> dataDirectory=<span class="string">"$&#123;activemq.data&#125;"</span>&gt;</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="u4E8C_u3001_u6301_u4E45_u5316_u914D_u7F6E"><a href="#u4E8C_u3001_u6301_u4E45_u5316_u914D_u7F6E" class="headerlink" title="二、持久化配置"></a>二、持久化配置</h2><h2 id="node1-100"><a href="#node1-100" class="headerlink" title="node1.100"></a>node1.100</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">        &lt;replicatedLevelDB</span><br><span class="line">            directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">            replicas=<span class="string">"3"</span></span><br><span class="line">            bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">            zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">            zkPassword=<span class="string">""</span></span><br><span class="line">            hostname=<span class="string">"192.168.1.100"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">            zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">    &lt;/persistenceAdapter&gt;</span><br></pre></td></tr></table></figure><h2 id="node21-200"><a href="#node21-200" class="headerlink" title="node21.200"></a>node21.200</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">            &lt;replicatedLevelDB</span><br><span class="line">                directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">                replicas=<span class="string">"3"</span></span><br><span class="line">                bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">                zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">                zkPassword=<span class="string">""</span></span><br><span class="line">                hostname=<span class="string">"192.168.1.200"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">                zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">        &lt;/persistenceAdapter&gt;</span><br><span class="line">`</span><br></pre></td></tr></table></figure><h2 id="node31-300"><a href="#node31-300" class="headerlink" title="node31.300"></a>node31.300</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">            &lt;replicatedLevelDB</span><br><span class="line">                directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">                replicas=<span class="string">"3"</span></span><br><span class="line">                bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">                zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">                zkPassword=<span class="string">""</span></span><br><span class="line">                hostname=<span class="string">"192.168.1.300"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">                zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">        &lt;/persistenceAdapter&gt;</span><br></pre></td></tr></table></figure><h2 id="u542F_u52A8_u6240_u6709_u8282_u70B9activemq"><a href="#u542F_u52A8_u6240_u6709_u8282_u70B9activemq" class="headerlink" title="启动所有节点activemq"></a>启动所有节点activemq</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/apache-activemq-<span class="number">5.14</span><span class="number">.0</span>/bin/activemq start</span><br></pre></td></tr></table></figure><p>客户端失败转移连接<br>ActiveMQ的客户端只能访问Master的Broker,其他处于Slave的Broker不能访问，所以客户端连接的Broker应该使用failover协议(失败转移)<br><figure class="hljs highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mq.broker.url=failover:(tcp://<span class="number">192.168.1.100</span>:61616,tcp://<span class="number">192.168.1.200</span>:61616,tcp://<span class="number">192.168.1.30</span><span class="number">0:61616</span>)?randomize=false&amp;initialReconnectDelay=1000</span><br></pre></td></tr></table></figure></p><h1 id="u8BB0_u5F55_u90E8_u5206activemq-xml_u914D_u7F6E"><a href="#u8BB0_u5F55_u90E8_u5206activemq-xml_u914D_u7F6E" class="headerlink" title="记录部分activemq.xml配置"></a>记录部分activemq.xml配置</h1><figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">plugins</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">simpleAuthenticationPlugin</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">users</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">authenticationUser</span> <span class="attribute">username</span>=<span class="value">"$&#123;activemq.username&#125;"</span> <span class="attribute">password</span>=<span class="value">"$&#123;activemq.password&#125;"</span> <span class="attribute">groups</span>=<span class="value">"users,admins"</span>/&gt;</span>  //conf/credentials.properties </span><br><span class="line">true<span class="tag">&lt;<span class="title">authenticationUser</span> <span class="attribute">username</span>=<span class="value">"admin"</span> <span class="attribute">password</span>=<span class="value">"admin11111"</span> <span class="attribute">groups</span>=<span class="value">"users"</span>/&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;/<span class="title">users</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;/<span class="title">simpleAuthenticationPlugin</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="title">authorizationPlugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">map</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="title">authorizationMap</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="title">authorizationEntries</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"admins"</span> <span class="attribute">write</span>=<span class="value">"admins"</span> <span class="attribute">admin</span>=<span class="value">"admins"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"users"</span> <span class="attribute">write</span>=<span class="value">"users"</span> <span class="attribute">admin</span>=<span class="value">"users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"GUEST.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"TEST.Q"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"admins"</span> <span class="attribute">write</span>=<span class="value">"admins"</span> <span class="attribute">admin</span>=<span class="value">"admins"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"USERS.&gt;"</span> <span class="attribute">read</span>=<span class="value">"users"</span> <span class="attribute">write</span>=<span class="value">"users"</span> <span class="attribute">admin</span>=<span class="value">"users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"GUEST.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"ActiveMQ.Advisory.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests,users"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="title">authorizationEntries</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="title">authorizationMap</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="title">map</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="title">authorizationPlugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="title">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><p>管理页面密码在jetty-realm.properties文件中修改</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ZooKeeper搭建&lt;br&gt;略&lt;br&gt;MQ高可用集群部署&lt;br&gt;参考&lt;a href=&quot;http://activemq.apache.org/replicated-leveldb-store.html&quot;&gt;http://activemq.apache.org/replicated-leveldb-store.html&lt;/a&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ip&lt;/th&gt;
&lt;th&gt;集群通信端口&lt;/th&gt;
&lt;th&gt;openwire端口&lt;/th&gt;
&lt;th&gt;管理端口&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;192.168.1.100&lt;/td&gt;
&lt;td&gt;61619&lt;/td&gt;
&lt;td&gt;61616&lt;/td&gt;
&lt;td&gt;8161&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.1.200&lt;/td&gt;
&lt;td&gt;61619&lt;/td&gt;
&lt;td&gt;61616&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.1.300&lt;/td&gt;
&lt;td&gt;61619&lt;/td&gt;
&lt;td&gt;61616&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&quot;u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml&quot;&gt;&lt;a href=&quot;#u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml&quot; class=&quot;headerlink&quot; title=&quot;一、修改 vim conf/activemq.xml&quot;&gt;&lt;/a&gt;一、修改 vim conf/activemq.xml&lt;/h1&gt;&lt;figure class=&quot;hljs highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;所以节点brokerName必须一致&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;lt;broker xmlns=&lt;span class=&quot;string&quot;&gt;&quot;http://activemq.apache.org/schema/core&quot;&lt;/span&gt; brokerName=&lt;span class=&quot;string&quot;&gt;&quot;mybroker&quot;&lt;/span&gt; dataDirectory=&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;activemq.data&amp;#125;&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="activemq" scheme="http://www.idcsec.com/categories/activemq/"/>
    
    
      <category term="activemq" scheme="http://www.idcsec.com/tags/activemq/"/>
    
  </entry>
  
  <entry>
    <title>k8s statefulsets部署zookeeper</title>
    <link href="http://www.idcsec.com/2018/07/10/8s-statefulsets%E9%83%A8%E7%BD%B2zookeeper/"/>
    <id>http://www.idcsec.com/2018/07/10/8s-statefulsets部署zookeeper/</id>
    <published>2018-07-10T15:06:00.000Z</published>
    <updated>2018-07-29T12:26:35.864Z</updated>
    
    <content type="html"><![CDATA[<h1 id="u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc"><a href="#u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc" class="headerlink" title="使用NFS配置pv、pvc"></a>使用NFS配置pv、pvc</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;root@centos-master pv]<span class="comment"># cat /etc/exports | grep /opt/zkdata/zk-data-</span></span><br><span class="line">/opt/zkdata/zk-data-<span class="number">0</span> *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/opt/zkdata/zk-data-<span class="number">1</span> *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/opt/zkdata/zk-data-<span class="number">2</span> *(rw,no_root_squash,no_all_squash,sync)</span><br></pre></td></tr></table></figure><h2 id="u521B_u5EFAk8spv_uFF1Apv-yaml"><a href="#u521B_u5EFAk8spv_uFF1Apv-yaml" class="headerlink" title="创建k8spv：pv.yaml"></a>创建k8spv：pv.yaml</h2><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">0</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi </span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - ReadWriteOnce </span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle </span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>: </span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">0</span> </span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br><span class="line">---</span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">1</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi</span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - RReadWriteOnce</span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle</span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>:</span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">1</span></span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br><span class="line">---</span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">2</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi</span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle</span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>:</span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">2</span></span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br></pre></td></tr></table></figure><p>kubectl  kubectl  create -f pv.yaml<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master pv]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME           CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE</span><br><span class="line">datadir-zk-<span class="number">0</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br><span class="line">datadir-zk-<span class="number">1</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br><span class="line">datadir-zk-<span class="number">2</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br></pre></td></tr></table></figure></p><a id="more"></a><h1 id="u521B_u5EFApvc_uFF1Apvc-yaml"><a href="#u521B_u5EFApvc_uFF1Apvc-yaml" class="headerlink" title="创建pvc：pvc.yaml"></a>创建pvc：pvc.yaml</h1><p>kubectl  create -f zkpvc.yaml<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@centos-master pv]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME           STATUS    VOLUME         CAPACITY   ACCESSMODES   STORAGECLASS   AGE</span><br><span class="line">datadir-zk-<span class="number">0</span>   Bound     datadir-zk-<span class="number">0</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br><span class="line">datadir-zk-<span class="number">1</span>   Bound     datadir-zk-<span class="number">1</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br><span class="line">datadir-zk-<span class="number">2</span>   Bound     datadir-zk-<span class="number">2</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br></pre></td></tr></table></figure></p><h1 id="pull_u955C_u50CF"><a href="#pull_u955C_u50CF" class="headerlink" title="pull镜像"></a>pull镜像</h1><p>临时<br> docker pull wtingdocker/dockerfiletemplatempl<br> docker tag 名称<br> docker push私有仓库<br> 修改zookeeper.yaml镜像地址<br> <figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"> apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: zk-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">2888</span></span><br><span class="line">    name: server</span><br><span class="line">  - port: <span class="number">3888</span></span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cm</span><br><span class="line">data:</span><br><span class="line">  jvm.heap: <span class="string">"2G"</span></span><br><span class="line">  tick: <span class="string">"2000"</span></span><br><span class="line">  init: <span class="string">"10"</span></span><br><span class="line">  sync: <span class="string">"5"</span></span><br><span class="line">  client.cnxns: <span class="string">"60"</span></span><br><span class="line">  snap.retain: <span class="string">"3"</span></span><br><span class="line">  purge.interval: <span class="string">"0"</span></span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  minAvailable: <span class="number">2</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  serviceName: zk-svc</span><br><span class="line">  replicas: <span class="number">3</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values: </span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: k8szk</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="number">192.168</span><span class="number">.19</span><span class="number">.111</span>/zhph/k8szk:v3</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"4Gi"</span></span><br><span class="line">            cpu: <span class="string">"2"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">2181</span></span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: <span class="number">2888</span></span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: <span class="number">3888</span></span><br><span class="line">          name: leader-election</span><br><span class="line">        env:</span><br><span class="line">        - name : ZK_REPLICAS</span><br><span class="line">          value: <span class="string">"3"</span></span><br><span class="line">        - name : ZK_HEAP_SIZE</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: jvm.heap</span><br><span class="line">        - name : ZK_TICK_TIME</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_INIT_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: init</span><br><span class="line">        - name : ZK_SYNC_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_MAX_CLIENT_CNXNS</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: client.cnxns</span><br><span class="line">        - name: ZK_SNAP_RETAIN_COUNT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: snap.retain</span><br><span class="line">        - name: ZK_PURGE_INTERVAL</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: purge.interval</span><br><span class="line">        - name: ZK_CLIENT_PORT</span><br><span class="line">          value: <span class="string">"2181"</span></span><br><span class="line">        - name: ZK_SERVER_PORT</span><br><span class="line">          value: <span class="string">"2888"</span></span><br><span class="line">        - name: ZK_ELECTION_PORT</span><br><span class="line">          value: <span class="string">"3888"</span></span><br><span class="line">        command:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - zkGenConfig.sh &amp;&amp; zkServer.sh start-foreground</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - <span class="string">"zkOk.sh"</span></span><br><span class="line">          initialDelaySeconds: <span class="number">10</span></span><br><span class="line">          timeoutSeconds: <span class="number">5</span></span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - <span class="string">"zkOk.sh"</span></span><br><span class="line">          initialDelaySeconds: <span class="number">10</span></span><br><span class="line">          timeoutSeconds: <span class="number">5</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /<span class="keyword">var</span>/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: <span class="number">1000</span></span><br><span class="line">        fsGroup: <span class="number">1000</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      storageClassName: slow</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: <span class="number">10</span>Gi</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master ~]<span class="comment"># kubectl  get  pod  | grep zk-</span></span><br><span class="line">zk-<span class="number">0</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">zk-<span class="number">1</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">10</span>         <span class="number">29</span>m</span><br><span class="line">zk-<span class="number">2</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">14</span>s</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-0 -- sh  /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh: <span class="number">81</span>: /opt/zookeeper/bin/zkEnv.sh: Syntax error: <span class="string">"("</span> unexpected (expecting <span class="string">"fi"</span>)</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-0    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-1    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-2    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><p>ReadWriteOnce—将卷作为单个节点的读写挂载<br>ReadOnlyMany—将该卷安装为只读的许多节点。<br>ReadWriteMany——将卷作为许多节点的读写挂载</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc&quot;&gt;&lt;a href=&quot;#u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc&quot; class=&quot;headerlink&quot; title=&quot;使用NFS配置pv、pvc&quot;&gt;&lt;/a&gt;使用NFS配置pv、pvc&lt;/h1&gt;&lt;figure class=&quot;hljs highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;root@centos-master pv]&lt;span class=&quot;comment&quot;&gt;# cat /etc/exports | grep /opt/zkdata/zk-data-&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; *(rw,no_root_squash,no_all_squash,sync)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; *(rw,no_root_squash,no_all_squash,sync)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; *(rw,no_root_squash,no_all_squash,sync)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;u521B_u5EFAk8spv_uFF1Apv-yaml&quot;&gt;&lt;a href=&quot;#u521B_u5EFAk8spv_uFF1Apv-yaml&quot; class=&quot;headerlink&quot; title=&quot;创建k8spv：pv.yaml&quot;&gt;&lt;/a&gt;创建k8spv：pv.yaml&lt;/h2&gt;&lt;figure class=&quot;hljs highlight less&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;apiVersion&lt;/span&gt;: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;kind&lt;/span&gt;: PersistentVolume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;metadata&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: datadir-zk-&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;spec&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;capacity&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;storage&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;accessModes&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - ReadWriteOnce &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;persistentVolumeReclaimPolicy&lt;/span&gt;: Recycle &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;storageClassName&lt;/span&gt;: slow&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;nfs&lt;/span&gt;: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;path&lt;/span&gt;: /opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;server&lt;/span&gt;: x.x.x.x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;readOnly&lt;/span&gt;: false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;apiVersion&lt;/span&gt;: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;kind&lt;/span&gt;: PersistentVolume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;metadata&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: datadir-zk-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;spec&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;capacity&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;storage&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;accessModes&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - RReadWriteOnce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;persistentVolumeReclaimPolicy&lt;/span&gt;: Recycle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;storageClassName&lt;/span&gt;: slow&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;nfs&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;path&lt;/span&gt;: /opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;server&lt;/span&gt;: x.x.x.x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;readOnly&lt;/span&gt;: false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;apiVersion&lt;/span&gt;: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;kind&lt;/span&gt;: PersistentVolume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;metadata&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;name&lt;/span&gt;: datadir-zk-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;spec&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;capacity&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;storage&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;accessModes&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - ReadWriteOnce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;persistentVolumeReclaimPolicy&lt;/span&gt;: Recycle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;storageClassName&lt;/span&gt;: slow&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;nfs&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;path&lt;/span&gt;: /opt/zkdata/zk-data-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;server&lt;/span&gt;: x.x.x.x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;readOnly&lt;/span&gt;: false&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;kubectl  kubectl  create -f pv.yaml&lt;br&gt;&lt;figure class=&quot;hljs highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@centos-master pv]&lt;span class=&quot;comment&quot;&gt;# kubectl get pv&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME           CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;datadir-zk-&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;   &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi       RWX           Recycle         Available             slow                     &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;datadir-zk-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;   &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi       RWX           Recycle         Available             slow                     &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;datadir-zk-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;   &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;Gi       RWX           Recycle         Available             slow                     &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="k8s" scheme="http://www.idcsec.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>fastDFS+Nginx分布式图片服务器搭建</title>
    <link href="http://www.idcsec.com/2018/03/23/fastDFS-Nginx%E5%88%86%E5%B8%83%E5%BC%8F%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"/>
    <id>http://www.idcsec.com/2018/03/23/fastDFS-Nginx分布式图片服务器搭建/</id>
    <published>2018-03-23T02:38:00.000Z</published>
    <updated>2018-10-27T13:55:50.252Z</updated>
    
    <content type="html"><![CDATA[<h1 id="u5B89_u88C5_u4F9D_u8D56_u5305"><a href="#u5B89_u88C5_u4F9D_u8D56_u5305" class="headerlink" title="安装依赖包"></a>安装依赖包</h1><p>系统：centos7.4<br><img src="/img/dfs8.png" alt="crt"><br>tracker和storage节点建议部署分别部署<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libevent</span><br><span class="line">yum install gcc-c++  openssl-devel  pcre-devel zlib-devel</span><br></pre></td></tr></table></figure></p><p>下载需要的包<br><a href="https://github.com/happyfish100" target="_blank" rel="external">https://github.com/happyfish100</a><br>nginx官网<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastdfs5<span class="number">.11</span>.zip</span><br><span class="line">fastdfs-nginx-module.zip</span><br><span class="line">libfastcommon.zip</span><br><span class="line">nginx-<span class="number">1.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure></p><h1 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h1><h2 id="libfastcommon"><a href="#libfastcommon" class="headerlink" title="libfastcommon"></a>libfastcommon</h2><p>首先第一步是安装libfastcommon<br>unzip libfastcommon-master.zip<br>解压成功后进入目录看一下压缩包的文件：<br><img src="/img/dfs1.png" alt="dfs"><br>解压完成后就可以进行编译安装了，执行./make.sh  &amp;&amp; ./make.sh  install<br><img src="/img/dfs2.png" alt="crt"><br>至此libfastcommon就已经安装成功了，但注意一下上图中红色框标注的内容，libfastcommon.so 默认安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以此处需要重新设置软链接<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/lib64/libfastcommon.so /usr/local/lib/libfastcommon.so</span><br><span class="line">ln -s /usr/lib64/libfastcommon.so /usr/lib/libfastcommon.so</span><br><span class="line">ln -s /usr/lib64/libfdfsclient.so /usr/local/lib/libfdfsclient.so</span><br><span class="line">ln -s /usr/lib64/libfdfsclient.so /usr/lib/libfdfsclient.so</span><br></pre></td></tr></table></figure></p><h1 id="u5B89_u88C5fastdfs"><a href="#u5B89_u88C5fastdfs" class="headerlink" title="安装fastdfs"></a>安装fastdfs</h1><p>unzip fastdfs5.11.zip<br>解压完成后进入目录 fastdfs-5.11，执行<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./make.sh  &amp;&amp; ./make.sh  install</span><br><span class="line">cd /etc/fdfs/</span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp client.conf.sample  client.conf</span></span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp storage.conf.sample storage.conf</span></span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp tracker.conf.sample tracker.conf</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/dfs3.png" alt="crt"></p><h2 id="Tracker_u670D_u52A1_u914D_u7F6E"><a href="#Tracker_u670D_u52A1_u914D_u7F6E" class="headerlink" title="Tracker服务配置"></a>Tracker服务配置</h2><p>mkdir -p /home/hjlc/app/fastdfs/fastdfs_tracker<br>编辑/etc/fdfs目录下的tracker.conf配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">disabled=<span class="keyword">false</span> <span class="comment">#启用配置文件（默认启用）</span></span><br><span class="line">port=<span class="number">22122</span> <span class="comment">#设置tracker的端口号，通常采用22122这个默认端口</span></span><br><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_tracker <span class="comment">#设置tracker的数据文件和日志目录</span></span><br><span class="line">http.server_port=<span class="number">6666</span> <span class="comment">#设置http端口号，默认为8080这个不需要了</span></span><br></pre></td></tr></table></figure></p><p>为启动脚本创建软引用<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/fdfs_trackerd /usr/local/bin</span></span><br><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/stop.sh /usr/local/bin</span></span><br><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/restart.sh /usr/local/bin</span></span><br><span class="line">启动tracker服务</span><br><span class="line">root@hjlc-storage-nodeA fastdfs]<span class="comment"># service  fdfs_trackerd start</span></span><br><span class="line">Reloading systemd:                                         [  OK  ]</span><br><span class="line">Starting fdfs_trackerd (via systemctl):                    [  OK  ]</span><br></pre></td></tr></table></figure></p><p>fastdfs_tracker中就可以看到启动后新生成的data和logs目录，tracker服务的端口也应当被正常监听，最后再通过netstat命令查看一下端口监听情况：<br><img src="/img/dfs4.png" alt="crt"><br>al<br>确认tracker正常启动后可以将tracker设置为开机启动，打开/etc/rc.d/rc.local并在其中加入以下配置：<br>service fdfs_trackerd start</p><h2 id="Storage_u670D_u52A1_u914D_u7F6E"><a href="#Storage_u670D_u52A1_u914D_u7F6E" class="headerlink" title="Storage服务配置"></a>Storage服务配置</h2><p>先是创建Storage服务器的文件目录，需要注意的是同Tracker相比我多建了一个目录，因为Storage还需要一个文件存储路径，用于存放接收的文件：<br>mkdir /home/hjlc/app/fastdfs/fastdfs_storage<br>mkdir /home/hjlc/app/fastdfs/fastdfs_storage_data</p><p>接下来修改/etc/fdfs目录下的storage.conf配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">disabled=<span class="keyword">false</span> <span class="comment">#启用配置文件（默认启用）</span></span><br><span class="line">group_name=group1 <span class="comment">#组名，根据实际情况修改</span></span><br><span class="line">port=<span class="number">23000</span> <span class="comment">#设置storage的端口号，默认是23000，同一个组的storage端口号必须一致</span></span><br><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_storage <span class="comment">#设置storage数据文件和日志目录</span></span><br><span class="line">store_path_count=<span class="number">1</span> <span class="comment">#存储路径个数，需要和store_path个数匹配</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data <span class="comment">#实际文件存储路径</span></span><br><span class="line">tracker_server=<span class="number">172.16</span><span class="number">.1</span><span class="number">.182</span>:<span class="number">22122</span> <span class="comment">#tracker 服务器的 IP地址和端口号，如果是单机搭建，IP不要写127.0.0.1，否则启动不成功</span></span><br><span class="line">http.server_port=<span class="number">8888</span> <span class="comment">#设置 http 端口号不需要</span></span><br></pre></td></tr></table></figure></p><p>配置完成后同样要为Storage服务器的启动脚本设置软引用：<br>ln -s /usr/bin/fdfs_storaged /usr/local/bin<br>启动Storage服务<br>service fdfs_storaged start<br>如果启动成功，/home/hjlc/app/fastdfs/fastdfs_storage中就可以看到启动后新生成的data和logs目录，端口23000也应被正常监听，还有一点就是文件存储路径下会生成多级存储目录，那么接下来看看是否启动成功了：<br><img src="/img/dfs5.png" alt="crt"><br><img src="/img/dfs6.png" alt="crt"><br>/usr/bin/fdfs_monitor /etc/fdfs/storage.conf<br><img src="/img/dfs7.png" alt="crt"><br>ACTIVE 字样即可说明storage服务器已经成功登记到了tracker服务器<br>开机启动，打开/etc/rc.d/rc.local并将如下配置追加到文件中：<br>echo “service fdfs_storage start” &gt;&gt; /etc/rc.d/rc.local</p><h1 id="u4E0A_u4F20_u6D4B_u8BD5"><a href="#u4E0A_u4F20_u6D4B_u8BD5" class="headerlink" title="上传测试"></a>上传测试</h1><p>编辑/etc/fdfs目录下的client.conf 文件<br>base_path=/home/hjlc/app/fastdfs/fastdfs_tracker #tracker服务器文件路径<br>tracker_server=172.16.1.182:22122 #tracker服务器IP地址和端口号<br>http.tracker_server_port=8080 # tracker 服务器的 http 端口号，必须和tracker的设置对应起来</p><p>然后通过执行客户端上传命令尝试上传：</p><p>[root@hjlc-storage-nodeA ~]# /usr/bin/fdfs_upload_file  /etc/fdfs/client.conf  ~/123.jpg<br>group1/M00/00/00/rBABtlqwYLWATj7XAABOLQixhsQ490.jpg</p><p>此时发现并不能访问，因为FastDFS目前已不支持http协议，我们在FastDFS 4.0.5的版本更新日志中可以看到这样一条信息：<br>使用FastDFS的模块fastdfs-nginx-module，下载地址如下：<a href="https://github.com/happyfish100/fastdfs-nginx-module，这样做最大的好处就是提供了HTTP服务并且解决了group中storage服务器的同步延迟问题" target="_blank" rel="external">https://github.com/happyfish100/fastdfs-nginx-module，这样做最大的好处就是提供了HTTP服务并且解决了group中storage服务器的同步延迟问题</a></p><h1 id="fastdfs-nginx-module+nginx_u5B89_u88C5"><a href="#fastdfs-nginx-module+nginx_u5B89_u88C5" class="headerlink" title="fastdfs-nginx-module+nginx安装"></a>fastdfs-nginx-module+nginx安装</h1><p>在安装nginx之前需要先安装一些模块依赖的lib库<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre pcre-devel  zlib zlib-devel  openssl openssl-devel</span><br></pre></td></tr></table></figure></p><p>storage nginx<br>首先是为storage服务器安装nginx，首先下载nginx和fastdfs-nginx-module的安装包<br> tar -zxvf nginx-1.12.2.tar.gz<br> unzip fastdfs-nginx-module.zip </p><p>解压成功后就可以编译安装nginx了，进入nginx目录<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@hjlc-storage-nodeA nginx-<span class="number">1.12</span><span class="number">.2</span>]<span class="comment"># ./configure --prefix=/home/hjlc/app/nginx --add-module=/root/fastdfs-nginx-module-master/src</span></span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>接下来要修改一下nginx的配置文件<br>server {<br>listen       9090;<br>server_name img.xxxx;<br>location ~/group1/M00 {<br>      root /home/hjlc/app/fastdfs/fastdfs_storage_data;<br>      ngx_fastdfs_module;<br>}<br>}<br>然后进入FastDFS的解压目录~/ fastdfs-5.11目录下的conf目录，将http.conf和mime.types拷贝到/etc/fdfs目录下<br>[root@hjlc-storage-nodeA fastdfs-5.11]# cp conf/http.conf /etc/fdfs/<br>[root@hjlc-storage-nodeA fastdfs-5.11]# cp conf/mime.types  /etc/fdfs/<br>把fastdfs-nginx-module解压目录中src目录下的mod_fastdfs.conf也拷贝到/etc/fdfs目录下：<br>[root@hjlc-storage-nodeA ~]# cp fastdfs-nginx-module-master/src/mod_fastdfs.conf  /etc/fdfs/<br>编辑刚拷贝的这个mod_fastdfs.conf文件了<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_storage <span class="comment">#保存日志目录</span></span><br><span class="line">tracker_server=<span class="number">172.16</span><span class="number">.1</span><span class="number">.182</span>:<span class="number">22122</span> <span class="comment">#tracker服务器的IP地址以及端口号</span></span><br><span class="line">storage_server_port=<span class="number">23000</span> <span class="comment">#storage服务器的端口号</span></span><br><span class="line">url_have_group_name = <span class="keyword">true</span> <span class="comment">#文件 url 中是否有 group 名</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data <span class="comment"># 存储路径</span></span><br><span class="line">group_count = <span class="number">3</span> <span class="comment">#设置组的个数，事实上这次只使用了group1</span></span><br><span class="line">设置了group_count = <span class="number">3</span>，接下来就需要在文件尾部追加这<span class="number">3</span>个group setting：</span><br><span class="line">group_count = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group settings for group #1</span></span><br><span class="line"><span class="comment"># since v1.14</span></span><br><span class="line"><span class="comment"># when support multi-group on this storage server, uncomment following section</span></span><br><span class="line">[group1]</span><br><span class="line">group_name=group1</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br><span class="line"></span><br><span class="line">[group2]</span><br><span class="line">group_name=group2</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br><span class="line"></span><br><span class="line">[group3]</span><br><span class="line">group_name=group3</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br></pre></td></tr></table></figure></p><p>接下来还需要建立 M00 至存储目录的符号连接：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ln  -s  /home/hjlc/app/fastdfs/fastdfs_storage_data/data  /home/hjlc/app/fastdfs/fastdfs_storage_data/data/M00</span><br><span class="line">[root@hjlc-storage-nodeA ~]<span class="comment"># /home/hjlc/app/nginx/sbin/nginx  -c /home/hjlc/app/nginx/conf/nginx.conf -t</span></span><br><span class="line">ngx_http_fastdfs_set pid=<span class="number">21138</span></span><br><span class="line">nginx: the configuration file /home/hjlc/app/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /home/hjlc/app/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure></p><p>节点2重复一遍storage服务安装和fastdfs-nginx-module+nginx安装即可，然后在安装一台Nginx发现代理服务器配置upstream代理，这我使用的SLB服务器就直接监听nodeA和nodeB的9090端口<br><img src="/img/1.jpg" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;u5B89_u88C5_u4F9D_u8D56_u5305&quot;&gt;&lt;a href=&quot;#u5B89_u88C5_u4F9D_u8D56_u5305&quot; class=&quot;headerlink&quot; title=&quot;安装依赖包&quot;&gt;&lt;/a&gt;安装依赖包&lt;/h1&gt;&lt;p&gt;系统：centos7
      
    
    </summary>
    
      <category term="fastDFS" scheme="http://www.idcsec.com/categories/fastDFS/"/>
    
    
      <category term="fastdfs" scheme="http://www.idcsec.com/tags/fastdfs/"/>
    
  </entry>
  
  <entry>
    <title>SecureCRT配置Cisco网络设备关键字高亮</title>
    <link href="http://www.idcsec.com/2018/02/27/ecureCRT%E9%85%8D%E7%BD%AECisco%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%85%B3%E9%94%AE%E5%AD%97%E9%AB%98%E4%BA%AE/"/>
    <id>http://www.idcsec.com/2018/02/27/ecureCRT配置Cisco网络设备关键字高亮/</id>
    <published>2018-02-27T07:34:00.000Z</published>
    <updated>2018-02-27T08:13:42.970Z</updated>
    
    <content type="html"><![CDATA[<p>##效果图：<br><img src="/img/securecrt1.png" alt="crt"><br>下载思科关键字文件解C:\Users\Administrator\AppData\Roaming\VanDyke\Config\Keywords(根据自己的用户路径)<br>链接: <a href="https://pan.baidu.com/s/1c3BZb8k" target="_blank" rel="external">https://pan.baidu.com/s/1c3BZb8k</a> 密码: xv7h</p><p>##设置 options-eitdefault-appearance<br><img src="/img/securecrt2.png" alt="crt"></p><p>##设置配置文件路径options-Globaloptions<br><img src="/img/securecrt3.png" alt="crt"></p><p>#下拉菜单选择解压好的关键字文件<br><img src="/img/securecrt4.png" alt="crt"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;##效果图：&lt;br&gt;&lt;img src=&quot;/img/securecrt1.png&quot; alt=&quot;crt&quot;&gt;&lt;br&gt;下载思科关键字文件解C:\Users\Administrator\AppData\Roaming\VanDyke\Config\Keywords(根据自己的用户路径
      
    
    </summary>
    
    
      <category term="crt" scheme="http://www.idcsec.com/tags/crt/"/>
    
  </entry>
  
  <entry>
    <title>解决Linux 出现大量TIME_WAIT连接问题</title>
    <link href="http://www.idcsec.com/2018/01/29/%E8%A7%A3%E5%86%B3Linux-%E5%87%BA%E7%8E%B0%E5%A4%A7%E9%87%8FTIME-WAIT%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98/"/>
    <id>http://www.idcsec.com/2018/01/29/解决Linux-出现大量TIME-WAIT连接问题/</id>
    <published>2018-01-29T03:30:59.000Z</published>
    <updated>2018-01-29T03:40:27.409Z</updated>
    
    <content type="html"><![CDATA[<figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n|awk <span class="string">'/^tcp/&#123;++S[$NF]&#125;END&#123;for (a in S) print a,S[a]&#125;'</span>    <span class="comment">#得到当前服务器的所有TCP连接数状态</span></span><br></pre></td></tr></table></figure><p>修改/etc/sysctl.conf文件参数<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span>  <span class="comment">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span>  <span class="comment">#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">30</span>  <span class="comment">#修改系統默认的TIMEOUT时间</span></span><br></pre></td></tr></table></figure></p><p>TIME_WAIT 的默认时间是 2倍的 MLS，即 240 秒，最低为 30 秒，最高为 300 秒。MLS 是 TCP 片在网上的最长存活时间。TIME_WAIT的主要作用是保证关闭的TCP端口不立即被使用。因为当网络存在延迟时，可能当某个端口被关闭后，网络中还有一些重传的TCP片在发向这个端口，如果这个端口立即建立新的TCP连接，则可能会有影响。所以使用2倍的MSL时间来限制这个端口立即被使用。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;hljs highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span 
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>zabbix+shell脚本钉钉机器人报警</title>
    <link href="http://www.idcsec.com/2017/12/15/zabbix-shell%E8%84%9A%E6%9C%AC%E9%92%89%E9%92%89%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A5%E8%AD%A6/"/>
    <id>http://www.idcsec.com/2017/12/15/zabbix-shell脚本钉钉机器人报警/</id>
    <published>2017-12-15T01:45:34.000Z</published>
    <updated>2018-03-09T05:14:10.171Z</updated>
    
    <content type="html"><![CDATA[<h1 id="u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21"><a href="#u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21" class="headerlink" title="内容原创,禁止转载!"></a>内容原创,禁止转载!</h1><h2 id="u6548_u679C_u56FE_u5982_u4E0B_uFF1A"><a href="#u6548_u679C_u56FE_u5982_u4E0B_uFF1A" class="headerlink" title="效果图如下："></a>效果图如下：</h2><p><img src="/img/dingding1.jpg" alt="jenkins"></p><h3 id="u81EA_u5B9A_u4E49_u8B66_u62A5_u63D0_u793A"><a href="#u81EA_u5B9A_u4E49_u8B66_u62A5_u63D0_u793A" class="headerlink" title="自定义警报提示"></a>自定义警报提示</h3><p>自定义告警脚本在zabbix_server.conf中配置，默认为： AlertScriptsPath=/usr/lib/zabbix/alertscripts<br>警报脚本在Zabbix服务器上执行。 这些脚本位于服务器配置文件中定义的目录中AlertScriptsPath.</p><p>这是一个示例警报脚本：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">to=$<span class="number">1</span></span><br><span class="line">messages=`<span class="keyword">echo</span> $<span class="number">3</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">subject=`<span class="keyword">echo</span> $<span class="number">2</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$&#123;messages&#125;"</span> | mail -s <span class="string">"$&#123;subject&#125;"</span> <span class="string">"$&#123;to&#125;"</span> &gt;&gt;/tmp/mail.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>Zabbix-Server 在调用脚本的时候，会传递三个变量参数给脚本作为位置参数：$1, $2, $3。 其中：$1 表示收件人，$2 表示主题，$3 表示内容。</p><h1 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="配置"></a>配置</h1><p>选择 报警媒介类型，创建自定义告警方式，<br>Type 选择 Script，Script name 指定自定义的告警脚本，<br>Script parameters 一般设置如下三个：</p><ul><li>{ALERT.SENDTO}</li><li>{ALERT.SUBJECT}</li><li>{ALERT.MESSAGE}<br><img src="/img/dingding2.png" alt="jenkins"><br>其他配置省略<br>shell+钉钉机器人脚本<figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#date:2017-12-14</span></span><br><span class="line"><span class="comment">#by wang.t</span></span><br><span class="line"><span class="comment">#Revision: 1.0</span></span><br><span class="line"><span class="comment"># Email:837479851@qq.com</span></span><br><span class="line"><span class="comment"># Website:idcsec.com</span></span><br><span class="line">LOGFILE=<span class="string">"/tmp/dingding.log"</span></span><br><span class="line">:&gt;<span class="string">"$LOGFILE"</span></span><br><span class="line">exec <span class="number">1</span>&gt;<span class="string">"$LOGFILE"</span></span><br><span class="line">exec <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://127.0.0.1/zabbix"</span></span><br><span class="line">CURL=<span class="string">"/usr/bin/curl"</span></span><br><span class="line">to=$<span class="number">1</span></span><br><span class="line">subject=`<span class="keyword">echo</span> $<span class="number">2</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">body=`<span class="keyword">echo</span> $<span class="number">3</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">$&#123;CURL&#125;  <span class="string">'https://oapi.dingtalk.com/robot/send?access_token=XXXXXXXXX'</span> \</span><br><span class="line">   -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">   -d <span class="string">""</span><span class="string">"</span><br><span class="line"> &#123;</span><br><span class="line">     \"msgtype\": \"markdown\",</span><br><span class="line">     \"markdown\": &#123;</span><br><span class="line">         \"title\":\"$&#123;subject&#125;@18******5\",</span><br><span class="line">         \"text\": \"$&#123;body&#125;\"</span><br><span class="line">     &#125;,</span><br><span class="line">    \"at\": &#123;</span><br><span class="line">        \"atMobiles\": [ </span><br><span class="line">            \"18*******5\",</span><br><span class="line">        ], </span><br><span class="line">        \"isAtAll\": false</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;"</span><span class="string">""</span></span><br></pre></td></tr></table></figure></li></ul><p>Github:<a href="https://github.com/Hwting/script/blob/master/zabbix_dingding.sh" target="_blank" rel="external">https://github.com/Hwting/script/blob/master/zabbix_dingding.sh</a><br>测试测试 zabbix_dingding.sh  “” 2 3</p><h1 id="u52A8_u4F5C_u8BBE_u7F6E"><a href="#u52A8_u4F5C_u8BBE_u7F6E" class="headerlink" title="动作设置"></a>动作设置</h1><p>到配置-》动作-》创建动作（触发器）</p><h2 id="zabbix_u62A5_u8B66_u6D88_u606F_u6A21_u677F"><a href="#zabbix_u62A5_u8B66_u6D88_u606F_u6A21_u677F" class="headerlink" title="zabbix报警消息模板"></a>zabbix报警消息模板</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">标题：故障&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line"></span><br><span class="line">告警IP:&#123;HOST.IP&#125;</span><br><span class="line"></span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line"></span><br><span class="line">等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line"></span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line"></span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line"></span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line"></span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line"></span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">标题：恢复&#123;TRIGGER.STATUS&#125;, 服务器:&#123;HOSTNAME1&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line"></span><br><span class="line">告警IP:&#123;HOST.IP&#125;</span><br><span class="line"></span><br><span class="line">恢复时间:&#123;EVENT.DATE&#125;&#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line"></span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line"></span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line"></span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line"></span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line"></span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line"></span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21&quot;&gt;&lt;a href=&quot;#u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21&quot; class=&quot;heade
      
    
    </summary>
    
    
  </entry>
  
</feed>
