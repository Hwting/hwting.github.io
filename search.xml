<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>使用Prometheus的blackbox_exporter进行网络监控</title>
      <link href="/2018/10/28/%E4%BD%BF%E7%94%A8Prometheus%E7%9A%84blackbox-exporter%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7/"/>
      <url>/2018/10/28/%E4%BD%BF%E7%94%A8Prometheus%E7%9A%84blackbox-exporter%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7/</url>
      
        <content type="html"><![CDATA[<p><img src="/img/20181028004809.png" alt="monitoring"></p><p>使用Prometheus的blackbox_exporter进行网络监控<br><img src="http://showdoc.zhph.lan/Public/Uploads/2018-10-15/5bc3e8988eaba.png" alt=""></p><ul><li>Prometheus提供了一个blackbox_exporter可以实现网络监控，支持http、dns、tcp、icmp等监控。</li></ul><p>其中9115是这个exporter的http端点的监听端口，blackbox.yml是它的配置文件，需要在其中使用blackbox_exporter的http、dns、tcp、icmp等prober定制配置出各种监测模块(module)。关于blackbox_exporter的配置具体参考Blackbox exporter configuration和Blackbox exporter configuration Exmaple。下面的例子是一个最基本的配置：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">modules</span>:</span><br><span class="line">  <span class="attribute">http_2xx</span>:  # http 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">  <span class="attribute">http_post_2xx</span>: # http post 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">method</span>: POST</span><br><span class="line">  <span class="attribute">tcp_connect</span>: # tcp 监测模块</span><br><span class="line">    <span class="attribute">prober</span>: tcp</span><br><span class="line">  <span class="attribute">ping</span>: # icmp 检测模块</span><br><span class="line">    <span class="attribute">prober</span>: icmp</span><br><span class="line">    <span class="attribute">timeout</span>: <span class="number">5s</span></span><br><span class="line">    <span class="attribute">icmp</span>:</span><br><span class="line">      <span class="attribute">preferred_ip_protocol</span>: <span class="string">"ip4"</span></span><br><span class="line">      <span class="attribute">dns</span>:</span><br><span class="line">       <span class="attribute">transport_protocol</span>: <span class="string">"tcp"</span></span><br><span class="line">       <span class="attribute">preferred_ip_protocol</span>: <span class="string">"ip4"</span></span><br><span class="line">       <span class="attribute">query_name</span>: <span class="string">"kubernetes.default.svc.cloud.ctrm"</span>  # 利用这个域名来检查 dns 服务器</span><br><span class="line">       <span class="attribute">query_type</span>: <span class="string">"A"</span>  # 如果是 kube-dns ，一定要加入这个</span><br></pre></td></tr></table></figure></p><p>在Prometheus的配置文件中配置使用ping module：<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'ping_all'</span></span><br><span class="line"></span>    scrape_interval: 1m</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [ping]</span><br><span class="line">    static_configs:</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>        -<span class="ruby"> <span class="number">192.168</span>.<span class="number">1.2</span></span><br><span class="line"></span>       labels:</span><br><span class="line">         instance: node2</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>        -<span class="ruby"> <span class="number">192.168</span>.<span class="number">1.3</span></span><br><span class="line"></span>       labels:</span><br><span class="line">         instance: node3</span><br><span class="line">    relabel_configs:</span><br><span class="line">      -<span class="ruby"> <span class="symbol">source_labels:</span> [__address_<span class="number">_</span>]</span><br><span class="line"></span>        target_label: __param_target</span><br><span class="line">      -<span class="ruby"> <span class="symbol">target_label:</span> __address_<span class="number">_</span></span><br><span class="line"></span>        replacement: 127.0.0.1:9115 # black_exporter服务器的地址</span><br></pre></td></tr></table></figure></p><p>测试<br>curl “<a href="http://127.0.0.1:9115/probe?module=ping&amp;target=192.168.1.2" target="_blank" rel="external">http://127.0.0.1:9115/probe?module=ping&amp;target=192.168.1.2</a>“<br>http检测<br>Blackbox 配置了 http_2xx 模块，所以这里只需要在 Prometheus的配置文件中配置使用http_2xx module<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'blackbox'</span></span><br><span class="line"></span>  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">  static_configs:</span><br><span class="line">    -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="symbol">http:</span>/<span class="regexp">/prometheus.io    # Target to probe with http.</span><br><span class="line"></span></span>      -<span class="ruby"><span class="regexp"> https:/</span><span class="regexp">/prometheus.io   # Target to probe with https.</span><br><span class="line"></span></span>      -<span class="ruby"><span class="regexp"> http:/</span><span class="regexp">/example.com:8080 # Target to probe with http on port 8080.</span><br><span class="line"></span></span>  relabel_configs:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> source_labels: [__address__]</span><br><span class="line"></span></span>      target_label: __param_target</span><br><span class="line">    -<span class="ruby"><span class="regexp"> source_labels: [__param_target]</span><br><span class="line"></span></span>      target_label: instance</span><br><span class="line">    -<span class="ruby"><span class="regexp"> target_label: __address__</span><br><span class="line"></span></span>      replacement: 127.0.0.1:9115  # The blackbox exporter's real hostname:port</span><br></pre></td></tr></table></figure></p><p>dns监控<br><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">"kubernetes-service-dns"</span></span><br><span class="line"></span>  metrics_path: /probe # 不是 metrics，是 probe</span><br><span class="line">  params:</span><br><span class="line">    module: [dns] # DNS 模块</span><br><span class="line">  static_configs:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>    -<span class="ruby"> kube-<span class="symbol">dns:</span><span class="number">53</span> <span class="comment"># 不要省略端口号</span></span><br><span class="line"></span>  relabel_configs:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">source_labels:</span> [__address_<span class="number">_</span>]</span><br><span class="line"></span>    target_label: __param_target</span><br><span class="line">  -<span class="ruby"> <span class="symbol">source_labels:</span> [__param_target]</span><br><span class="line"></span>    target_label: instance</span><br><span class="line">  -<span class="ruby"> <span class="symbol">target_label:</span> __address_<span class="number">_</span></span><br><span class="line"></span>    replacement: blackbox # 服务地址，和上面的 Service 定义保持一致</span><br></pre></td></tr></table></figure></p><p>/-/reload(curl -XPOST ip:prom端口/-/reload）使配置生效<br>可以使用 probe_success{job=”kubernetes-service-dns”} 查看结果<br>如果HTTP服务启用了安全认证，Blockbox Exporter内置了对basic_auth的支持，可以直接设置相关的认证信息即可：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http_basic_auth_example</span>:</span><br><span class="line">    <span class="attribute">prober</span>: http</span><br><span class="line">    <span class="attribute">timeout</span>: <span class="number">5s</span></span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">method</span>: POST</span><br><span class="line">      <span class="attribute">headers</span>:</span><br><span class="line">        <span class="attribute">Host</span>: <span class="string">"login.example.com"</span></span><br><span class="line">      <span class="attribute">basic_auth</span>:</span><br><span class="line">        <span class="attribute">username</span>: <span class="string">"username"</span></span><br><span class="line">        <span class="attribute">password</span>: <span class="string">"mysecret"</span></span><br></pre></td></tr></table></figure></p><p>对于使用了Bear Token的服务也可以通过bearer_token配置项直接指定令牌字符串，或者通过bearer_token_file指定令牌文件。</p><p>对于一些启用了HTTPS的服务，但是需要自定义证书的服务，可以通过tls_config指定相关的证书信息：<br><figure class="hljs highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_custom_ca_example:</span><br><span class="line">   prober: http</span><br><span class="line">   http:</span><br><span class="line">     <span class="keyword">method</span>: <span class="type">GET</span></span><br><span class="line">     tls_config:</span><br><span class="line">       ca_file: <span class="string">"/certs/my_cert.crt"</span></span><br></pre></td></tr></table></figure></p><p>自带 metrics 端点的服务<br>有的服务，例如 prometheus 或者 blackbox，以及 kube-dns、etcd 等， 都是自有 /metrics 提供指标输出的，这种服务对 Blackbox + Prometheus 组合是非常方便的。<br>只要给服务的注解部分加入几个标签：<br>kubernetes-pods<br>对于pod的监测也是需要加注解：<br><figure class="hljs highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">prometheus.io/host</span>: <span class="string">calico-etcd # 服务名称</span></span><br><span class="line"><span class="attribute">prometheus.io/port</span>: <span class="string">"6666" # metrics 端口</span></span><br><span class="line"><span class="attribute">prometheus.io/scrape</span>: <span class="string">"true" # 抓取开关</span></span><br><span class="line"><span class="attribute">prometheus.io/path</span>: <span class="string">"/metrics"默认为/metric</span></span><br></pre></td></tr></table></figure></p><h1 id="u5B8C_u6574_u7684kubernetes_u90E8_u7F72_u6587_u4EF6"><a href="#u5B8C_u6574_u7684kubernetes_u90E8_u7F72_u6587_u4EF6" class="headerlink" title="完整的kubernetes部署文件"></a>完整的kubernetes部署文件</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">blackbox-exporter-deploy.yaml </span><br><span class="line"><span class="string">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="string">kind:</span> Deployment</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  namespace:</span> monitoring</span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  selector:</span></span><br><span class="line"><span class="label">    matchLabels:</span></span><br><span class="line"><span class="label">      app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="label">  template:</span></span><br><span class="line"><span class="label">    metadata:</span></span><br><span class="line"><span class="label">      labels:</span></span><br><span class="line"><span class="label">        app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">    spec:</span></span><br><span class="line"><span class="label">      restartPolicy:</span> Always</span><br><span class="line"><span class="label">      containers:</span></span><br><span class="line">      - <span class="string">name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">        image:</span> prom/blackbox-<span class="string">exporter:</span>v0<span class="number">.12</span><span class="number">.0</span></span><br><span class="line"><span class="label">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="label">        ports:</span></span><br><span class="line">        - <span class="string">name:</span> blackbox-port</span><br><span class="line"><span class="label">          containerPort:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">        readinessProbe:</span></span><br><span class="line"><span class="label">          tcpSocket:</span></span><br><span class="line"><span class="label">            port:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="label">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="label">        resources:</span></span><br><span class="line"><span class="label">          requests:</span></span><br><span class="line"><span class="label">            memory:</span> <span class="number">50</span>Mi</span><br><span class="line"><span class="label">            cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="label">          limits:</span></span><br><span class="line"><span class="label">            memory:</span> <span class="number">60</span>Mi</span><br><span class="line"><span class="label">            cpu:</span> <span class="number">200</span>m</span><br><span class="line"><span class="label">        volumeMounts:</span></span><br><span class="line">        - <span class="string">name:</span> config</span><br><span class="line"><span class="label">          mountPath:</span> <span class="regexp">/etc/</span>blackbox_exporter</span><br><span class="line"><span class="label">        args:</span></span><br><span class="line">        - --config.file=<span class="regexp">/etc/</span>blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --web.listen-address=:<span class="number">9115</span></span><br><span class="line"><span class="label">      volumes:</span></span><br><span class="line">      - <span class="string">name:</span> config</span><br><span class="line"><span class="label">        configMap:</span></span><br><span class="line"><span class="label">          name:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">      nodeSelector:</span></span><br><span class="line"><span class="label">        prometheus:</span> <span class="string">"core"</span></span><br><span class="line"><span class="label">      tolerations:</span></span><br><span class="line">      - <span class="string">key:</span> <span class="string">"node-role.kubernetes.io/master"</span></span><br><span class="line"><span class="label">        effect:</span> <span class="string">"NoSchedule"</span></span><br><span class="line">---</span><br><span class="line"><span class="string">apiVersion:</span> v1</span><br><span class="line"><span class="string">kind:</span> Service</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  labels:</span></span><br><span class="line"><span class="label">    app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  name:</span> blackbox-exporter</span><br><span class="line"><span class="label">  namespace:</span> monitoring</span><br><span class="line"><span class="label">  annotations:</span></span><br><span class="line">    prometheus.io/<span class="string">scrape:</span> <span class="string">'true'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  type:</span> NodePort</span><br><span class="line"><span class="label">  selector:</span></span><br><span class="line"><span class="label">    app:</span> prometheus-blackbox-exporter</span><br><span class="line"><span class="label">  ports:</span></span><br><span class="line">  - <span class="string">name:</span> blackbox</span><br><span class="line"><span class="label">    port:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">    targetPort:</span> <span class="number">9115</span></span><br><span class="line"><span class="label">    protocol:</span> TCP</span><br></pre></td></tr></table></figure><h1 id="prometheus_u7684_u914D_u7F6E_u6587_u4EF6"><a href="#prometheus_u7684_u914D_u7F6E_u6587_u4EF6" class="headerlink" title="prometheus的配置文件"></a>prometheus的配置文件</h1><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="symbol">job_name:</span> <span class="string">'blackbox'</span></span><br><span class="line"></span>   metrics_path: /probe</span><br><span class="line">   params:</span><br><span class="line">     module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">   static_configs:</span><br><span class="line">     -<span class="ruby"> <span class="symbol">targets:</span></span><br><span class="line"></span>       -<span class="ruby"> <span class="symbol">http:</span>/<span class="regexp">/prometheus.io    # Target to probe with http.</span><br><span class="line"></span></span>       -<span class="ruby"><span class="regexp"> https:/</span><span class="regexp">/prometheus.io   # Target to probe with https.</span><br><span class="line"></span></span>       -<span class="ruby"><span class="regexp"> http:/</span><span class="regexp">/example.com:8080 # Target to probe with http on port 8080.</span><br><span class="line"></span></span>   relabel_configs:</span><br><span class="line">     -<span class="ruby"><span class="regexp"> source_labels: [__address__]</span><br><span class="line"></span></span>       target_label: __param_target</span><br><span class="line">     -<span class="ruby"><span class="regexp"> source_labels: [__param_target]</span><br><span class="line"></span></span>       target_label: instance</span><br><span class="line">     -<span class="ruby"><span class="regexp"> target_label: __address__</span><br><span class="line"></span></span>       replacement: blackbox-exporter:9115  # The blackbox exporter's real hostname:port</span><br></pre></td></tr></table></figure><p><img src="/img/20181028013940.png" alt="monitoring"></p><h1 id="prometheus_u7684_u914D_u7F6E_u6587_u4EF6alermanager_u62A5_u8B66_u89C4_u5219"><a href="#prometheus_u7684_u914D_u7F6E_u6587_u4EF6alermanager_u62A5_u8B66_u89C4_u5219" class="headerlink" title="prometheus的配置文件alermanager报警规则"></a>prometheus的配置文件alermanager报警规则</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: sitealer</span><br><span class="line">  rules:</span><br><span class="line">  - alert: 网站异常</span><br><span class="line">    expr: up&#123;job=<span class="string">"blackbox"</span>&#125; == <span class="number">0</span>  or  probe_success&#123;job=<span class="string">"blackbox"</span>&#125; == <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span>: <span class="number">10</span>s</span><br><span class="line">    labels:</span><br><span class="line">      severity: critica</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"网站 &#123;&#123; $labels.target &#125;&#125; 访问异常"</span></span><br></pre></td></tr></table></figure><p><img src="/img/20181028012307.png" alt="monitoring"></p>]]></content>
      
      
      <categories>
          
          <category> prometheus </category>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blackbox-exporter </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用Prometheus监控Oracle系统展示到Grafana</title>
      <link href="/2018/10/27/%E4%BD%BF%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7Oracle%E7%B3%BB%E7%BB%9F%E5%B1%95%E7%A4%BA%E5%88%B0Grafana/"/>
      <url>/2018/10/27/%E4%BD%BF%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7Oracle%E7%B3%BB%E7%BB%9F%E5%B1%95%E7%A4%BA%E5%88%B0Grafana/</url>
      
        <content type="html"><![CDATA[<p>oracledb_exporter参考：<br><a href="https://github.com/iamseth/oracledb_exporter" target="_blank" rel="external">https://github.com/iamseth/oracledb_exporter</a><br>本文直接把oracledb_exporter部署在k8s环境。docker部署方式更为简单<br>我们使用Prometheus在Grafana上为Oracle实现监控仪表板。由于Oracle不支持http通信，它由Oracle Exporter获取指标，它将Oracle的内容发送到Prometheus，并将Prometheus内容输出到Grafana。<br><img src="/img/oracle1.jpg" alt="crt"><br>Oracle DB→Oracle Exporter→Prometheus→Grafana</p><p>Oracle Exporter需要将Oracle与Prometheus连接。Oracle Exporter将有关Oracle的信息传递给Prometheus。<br>创建yaml对象</p><h1 id="u90E8_u7F72oracle-export"><a href="#u90E8_u7F72oracle-export" class="headerlink" title="部署oracle-export"></a>部署oracle-export</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f - </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  name: oracle-<span class="keyword">export</span>-dm</span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  <span class="keyword">template</span>:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image:  wtingdocker/oracledb_exporter:latest</span><br><span class="line">        name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">        command:</span><br><span class="line">        - <span class="string">"/oracledb_exporter"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">9161</span></span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: DATA_SOURCE_NAME</span><br><span class="line">          value: <span class="string">"system/oracle@ip:1521/sid"</span>  <span class="preprocessor">#改成自己的数据库信息 定义DATA_SOURCE_NAME变量</span></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  name: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">9161</span></span><br><span class="line">    targetPort: <span class="number">9161</span></span><br><span class="line">  selector:</span><br><span class="line">    app: oracle-<span class="keyword">export</span>-<span class="number">198</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="u4FEE_u6539prometheus-yml_u6587_u4EF6"><a href="#u4FEE_u6539prometheus-yml_u6587_u4EF6" class="headerlink" title="修改prometheus.yml文件"></a>修改prometheus.yml文件</h1><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">scrape_configs</span>:</span><br><span class="line">- <span class="attribute">job_name</span>: <span class="string">'oracle-198'</span></span><br><span class="line">  <span class="attribute">static_configs</span>:</span><br><span class="line">  - <span class="attribute">targets</span>: [<span class="string">'oracle-export-198:9161'</span>]</span><br></pre></td></tr></table></figure><p>重新加载prometheus配置文件<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  apply <span class="operator">-f</span> configmao.yaml</span><br></pre></td></tr></table></figure></p><p>重新启动prometheus容器以使修改后的内容生效<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">http:</span><span class="comment">//192.168.7.X:30680/-/reload</span></span><br></pre></td></tr></table></figure></p><h1 id="Grafana_u5C55_u793A"><a href="#Grafana_u5C55_u793A" class="headerlink" title="Grafana展示"></a>Grafana展示</h1><p>访问oracle-export端口验证Oracle和Prometheus连接<br><img src="/img/20181027225036.png" alt="oracle1"><br><img src="/img/20181027225445.png" alt="oracle1"><br>Grafana添加Prometheus数据库源<br><img src="/img/0181027230136.png" alt="oracle2"></p><p>仪表板导入3333可以根据自己的需要添加export提供的metrics 展示以及通过alertmanager告警<br><img src="/img/20181027230648.png" alt="oracle2"></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetes ingress配置HTTPS/TLS证书</title>
      <link href="/2018/09/29/kubernetes-ingress%E9%85%8D%E7%BD%AEHTTPS-TLS%E8%AF%81%E4%B9%A6/"/>
      <url>/2018/09/29/kubernetes-ingress%E9%85%8D%E7%BD%AEHTTPS-TLS%E8%AF%81%E4%B9%A6/</url>
      
        <content type="html"><![CDATA[<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="external">Ingress是Kubernetes中的一个概念，用于</a>将入站连接路由到不同的服务。这可以通过不同方式实现。<br>生成证书文件<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days <span class="number">2920</span> -newkey rsa:<span class="number">2048</span> -keyout tls<span class="class">.key</span> -out tls<span class="class">.crt</span> -subj <span class="string">"/CN=*.idcsec.com/O=nginxsvc"</span></span><br></pre></td></tr></table></figure></p><p>导入证书文件到k8s secret<br><figure class="hljs highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> secret tls <span class="keyword">https</span>-secret <span class="comment">--key tls.key --cert tls.crt</span></span><br></pre></td></tr></table></figure></p><p>或者使用yaml<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">apiVersion:</span> v1</span><br><span class="line"><span class="string">kind:</span> Secret</span><br><span class="line"><span class="string">type:</span> kubernetes.io/tls</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> mytlssecret</span><br><span class="line"><span class="string">data:</span></span><br><span class="line">  tls.<span class="string">crt:</span> &lt;base64 encoded cert&gt;</span><br><span class="line">  tls.<span class="string">key:</span> &lt;base64 encoded key&gt;</span><br></pre></td></tr></table></figure></p><p>配置ingress<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Ingress</span><br><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: test</span><br><span class="line">  <span class="attribute">annotations</span>:</span><br><span class="line">    ingress.kubernetes.io/<span class="attribute">ssl-redirect</span>: <span class="string">"False"</span>  #设置是否强制跳转 false| true</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">tls</span>:</span><br><span class="line">  - <span class="attribute">hosts</span>: </span><br><span class="line">    - www.idcsec.com</span><br><span class="line">    <span class="attribute">secretName</span>: https-secret</span><br><span class="line">  <span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">host</span>:  www.idcsec.com</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">paths</span>:</span><br><span class="line">      - <span class="attribute">path</span>: /</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: test</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure></p><p>校验证书信息<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> tls<span class="class">.crt</span>  -noout -text</span><br></pre></td></tr></table></figure></p><p><a href="https://github.com/kubernetes/ingress-nginx/tree/master/docs/examples/auth/client-certs" target="_blank" rel="external">Client Certificate Authentication</a><br><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#creating-the-ca-authentication-secret" target="_blank" rel="external">TLS证书</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ingress-nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetes ingres-nginx高级配置</title>
      <link href="/2018/09/29/kubernetes-ingres-nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/09/29/kubernetes-ingres-nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="u901A_u8FC7configmap_u4FEE_u6539nginx_controller_u7684_u4E00_u4E9B_u5168_u5C40_u53D8_u91CF"><a href="#u901A_u8FC7configmap_u4FEE_u6539nginx_controller_u7684_u4E00_u4E9B_u5168_u5C40_u53D8_u91CF" class="headerlink" title="通过configmap修改nginx controller的一些全局变量"></a>通过configmap修改nginx controller的一些全局变量</h2><p>通过启动nginx controller的yaml文件，其实我们可以看出来，在启动controller的时候，向启动命令传递了一大堆参数，包括–default-backend-service以及–apiserver-host等。更多的参数，可以直接参考<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/multiple-ingress.md" target="_blank" rel="external">相关文档</a></p><p>nginx controller本质上就是一个nginx代理，这个代理使用了一大堆nginx默认参数启动。而在某些特定场景下，这些我们需要定制这些参数以更适用于我们的需求。在controller启动的时候，提供了一个–configmap的参数，我们可以将需要定制的参数保存到一个configmap中，并在controller启动的时候，来读取这个configmap，获取其值，应用到controller中。具体哪些值可以通过configmap来传递，可以直接参考<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md" target="_blank" rel="external">相关文档</a><br><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md" target="_blank" rel="external">https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md</a></p><h1 id="u4E00_u3001_u4F7F_u7528ConfigMap"><a href="#u4E00_u3001_u4F7F_u7528ConfigMap" class="headerlink" title="一、使用ConfigMap"></a>一、使用ConfigMap</h1><p>确保指定启动Ingress控制器时要使用的configmaps资源。</p><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: ConfigMap </span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: nginx-configuration</span><br><span class="line">  <span class="attribute">namespace</span>: ingress-nginx</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: ingress-nginx</span><br><span class="line"><span class="attribute">data</span>:</span><br><span class="line">  <span class="attribute">client-header-buffer-size</span>: <span class="string">"4k"</span></span><br><span class="line">  <span class="attribute">proxy-connect-timeout</span>: <span class="string">"40"</span></span><br><span class="line">  <span class="attribute">proxy-read-timeout</span>: <span class="string">"110"</span></span><br><span class="line">  <span class="attribute">proxy-send-timeout</span>: <span class="string">"110"</span></span><br></pre></td></tr></table></figure><p>创建配置资源：<br><figure class="hljs highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> kubectl apply -f nginx-configuration.yaml</span><br><span class="line"> kubectl get cm nginx-configuration -<span class="keyword">n</span> ingress-nginx  -o yaml</span><br><span class="line">[root@k8s-<span class="keyword">m</span> ~]# kubectl  exec -it     nginx-ingress-controller-5f947cc79f-86cvc      -<span class="keyword">n</span> ingress-nginx -- <span class="keyword">cat</span> /etc/nginx/nginx.<span class="keyword">conf</span> | grep    client_header_buffer_size</span><br><span class="line">trueclient_header_buffer_size       4k;</span><br></pre></td></tr></table></figure></p><h3 id="u4FEE_u6539nginx-controller_u7684yml_u6587_u4EF6nginx-ingress-daemonset-yaml_u542F_u52A8_u53C2_u6570_u5982_u4E0B_uFF1A"><a href="#u4FEE_u6539nginx-controller_u7684yml_u6587_u4EF6nginx-ingress-daemonset-yaml_u542F_u52A8_u53C2_u6570_u5982_u4E0B_uFF1A" class="headerlink" title="修改nginx-controller的yml文件nginx-ingress-daemonset.yaml启动参数如下："></a>修改nginx-controller的yml文件nginx-ingress-daemonset.yaml启动参数如下：</h3><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">args:</span></span><br><span class="line"></span>    -<span class="ruby"> /nginx-ingress-controller</span><br><span class="line"></span>    -<span class="ruby"> --default-backend-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/default-http-backend</span><br><span class="line"></span>    -<span class="ruby"> --configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/nginx-configuration /<span class="regexp">/例如</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> --tcp-services-configmap=$(POD_NAMESPACE)/tcp</span>-services</span><br><span class="line"></span>    -<span class="ruby"> --udp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/udp-services</span><br><span class="line"></span>    -<span class="ruby"> --publish-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/ingress-nginx</span><br><span class="line"></span>    -<span class="ruby"> --annotations-prefix=nginx.ingress.kubernetes.io</span></span><br></pre></td></tr></table></figure><ul><li>如需要生效重启nginx-ingress-controller pod *<h1 id="u4E8C_u3001_u4F7F_u7528Annotations"><a href="#u4E8C_u3001_u4F7F_u7528Annotations" class="headerlink" title="二、使用Annotations"></a>二、使用Annotations</h1>如果只想自定义特定Ingress资源的配置，可以使用Annotations。<figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Ingress</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: cafe-ingress-with-annotations</span><br><span class="line">  <span class="attribute">annotations</span>:</span><br><span class="line">    nginx.org/<span class="attribute">proxy-connect-timeout</span>: <span class="string">"30s"</span></span><br><span class="line">    nginx.org/<span class="attribute">proxy-read-timeout</span>: <span class="string">"20s"</span></span><br><span class="line">    nginx.org/<span class="attribute">client-max-body-size</span>: <span class="string">"4m"</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">host</span>: cafe.example.com</span><br><span class="line">    <span class="attribute">http</span>:</span><br><span class="line">      <span class="attribute">paths</span>:</span><br><span class="line">      - <span class="attribute">path</span>: /tea</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: tea-svc</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br><span class="line">      - <span class="attribute">path</span>: /coffee</span><br><span class="line">        <span class="attribute">backend</span>:</span><br><span class="line">          <span class="attribute">serviceName</span>: coffee-svc</span><br><span class="line">          <span class="attribute">servicePort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure></li></ul><p>Annotations配置优先于ConfigMap<br><a href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization" target="_blank" rel="external">https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization</a><br><a href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization" target="_blank" rel="external">https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/customization</a></p><h1 id="u9650_u901F"><a href="#u9650_u901F" class="headerlink" title="限速"></a>限速</h1><p>Annotations<code>ingress.kubernetes.io/limit-connections</code>和<code>ingress.kubernetes.io/limit-rps</code>定义可由单个客户端IP地址打开的连接的限制。这可用于缓解<a href="https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus" target="_blank" rel="external">DDoS攻击</a>。</p><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/limit-connections：单个IP地址允许的并发连接数。</span><br><span class="line"></span><br><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/limit-rps：每秒可从给定IP接受的连接数。</span><br><span class="line"></span><br><span class="line">如果在单个Ingress规则中指定两个Annotations，`limit-rps`则优先。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ingress-nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>etcdv3 集群基本操作使用</title>
      <link href="/2018/09/21/etcdv3-%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/09/21/etcdv3-%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/coreos/etcd" target="_blank" rel="external">etcd</a>是一个开源的分布式键值对数据库，他的每一个节点都有一份数据的copy，当有节点故障时保证了高可用性。etcd使用<a href="https://raft.github.io/" target="_blank" rel="external">Raft</a>算法来保证一致性。</p><p>etcd的apiv3在使用命令时需要在前面加上ETCDCTL_API=3<br>集群成员<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=<span class="number">3</span> etcdctl member <span class="built_in">list</span></span><br></pre></td></tr></table></figure></p><p>更新一个节点ip<br><figure class="hljs highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl <span class="keyword">member</span> list</span><br><span class="line">etcdctl <span class="keyword">member</span> update memberID http:<span class="comment">//ip:2380</span></span><br></pre></td></tr></table></figure></p><p>删除一个节点<br><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member <span class="keyword">list</span>  </span><br><span class="line">etcdctl member <span class="built_in">remove</span> memberID  </span><br><span class="line">etcdctl member <span class="keyword">list</span>  </span><br><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> etcd //在相关节点上kill掉etcd进程</span><br></pre></td></tr></table></figure></p><p>测试增加一个新节点<br>注意：添加已经删除的需要将etcd3的rm -rf /var/lib/etcd/*必须删除<br>移除节点<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  list -w table</span><br><span class="line">ETCDCTL_API=3  etcdctl --endpoints=https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  remove 7d17ab970f6de141</span></span><br></pre></td></tr></table></figure></p><p>添加节点<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member add  etcd3 --peer-urls="https:/</span><span class="regexp">/192.168.7.92:2380" /</span><span class="regexp">/查看新增成员列表，etcd3状态为unstarted</span><br><span class="line">rm -rf /var</span><span class="regexp">/lib/etcd</span><span class="regexp">/*  /</span><span class="regexp">/etcd3上面操作</span><br><span class="line">vi  /etc</span><span class="regexp">/systemd/system</span><span class="regexp">/etcd.service  /</span><span class="regexp">//etcd</span>3上面操作 修改--initial-cluster-state=existing 不改报错 streaming request ignored (<span class="constant">ID</span> mismatch got <span class="number">7</span>d17ab970f6de141 want <span class="number">58662</span>caff7c6e081)</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl  restart   etcd  /<span class="regexp">//etcd</span>3上面操作</span><br><span class="line"><span class="constant">ETCDCTL_API</span>=<span class="number">3</span>  etcdctl --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379，https:/</span><span class="regexp">/192.168.7.92:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  member  list -w table</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>kubernetesk kubelet证书到期解决方法</title>
      <link href="/2018/09/21/kubernetesk-kubelet%E8%AF%81%E4%B9%A6%E5%88%B0%E6%9C%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2018/09/21/kubernetesk-kubelet%E8%AF%81%E4%B9%A6%E5%88%B0%E6%9C%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>kubelete 证书默认有效期一年<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L -o <span class="regexp">/bin/</span>cfssl-certinfo <span class="string">https:</span><span class="comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line">chmod a+x <span class="regexp">/bin/</span>cfssl-certinfo</span><br><span class="line"> cfssl-certinfo -cert <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.crt</span><br></pre></td></tr></table></figure></p><p><img src="/img/kubelet1.png" alt="crt"></p><h1 id="u65B9_u6CD5_u4E00"><a href="#u65B9_u6CD5_u4E00" class="headerlink" title="方法一"></a>方法一</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">备份 mkdir  <span class="regexp">~/sslback &amp;&amp; mv /</span>etc<span class="regexp">/kubernetes/</span>kubelet.kubeconfig  <span class="regexp">~/sslback/</span></span><br><span class="line">使用admin证书文件替换</span><br><span class="line">cp <span class="regexp">~/.kube/</span>config <span class="regexp">/etc/</span>kubernetes/kubelet.kubeconfig </span><br><span class="line">systemctl  restart kubelet &amp;&amp; systemctl  status  kubelet</span><br></pre></td></tr></table></figure><h1 id="u65B9_u6CD5_u4E8C_kubelet_u91CD_u65B0_u8BF7_u6C42_u8BC1_u4E66"><a href="#u65B9_u6CD5_u4E8C_kubelet_u91CD_u65B0_u8BF7_u6C42_u8BC1_u4E66" class="headerlink" title="方法二 kubelet重新请求证书"></a>方法二 kubelet重新请求证书</h1><p>手动签发<br>在 kubelet 首次启动后，如果用户 Token 没问题，并且 RBAC 也做了相应的设置，那么此时在集群内应该能看到 kubelet 发起的 CSR 请求 ，必须通过后kubernetes 系统才会将该 Node 加入到集群。<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在证书过期node删除kubelet相关证书文件</span><br><span class="line">rm -rf <span class="regexp">/etc/</span>kubernetes/kubelet.kubeconfig</span><br><span class="line">rm -rf <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.*</span><br><span class="line">systemctl  restart kubelet &amp;&amp; systemctl  status  kubelet</span><br><span class="line">自动生成了kubelet kubeconfig 文件和公私钥</span><br><span class="line">查看未授权的CSR请求</span><br><span class="line">kubectl get csr</span><br><span class="line">通过CSR 请求：</span><br><span class="line">kubectl certificate approve csr-<span class="number">404</span>fc</span><br><span class="line">查看重新生成的证书文件</span><br><span class="line">ll <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>kubelet.*</span><br><span class="line">kubectl  get nodes --show-labels</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tls </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>prometheus alertmanager邮件告警</title>
      <link href="/2018/09/19/prometheus-alertmanager%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/"/>
      <url>/2018/09/19/prometheus-alertmanager%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<p>prometheus将监测到的异常事件发送给alertmanager，alertmanager发送异常事件的通知（邮件、webhook等）</p><ul><li>参考<br><a href="https://prometheus.io/docs/alerting/configuration/" target="_blank" rel="external">https://prometheus.io/docs/alerting/configuration/</a><br><a href="https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html" target="_blank" rel="external">https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/configuring-prometheus-alertmanager.html</a><br><a href="https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml" target="_blank" rel="external">https://github.com/coreos/prometheus-operator/blob/master/contrib/kube-prometheus/manifests/prometheus-rules.yaml</a><br><a href="https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl" target="_blank" rel="external">https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl</a><br>k8s部署prometheus<br>略<br>k8s部署alertmanager<br>修改Prometheus配置文件我prometheus.yml<figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">global</span>:</span><br><span class="line">  <span class="attribute">scrape_interval</span>:     <span class="number">15s</span></span><br><span class="line">  <span class="attribute">evaluation_interval</span>: <span class="number">15s</span></span><br><span class="line"><span class="attribute">alerting</span>:</span><br><span class="line">  <span class="attribute">alertmanagers</span>:</span><br><span class="line">    - <span class="attribute">static_configs</span>:</span><br><span class="line">        - <span class="attribute">targets</span>: [<span class="string">"alertmanager:9093"</span>]#AlertManager 地址与端口</span><br></pre></td></tr></table></figure></li></ul><h1 id="configMap-yaml_u6587_u4EF6"><a href="#configMap-yaml_u6587_u4EF6" class="headerlink" title="configMap.yaml文件"></a>configMap.yaml文件</h1><p>随便注释一部分具体参数参考官方</p><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: ConfigMap</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">    <span class="attribute">name</span>: alertmanager</span><br><span class="line">    <span class="attribute">namespace</span>: monitoring</span><br><span class="line"><span class="attribute">data</span>:</span><br><span class="line">  config.<span class="attribute">yml</span>: |-</span><br><span class="line">    <span class="attribute">global</span>:</span><br><span class="line">      <span class="attribute">smtp_smarthost</span>:  <span class="string">'smtp.idcsec.com:25'</span> # Email SMTP 服务器信息</span><br><span class="line">      <span class="attribute">smtp_from</span>:  <span class="string">'root@idcsec.com'</span></span><br><span class="line">      <span class="attribute">smtp_auth_username</span>:   <span class="string">'root@idcsec.com'</span></span><br><span class="line">      <span class="attribute">smtp_auth_password</span>:  <span class="string">'pwd'</span></span><br><span class="line">      <span class="attribute">resolve_timeout</span>: <span class="number">10</span>m</span><br><span class="line">      <span class="attribute">smtp_require_tls</span>: false          #是否开启 TLS</span><br><span class="line">    <span class="attribute">route</span>:                       # 路由规则配置将不同告警发送给指定人</span><br><span class="line">      <span class="attribute">group_by</span>: [<span class="string">'alertname'</span>]         # 告警压缩规则</span><br><span class="line">      <span class="attribute">repeat_interval</span>: <span class="number">24</span>h</span><br><span class="line">      <span class="attribute">receiver</span>: monitoring       #默认发送到 <span class="built_in">`monitoring`</span>，该 monitoring 必须存在，否则报错退出</span><br><span class="line">       <span class="attribute">routes</span>:               # 子路由告警级别分别发给不同的接收器</span><br><span class="line">       - <span class="attribute">match</span>:</span><br><span class="line">         <span class="attribute">team</span>:dba      #匹配prometheus的rule_files文件中的labels</span><br><span class="line">         <span class="attribute">receiver</span>: db-team-email   receiver接收器名称 全局唯一</span><br><span class="line">         <span class="attribute">continue</span>: true               # 默认告警匹配成功第一个 receivers 会退出匹配，开启 continue 参数后会继续匹配 receivers 列表</span><br><span class="line">         </span><br><span class="line">    <span class="attribute">receivers</span>:                         # 接收器</span><br><span class="line">    - <span class="attribute">name</span>: <span class="string">'monitoring'</span></span><br><span class="line">      <span class="attribute">email_configs</span>:</span><br><span class="line">      - <span class="attribute">send_resolved</span>: true  #告警恢复后否发送通知，这里选择发送</span><br><span class="line">       <span class="attribute">to</span>: <span class="string">'test@idcsec.com'</span> #接收邮件<span class="string">'A@.com,B@com'</span></span><br><span class="line">    - <span class="attribute">name</span>: <span class="string">'db-team-email'</span></span><br><span class="line">     <span class="attribute">email_configs</span>:</span><br><span class="line">     - <span class="attribute">send_resolved</span>: true</span><br><span class="line">       <span class="attribute">to</span>:<span class="string">'xxx@xxx.com'</span></span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="alertmanager-yaml_u6587_u4EF6"><a href="#alertmanager-yaml_u6587_u4EF6" class="headerlink" title="alertmanager.yaml文件"></a>alertmanager.yaml文件</h1><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: <span class="string">"3"</span></span><br><span class="line">  creationTimestamp: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">  generation: <span class="number">3</span></span><br><span class="line">  labels:</span><br><span class="line">    app: alertmanager</span><br><span class="line">  name: alertmanager</span><br><span class="line">  <span class="keyword">namespace</span>: monitoring</span><br><span class="line">  resourceVersion: <span class="string">"43603292"</span></span><br><span class="line">  selfLink: /apis/extensions/v1beta1/namespaces/monitoring/deployments/alertmanager</span><br><span class="line">  uid: c3c75e6c-<span class="number">94</span>c2-<span class="number">11e8</span>-b5ba-<span class="number">1866</span>daeddaa4</span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: <span class="number">1</span></span><br><span class="line">      maxUnavailable: <span class="number">1</span></span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  <span class="keyword">template</span>:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">      name: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - -config.file=/etc/alertmanager/config.yml</span><br><span class="line">        - -storage.path=/alertmanager</span><br><span class="line">        image: alertmanager:v0<span class="number">.7</span><span class="number">.1</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: alertmanager</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">9093</span></span><br><span class="line">          name: alertmanager</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        terminationMessagePath: /dev/termination-<span class="built_in">log</span></span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/alertmanager</span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: /etc/alertmanager-templates</span><br><span class="line">          name: templates-volume</span><br><span class="line">        - mountPath: /alertmanager</span><br><span class="line">          name: alertmanager</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: <span class="keyword">default</span>-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      terminationGracePeriodSeconds: <span class="number">30</span></span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: <span class="number">420</span></span><br><span class="line">          name: alertmanager</span><br><span class="line">        name: config-volume</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: <span class="number">420</span></span><br><span class="line">          name: alertmanager-templates</span><br><span class="line">        name: templates-volume</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: alertmanager</span><br><span class="line">status:</span><br><span class="line">  availableReplicas: <span class="number">1</span></span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">    lastUpdateTime: <span class="number">2018</span>-<span class="number">07</span>-<span class="number">31</span>T13:<span class="number">08</span>:<span class="number">06</span>Z</span><br><span class="line">    message: Deployment has minimum availability.</span><br><span class="line">    reason: MinimumReplicasAvailable</span><br><span class="line">    status: <span class="string">"True"</span></span><br><span class="line">    type: Available</span><br><span class="line">  observedGeneration: <span class="number">3</span></span><br><span class="line">  readyReplicas: <span class="number">1</span></span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  updatedReplicas: <span class="number">1</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>部署Prometheus alertmanager相关配置文件<br>在prometheus.yml中指定规则文件（可使用通配符，如rules/*.rules）这使用 rules.yaml</p><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> <span class="constant">ConfigMap</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line">  <span class="symbol">name:</span> prometheus-config</span><br><span class="line">  <span class="symbol">labels:</span></span><br><span class="line">    <span class="symbol">name:</span>  prometheus-config</span><br><span class="line">  <span class="symbol">namespace:</span> monitoring</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line">  prometheus.<span class="symbol">yml:</span> |</span><br><span class="line">    <span class="symbol">global:</span></span><br><span class="line">      <span class="symbol">scrape_interval:</span>     <span class="number">15</span>s</span><br><span class="line">      <span class="symbol">evaluation_interval:</span> <span class="number">15</span>s</span><br><span class="line">    <span class="symbol">alerting:</span></span><br><span class="line">      <span class="symbol">alertmanagers:</span></span><br><span class="line">        - <span class="symbol">static_configs:</span></span><br><span class="line">            - <span class="symbol">targets:</span> [<span class="string">"alertmanager:9093"</span>] <span class="comment"># AlertManager 地址与端口</span></span><br><span class="line">    <span class="symbol">rule_files:</span></span><br><span class="line">     - <span class="string">"rules.yml"</span></span><br><span class="line">    <span class="symbol">scrape_configs:</span></span><br><span class="line">    ..........</span><br><span class="line">  </span><br><span class="line">rules.<span class="symbol">yml:</span> |-</span><br><span class="line">    <span class="symbol">groups:</span></span><br><span class="line">    - <span class="symbol">name:</span> noah_pod.rules</span><br><span class="line">      <span class="symbol">rules:</span></span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_cpu_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> (sum by(name)(rate(container_cpu_usage_seconds_total&#123;image!=<span class="string">""</span>&#125;[<span class="number">5</span>m]))*<span class="number">100</span>) &gt; <span class="number">10</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">5</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">          <span class="symbol">service:</span> pods</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> <span class="constant">CPU</span> 资源利用率大于 <span class="number">75</span>% , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> <span class="constant">Dev</span> <span class="constant">CPU</span> 负载告警</span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_memory_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> sort_desc(avg by(name)(irate(container_memory_usage_bytes&#123;name!=<span class="string">""</span>&#125;[<span class="number">5</span>m]))*<span class="number">100</span>) &gt; <span class="number">1024</span>*<span class="number">10</span>^<span class="number">3</span>*<span class="number">2</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">10</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> <span class="constant">Memory</span> 资源利用率大于 <span class="number">2</span>G , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> <span class="constant">Dev</span> <span class="constant">Memory</span> 负载告警</span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Pod_all_network_receive_usage</span></span><br><span class="line">        <span class="symbol">expr:</span> sum by (name)(irate(container_network_receive_bytes_total&#123;container_name=<span class="string">"POD"</span>&#125;[<span class="number">1</span>m])) &gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">50</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">10</span>m</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critical</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">description:</span> 容器 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.name &#125;&#125;</span> network_receive 资源利用率大于 <span class="number">50</span>M , (current value is <span class="expansion">&#123;&#123; <span class="variable">$value</span> &#125;&#125;</span>)</span><br><span class="line">          <span class="symbol">summary:</span> network_receive 负载告警</span><br><span class="line">    - <span class="symbol">name:</span> <span class="constant">Oracle</span>.rules</span><br><span class="line">      <span class="symbol">rules:</span></span><br><span class="line">      - <span class="symbol">alert:</span> <span class="constant">Oracledb</span>-status</span><br><span class="line">        <span class="symbol">expr:</span> oracledb_up&#123;job=<span class="string">"oracle-198"</span>&#125;  == <span class="number">0</span></span><br><span class="line">        <span class="symbol">for:</span> <span class="number">60</span>s</span><br><span class="line">        <span class="symbol">labels:</span></span><br><span class="line">          <span class="symbol">severity:</span> critica</span><br><span class="line">          <span class="symbol">team:</span>dba</span><br><span class="line">        <span class="symbol">annotations:</span></span><br><span class="line">          <span class="symbol">summary:</span> 数据库 <span class="expansion">&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125;</span> 告警</span><br><span class="line">          <span class="symbol">description:</span> <span class="string">"数据库 &#123;&#123; $labels.instance &#125;&#125; 异常 (当前值: &#123;&#123; $value &#125;&#125;"</span></span><br></pre></td></tr></table></figure><p>更新prometheus的配置需要让重新读取，有两种方法：<br>1、通过HTTP API向/-/reload发送POST请求，例：curl -X POST <a href="http://ip:9090/-/reload" target="_blank" rel="external">http://ip:9090/-/reload</a><br>2、向prometheus进程发送SIGHUP信号<br><img src="/img/p1.png" alt="crt"><br><img src="/img/p2.png" alt="crt"><br><img src="/img/p3.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>解决ingress-nginx反向代理在监听非80端口时候跳转问题以及Nginx</title>
      <link href="/2018/09/16/%E8%A7%A3%E5%86%B3ingress-nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%9C%A8%E7%9B%91%E5%90%AC%E9%9D%9E80%E7%AB%AF%E5%8F%A3%E6%97%B6%E5%80%99%E8%B7%B3%E8%BD%AC%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8ANginx/"/>
      <url>/2018/09/16/%E8%A7%A3%E5%86%B3ingress-nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%9C%A8%E7%9B%91%E5%90%AC%E9%9D%9E80%E7%AB%AF%E5%8F%A3%E6%97%B6%E5%80%99%E8%B7%B3%E8%BD%AC%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8ANginx/</url>
      
        <content type="html"><![CDATA[<ul><li>解决方法比较多主要根据自己的环境找到合适的解决方式，ingress-nginx默认监听443,80，这里的环境主要是因为路由器映射到非80端口导致跳转的Heather的Request丢失端口跳转到了默认的80<br>参考<br><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" target="_blank" rel="external">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect</a><br><a href="https://www.nginx.com/resources/wiki/start/topics/examples/fullexample2/" target="_blank" rel="external">https://www.nginx.com/resources/wiki/start/topics/examples/fullexample2/</a><br><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-redirect" target="_blank" rel="external">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-redirect</a><h1 id="nginx_u914D_u7F6E"><a href="#nginx_u914D_u7F6E" class="headerlink" title="nginx配置"></a>nginx配置</h1><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream tomcat &#123;</span><br><span class="line">    server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9090</span> weight=<span class="number">1</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name example.com *.example.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_next_upstream http_502 http_504 error timeout invalid_header;</span><br><span class="line"></span><br><span class="line">      proxy_set_header Host  <span class="variable">$host</span>:<span class="variable">$server</span>_port;</span><br><span class="line">      proxy_set_header X-Real-IP <span class="variable">$remote</span>_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For <span class="variable">$proxy</span>_add_x_forwarded_for;</span><br><span class="line">      proxy_redirect http://<span class="variable">$host</span> http://<span class="variable">$host</span>:<span class="variable">$server</span>_port;//由于是路由器上面配置映射非<span class="number">80</span>端口到<span class="number">80</span>端口这里就不能使用<span class="variable">$server</span>_port需要直接写端口号</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="ingress-nginx_u914D_u7F6E"><a href="#ingress-nginx_u914D_u7F6E" class="headerlink" title="ingress-nginx配置"></a>ingress-nginx配置</h1><p>默认ingress-nginx 代理重定向是OFF<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master ~]<span class="preprocessor"># kubectl exec -it nginx-ingress-controller-<span class="number">1971110253</span>-<span class="number">0</span>rcjw  -n kube-system -- cat /etc/nginx/nginx.conf   | grep <span class="string">"proxy_redirect"</span> | head -n <span class="number">1</span></span></span><br><span class="line">            proxy_redirect                          off;</span><br></pre></td></tr></table></figure></p><h1 id="ingress_u4EE3_u7406_u91CD_u5B9A_u5411_u914D_u7F6E"><a href="#ingress_u4EE3_u7406_u91CD_u5B9A_u5411_u914D_u7F6E" class="headerlink" title="ingress代理重定向配置"></a>ingress代理重定向配置</h1><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kind:</span> Ingress</span><br><span class="line"><span class="string">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="label">  name:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">  annotations:</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-redirect-<span class="string">from:</span> <span class="string">"test.cn:9090"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-redirect-<span class="string">to:</span> <span class="string">"test.cn:9090"</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="label">  rules:</span></span><br><span class="line">  - <span class="string">host:</span>  $&#123;projectUrl&#125;</span><br><span class="line"><span class="label">    http:</span></span><br><span class="line"><span class="label">      paths:</span></span><br><span class="line">      - <span class="string">path:</span> /</span><br><span class="line"><span class="label">        backend:</span></span><br><span class="line"><span class="label">          serviceName:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">          servicePort:</span> <span class="number">80</span></span><br><span class="line">  - <span class="string">host:</span> $&#123;projectUrl<span class="regexp">/test.loca/</span>test.cn&#125;</span><br><span class="line"><span class="label">    http:</span> </span><br><span class="line"><span class="label">      paths:</span> </span><br><span class="line">      - <span class="string">path:</span> /</span><br><span class="line"><span class="label">        backend:</span></span><br><span class="line"><span class="label">          serviceName:</span> $&#123;projectSvc&#125;</span><br><span class="line"><span class="label">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><ul><li>重点</li></ul><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/proxy-redirect-from: <span class="string">"idcsec.com"</span></span><br><span class="line">nginx<span class="class">.ingress</span><span class="class">.kubernetes</span><span class="class">.io</span>/proxy-redirect-to: <span class="string">"idcsec.com"</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ingress-nginx </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HARBOR仓库安装部署</title>
      <link href="/2018/09/14/HARBOR%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/09/14/HARBOR%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="Harbor__u4ECB_u7ECD"><a href="#Harbor__u4ECB_u7ECD" class="headerlink" title="<strong> Harbor 介绍</strong>"></a><strong> Harbor 介绍</strong></h1><p>Harbor 是 Vmwar 公司开源的 企业级的 Docker Registry 管理项目<br>它主要 提供 Dcoker Registry 管理UI，可基于角色访问控制, AD/LDAP 集成，日志审核等功能，完全的支持中文。<br>Harbor 的所有组件都在 Dcoker 中部署，所以 Harbor 可使用 Docker Compose 快速部署。<br>安装方式:<br>-在线安装程序：安装程序从Docker hub下载Harbor的图像。因此，安装程序的尺寸非常小。</p><p>-脱机安装程序：当主机没有Internet连接时使用此安装程序。安装程序包含预先构建的图像，因此其大小更大。</p><h2 id="harbor__u90E8_u7F72"><a href="#harbor__u90E8_u7F72" class="headerlink" title="harbor 部署"></a>harbor 部署</h2><p>开源项目地址：<a href="https://github.com/vmware/harbor" target="_blank" rel="external">https://github.com/vmware/harbor</a><br>官方安装说明：<a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a></p><h1 id="Docker_u5B89_u88C5"><a href="#Docker_u5B89_u88C5" class="headerlink" title="Docker安装"></a>Docker安装</h1><h2 id="u5378_u8F7D_u8001docker_u7248_u672C"><a href="#u5378_u8F7D_u8001docker_u7248_u672C" class="headerlink" title="卸载老docker版本"></a>卸载老docker版本</h2><figure class="hljs highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker <span class="string">\</span></span><br><span class="line">                  docker-client <span class="string">\</span></span><br><span class="line">                  docker-client-latest <span class="string">\</span></span><br><span class="line">                  docker-common <span class="string">\</span></span><br><span class="line">                  docker-latest <span class="string">\</span></span><br><span class="line">                  docker-latest-logrotate <span class="string">\</span></span><br><span class="line">                  docker-logrotate <span class="string">\</span></span><br><span class="line">                  docker-selinux <span class="string">\</span></span><br><span class="line">                  docker-engine-selinux <span class="string">\</span></span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure><h3 id="u5B89_u88C5_docker_repository"><a href="#u5B89_u88C5_docker_repository" class="headerlink" title="安装 docker repository"></a>安装 docker repository</h3><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -<span class="keyword">y</span> yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --<span class="built_in">add</span>-repo \</span><br><span class="line">    http<span class="variable">s:</span>//download.docker.<span class="keyword">com</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">$ yum <span class="keyword">list</span> docker-<span class="keyword">ce</span> --showduplicates | <span class="built_in">sort</span> -<span class="keyword">r</span></span><br><span class="line">$ sudo yum install docker-<span class="keyword">ce</span> -<span class="keyword">y</span></span><br><span class="line">$ systemctl   start docker</span><br></pre></td></tr></table></figure><p>安装docker-compose<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro harbor-<span class="number">1.5</span><span class="number">.3</span>]<span class="preprocessor"># yum install python2-pip -y &amp;&amp; yum install docker-compose -y</span></span><br></pre></td></tr></table></figure></p><h4 id="u4FEE_u6539docker_u52A0_u901F"><a href="#u4FEE_u6539docker_u52A0_u901F" class="headerlink" title="修改docker加速"></a>修改docker加速</h4><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [ <span class="string">"https://registry.docker-cn.com"</span>,], </span><br><span class="line">  <span class="string">"max-concurrent-downloads"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-level"</span>: <span class="string">"warn"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"10m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="u90E8_u7F72harbor"><a href="#u90E8_u7F72harbor" class="headerlink" title="部署harbor"></a>部署harbor</h1><h2 id="u4E0B_u8F7D_u5B89_u88C5_u5305_u5E76_u89E3_u538B_uFF1A"><a href="#u4E0B_u8F7D_u5B89_u88C5_u5305_u5E76_u89E3_u538B_uFF1A" class="headerlink" title="下载安装包并解压："></a>下载安装包并解压：</h2><figure class="hljs highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># wget https://storage.googleapis.com/harbor-releases/release-1.6.0/harbor-online-installer-v1.6.0.tgz</span></span><br><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># tar -zxvf harbor-online-installer-v1.6.0.tgz</span></span><br><span class="line">[root<span class="constant">@Pro</span> ~]<span class="preprocessor"># vi harbor/harbor.cfg</span></span><br></pre></td></tr></table></figure><h3 id="u4FEE_u6539harbor_u914D_u7F6E"><a href="#u4FEE_u6539harbor_u914D_u7F6E" class="headerlink" title="修改harbor配置"></a>修改harbor配置</h3><figure class="hljs highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[root@Pro ~]</span><span class="comment"># vi harbor/harbor.cfg </span></span><br><span class="line"><span class="comment"># hostname 设置访问地址，支持IP，域名，主机名，禁止设置127.0.0.1</span></span><br><span class="line"><span class="setting">hostname =<span class="value">harbor.idcsec.com</span></span></span><br><span class="line"><span class="comment"># 访问协议，可设置 http,https</span></span><br><span class="line"><span class="setting">ui_url_protocol = <span class="value">http</span></span></span><br><span class="line"><span class="comment"># harbor WEB UI登陆使用的密码</span></span><br><span class="line"><span class="setting">harbor_admin_password = <span class="value">Harbor12345</span></span></span><br><span class="line"><span class="comment"># 认证方式，这里支持多种认证方式，默认是 db_auth ，mysql数据库存储认证。</span></span><br><span class="line"><span class="comment"># 支持 ldap 以及 本地文件存储方式。</span></span><br><span class="line"><span class="setting">auth_mode = <span class="value">db_auth</span></span></span><br><span class="line"><span class="comment"># mysql root 账户的 密码</span></span><br><span class="line"><span class="setting">db_password = <span class="value">root123</span></span></span><br><span class="line"><span class="setting">self_registration= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">use_compressed_js= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">max_job_workers= <span class="value"><span class="number">10</span></span></span></span><br><span class="line"><span class="setting">verify_remote_cert= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="setting">customize_crt= <span class="value"><span class="keyword">on</span></span></span></span><br><span class="line"><span class="comment">#其他的参数可以保持默认</span></span><br></pre></td></tr></table></figure><p><strong> 配置存储后端（可选）</strong><br>默认情况下，Harbor将图像存储在本地文件系统中。在生产环境中，您可以考虑使用其他存储后端而不是本地文件系统，如S3，OpenStack Swift，Ceph等。您需要更新的是storage文件中的部分common/templates/registry/config.yml</p><h4 id="u5B89_u88C5harbor"><a href="#u5B89_u88C5harbor" class="headerlink" title="安装harbor"></a>安装harbor</h4><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro ~]<span class="preprocessor"># ./harbor/install.sh </span></span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker-compose ps</span></span><br><span class="line">       Name                     Command               State                                Ports                              </span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                      </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      <span class="number">5432</span>/tcp                                                        </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                      </span><br><span class="line">harbor-<span class="built_in">log</span>           /bin/sh -c /usr/local/bin/ ...   Up      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1514</span>-&gt;<span class="number">10514</span>/tcp                                       </span><br><span class="line">harbor-ui            /harbor/start.sh                 Up                                                                      </span><br><span class="line">nginx                nginx -g daemon off;             Up      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">443</span>-&gt;<span class="number">443</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4443</span>-&gt;<span class="number">4443</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      <span class="number">6379</span>/tcp                                                        </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      <span class="number">5000</span>/tcp</span><br></pre></td></tr></table></figure><h5 id="u767B_u5F55_u4ED3_u5E93"><a href="#u767B_u5F55_u4ED3_u5E93" class="headerlink" title="登录仓库"></a>登录仓库</h5><figure class="hljs highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="property">@Pro</span> harbor]<span class="comment"># docker login  http://harbor.idcsec.com</span></span><br><span class="line"><span class="attribute">Username</span>: admin</span><br><span class="line"><span class="attribute">Password</span>: </span><br><span class="line">Error response <span class="keyword">from</span> <span class="attribute">daemon</span>: Get <span class="attribute">https</span>:<span class="pi">//harbor.idcsec.com/v2/: dial tcp 47.94.253.198:443: connect: connection refused</span><br><span class="line">//</span>配置的是http，docker login默认走的是https.</span><br><span class="line">[root<span class="property">@Pro</span> ~]<span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://registry.docker-cn.com"</span>, <span class="string">"https://docker.mirrors.ustc.edu.cn"</span>], </span><br><span class="line"> <span class="string">"insecure-registries"</span>:[<span class="string">"harbor.idcsec.com"</span>],</span><br><span class="line">  <span class="string">"max-concurrent-downloads"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-level"</span>: <span class="string">"warn"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"10m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root<span class="property">@Pro</span> harbor]<span class="comment"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span></span><br></pre></td></tr></table></figure><h1 id="u6D4B_u8BD5push_u955C_u50CF_u5230harbor"><a href="#u6D4B_u8BD5push_u955C_u50CF_u5230harbor" class="headerlink" title="测试push镜像到harbor"></a>测试push镜像到harbor</h1><figure class="hljs highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@Pro harbor]<span class="preprocessor"># docker login harbor.idcsec.com</span></span><br><span class="line"><span class="label">Username:</span> admin</span><br><span class="line"><span class="label">Password:</span> </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line"><span class="label">https:</span>//docs.docker.com/engine/reference/commandline/login/<span class="preprocessor">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker pull busybox</span></span><br><span class="line">Using default tag: latest</span><br><span class="line"><span class="label">latest:</span> Pulling from library/busybox</span><br><span class="line"><span class="number">8</span>c5a7da1afbc: Pull complete </span><br><span class="line"><span class="label">Digest:</span> sha256:cb63aa0641a885f54de20f61d152187419e8f6b159ed11a251a09d115fdff9bd</span><br><span class="line"><span class="label">Status:</span> Downloaded newer image for busybox:latest</span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker tag  busybox:latest harbor.idcsec.com/pro/busybox:latest</span></span><br><span class="line">[root@Pro harbor]<span class="preprocessor"># docker push   harbor.idcsec.com/pro/busybox:latest</span></span><br><span class="line">The <span class="keyword">push</span> refers to repository [harbor.idcsec.com/pro/busybox]</span><br><span class="line"><span class="label">f9d9e4e6e2f0:</span> Pushed </span><br><span class="line"><span class="label">latest:</span> digest: sha256:<span class="number">5e8</span>e0509e829bb8f990249135a36e81a3ecbe94294e7a185cc14616e5fad96bd size: <span class="number">527</span></span><br></pre></td></tr></table></figure><p><img src="/img/harbor1.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> harbor </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetes基于StorageClass的NFS动态卷</title>
      <link href="/2018/08/16/kubernetes%E5%9F%BA%E4%BA%8EStorageClass%E7%9A%84NFS%E5%8A%A8%E6%80%81%E5%8D%B7/"/>
      <url>/2018/08/16/kubernetes%E5%9F%BA%E4%BA%8EStorageClass%E7%9A%84NFS%E5%8A%A8%E6%80%81%E5%8D%B7/</url>
      
        <content type="html"><![CDATA[<p>NFS搭建略..</p><h1 id="u521B_u5EFAnfs_u6587_u4EF6"><a href="#u521B_u5EFAnfs_u6587_u4EF6" class="headerlink" title="创建nfs文件"></a>创建nfs文件</h1><p>安装部署<br><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="keyword">opt</span>/k8s-nfs-storage</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"/opt/k8s-nfs-storage *(rw,no_root_squash,no_all_squash,sync)"</span> &gt; /etc/exports</span><br><span class="line">exportfs  -vr</span><br></pre></td></tr></table></figure></p><p>所需要的yaml文件github：<br>修改deployment文件并部署deployment.yaml<br>需要修改的地方只有NFS服务器所在的IP地址（192.168.7.206），以及NFS服务器共享的路径（/opt/k8s-nfs-storage），两处都需要修改为你实际的NFS服务器和共享目录<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: nfs-client-provisioner</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">strategy</span>:</span><br><span class="line">    <span class="attribute">type</span>: Recreate</span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">app</span>: nfs-client-provisioner</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">serviceAccountName</span>: nfs-client-provisioner</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">        - <span class="attribute">name</span>: nfs-client-provisioner</span><br><span class="line">          <span class="attribute">image</span>: <span class="number">192.168</span>.<span class="number">19.111</span>/gc/<span class="attribute">nfs-client-provisioner</span>:latest</span><br><span class="line">          <span class="attribute">volumeMounts</span>:</span><br><span class="line">            - <span class="attribute">name</span>: nfs-client-root</span><br><span class="line">              <span class="attribute">mountPath</span>: /persistentvolumes</span><br><span class="line">          <span class="attribute">env</span>:</span><br><span class="line">            - <span class="attribute">name</span>: PROVISIONER_NAME</span><br><span class="line">              <span class="attribute">value</span>: idcsec.lan/nfs</span><br><span class="line">            - <span class="attribute">name</span>: NFS_SERVER</span><br><span class="line">              <span class="attribute">value</span>: <span class="number">192.168</span>.<span class="number">7.206</span></span><br><span class="line">            - <span class="attribute">name</span>: NFS_PATH</span><br><span class="line">              <span class="attribute">value</span>: /opt/k8s-nfs-storage</span><br><span class="line">      <span class="attribute">volumes</span>:</span><br><span class="line">        - <span class="attribute">name</span>: nfs-client-root</span><br><span class="line">          <span class="attribute">nfs</span>:</span><br><span class="line">            <span class="attribute">server</span>: <span class="number">192.168</span>.<span class="number">7.206</span></span><br><span class="line">            <span class="attribute">path</span>: /opt/k8s-nfs-storage</span><br></pre></td></tr></table></figure></p><p>修改StorageClass文件并部署class.yaml<br>此处可以不修改，或者修改provisioner的名字，需要与上面的deployment的PROVISIONER_NAME名字一致。<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: storage.k8s.io/v1</span><br><span class="line"><span class="attribute">kind</span>: StorageClass</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: k8s-nfs-storage</span><br><span class="line"><span class="attribute">provisioner</span>: idcsec.lan/nf</span><br></pre></td></tr></table></figure></p><p>授权<br>RBAC授权文件在auth目录下面<br>如果您的集群启用了RBAC，必须授权provisioner。<br>设置 k8s-nfs-storage作为默认存储类<br><figure class="hljs highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass  k8s-nfs-storage -p <span class="string">'&#123;"</span>metadata<span class="string">": &#123;"</span>annotations<span class="string">":&#123;"</span><span class="transposed_variable">storageclass.</span><span class="transposed_variable">kubernetes.</span>io/is-default-class<span class="string">":"</span>true<span class="string">"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/nfs1.png" alt="crt"><br>实例：<br><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: apps/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: StatefulSet</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: k8sapp</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">serviceName</span>: <span class="string">"k8sapp"</span></span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">volumeClaimTemplates</span>:</span><br><span class="line">  - <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">name</span>: test </span><br><span class="line">      <span class="attribute">annotations</span>:</span><br><span class="line">        volume.beta.kubernetes.io/<span class="attribute">storage-class</span>: <span class="string">"k8s-nfs-storage"</span></span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">accessModes</span>: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      <span class="attribute">resources</span>:</span><br><span class="line">        <span class="attribute">requests</span>:</span><br><span class="line">          <span class="attribute">storage</span>: <span class="number">2</span>Gi</span><br></pre></td></tr></table></figure></p><p><img src="/img/nfs2.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetes1.11安装Helm管理部署Kubernetes应用</title>
      <link href="/2018/08/14/kubernetes1-11%E5%AE%89%E8%A3%85Helm%E7%AE%A1%E7%90%86%E9%83%A8%E7%BD%B2Kubernetes%E5%BA%94%E7%94%A8/"/>
      <url>/2018/08/14/kubernetes1-11%E5%AE%89%E8%A3%85Helm%E7%AE%A1%E7%90%86%E9%83%A8%E7%BD%B2Kubernetes%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Helm__u57FA_u672C_u6982_u5FF5"><a href="#Helm__u57FA_u672C_u6982_u5FF5" class="headerlink" title="Helm 基本概念"></a>Helm 基本概念</h1><p>Helm 可以理解为 Kubernetes 的包管理工具，可以方便地发现、共享和使用为Kubernetes构建的应用，它包含几个基本概念</p><p>Chart：一个 Helm 包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含 Kubernetes 集群中的服务定义，类似 Homebrew 中的 formula，APT 的 dpkg 或者 Yum 的 rpm 文件，<br>Release: 在 Kubernetes 集群上运行的 Chart 的一个实例。在同一个集群上，一个 Chart 可以安装很多次。每次安装都会创建一个新的 release。例如一个 MySQL Chart，如果想在服务器上运行两个数据库，就可以把这个 Chart 安装两次。每次安装都会生成自己的 Release，会有自己的 Release 名称。<br>Repository：用于发布和存储 Chart 的仓库。</p><h1 id="Helm__u7EC4_u4EF6"><a href="#Helm__u7EC4_u4EF6" class="headerlink" title="Helm 组件"></a>Helm 组件</h1><p>Helm 采用客户端/服务器架构，有如下组件组成：</p><p>Helm CLI 是 Helm 客户端，可以在本地执行<br>从最新<code>https://github.com/helm/helm/releases</code>，下载helm-v2.9.1-linux-amd64.tar.gz到本地，解压后把二进制直接放到环境PATH下即可<br>Tiller 是服务器端组件，在 Kubernetes 群集上运行，并管理 Kubernetes 应用程序的生命周期<br>Repository 是 Chart 仓库，Helm客户端通过HTTP协议来访问仓库中Chart的索引文件和压缩包。</p><h1 id="u5B89_u88C5Helm"><a href="#u5B89_u88C5Helm" class="headerlink" title="安装Helm"></a>安装Helm</h1><p>Helm 会利用 “gcr.io/kubernetes-helm/tiller” 镜像在Kubernetes集群上安装配置 Tiller；并且利用 “<a href="https://kubernetes-charts.storage.googleapis.com" target="_blank" rel="external">https://kubernetes-charts.storage.googleapis.com</a>“ 作为缺省的 stable repository 的地址。由于在国内可能无法访问 “gcr.io”, “storage.googleapis.com” 等域名.可以使用阿里云提供的table repository 的地址</p><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz</span></span><br><span class="line">tar -zxvf helm-v2<span class="number">.9</span><span class="number">.1</span>-linux-amd64.tar.gz &amp;&amp;\</span><br><span class="line">cp linux-amd64<span class="regexp">/helm /</span>opt<span class="regexp">/kube/</span>bin<span class="regexp">/ &amp;&amp; chmod +x /</span>opt<span class="regexp">/kube/</span>bin/helm</span><br></pre></td></tr></table></figure><p>执行下面命令安装<br>未使用SSL/TLS认证机制<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$helm init --upgrade -i <span class="number">192.168</span><span class="number">.19</span><span class="number">.111</span>/gc/tiller:v2<span class="number">.5</span><span class="number">.1</span> --stable-repo-url https:<span class="comment">//kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br><span class="line">kubectl get pod --all-namespaces|grep tiller</span><br></pre></td></tr></table></figure></p><p>若要查看在存储库中可用的所有 Helm charts<br><figure class="hljs highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="keyword">search</span>  <span class="comment">//看在存储库中可用的所有 Helm charts</span></span><br><span class="line">helm repo <span class="keyword">update</span>  <span class="comment">//更新charts列表以获取最新版本</span></span><br><span class="line">helm <span class="keyword">list</span> <span class="comment">//查看在群集上安装的Charts列表</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/helm1.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Caliconode-localhostlocaldomainisalreadyusingtheIPv4address问题</title>
      <link href="/2018/08/14/Caliconode-localhostlocaldomainisalreadyusingtheIPv4address%E9%97%AE%E9%A2%98/"/>
      <url>/2018/08/14/Caliconode-localhostlocaldomainisalreadyusingtheIPv4address%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>   Calico报错 Calico node ‘localhost.localdomain’ is already using the IPv4 addressx.x.x.x解决<br>服务器之前改名了hostname没有重启部署完etcd、Calico node。后来重启导致k8sCalico node起不来。<br>报错大楷是由于etcd内存储了之前hostname(localhost.localdomain)的的记录导致现在ip和之前冲突，不能自动删除重建<br>查看日志信息<br><figure class="hljs highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  logs   calico-<span class="keyword">node</span><span class="identifier"></span><span class="title">-8w7tv</span> -c  calico-<span class="keyword">node</span><span class="identifier">  </span><span class="title">-n</span> kube-system -f</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc2.png" alt="crt"></p><p>v3没有ls使用get替代</p><p>查看etcd信息<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$export</span> <span class="constant">ETCDCTL_API</span>=<span class="number">3</span></span><br><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.92:2379,https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  get  /</span> --prefix --keys-only | grep localhost</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc1.png" alt="crt"><br>删除之前存储的信息<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="symbol">https:</span>/<span class="regexp">/192.168.7.92:2379,https:/</span><span class="regexp">/192.168.7.93:2379,https:/</span><span class="regexp">/192.168.7.94:2379   --cacert=/etc</span><span class="regexp">/kubernetes/ssl</span><span class="regexp">/ca.pem   --cert=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem   --key=/etc</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem  get /</span> --prefix --keys-only | grep localhost | xargs -<span class="constant">I</span> &#123;&#125; etcdctl del &#123;&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/img/etc3.png" alt="crt"></p><p>重启caliconode pod恢复正常<br><img src="/img/etc4.png" alt="crt"></p>]]></content>
      
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Kubernetes1.11 nginx-ingress安装部署</title>
      <link href="/2018/08/09/Kubernetes1-11-nginx-ingress%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/09/Kubernetes1-11-nginx-ingress%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="u90E8_u7F72Ingress"><a href="#u90E8_u7F72Ingress" class="headerlink" title="部署Ingress"></a>部署Ingress</h1><p>ingress的部署文件在kubernetes Ingress 修改nodeselector 指定nodes上。<br><code>Pod.spec.nodeSelector</code>是通过kubernetes的label-selector机制进行节点选择，由scheduler调度策略<code>MatchNodeSelector</code>进行label匹配，调度pod到目标节点，该匹配规则是强制约束。启用节点选择器的步骤为:</p><h2 id="Node_u6DFB_u52A0label_u6807_u8BB0"><a href="#Node_u6DFB_u52A0label_u6807_u8BB0" class="headerlink" title="Node添加label标记"></a>Node添加label标记</h2><p>查询lable<br><figure class="hljs highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes --show-labels</span><br><span class="line">标记规则：kubectl <span class="keyword">label</span> nodes <span class="variable">&lt;node-name&gt;</span> <span class="variable">&lt;label-key&gt;</span>=<span class="variable">&lt;label-value&gt;</span></span><br><span class="line">kubectl <span class="keyword">label</span> node <span class="number">192.168</span>.<span class="number">7.93</span> role=nginx-ingress</span><br></pre></td></tr></table></figure></p><p><img src="/img/ingress1.png" alt="crt"><br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">镜像v0<span class="number">.17</span><span class="number">.1</span>:docker pull wtingdocker/nginx-ingress-controller</span><br><span class="line">https:<span class="comment">//github.com/kubernetes/ingress-nginx/releases</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="u90E8_u7F72_u90E8_u7F72default_backend__u90E8_u7F72nginx-ingress-controller-yaml"><a href="#u90E8_u7F72_u90E8_u7F72default_backend__u90E8_u7F72nginx-ingress-controller-yaml" class="headerlink" title="部署部署default backend 部署nginx-ingress-controller.yaml"></a>部署部署default backend 部署nginx-ingress-controller.yaml</h2><p>修改<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> kubectl label nodes  <span class="number">192.168</span><span class="number">.7</span><span class="number">.93</span>  kubernetes.io/app=nginx-ingress</span><br><span class="line">nodeSelector:</span><br><span class="line">        kubernetes.io/app: nginx-ingress</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: default-http-backend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      -<span class="ruby"> <span class="symbol">name:</span> default-http-backend</span><br><span class="line"></span>        # Any image is permissible as long as:</span><br><span class="line">        # 1. It serves a 404 page at /</span><br><span class="line">        # 2. It serves 200 on a /healthz endpoint</span><br><span class="line">        image: 192.168.19.111/gc/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        -<span class="ruby"> <span class="symbol">containerPort:</span> <span class="number">8080</span></span><br><span class="line"></span>        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">port:</span> <span class="number">80</span></span><br><span class="line"></span>    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: default-http-backend</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">rules:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>      -<span class="ruby"> endpoints</span><br><span class="line"></span>      -<span class="ruby"> nodes</span><br><span class="line"></span>      -<span class="ruby"> pods</span><br><span class="line"></span>      -<span class="ruby"> secrets</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> nodes</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> services</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">"extensions"</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> ingresses</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> list</span><br><span class="line"></span>      -<span class="ruby"> watch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">        -<span class="ruby"> events</span><br><span class="line"></span>    verbs:</span><br><span class="line">        -<span class="ruby"> create</span><br><span class="line"></span>        -<span class="ruby"> patch</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">"extensions"</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> ingresses/status</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> update</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>      -<span class="ruby"> pods</span><br><span class="line"></span>      -<span class="ruby"> secrets</span><br><span class="line"></span>      -<span class="ruby"> namespaces</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>    resourceNames:</span><br><span class="line">      # Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span><br><span class="line">      # Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span><br><span class="line">      # This has to be adapted if you change either parameter</span><br><span class="line">      # when launching the nginx-ingress-controller.</span><br><span class="line">      -<span class="ruby"> <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span>      -<span class="ruby"> update</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> configmaps</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> create</span><br><span class="line"></span>  -<span class="ruby"> <span class="symbol">apiGroups:</span></span><br><span class="line"></span>      -<span class="ruby"> <span class="string">""</span></span><br><span class="line"></span>    resources:</span><br><span class="line">      -<span class="ruby"> endpoints</span><br><span class="line"></span>    verbs:</span><br><span class="line">      -<span class="ruby"> get</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">kind:</span> <span class="constant">ServiceAccount</span></span><br><span class="line"></span>    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  -<span class="ruby"> <span class="symbol">kind:</span> <span class="constant">ServiceAccount</span></span><br><span class="line"></span>    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">-<span class="ruby">--</span><br><span class="line"></span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx </span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: '10254'</span><br><span class="line">        prometheus.io/scrape: 'true'</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/app: nginx-ingress</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      containers:</span><br><span class="line">        -<span class="ruby"> <span class="symbol">name:</span> nginx-ingress-controller</span><br><span class="line"></span>          image: 192.168.19.111/gc/nginx-ingress-controller:0.17.1</span><br><span class="line">          args:</span><br><span class="line">            -<span class="ruby"> /nginx-ingress-controller</span><br><span class="line"></span>            -<span class="ruby"> --default-backend-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/default-http-backend</span><br><span class="line"></span>            -<span class="ruby"> --configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/nginx-configuration</span><br><span class="line"></span>            -<span class="ruby"> --tcp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/tcp-services</span><br><span class="line"></span>            -<span class="ruby"> --udp-services-configmap=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/udp-services</span><br><span class="line"></span>            -<span class="ruby"> --publish-service=<span class="variable">$(</span><span class="constant">POD_NAMESPACE</span>)/ingress-nginx</span><br><span class="line"></span>            -<span class="ruby"> --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line"></span>        nodeSelector:</span><br><span class="line">         role= "nginx-ingress" </span><br><span class="line">         securityContext:</span><br><span class="line">            capabilities:</span><br><span class="line">                drop:</span><br><span class="line">                -<span class="ruby"> <span class="constant">ALL</span></span><br><span class="line"></span>                add:</span><br><span class="line">                -<span class="ruby"> <span class="constant">NET_BIND_SERVICE</span></span><br><span class="line"></span>            # www-data -&gt; 33</span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            -<span class="ruby"> <span class="symbol">name:</span> <span class="constant">POD_NAME</span></span><br><span class="line"></span>              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            -<span class="ruby"> <span class="symbol">name:</span> <span class="constant">POD_NAMESPACE</span></span><br><span class="line"></span>              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">          -<span class="ruby"> <span class="symbol">name:</span> http</span><br><span class="line"></span>            containerPort: 80</span><br><span class="line">          -<span class="ruby"> <span class="symbol">name:</span> https</span><br><span class="line"></span>            containerPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br></pre></td></tr></table></figure><h3 id="u90E8_u7F72_ingress-nginx-svc-yaml"><a href="#u90E8_u7F72_ingress-nginx-svc-yaml" class="headerlink" title="部署 ingress-nginx.svc.yaml"></a>部署 ingress-nginx.svc.yaml</h3><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: ingress-nginx</span><br><span class="line">  <span class="attribute">namespace</span>: ingress-nginx</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">externalIPs</span>:</span><br><span class="line">  - <span class="number">192.168</span>.<span class="number">7.93</span></span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">  - <span class="attribute">name</span>: http</span><br><span class="line">    <span class="attribute">port</span>: <span class="number">80</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">80</span></span><br><span class="line">    <span class="attribute">protocol</span>: TCP</span><br><span class="line">  - <span class="attribute">name</span>: https</span><br><span class="line">    <span class="attribute">port</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">protocol</span>: TCP</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">app</span>: ingress-nginx</span><br></pre></td></tr></table></figure><p>可以看到ExternalIP的Service也是通过kube-proxy对外暴露的。192.168.7.93是nodeip。 可以通过反向代理HAproxy将边缘路由器或全局统一接入层的负载均衡器将到达公网ip的外网流量转发到内网ip上，外部通过域名访问集群中将会以ingress暴露的所有服务<br><img src="/img/ingress3.png" alt="crt"><br><img src="/img/ingress4.png" alt="crt"><br><img src="/img/ingress5.png" alt="crt"><br>也可以采用 hostNetwork: true 暴露ingress服务端口表示容器使用和宿主机一样的网络<br><code>...spec:      nodeSelector:        kubernetes.io/app: nginx-ingress      hostNetwork: true       serviceAccountName: nginx-ingress-serviceaccount      containers...</code><br><img src="/img/ingress6.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ingress </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Kubernetes Heapster安装部署</title>
      <link href="/2018/08/09/Kubernetes-Heapster%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/09/Kubernetes-Heapster%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p>默认安装的kubernetes没有统计 CPU 和内存Dashboard图表也没有显示，装上 Heapster 后就可以直观地看到各个组件的资源消耗情况，以及kubectl top 查看 nodes pod资源。Heapster已弃用。请考虑使用 metrics-server 和第三方指标管道来收集Prometheus格式的指标。<br>可以不安装influxdb    </p><h1 id="u6267_u884Cheapster-yaml_u6587_u4EF6"><a href="#u6267_u884Cheapster-yaml_u6587_u4EF6" class="headerlink" title="执行heapster.yaml文件"></a>执行heapster.yaml文件</h1><figure class="hljs highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">修改:</span> <span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">source=</span> <span class="comment">、</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sink、images</span></span><br></pre></td></tr></table></figure><a id="more"></a><figure class="hljs highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">---</span><br><span class="line"></span>apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="header">  namespace: kube-system</span><br><span class="line">---</span></span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line">subjects:</span><br><span class="line"><span class="code">  - kind: ServiceAccount</span></span><br><span class="line"><span class="code">    name: heapster</span></span><br><span class="line"><span class="code">    namespace: kube-system</span></span><br><span class="line">roleRef:</span><br><span class="line"><span class="code">  kind: ClusterRole</span></span><br><span class="line"><span class="code">  name: system:heapster</span></span><br><span class="line"><span class="header">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  replicas: 1</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    matchLabels:</span></span><br><span class="line"><span class="code">      k8s-app: heapster</span></span><br><span class="line"><span class="code">  template:</span></span><br><span class="line"><span class="code">    metadata:</span></span><br><span class="line"><span class="code">      labels:</span></span><br><span class="line"><span class="code">        task: monitoring</span></span><br><span class="line"><span class="code">        k8s-app: heapster</span></span><br><span class="line"><span class="code">    spec:</span></span><br><span class="line"><span class="code">      serviceAccountName: heapster</span></span><br><span class="line"><span class="code">      containers:</span></span><br><span class="line"><span class="code">      - name: heapster</span></span><br><span class="line"><span class="code">        #image: gcr.io/google_containers/heapster-amd64:v1.5.1</span></span><br><span class="line"><span class="code">        image: 192.168.19.111/gc/heapster-amd64:v1.5.1 </span></span><br><span class="line"><span class="code">        imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="code">        command:</span></span><br><span class="line"><span class="code">        - /heapster</span></span><br><span class="line"><span class="code">        - --source=kubernetes:https://kubernetes.default</span></span><br><span class="line"><span class="header">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086 </span><br><span class="line">---</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  labels:</span></span><br><span class="line"><span class="code">    task: monitoring</span></span><br><span class="line"><span class="code">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line"><span class="code">    # If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line"><span class="code">    #kubernetes.io/cluster-service: 'true'</span></span><br><span class="line"><span class="code">    kubernetes.io/name: Heapster</span></span><br><span class="line"><span class="code">  name: heapster</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  ports:</span></span><br><span class="line"><span class="code">  - port: 80</span></span><br><span class="line"><span class="code">    targetPort: 8082</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    k8s-app: heapster</span></span><br></pre></td></tr></table></figure><p>或者执行<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f <span class="symbol">https:</span>/<span class="regexp">/github.com/kubernetes</span><span class="regexp">/heapster/blob</span><span class="regexp">/master/deploy</span><span class="regexp">/kube-config/standalone</span><span class="regexp">/heapster-controller.yaml</span></span><br></pre></td></tr></table></figure></p><h1 id="u90E8_u7F72influxdb-yaml"><a href="#u90E8_u7F72influxdb-yaml" class="headerlink" title="部署influxdb.yaml"></a>部署influxdb.yaml</h1><figure class="hljs highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">---</span><br><span class="line"></span>apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  replicas: 1</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="code">    matchLabels:</span></span><br><span class="line"><span class="code">      k8s-app: influxdb</span></span><br><span class="line"><span class="code">  template:</span></span><br><span class="line"><span class="code">    metadata:</span></span><br><span class="line"><span class="code">      labels:</span></span><br><span class="line"><span class="code">        task: monitoring</span></span><br><span class="line"><span class="code">        k8s-app: influxdb</span></span><br><span class="line"><span class="code">    spec:</span></span><br><span class="line"><span class="code">      containers:</span></span><br><span class="line"><span class="code">      - name: influxdb</span></span><br><span class="line"><span class="code">        #image: gcr.io/google_containers/heapster-influxdb-amd64:v1.3.3</span></span><br><span class="line"><span class="code">        image: mirrorgooglecontainers/heapster-influxdb-amd64:v1.3.3</span></span><br><span class="line"><span class="code">        volumeMounts:</span></span><br><span class="line"><span class="code">        - mountPath: /data</span></span><br><span class="line"><span class="code">          name: influxdb-storage</span></span><br><span class="line"><span class="code">      volumes:</span></span><br><span class="line"><span class="code">      - name: influxdb-storage</span></span><br><span class="line"><span class="header">        emptyDir: &#123;&#125;</span><br><span class="line">---</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line"><span class="code">  labels:</span></span><br><span class="line"><span class="code">    task: monitoring</span></span><br><span class="line"><span class="code">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line"><span class="code">    # If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line"><span class="code">    # kubernetes.io/cluster-service: 'true'</span></span><br><span class="line"><span class="code">    kubernetes.io/name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  name: monitoring-influxdb</span></span><br><span class="line"><span class="code">  namespace: kube-system</span></span><br><span class="line">spec:</span><br><span class="line"><span class="code">  ports:</span></span><br><span class="line"><span class="code">  - port: 8086</span></span><br><span class="line"><span class="code">    targetPort: 8086</span></span><br><span class="line"><span class="code">    name: http</span></span><br><span class="line"><span class="code">  selector:</span></span><br><span class="line"><span class="header">    k8s-app: influxdb</span><br><span class="line">---</span></span><br></pre></td></tr></table></figure><p><img src="/img/heap1.png" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Activemq集群搭建ZooKeeper+LevelDB</title>
      <link href="/2018/07/16/Activemq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BAZooKeeper-LevelDB/"/>
      <url>/2018/07/16/Activemq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BAZooKeeper-LevelDB/</url>
      
        <content type="html"><![CDATA[<p>ZooKeeper搭建<br>略<br>MQ高可用集群部署<br>参考<a href="http://activemq.apache.org/replicated-leveldb-store.html" target="_blank" rel="external">http://activemq.apache.org/replicated-leveldb-store.html</a></p><table><thead><tr><th>ip</th><th>集群通信端口</th><th>openwire端口</th><th>管理端口</th></tr></thead><tbody><tr><td>192.168.1.100</td><td>61619</td><td>61616</td><td>8161</td></tr><tr><td>192.168.1.200</td><td>61619</td><td>61616</td></tr><tr><td>192.168.1.300</td><td>61619</td><td>61616</td></tr></tbody></table><h1 id="u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml"><a href="#u4E00_u3001_u4FEE_u6539_vim_conf/activemq-xml" class="headerlink" title="一、修改 vim conf/activemq.xml"></a>一、修改 vim conf/activemq.xml</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">所以节点brokerName必须一致</span><br><span class="line"> &lt;broker xmlns=<span class="string">"http://activemq.apache.org/schema/core"</span> brokerName=<span class="string">"mybroker"</span> dataDirectory=<span class="string">"$&#123;activemq.data&#125;"</span>&gt;</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="u4E8C_u3001_u6301_u4E45_u5316_u914D_u7F6E"><a href="#u4E8C_u3001_u6301_u4E45_u5316_u914D_u7F6E" class="headerlink" title="二、持久化配置"></a>二、持久化配置</h2><h2 id="node1-100"><a href="#node1-100" class="headerlink" title="node1.100"></a>node1.100</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">        &lt;replicatedLevelDB</span><br><span class="line">            directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">            replicas=<span class="string">"3"</span></span><br><span class="line">            bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">            zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">            zkPassword=<span class="string">""</span></span><br><span class="line">            hostname=<span class="string">"192.168.1.100"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">            zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">    &lt;/persistenceAdapter&gt;</span><br></pre></td></tr></table></figure><h2 id="node21-200"><a href="#node21-200" class="headerlink" title="node21.200"></a>node21.200</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">            &lt;replicatedLevelDB</span><br><span class="line">                directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">                replicas=<span class="string">"3"</span></span><br><span class="line">                bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">                zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">                zkPassword=<span class="string">""</span></span><br><span class="line">                hostname=<span class="string">"192.168.1.200"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">                zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">        &lt;/persistenceAdapter&gt;</span><br><span class="line">`</span><br></pre></td></tr></table></figure><h2 id="node31-300"><a href="#node31-300" class="headerlink" title="node31.300"></a>node31.300</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt;</span><br><span class="line">            &lt;replicatedLevelDB</span><br><span class="line">                directory=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span></span><br><span class="line">                replicas=<span class="string">"3"</span></span><br><span class="line">                bind=<span class="string">"tcp://0.0.0.0:61619"</span></span><br><span class="line">                zkAddress=<span class="string">"x.x.x.x:2181,x.x.x.x:2181,x.x.x.x:2181"</span></span><br><span class="line">                zkPassword=<span class="string">""</span></span><br><span class="line">                hostname=<span class="string">"192.168.1.300"</span> <span class="comment">//本机地址或者hostname</span></span><br><span class="line">                zkPath=<span class="string">"/activemq/leveldb-stores"</span> /&gt;</span><br><span class="line">        &lt;/persistenceAdapter&gt;</span><br></pre></td></tr></table></figure><h2 id="u542F_u52A8_u6240_u6709_u8282_u70B9activemq"><a href="#u542F_u52A8_u6240_u6709_u8282_u70B9activemq" class="headerlink" title="启动所有节点activemq"></a>启动所有节点activemq</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/apache-activemq-<span class="number">5.14</span><span class="number">.0</span>/bin/activemq start</span><br></pre></td></tr></table></figure><p>客户端失败转移连接<br>ActiveMQ的客户端只能访问Master的Broker,其他处于Slave的Broker不能访问，所以客户端连接的Broker应该使用failover协议(失败转移)<br><figure class="hljs highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mq.broker.url=failover:(tcp://<span class="number">192.168.1.100</span>:61616,tcp://<span class="number">192.168.1.200</span>:61616,tcp://<span class="number">192.168.1.30</span><span class="number">0:61616</span>)?randomize=false&amp;initialReconnectDelay=1000</span><br></pre></td></tr></table></figure></p><h1 id="u8BB0_u5F55_u90E8_u5206activemq-xml_u914D_u7F6E"><a href="#u8BB0_u5F55_u90E8_u5206activemq-xml_u914D_u7F6E" class="headerlink" title="记录部分activemq.xml配置"></a>记录部分activemq.xml配置</h1><figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">plugins</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">simpleAuthenticationPlugin</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">users</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;<span class="title">authenticationUser</span> <span class="attribute">username</span>=<span class="value">"$&#123;activemq.username&#125;"</span> <span class="attribute">password</span>=<span class="value">"$&#123;activemq.password&#125;"</span> <span class="attribute">groups</span>=<span class="value">"users,admins"</span>/&gt;</span>  //conf/credentials.properties </span><br><span class="line">true<span class="tag">&lt;<span class="title">authenticationUser</span> <span class="attribute">username</span>=<span class="value">"admin"</span> <span class="attribute">password</span>=<span class="value">"admin11111"</span> <span class="attribute">groups</span>=<span class="value">"users"</span>/&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;/<span class="title">users</span>&gt;</span>  </span><br><span class="line">true<span class="tag">&lt;/<span class="title">simpleAuthenticationPlugin</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="title">authorizationPlugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="title">map</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="title">authorizationMap</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="title">authorizationEntries</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"admins"</span> <span class="attribute">write</span>=<span class="value">"admins"</span> <span class="attribute">admin</span>=<span class="value">"admins"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"users"</span> <span class="attribute">write</span>=<span class="value">"users"</span> <span class="attribute">admin</span>=<span class="value">"users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"GUEST.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">queue</span>=<span class="value">"TEST.Q"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"&gt;"</span> <span class="attribute">read</span>=<span class="value">"admins"</span> <span class="attribute">write</span>=<span class="value">"admins"</span> <span class="attribute">admin</span>=<span class="value">"admins"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"USERS.&gt;"</span> <span class="attribute">read</span>=<span class="value">"users"</span> <span class="attribute">write</span>=<span class="value">"users"</span> <span class="attribute">admin</span>=<span class="value">"users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"GUEST.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="title">authorizationEntry</span> <span class="attribute">topic</span>=<span class="value">"ActiveMQ.Advisory.&gt;"</span> <span class="attribute">read</span>=<span class="value">"guests,users"</span> <span class="attribute">write</span>=<span class="value">"guests,users"</span> <span class="attribute">admin</span>=<span class="value">"guests,users"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="title">authorizationEntries</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="title">authorizationMap</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="title">map</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="title">authorizationPlugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="title">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><p>管理页面密码在jetty-realm.properties文件中修改</p>]]></content>
      
      
      <categories>
          
          <category> activemq </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>k8s statefulsets部署zookeeper</title>
      <link href="/2018/07/10/8s-statefulsets%E9%83%A8%E7%BD%B2zookeeper/"/>
      <url>/2018/07/10/8s-statefulsets%E9%83%A8%E7%BD%B2zookeeper/</url>
      
        <content type="html"><![CDATA[<h1 id="u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc"><a href="#u4F7F_u7528NFS_u914D_u7F6Epv_u3001pvc" class="headerlink" title="使用NFS配置pv、pvc"></a>使用NFS配置pv、pvc</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;root@centos-master pv]<span class="comment"># cat /etc/exports | grep /opt/zkdata/zk-data-</span></span><br><span class="line">/opt/zkdata/zk-data-<span class="number">0</span> *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/opt/zkdata/zk-data-<span class="number">1</span> *(rw,no_root_squash,no_all_squash,sync)</span><br><span class="line">/opt/zkdata/zk-data-<span class="number">2</span> *(rw,no_root_squash,no_all_squash,sync)</span><br></pre></td></tr></table></figure><h2 id="u521B_u5EFAk8spv_uFF1Apv-yaml"><a href="#u521B_u5EFAk8spv_uFF1Apv-yaml" class="headerlink" title="创建k8spv：pv.yaml"></a>创建k8spv：pv.yaml</h2><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">0</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi </span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - ReadWriteOnce </span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle </span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>: </span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">0</span> </span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br><span class="line">---</span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">1</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi</span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - RReadWriteOnce</span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle</span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>:</span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">1</span></span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br><span class="line">---</span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: PersistentVolume</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: datadir-zk-<span class="number">2</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">capacity</span>:</span><br><span class="line">    <span class="attribute">storage</span>: <span class="number">10</span>Gi</span><br><span class="line">  <span class="attribute">accessModes</span>:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  <span class="attribute">persistentVolumeReclaimPolicy</span>: Recycle</span><br><span class="line">  <span class="attribute">storageClassName</span>: slow</span><br><span class="line">  <span class="attribute">nfs</span>:</span><br><span class="line">    <span class="attribute">path</span>: /opt/zkdata/zk-data-<span class="number">2</span></span><br><span class="line">    <span class="attribute">server</span>: x.x.x.x</span><br><span class="line">    <span class="attribute">readOnly</span>: false</span><br></pre></td></tr></table></figure><p>kubectl  kubectl  create -f pv.yaml<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master pv]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME           CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE</span><br><span class="line">datadir-zk-<span class="number">0</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br><span class="line">datadir-zk-<span class="number">1</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br><span class="line">datadir-zk-<span class="number">2</span>   <span class="number">10</span>Gi       RWX           Recycle         Available             slow                     <span class="number">25</span>s</span><br></pre></td></tr></table></figure></p><a id="more"></a><h1 id="u521B_u5EFApvc_uFF1Apvc-yaml"><a href="#u521B_u5EFApvc_uFF1Apvc-yaml" class="headerlink" title="创建pvc：pvc.yaml"></a>创建pvc：pvc.yaml</h1><p>kubectl  create -f zkpvc.yaml<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@centos-master pv]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME           STATUS    VOLUME         CAPACITY   ACCESSMODES   STORAGECLASS   AGE</span><br><span class="line">datadir-zk-<span class="number">0</span>   Bound     datadir-zk-<span class="number">0</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br><span class="line">datadir-zk-<span class="number">1</span>   Bound     datadir-zk-<span class="number">1</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br><span class="line">datadir-zk-<span class="number">2</span>   Bound     datadir-zk-<span class="number">2</span>   <span class="number">10</span>Gi       RWX           slow           <span class="number">32</span>s</span><br></pre></td></tr></table></figure></p><h1 id="pull_u955C_u50CF"><a href="#pull_u955C_u50CF" class="headerlink" title="pull镜像"></a>pull镜像</h1><p>临时<br> docker pull wtingdocker/dockerfiletemplatempl<br> docker tag 名称<br> docker push私有仓库<br> 修改zookeeper.yaml镜像地址<br> <figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"> apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: zk-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">2888</span></span><br><span class="line">    name: server</span><br><span class="line">  - port: <span class="number">3888</span></span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cm</span><br><span class="line">data:</span><br><span class="line">  jvm.heap: <span class="string">"2G"</span></span><br><span class="line">  tick: <span class="string">"2000"</span></span><br><span class="line">  init: <span class="string">"10"</span></span><br><span class="line">  sync: <span class="string">"5"</span></span><br><span class="line">  client.cnxns: <span class="string">"60"</span></span><br><span class="line">  snap.retain: <span class="string">"3"</span></span><br><span class="line">  purge.interval: <span class="string">"0"</span></span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  minAvailable: <span class="number">2</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  serviceName: zk-svc</span><br><span class="line">  replicas: <span class="number">3</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values: </span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: k8szk</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="number">192.168</span><span class="number">.19</span><span class="number">.111</span>/zhph/k8szk:v3</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"4Gi"</span></span><br><span class="line">            cpu: <span class="string">"2"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">2181</span></span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: <span class="number">2888</span></span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: <span class="number">3888</span></span><br><span class="line">          name: leader-election</span><br><span class="line">        env:</span><br><span class="line">        - name : ZK_REPLICAS</span><br><span class="line">          value: <span class="string">"3"</span></span><br><span class="line">        - name : ZK_HEAP_SIZE</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: jvm.heap</span><br><span class="line">        - name : ZK_TICK_TIME</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_INIT_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: init</span><br><span class="line">        - name : ZK_SYNC_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_MAX_CLIENT_CNXNS</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: client.cnxns</span><br><span class="line">        - name: ZK_SNAP_RETAIN_COUNT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: snap.retain</span><br><span class="line">        - name: ZK_PURGE_INTERVAL</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-cm</span><br><span class="line">                key: purge.interval</span><br><span class="line">        - name: ZK_CLIENT_PORT</span><br><span class="line">          value: <span class="string">"2181"</span></span><br><span class="line">        - name: ZK_SERVER_PORT</span><br><span class="line">          value: <span class="string">"2888"</span></span><br><span class="line">        - name: ZK_ELECTION_PORT</span><br><span class="line">          value: <span class="string">"3888"</span></span><br><span class="line">        command:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - zkGenConfig.sh &amp;&amp; zkServer.sh start-foreground</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - <span class="string">"zkOk.sh"</span></span><br><span class="line">          initialDelaySeconds: <span class="number">10</span></span><br><span class="line">          timeoutSeconds: <span class="number">5</span></span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - <span class="string">"zkOk.sh"</span></span><br><span class="line">          initialDelaySeconds: <span class="number">10</span></span><br><span class="line">          timeoutSeconds: <span class="number">5</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /<span class="keyword">var</span>/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: <span class="number">1000</span></span><br><span class="line">        fsGroup: <span class="number">1000</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      storageClassName: slow</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: <span class="number">10</span>Gi</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-master ~]<span class="comment"># kubectl  get  pod  | grep zk-</span></span><br><span class="line">zk-<span class="number">0</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">zk-<span class="number">1</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">10</span>         <span class="number">29</span>m</span><br><span class="line">zk-<span class="number">2</span>                                                    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">14</span>s</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-0 -- sh  /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh: <span class="number">81</span>: /opt/zookeeper/bin/zkEnv.sh: Syntax error: <span class="string">"("</span> unexpected (expecting <span class="string">"fi"</span>)</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-0    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-1    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">[root@centos-master ~]<span class="comment"># kubectl exec -it   zk-2    /opt/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><p>ReadWriteOnce—将卷作为单个节点的读写挂载<br>ReadOnlyMany—将该卷安装为只读的许多节点。<br>ReadWriteMany——将卷作为许多节点的读写挂载</p>]]></content>
      
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>fastDFS+Nginx分布式图片服务器搭建</title>
      <link href="/2018/03/23/fastDFS-Nginx%E5%88%86%E5%B8%83%E5%BC%8F%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"/>
      <url>/2018/03/23/fastDFS-Nginx%E5%88%86%E5%B8%83%E5%BC%8F%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="u5B89_u88C5_u4F9D_u8D56_u5305"><a href="#u5B89_u88C5_u4F9D_u8D56_u5305" class="headerlink" title="安装依赖包"></a>安装依赖包</h1><p>系统：centos7.4<br><img src="/img/dfs8.png" alt="crt"><br>tracker和storage节点建议部署分别部署<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libevent</span><br><span class="line">yum install gcc-c++  openssl-devel  pcre-devel zlib-devel</span><br></pre></td></tr></table></figure></p><p>下载需要的包<br><a href="https://github.com/happyfish100" target="_blank" rel="external">https://github.com/happyfish100</a><br>nginx官网<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastdfs5<span class="number">.11</span>.zip</span><br><span class="line">fastdfs-nginx-module.zip</span><br><span class="line">libfastcommon.zip</span><br><span class="line">nginx-<span class="number">1.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure></p><h1 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h1><h2 id="libfastcommon"><a href="#libfastcommon" class="headerlink" title="libfastcommon"></a>libfastcommon</h2><p>首先第一步是安装libfastcommon<br>unzip libfastcommon-master.zip<br>解压成功后进入目录看一下压缩包的文件：<br><img src="/img/dfs1.png" alt="dfs"><br>解压完成后就可以进行编译安装了，执行./make.sh  &amp;&amp; ./make.sh  install<br><img src="/img/dfs2.png" alt="crt"><br>至此libfastcommon就已经安装成功了，但注意一下上图中红色框标注的内容，libfastcommon.so 默认安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以此处需要重新设置软链接<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/lib64/libfastcommon.so /usr/local/lib/libfastcommon.so</span><br><span class="line">ln -s /usr/lib64/libfastcommon.so /usr/lib/libfastcommon.so</span><br><span class="line">ln -s /usr/lib64/libfdfsclient.so /usr/local/lib/libfdfsclient.so</span><br><span class="line">ln -s /usr/lib64/libfdfsclient.so /usr/lib/libfdfsclient.so</span><br></pre></td></tr></table></figure></p><h1 id="u5B89_u88C5fastdfs"><a href="#u5B89_u88C5fastdfs" class="headerlink" title="安装fastdfs"></a>安装fastdfs</h1><p>unzip fastdfs5.11.zip<br>解压完成后进入目录 fastdfs-5.11，执行<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./make.sh  &amp;&amp; ./make.sh  install</span><br><span class="line">cd /etc/fdfs/</span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp client.conf.sample  client.conf</span></span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp storage.conf.sample storage.conf</span></span><br><span class="line">[root@hjlc-storage-nodeA fdfs]<span class="comment"># cp tracker.conf.sample tracker.conf</span></span><br></pre></td></tr></table></figure></p><p><img src="/img/dfs3.png" alt="crt"></p><h2 id="Tracker_u670D_u52A1_u914D_u7F6E"><a href="#Tracker_u670D_u52A1_u914D_u7F6E" class="headerlink" title="Tracker服务配置"></a>Tracker服务配置</h2><p>mkdir -p /home/hjlc/app/fastdfs/fastdfs_tracker<br>编辑/etc/fdfs目录下的tracker.conf配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">disabled=<span class="keyword">false</span> <span class="comment">#启用配置文件（默认启用）</span></span><br><span class="line">port=<span class="number">22122</span> <span class="comment">#设置tracker的端口号，通常采用22122这个默认端口</span></span><br><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_tracker <span class="comment">#设置tracker的数据文件和日志目录</span></span><br><span class="line">http.server_port=<span class="number">6666</span> <span class="comment">#设置http端口号，默认为8080这个不需要了</span></span><br></pre></td></tr></table></figure></p><p>为启动脚本创建软引用<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/fdfs_trackerd /usr/local/bin</span></span><br><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/stop.sh /usr/local/bin</span></span><br><span class="line">[root@hjlc-storage-nodeA fastdfs]<span class="comment"># ln -s /usr/bin/restart.sh /usr/local/bin</span></span><br><span class="line">启动tracker服务</span><br><span class="line">root@hjlc-storage-nodeA fastdfs]<span class="comment"># service  fdfs_trackerd start</span></span><br><span class="line">Reloading systemd:                                         [  OK  ]</span><br><span class="line">Starting fdfs_trackerd (via systemctl):                    [  OK  ]</span><br></pre></td></tr></table></figure></p><p>fastdfs_tracker中就可以看到启动后新生成的data和logs目录，tracker服务的端口也应当被正常监听，最后再通过netstat命令查看一下端口监听情况：<br><img src="/img/dfs4.png" alt="crt"><br>al<br>确认tracker正常启动后可以将tracker设置为开机启动，打开/etc/rc.d/rc.local并在其中加入以下配置：<br>service fdfs_trackerd start</p><h2 id="Storage_u670D_u52A1_u914D_u7F6E"><a href="#Storage_u670D_u52A1_u914D_u7F6E" class="headerlink" title="Storage服务配置"></a>Storage服务配置</h2><p>先是创建Storage服务器的文件目录，需要注意的是同Tracker相比我多建了一个目录，因为Storage还需要一个文件存储路径，用于存放接收的文件：<br>mkdir /home/hjlc/app/fastdfs/fastdfs_storage<br>mkdir /home/hjlc/app/fastdfs/fastdfs_storage_data</p><p>接下来修改/etc/fdfs目录下的storage.conf配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">disabled=<span class="keyword">false</span> <span class="comment">#启用配置文件（默认启用）</span></span><br><span class="line">group_name=group1 <span class="comment">#组名，根据实际情况修改</span></span><br><span class="line">port=<span class="number">23000</span> <span class="comment">#设置storage的端口号，默认是23000，同一个组的storage端口号必须一致</span></span><br><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_storage <span class="comment">#设置storage数据文件和日志目录</span></span><br><span class="line">store_path_count=<span class="number">1</span> <span class="comment">#存储路径个数，需要和store_path个数匹配</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data <span class="comment">#实际文件存储路径</span></span><br><span class="line">tracker_server=<span class="number">172.16</span><span class="number">.1</span><span class="number">.182</span>:<span class="number">22122</span> <span class="comment">#tracker 服务器的 IP地址和端口号，如果是单机搭建，IP不要写127.0.0.1，否则启动不成功</span></span><br><span class="line">http.server_port=<span class="number">8888</span> <span class="comment">#设置 http 端口号不需要</span></span><br></pre></td></tr></table></figure></p><p>配置完成后同样要为Storage服务器的启动脚本设置软引用：<br>ln -s /usr/bin/fdfs_storaged /usr/local/bin<br>启动Storage服务<br>service fdfs_storaged start<br>如果启动成功，/home/hjlc/app/fastdfs/fastdfs_storage中就可以看到启动后新生成的data和logs目录，端口23000也应被正常监听，还有一点就是文件存储路径下会生成多级存储目录，那么接下来看看是否启动成功了：<br><img src="/img/dfs5.png" alt="crt"><br><img src="/img/dfs6.png" alt="crt"><br>/usr/bin/fdfs_monitor /etc/fdfs/storage.conf<br><img src="/img/dfs7.png" alt="crt"><br>ACTIVE 字样即可说明storage服务器已经成功登记到了tracker服务器<br>开机启动，打开/etc/rc.d/rc.local并将如下配置追加到文件中：<br>echo “service fdfs_storage start” &gt;&gt; /etc/rc.d/rc.local</p><h1 id="u4E0A_u4F20_u6D4B_u8BD5"><a href="#u4E0A_u4F20_u6D4B_u8BD5" class="headerlink" title="上传测试"></a>上传测试</h1><p>编辑/etc/fdfs目录下的client.conf 文件<br>base_path=/home/hjlc/app/fastdfs/fastdfs_tracker #tracker服务器文件路径<br>tracker_server=172.16.1.182:22122 #tracker服务器IP地址和端口号<br>http.tracker_server_port=8080 # tracker 服务器的 http 端口号，必须和tracker的设置对应起来</p><p>然后通过执行客户端上传命令尝试上传：</p><p>[root@hjlc-storage-nodeA ~]# /usr/bin/fdfs_upload_file  /etc/fdfs/client.conf  ~/123.jpg<br>group1/M00/00/00/rBABtlqwYLWATj7XAABOLQixhsQ490.jpg</p><p>此时发现并不能访问，因为FastDFS目前已不支持http协议，我们在FastDFS 4.0.5的版本更新日志中可以看到这样一条信息：<br>使用FastDFS的模块fastdfs-nginx-module，下载地址如下：<a href="https://github.com/happyfish100/fastdfs-nginx-module，这样做最大的好处就是提供了HTTP服务并且解决了group中storage服务器的同步延迟问题" target="_blank" rel="external">https://github.com/happyfish100/fastdfs-nginx-module，这样做最大的好处就是提供了HTTP服务并且解决了group中storage服务器的同步延迟问题</a></p><h1 id="fastdfs-nginx-module+nginx_u5B89_u88C5"><a href="#fastdfs-nginx-module+nginx_u5B89_u88C5" class="headerlink" title="fastdfs-nginx-module+nginx安装"></a>fastdfs-nginx-module+nginx安装</h1><p>在安装nginx之前需要先安装一些模块依赖的lib库<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre pcre-devel  zlib zlib-devel  openssl openssl-devel</span><br></pre></td></tr></table></figure></p><p>storage nginx<br>首先是为storage服务器安装nginx，首先下载nginx和fastdfs-nginx-module的安装包<br> tar -zxvf nginx-1.12.2.tar.gz<br> unzip fastdfs-nginx-module.zip </p><p>解压成功后就可以编译安装nginx了，进入nginx目录<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@hjlc-storage-nodeA nginx-<span class="number">1.12</span><span class="number">.2</span>]<span class="comment"># ./configure --prefix=/home/hjlc/app/nginx --add-module=/root/fastdfs-nginx-module-master/src</span></span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>接下来要修改一下nginx的配置文件<br>server {<br>listen       9090;<br>server_name img.xxxx;<br>location ~/group1/M00 {<br>      root /home/hjlc/app/fastdfs/fastdfs_storage_data;<br>      ngx_fastdfs_module;<br>}<br>}<br>然后进入FastDFS的解压目录~/ fastdfs-5.11目录下的conf目录，将http.conf和mime.types拷贝到/etc/fdfs目录下<br>[root@hjlc-storage-nodeA fastdfs-5.11]# cp conf/http.conf /etc/fdfs/<br>[root@hjlc-storage-nodeA fastdfs-5.11]# cp conf/mime.types  /etc/fdfs/<br>把fastdfs-nginx-module解压目录中src目录下的mod_fastdfs.conf也拷贝到/etc/fdfs目录下：<br>[root@hjlc-storage-nodeA ~]# cp fastdfs-nginx-module-master/src/mod_fastdfs.conf  /etc/fdfs/<br>编辑刚拷贝的这个mod_fastdfs.conf文件了<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">base_path=/home/hjlc/app/fastdfs/fastdfs_storage <span class="comment">#保存日志目录</span></span><br><span class="line">tracker_server=<span class="number">172.16</span><span class="number">.1</span><span class="number">.182</span>:<span class="number">22122</span> <span class="comment">#tracker服务器的IP地址以及端口号</span></span><br><span class="line">storage_server_port=<span class="number">23000</span> <span class="comment">#storage服务器的端口号</span></span><br><span class="line">url_have_group_name = <span class="keyword">true</span> <span class="comment">#文件 url 中是否有 group 名</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data <span class="comment"># 存储路径</span></span><br><span class="line">group_count = <span class="number">3</span> <span class="comment">#设置组的个数，事实上这次只使用了group1</span></span><br><span class="line">设置了group_count = <span class="number">3</span>，接下来就需要在文件尾部追加这<span class="number">3</span>个group setting：</span><br><span class="line">group_count = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group settings for group #1</span></span><br><span class="line"><span class="comment"># since v1.14</span></span><br><span class="line"><span class="comment"># when support multi-group on this storage server, uncomment following section</span></span><br><span class="line">[group1]</span><br><span class="line">group_name=group1</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br><span class="line"></span><br><span class="line">[group2]</span><br><span class="line">group_name=group2</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br><span class="line"></span><br><span class="line">[group3]</span><br><span class="line">group_name=group3</span><br><span class="line">storage_server_port=<span class="number">23000</span></span><br><span class="line">store_path_count=<span class="number">1</span></span><br><span class="line">store_path0=/home/hjlc/app/fastdfs/fastdfs_storage_data</span><br></pre></td></tr></table></figure></p><p>接下来还需要建立 M00 至存储目录的符号连接：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ln  -s  /home/hjlc/app/fastdfs/fastdfs_storage_data/data  /home/hjlc/app/fastdfs/fastdfs_storage_data/data/M00</span><br><span class="line">[root@hjlc-storage-nodeA ~]<span class="comment"># /home/hjlc/app/nginx/sbin/nginx  -c /home/hjlc/app/nginx/conf/nginx.conf -t</span></span><br><span class="line">ngx_http_fastdfs_set pid=<span class="number">21138</span></span><br><span class="line">nginx: the configuration file /home/hjlc/app/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /home/hjlc/app/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure></p><p>节点2重复一遍storage服务安装和fastdfs-nginx-module+nginx安装即可，然后在安装一台Nginx发现代理服务器配置upstream代理，这我使用的SLB服务器就直接监听nodeA和nodeB的9090端口<br><img src="/img/1.jpg" alt="crt"></p>]]></content>
      
      
      <categories>
          
          <category> fastDFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastdfs </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>SecureCRT配置Cisco网络设备关键字高亮</title>
      <link href="/2018/02/27/ecureCRT%E9%85%8D%E7%BD%AECisco%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%85%B3%E9%94%AE%E5%AD%97%E9%AB%98%E4%BA%AE/"/>
      <url>/2018/02/27/ecureCRT%E9%85%8D%E7%BD%AECisco%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%85%B3%E9%94%AE%E5%AD%97%E9%AB%98%E4%BA%AE/</url>
      
        <content type="html"><![CDATA[<p>##效果图：<br><img src="/img/securecrt1.png" alt="crt"><br>下载思科关键字文件解C:\Users\Administrator\AppData\Roaming\VanDyke\Config\Keywords(根据自己的用户路径)<br>链接: <a href="https://pan.baidu.com/s/1c3BZb8k" target="_blank" rel="external">https://pan.baidu.com/s/1c3BZb8k</a> 密码: xv7h</p><p>##设置 options-eitdefault-appearance<br><img src="/img/securecrt2.png" alt="crt"></p><p>##设置配置文件路径options-Globaloptions<br><img src="/img/securecrt3.png" alt="crt"></p><p>#下拉菜单选择解压好的关键字文件<br><img src="/img/securecrt4.png" alt="crt"></p>]]></content>
      
      
      
        <tags>
            
            <tag> crt </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>解决Linux 出现大量TIME_WAIT连接问题</title>
      <link href="/2018/01/29/%E8%A7%A3%E5%86%B3Linux-%E5%87%BA%E7%8E%B0%E5%A4%A7%E9%87%8FTIME-WAIT%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98/"/>
      <url>/2018/01/29/%E8%A7%A3%E5%86%B3Linux-%E5%87%BA%E7%8E%B0%E5%A4%A7%E9%87%8FTIME-WAIT%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n|awk <span class="string">'/^tcp/&#123;++S[$NF]&#125;END&#123;for (a in S) print a,S[a]&#125;'</span>    <span class="comment">#得到当前服务器的所有TCP连接数状态</span></span><br></pre></td></tr></table></figure><p>修改/etc/sysctl.conf文件参数<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span>  <span class="comment">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span>  <span class="comment">#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">30</span>  <span class="comment">#修改系統默认的TIMEOUT时间</span></span><br></pre></td></tr></table></figure></p><p>TIME_WAIT 的默认时间是 2倍的 MLS，即 240 秒，最低为 30 秒，最高为 300 秒。MLS 是 TCP 片在网上的最长存活时间。TIME_WAIT的主要作用是保证关闭的TCP端口不立即被使用。因为当网络存在延迟时，可能当某个端口被关闭后，网络中还有一些重传的TCP片在发向这个端口，如果这个端口立即建立新的TCP连接，则可能会有影响。所以使用2倍的MSL时间来限制这个端口立即被使用。</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>zabbix+shell脚本钉钉机器人报警</title>
      <link href="/2017/12/15/zabbix-shell%E8%84%9A%E6%9C%AC%E9%92%89%E9%92%89%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A5%E8%AD%A6/"/>
      <url>/2017/12/15/zabbix-shell%E8%84%9A%E6%9C%AC%E9%92%89%E9%92%89%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A5%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<h1 id="u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21"><a href="#u5185_u5BB9_u539F_u521B_2C_u7981_u6B62_u8F6C_u8F7D_21" class="headerlink" title="内容原创,禁止转载!"></a>内容原创,禁止转载!</h1><h2 id="u6548_u679C_u56FE_u5982_u4E0B_uFF1A"><a href="#u6548_u679C_u56FE_u5982_u4E0B_uFF1A" class="headerlink" title="效果图如下："></a>效果图如下：</h2><p><img src="/img/dingding1.jpg" alt="jenkins"></p><h3 id="u81EA_u5B9A_u4E49_u8B66_u62A5_u63D0_u793A"><a href="#u81EA_u5B9A_u4E49_u8B66_u62A5_u63D0_u793A" class="headerlink" title="自定义警报提示"></a>自定义警报提示</h3><p>自定义告警脚本在zabbix_server.conf中配置，默认为： AlertScriptsPath=/usr/lib/zabbix/alertscripts<br>警报脚本在Zabbix服务器上执行。 这些脚本位于服务器配置文件中定义的目录中AlertScriptsPath.</p><p>这是一个示例警报脚本：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">to=$<span class="number">1</span></span><br><span class="line">messages=`<span class="keyword">echo</span> $<span class="number">3</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">subject=`<span class="keyword">echo</span> $<span class="number">2</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$&#123;messages&#125;"</span> | mail -s <span class="string">"$&#123;subject&#125;"</span> <span class="string">"$&#123;to&#125;"</span> &gt;&gt;/tmp/mail.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>Zabbix-Server 在调用脚本的时候，会传递三个变量参数给脚本作为位置参数：$1, $2, $3。 其中：$1 表示收件人，$2 表示主题，$3 表示内容。</p><h1 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="配置"></a>配置</h1><p>选择 报警媒介类型，创建自定义告警方式，<br>Type 选择 Script，Script name 指定自定义的告警脚本，<br>Script parameters 一般设置如下三个：</p><ul><li>{ALERT.SENDTO}</li><li>{ALERT.SUBJECT}</li><li>{ALERT.MESSAGE}<br><img src="/img/dingding2.png" alt="jenkins"><br>其他配置省略<br>shell+钉钉机器人脚本<figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#date:2017-12-14</span></span><br><span class="line"><span class="comment">#by wang.t</span></span><br><span class="line"><span class="comment">#Revision: 1.0</span></span><br><span class="line"><span class="comment"># Email:837479851@qq.com</span></span><br><span class="line"><span class="comment"># Website:idcsec.com</span></span><br><span class="line">LOGFILE=<span class="string">"/tmp/dingding.log"</span></span><br><span class="line">:&gt;<span class="string">"$LOGFILE"</span></span><br><span class="line">exec <span class="number">1</span>&gt;<span class="string">"$LOGFILE"</span></span><br><span class="line">exec <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://127.0.0.1/zabbix"</span></span><br><span class="line">CURL=<span class="string">"/usr/bin/curl"</span></span><br><span class="line">to=$<span class="number">1</span></span><br><span class="line">subject=`<span class="keyword">echo</span> $<span class="number">2</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">body=`<span class="keyword">echo</span> $<span class="number">3</span> | tr <span class="string">'\r\n'</span> <span class="string">'\n'</span>`</span><br><span class="line">$&#123;CURL&#125;  <span class="string">'https://oapi.dingtalk.com/robot/send?access_token=XXXXXXXXX'</span> \</span><br><span class="line">   -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">   -d <span class="string">""</span><span class="string">"</span><br><span class="line"> &#123;</span><br><span class="line">     \"msgtype\": \"markdown\",</span><br><span class="line">     \"markdown\": &#123;</span><br><span class="line">         \"title\":\"$&#123;subject&#125;@18******5\",</span><br><span class="line">         \"text\": \"$&#123;body&#125;\"</span><br><span class="line">     &#125;,</span><br><span class="line">    \"at\": &#123;</span><br><span class="line">        \"atMobiles\": [ </span><br><span class="line">            \"18*******5\",</span><br><span class="line">        ], </span><br><span class="line">        \"isAtAll\": false</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;"</span><span class="string">""</span></span><br></pre></td></tr></table></figure></li></ul><p>Github:<a href="https://github.com/Hwting/script/blob/master/zabbix_dingding.sh" target="_blank" rel="external">https://github.com/Hwting/script/blob/master/zabbix_dingding.sh</a><br>测试测试 zabbix_dingding.sh  “” 2 3</p><h1 id="u52A8_u4F5C_u8BBE_u7F6E"><a href="#u52A8_u4F5C_u8BBE_u7F6E" class="headerlink" title="动作设置"></a>动作设置</h1><p>到配置-》动作-》创建动作（触发器）</p><h2 id="zabbix_u62A5_u8B66_u6D88_u606F_u6A21_u677F"><a href="#zabbix_u62A5_u8B66_u6D88_u606F_u6A21_u677F" class="headerlink" title="zabbix报警消息模板"></a>zabbix报警消息模板</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">标题：故障&#123;TRIGGER.STATUS&#125;,服务器:&#123;HOSTNAME1&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line"></span><br><span class="line">告警IP:&#123;HOST.IP&#125;</span><br><span class="line"></span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line"></span><br><span class="line">等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line"></span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line"></span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line"></span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line"></span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line"></span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">标题：恢复&#123;TRIGGER.STATUS&#125;, 服务器:&#123;HOSTNAME1&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line"></span><br><span class="line">告警IP:&#123;HOST.IP&#125;</span><br><span class="line"></span><br><span class="line">恢复时间:&#123;EVENT.DATE&#125;&#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line"></span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line"></span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line"></span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line"></span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line"></span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line"></span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>jenkins与sonar集成自动化代码质量检查</title>
      <link href="/2017/12/13/jenkins%E4%B8%8Esonar%E9%9B%86%E6%88%90%E8%87%AA%E5%8A%A8%E5%8C%96%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%9F%A5/"/>
      <url>/2017/12/13/jenkins%E4%B8%8Esonar%E9%9B%86%E6%88%90%E8%87%AA%E5%8A%A8%E5%8C%96%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<p>安装jenkins,mysql：省略</p><h1 id="u5B89_u88C5sonar"><a href="#u5B89_u88C5sonar" class="headerlink" title="安装sonar"></a>安装sonar</h1><h2 id="mysql_u521B_u5EFA_u6570_u636E_u5E93user_u5E76_u6388_u6743_28_u6D4B_u8BD5_u53EF_u4EE5_u4F7F_u7528_u81EA_u5E26_u6570_u636E_u5E93_29"><a href="#mysql_u521B_u5EFA_u6570_u636E_u5E93user_u5E76_u6388_u6743_28_u6D4B_u8BD5_u53EF_u4EE5_u4F7F_u7528_u81EA_u5E26_u6570_u636E_u5E93_29" class="headerlink" title="mysql创建数据库user并授权(测试可以使用自带数据库)"></a>mysql创建数据库user并授权(测试可以使用自带数据库)</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;CREATE DATABASE sonarqube SET utf8 COLLATE utf8_general_ci;</span><br><span class="line">&gt; CREATE USER <span class="string">'sonar’@'</span>%<span class="string">' IDENTIFIED BY '</span>password<span class="string">';</span><br><span class="line">&gt; GRANT all privileges ON sonarqube.* TO sonar’@‘%'</span> IDENTIFIED BY <span class="string">'password'</span>;</span><br><span class="line">&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="u4E0B_u8F7D_u5B89_u88C5"><a href="#u4E0B_u8F7D_u5B89_u88C5" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//sonarsource.bintray.com/Distribution/sonarqube/sonarqube-6.7.zip</span></span><br><span class="line">unzip sonarqube-<span class="number">6.7</span><span class="class">.zip</span>  -d /usr/local/</span><br><span class="line">cd /usr/local/sonarqube-<span class="number">6.7</span>/</span><br><span class="line">vim conf/sonar<span class="class">.properties</span>  /配置文件</span><br><span class="line">sonar<span class="class">.web</span><span class="class">.host</span>=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">sonar<span class="class">.web</span><span class="class">.port</span>=<span class="number">9000</span></span><br><span class="line">sonar<span class="class">.jdbc</span><span class="class">.username</span>=sonar</span><br><span class="line">sonar<span class="class">.jdbc</span><span class="class">.password</span>=password</span><br><span class="line">sonar<span class="class">.jdbc</span><span class="class">.url</span>=jdbc:mysql:<span class="comment">//localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance&amp;useSSL=false</span></span><br><span class="line"> ./bin/linux-x86-<span class="number">64</span>/sonar<span class="class">.sh</span>  start 启动sonar 需要使用非root启动</span><br><span class="line"> 中文插件下载解压到下目录</span><br><span class="line">wget https:<span class="comment">//github.com/SonarQubeCommunity/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-1.18/sonar-l10n-zh-plugin-1.18.jar</span></span><br><span class="line"> /usr/local/sonarqube-<span class="number">6.7</span>/extensions/plugins/</span><br><span class="line"> ./bin/linux-x86-<span class="number">64</span>/sonar<span class="class">.sh</span>  restart</span><br></pre></td></tr></table></figure><h1 id="u5B89_u88C5sonar-runner"><a href="#u5B89_u88C5sonar-runner" class="headerlink" title="安装sonar-runner"></a>安装sonar-runner</h1><h2 id="u4E0B_u8F7D_u5B89_u88C5-1"><a href="#u4E0B_u8F7D_u5B89_u88C5-1" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//repo1.maven.org/maven2/org/codehaus/sonar/runner/sonar-runner-dist/2.4/sonar-runner-dist-2.4.zip</span></span><br><span class="line">unzip sonar-runner-dist-<span class="number">2.4</span>.zip -d /usr/local/</span><br><span class="line">cd /usr/local/sonar-runner-dist-<span class="number">2.4</span></span><br><span class="line">vim conf/sonar-runner.properties </span><br><span class="line">sonar.host.url=http:<span class="comment">//172.18.8.32:9000</span></span><br><span class="line">sonar.sourceEncoding=UTF-<span class="number">8</span></span><br><span class="line">sonar.login=admin</span><br><span class="line">sonar.password=admi</span><br><span class="line">配置环境配置</span><br><span class="line">vim /etc/profile</span><br><span class="line">export SONAR_HOME=/usr/local/sonarqube-<span class="number">6.7</span></span><br><span class="line">PATH=<span class="variable">$PATH</span>:/usr/local/sonar-runner-<span class="number">2.4</span>/bin   </span><br><span class="line">export PATH</span><br><span class="line">source  /etc/profile</span><br><span class="line">测试ok</span><br><span class="line">sonar-scanner -h</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="github_u4E0B_u8F7D_u4E00_u4E2A_u63D0_u4F9B_u6D4B_u8BD5_u9879_u76EE"><a href="#github_u4E0B_u8F7D_u4E00_u4E2A_u63D0_u4F9B_u6D4B_u8BD5_u9879_u76EE" class="headerlink" title="github下载一个提供测试项目"></a>github下载一个提供测试项目</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> https:<span class="comment">//github.com/SonarSource/sonar-scanning-examples.git</span></span><br><span class="line">cd sonar-scanning-examples/sonarqube-scanner</span><br><span class="line">如果是直接在linux客服端测试需要在代码根目录创建sonar-project.properties文件</span><br><span class="line"> cat sonar-project.properties </span><br><span class="line">sonar.projectKey=org.sonarqube:sonarqube-scanner</span><br><span class="line">sonar.projectName=Example of SonarQube Scanner Usage</span><br><span class="line">sonar.projectVersion=<span class="number">1.0</span></span><br><span class="line">sonar.sources=src,copybooks</span><br><span class="line">sonar.sourceEncoding=UTF-<span class="number">8</span></span><br><span class="line"><span class="comment">## Cobol Specific Properties</span></span><br><span class="line"><span class="comment"># comma-separated paths to directories with copybooks</span></span><br><span class="line">sonar.cobol.copy.directories=copybooks</span><br><span class="line"><span class="comment"># comma-separated list of suffixes</span></span><br><span class="line">sonar.cobol.file.suffixes=cbl,cpy</span><br><span class="line">sonar.cobol.copy.suffixes=cpy</span><br><span class="line"><span class="comment">## Flex Specific Properties</span></span><br><span class="line"><span class="comment"># retrieve code coverage data from the Cobertura report</span></span><br><span class="line">sonar.flex.cobertura.reportPath=coverage-report/coverage-cobertua-flex.xml</span><br><span class="line"><span class="comment"># PL/I Specific Properties</span></span><br><span class="line">sonar.pli.marginLeft=<span class="number">2</span></span><br><span class="line">sonar.pli.marginRight=<span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="u5728_u6E90_u4EE3_u7801_u6839_u76EE_u5F55_u6267_u884C_sonar-runner_-X__u6D4B_u8BD5_u6210_u529F"><a href="#u5728_u6E90_u4EE3_u7801_u6839_u76EE_u5F55_u6267_u884C_sonar-runner_-X__u6D4B_u8BD5_u6210_u529F" class="headerlink" title="在源代码根目录执行 sonar-runner -X 测试成功"></a>在源代码根目录执行 sonar-runner -X 测试成功</h2><p><img src="/img/sonar1.png" alt="jenkins"><br>访问<a href="http://ip:9000查看结果" target="_blank" rel="external">http://ip:9000查看结果</a><br><img src="/img/sonar2.png" alt="jenkins"><br>ok现在sonar环境配置好</p><h1 id="u8BBE_u7F6Ejenkins+sonar_u81EA_u52A8_u5316"><a href="#u8BBE_u7F6Ejenkins+sonar_u81EA_u52A8_u5316" class="headerlink" title="设置jenkins+sonar自动化"></a>设置jenkins+sonar自动化</h1><h2 id="u5B89_u88C5_u63D2_u4EF6"><a href="#u5B89_u88C5_u63D2_u4EF6" class="headerlink" title="安装插件"></a>安装插件</h2><p>SonarQube Scanner for Jenkins<br><img src="/img/sonar3.png" alt="jenkins"></p><h2 id="jenkins_u8BBE_u7F6Esonar_u8DEF_u5F84"><a href="#jenkins_u8BBE_u7F6Esonar_u8DEF_u5F84" class="headerlink" title="jenkins设置sonar路径"></a>jenkins设置sonar路径</h2><p><img src="/img/sonar4.png" alt="jenkins"></p><h3 id="jenkins_u4E0A_u914D_u7F6Esonar_u7684_u4FE1_u606F"><a href="#jenkins_u4E0A_u914D_u7F6Esonar_u7684_u4FE1_u606F" class="headerlink" title="jenkins上配置sonar的信息"></a>jenkins上配置sonar的信息</h3><p>这里可以在sonarweb界面生成使用token<br><img src="/img/sonar5.png" alt="jenkins"></p><h4 id="u9879_u76EE_u91CC_u9762_u914D_u7F6Esonar"><a href="#u9879_u76EE_u91CC_u9762_u914D_u7F6Esonar" class="headerlink" title="项目里面配置sonar"></a>项目里面配置sonar</h4><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectKey=java-api <span class="comment">//key需要唯一</span></span><br><span class="line">sonar.projectName=java-api <span class="comment">//项目名称</span></span><br><span class="line">sonar.projectVersion=<span class="number">4.3</span>   <span class="comment">//版本</span></span><br><span class="line">sonar.sources=src <span class="comment">//源码路径</span></span><br><span class="line">sonar.language=java</span><br><span class="line">sonar.sourceEncoding=UTF-<span class="number">8</span></span><br><span class="line">sonar.java.binaries=target/classes</span><br></pre></td></tr></table></figure><p><img src="/img/sonar6.png" alt="jenkins"></p><h1 id="u6784_u5EFA"><a href="#u6784_u5EFA" class="headerlink" title="构建"></a>构建</h1><p><img src="/img/sonar7.png" alt="jenkins"><br><img src="/img/sonar8.png" alt="jenkins"><br><img src="/img/sonar9.png" alt="jenkins"><br>sonar.java.binaries报错参考：<br><a href="https://docs.sonarqube.org/display/PLUG/Java+Plugin+and+Bytecode" target="_blank" rel="external">https://docs.sonarqube.org/display/PLUG/Java+Plugin+and+Bytecode</a><br>如：<br>sonar.java.test.libraries=path/to/specific/Library.jar,path/to/libs/<em>.jar,directory/**/</em>.jar</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>zabbix自动发现交换机接口信息监控网络设备流量模板配置</title>
      <link href="/2017/12/11/zabbix%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E6%B5%81%E9%87%8F%E6%A8%A1%E6%9D%BF%E9%85%8D%E7%BD%AE/"/>
      <url>/2017/12/11/zabbix%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E6%B5%81%E9%87%8F%E6%A8%A1%E6%9D%BF%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>1、思科交换机snmp配置<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">建立snmp团体，名称为<span class="keyword">public</span>，权限为只读</span><br><span class="line">(config)<span class="comment">#snmp-server community public ro</span></span><br><span class="line">    允许路由器将所有类型SNMP Trap发送出去</span><br><span class="line">(config)<span class="comment">#snmp-server enable traps</span></span><br><span class="line">    设置主机<span class="number">172.16</span><span class="number">.0</span><span class="number">.21</span>接受交换机所发送过来的SNMP Trap 信息</span><br><span class="line">(config)<span class="comment">#snmp-server host 172.16.0.21 version 2c public</span></span><br><span class="line">    使用loopback0接口的IP地址作为SNMP Traps发送源地址，这个随便可以不用。</span><br><span class="line">(config)<span class="comment">#snmp-server trap-source loopback0</span></span><br><span class="line">    zabbix执行测试</span><br><span class="line">snmpwalk -v <span class="number">2</span>c -c <span class="keyword">public</span>   <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></p><h1 id="u914D_u7F6E_u53D1_u73B0_u89C4_u5219__u8FD9_u91CC_u4F7F_u7528_u6DF1_u4FE1_u670D_u8BBE_u5907"><a href="#u914D_u7F6E_u53D1_u73B0_u89C4_u5219__u8FD9_u91CC_u4F7F_u7528_u6DF1_u4FE1_u670D_u8BBE_u5907" class="headerlink" title="配置发现规则 这里使用深信服设备"></a>配置发现规则 这里使用深信服设备</h1><p>配置 → 模板→点击适当模板行中的发现<br><img src="/img/zabbix1.png" alt="zabbix"><br>点击屏幕右上角的创建发现规则<br>填写发现规则表单，具体细节如下面的屏幕截图所示<br><img src="/img/zabbix2.png" alt="zabbix"><br><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">名称 Network interfaces</span><br><span class="line">类型  SNMPv2 agent</span><br><span class="line">键值 ifDescr</span><br><span class="line">SNMP OID discovery[&#123;#SNMPVALUE&#125;,IF-MIB::ifDescr]</span><br><span class="line">SNMP community &#123;<span class="variable">$SNMP</span>_COMMUNITY&#125;</span><br><span class="line">端口 <span class="number">161</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">要发现的<span class="tag">OID</span>在<span class="tag">SNMP</span> <span class="tag">OID</span>字段中按以下格式定义： <span class="tag">discovery</span><span class="attr_selector">[&#123;#MACRO1&#125;, oid1, &#123;#MACRO2&#125;, oid2, …,]</span></span><br><span class="line">其中&#123;<span class="id">#MACRO1</span>&#125;，&#123;<span class="id">#MACRO2</span>&#125; ...是有效的宏名称，<span class="tag">oid1</span>，<span class="tag">oid2</span> ...是能够为这些宏生成有意义的值的<span class="tag">OID</span>。包含已发现<span class="tag">OID</span>索引的内置宏&#123;<span class="id">#SNMPINDEX</span>&#125;将应用于发现的实体。发现的实体按&#123;<span class="id">#SNMPINDEX</span>&#125;宏值分组。</span><br></pre></td></tr></table></figure><p>为了理解我们的意思，让我们在我们的交换机上执行几个步骤：<br>snmpwalk获取接口描述<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]<span class="preprocessor"># snmpwalk -v <span class="number">2</span>c -c public  <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span>  IF-MIB:ifDescr</span></span><br><span class="line">IF-MIB::ifDescr<span class="number">.1</span> = STRING: lo</span><br><span class="line">IF-MIB::ifDescr<span class="number">.2</span> = STRING: blackhole</span><br><span class="line">IF-MIB::ifDescr<span class="number">.3</span> = STRING: eth0</span><br><span class="line">IF-MIB::ifDescr<span class="number">.4</span> = STRING: eth1</span><br><span class="line">IF-MIB::ifDescr<span class="number">.5</span> = STRING: eth2</span><br><span class="line">IF-MIB::ifDescr<span class="number">.6</span> = STRING: eth3</span><br><span class="line">IF-MIB::ifDescr<span class="number">.7</span> = STRING: eth4</span><br><span class="line">IF-MIB::ifDescr<span class="number">.8</span> = STRING: eth5</span><br><span class="line">IF-MIB::ifDescr<span class="number">.9</span> = STRING: bond0</span><br><span class="line">IF-MIB::ifDescr<span class="number">.10</span> = STRING: bond1</span><br><span class="line">IF-MIB::ifDescr<span class="number">.11</span> = STRING: bond2</span><br><span class="line">IF-MIB::ifDescr<span class="number">.12</span> = STRING: bond3</span><br><span class="line">IF-MIB::ifDescr<span class="number">.13</span> = STRING: bond4</span><br><span class="line">IF-MIB::ifDescr<span class="number">.14</span> = STRING: gre0</span><br><span class="line">IF-MIB::ifDescr<span class="number">.15</span> = STRING: vlan0</span><br><span class="line">IF-MIB::ifDescr<span class="number">.16</span> = STRING: vpntun</span><br><span class="line">IF-MIB::ifDescr<span class="number">.17</span> = STRING: Tun0</span><br><span class="line">IF-MIB::ifDescr<span class="number">.18</span> = STRING: Tun</span><br><span class="line">[root@localhost~]<span class="preprocessor"># snmpwalk -v <span class="number">2</span>c -c public  <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span> IF-MIB::ifPhysAddress</span></span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.1</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.2</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.3</span> = STRING: <span class="number">68</span>:ed:a4:a:<span class="number">5f</span>:d1</span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.4</span> = STRING: <span class="number">68</span>:ed:a4:a:<span class="number">5f</span>:d4</span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.5</span> = STRING: <span class="number">68</span>:ed:a4:a:<span class="number">5f</span>:d3</span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.6</span> = STRING: <span class="number">68</span>:ed:a4:a:<span class="number">5f</span>:d2</span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.7</span> = STRING: <span class="number">68</span>:ed:a4:b:d8:<span class="number">71</span></span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.8</span> = STRING: <span class="number">68</span>:ed:a4:b:d8:<span class="number">72</span></span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.9</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.10</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.11</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.12</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.13</span> = STRIN</span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.14</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.15</span> = STRING: <span class="number">2</span>:<span class="number">0</span>:<span class="number">4</span>c:<span class="number">69</span>:<span class="number">36</span>:<span class="number">49</span></span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.16</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.17</span> = STRING: </span><br><span class="line">IF-MIB::ifPhysAddress<span class="number">.18</span> = STRING:</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">并将SNMP OID设置为： discovery[</span><span class="expression">&#123;<span class="begin-block">#IFDESCR</span>&#125;</span><span class="xml">, ifDescr, </span><span class="expression">&#123;<span class="begin-block">#IFPHYSADDRESS</span>&#125;</span><span class="xml">, ifPhysAddress]</span></span><br></pre></td></tr></table></figure><h1 id="u76D1_u63A7_u9879_u539F_u578B"><a href="#u76D1_u63A7_u9879_u539F_u578B" class="headerlink" title="监控项原型"></a>监控项原型</h1><p>获取接口出流量信息<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]<span class="preprocessor"># snmpwalk -v <span class="number">2</span>c -c public  <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span> ifoutOctets</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.1</span> = Counter32: <span class="number">2312213349</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.2</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.3</span> = Counter32: <span class="number">1302935657</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.4</span> = Counter32: <span class="number">2736366927</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.5</span> = Counter32: <span class="number">16974643</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.6</span> = Counter32: <span class="number">242096597</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.7</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.8</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.9</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.10</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.11</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.12</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.13</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.14</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.15</span> = Counter32: <span class="number">0</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.16</span> = Counter32: <span class="number">2958989090</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.17</span> = Counter32: <span class="number">1787720</span></span><br><span class="line">IF-MIB::ifOutOctets<span class="number">.18</span> = Counter32: <span class="number">0</span></span><br></pre></td></tr></table></figure></p><h2 id="u6DFB_u52A0item"><a href="#u6DFB_u52A0item" class="headerlink" title="添加item"></a>添加item</h2><p><img src="/img/zabbix3.png" alt="zabbix"><br><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">名称 Outbound traffic on interface <span class="variable">$1</span></span><br><span class="line">类型 SNMPv2 agent</span><br><span class="line">键值 ifOutOctets[&#123;#SNMPVALUE&#125;]</span><br><span class="line">SNMP OID IF-MIB::ifOutOctets.&#123;#SNMPINDEX&#125;</span><br><span class="line">SNMPcommunity &#123;<span class="variable">$SNMP</span>_COMMUNITY&#125;</span><br><span class="line">端口 <span class="number">161</span></span><br></pre></td></tr></table></figure></p><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">进流量只需要改</span><br><span class="line">名称  Incoming traffic on interface <span class="variable">$1</span></span><br><span class="line">键值 ifInOctets[&#123;#SNMPVALUE&#125;]</span><br><span class="line">SNMP OID IF-MIB::ifInOctets.&#123;#SNMPINDEX&#125;</span><br></pre></td></tr></table></figure><p>根据需要创建尽可能多的项目原型<br><img src="/img/zabbix4.png" alt="zabbix"></p><h1 id="Graph_prototypes__u521B_u5EFA_u56FE_u5F62"><a href="#Graph_prototypes__u521B_u5EFA_u56FE_u5F62" class="headerlink" title="Graph prototypes 创建图形"></a>Graph prototypes 创建图形</h1><figure class="hljs highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">名称： &#123;<span class="id">#SNMPVALUE</span>&#125;接口流量信息</span><br></pre></td></tr></table></figure><p><img src="/img/zabbix5.png" alt="zabbix"><br><img src="/img/zabbix6.png" alt="zabbix"><br>主机添加模板省略（博客不方便放图片）</p><h1 id="u914D_u7F6E_u65B0_u52A0_u7F51_u7EDC_u8BBE_u5907Macros_u53C2_u6570"><a href="#u914D_u7F6E_u65B0_u52A0_u7F51_u7EDC_u8BBE_u5907Macros_u53C2_u6570" class="headerlink" title="配置新加网络设备Macros参数"></a>配置新加网络设备Macros参数</h1><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置 Host macros :  MACRO : &#123;<span class="variable">$SNMP</span>_COMMUNITY&#125;  ； VALUE : public (VALUE 值是配置网络设备SNMP的团体字符串)</span><br></pre></td></tr></table></figure><p><img src="/img/zabbix7.png" alt="zabbix"></p><h1 id="u67E5_u770B_u76D1_u63A7"><a href="#u67E5_u770B_u76D1_u63A7" class="headerlink" title="查看监控"></a>查看监控</h1><p><img src="/img/zabbix8.png" alt="zabbix"></p><p>官网资料<a href="https://www.zabbix.com/documentation/3.4/manual/discovery/low_level_discovery/snmp_oidsG" target="_blank" rel="external">https://www.zabbix.com/documentation/3.4/manual/discovery/low_level_discovery/snmp_oidsG</a>:</p>]]></content>
      
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MySQL批量杀连接的几种方法</title>
      <link href="/2017/11/29/MySQL%E6%89%B9%E9%87%8F%E6%9D%80%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"/>
      <url>/2017/11/29/MySQL%E6%89%B9%E9%87%8F%E6%9D%80%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h1 id="u65B9_u6CD5_u4E00"><a href="#u65B9_u6CD5_u4E00" class="headerlink" title="方法一"></a>方法一</h1><p>通过information_schema.processlist表中的连接信息生成需要处理掉的MySQL连接的语句临时文件，然后执行临时文件中生成的指令。<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select concat(<span class="string">'KILL '</span>,id,<span class="string">';'</span>) from information_schema.processlist <span class="built_in">where</span> user=<span class="string">'root'</span>;</span><br><span class="line">+------------------------+</span><br><span class="line">| concat(<span class="string">'KILL '</span>,id,<span class="string">';'</span>) |</span><br><span class="line">+------------------------+</span><br><span class="line">| KILL <span class="number">3101</span>;             |</span><br><span class="line">| KILL <span class="number">2946</span>;             |</span><br><span class="line">+------------------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;select concat(<span class="string">'KILL '</span>,id,<span class="string">';'</span>) from information_schema.processlist <span class="built_in">where</span> user=<span class="string">'root'</span> into outfile <span class="string">'/tmp/a.txt'</span>;</span><br><span class="line">Query OK, <span class="number">2</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;<span class="built_in">source</span> /tmp/a.txt;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><h1 id="u65B9_u6CD5_u4E8C"><a href="#u65B9_u6CD5_u4E8C" class="headerlink" title="方法二"></a>方法二</h1><p>杀掉当前所有的MySQL连接<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p processlist|awk -F <span class="string">"|"</span> <span class="string">'&#123;print $2&#125;'</span>|xargs -n <span class="number">1</span> mysqladmin -uroot -p <span class="built_in">kill</span></span><br></pre></td></tr></table></figure></p><p>杀掉指定用户运行的连接，这里为Mike<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p processlist|awk -F <span class="string">"|"</span> <span class="string">'&#123;if($3 == "Mike")print $2&#125;'</span>|xargs -n <span class="number">1</span> mysqladmin -uroot -p <span class="built_in">kill</span></span><br></pre></td></tr></table></figure></p><h1 id="u65B9_u6CD5_u4E09"><a href="#u65B9_u6CD5_u4E09" class="headerlink" title="方法三"></a>方法三</h1><p>通过SHEL脚本实现<br>杀掉锁定的MySQL连接<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> `mysqladmin processlist | grep -i locked | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">mysqladmin <span class="built_in">kill</span> <span class="variable">$&#123;id&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><h1 id="u65B9_u6CD5_u56DB"><a href="#u65B9_u6CD5_u56DB" class="headerlink" title="方法四"></a>方法四</h1><p>通过Maatkit工具集中提供的mk-kill命令进行</p><ul><li>杀掉超过60秒的sql<br>mk-kill -busy-time 60 -kill</li><li>如果你想先不杀，先看看有哪些sql运行超过60秒<br>mk-kill -busy-time 60 -print</li><li>如果你想杀掉，同时输出杀掉了哪些进程<br>mk-kill -busy-time 60 -print –kill</li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>nginx配置http2平滑升级</title>
      <link href="/2017/11/17/nginx%E9%85%8D%E7%BD%AEhttp2%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/"/>
      <url>/2017/11/17/nginx%E9%85%8D%E7%BD%AEhttp2%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP/2_u4F18_u70B9"><a href="#HTTP/2_u4F18_u70B9" class="headerlink" title="HTTP/2优点"></a>HTTP/2优点</h2><ul><li><p>采用二进制格式传输数据，而非文本格式。二进制格式在协议的解析和优化扩展上带来更多的优势和可能。</p></li><li><p>对消息头进行压缩传输，能够节省消息头占用的网络的流量，而 HTTP 1.1 每次请求，都会携带大量冗余头信息，浪费了很多带宽资源，头压缩能够很好的解决该问题。</p></li><li><p>多路复用，就是多个请求都是通过一个 TCP 连接并发完成， HTTP 1.1 虽然通过 pipeline 也能并发请求，但是多个请求之间的响应会被阻塞的，所以 pipeline 至今也没有被普及应用，而 HTTP/2 做到了真正的并发请求，同时流还支持优先级和流量控制。</p></li><li><p>服务器推送，服务端能够更快的把资源推送给客户端，例如服务端可以主动把 JS 和 CSS 文件推送给客户端，而不需要客户端解析 HTML 再发送这些请求，当客户端需要的时候，它已经在客户端了。</p></li></ul><p>HTTP/2站点的优势</p><ul><li>提升网站访问速度。</li><li>降低服务器压力。</li><li>部分替代异步加载的使用。</li><li>保护网站安全。<h2 id="nginx_u914D_u7F6Ehttp2"><a href="#nginx_u914D_u7F6Ehttp2" class="headerlink" title="nginx配置http2"></a>nginx配置http2</h2>默认编译的 Nginx 并不包含 h2 模块，我们需要加入参数来编译。Nginx 1.9 开发版及以上版本源码需要自己加入编译参数。<br>以下是平滑升级模块过程<br>最后使用源码自带升级命令：make upgrade自动完成平滑<br>根据需求添加编译模块，不过只需要执行到make 不要执行make install！<br>http2需要openss1.0.2e以上版本<br>下载openssl<figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//www.openssl.org/source/openssl-1.0.2m.tar.gz</span></span><br></pre></td></tr></table></figure></li></ul><p>这里查看我当前nginx编译参数<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx  -V</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module</span><br></pre></td></tr></table></figure></p><p>到nginx源码下重新编译nginx,解压openssl指定openssl源码路径 –with-openssl=../openssl-1.0.2m<br>加上 –with-http_realip_module –with-http_v2_module   –with-openssl=../openssl-1.0.2<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure  --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_v2_module   --with-openssl=../openssl-<span class="number">1.0</span><span class="number">.2</span>m</span><br><span class="line"><span class="comment">#执行到make 不要执行make install</span></span><br><span class="line">make <span class="comment">#执行make 但不要执行make install</span></span><br></pre></td></tr></table></figure></p><p>备份二进制文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv  /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.back</span><br></pre></td></tr></table></figure></p><p>期间nginx并不会停止服务<br>拷贝新编译的二进制文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure></p><p>在源码目录下执行平滑重新加载配置命令<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx-<span class="number">1.12</span><span class="number">.0</span>]<span class="comment"># make upgrade</span></span><br><span class="line">usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">kill -USR2 `cat /usr/local/nginx/logs/nginx.pid`</span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line">test -f /usr/local/nginx/logs/nginx.pid.oldbin</span><br><span class="line">kill -QUIT `cat /usr/local/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure></p><p>验证<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nginx-<span class="number">1.12</span><span class="number">.0</span>]<span class="comment">#/usr/local/nginx/sbin/nginx  -V</span></span><br><span class="line">nginx version: Microsoft-IIS/<span class="number">1.12</span><span class="number">.0</span></span><br><span class="line">built by gcc <span class="number">4.4</span><span class="number">.7</span> <span class="number">20120313</span> (Red Hat <span class="number">4.4</span><span class="number">.7</span>-<span class="number">18</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1.0</span><span class="number">.2</span>m  <span class="number">2</span> Nov <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_v2_module --with-openssl=../openssl-<span class="number">1.0</span><span class="number">.2</span>m</span><br></pre></td></tr></table></figure></p><p><img src="/img/nginx2.png" alt="nginx"><br>http2demo：<a href="https://http2.akamai.com/demo" target="_blank" rel="external">https://http2.akamai.com/demo</a></p>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx编译添加后端健康检查模块</title>
      <link href="/2017/10/24/Nginx%E7%BC%96%E8%AF%91%E6%B7%BB%E5%8A%A0%E5%90%8E%E7%AB%AF%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%9D%97/"/>
      <url>/2017/10/24/Nginx%E7%BC%96%E8%AF%91%E6%B7%BB%E5%8A%A0%E5%90%8E%E7%AB%AF%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<p>该模块可以为Tengine提供主动式后端服务器健康检查的功能。可以通过补丁的方式来添加该模块到我们自己的nginx中。</p><h1 id="u4E0B_u8F7Dnginx_upstream_check_module_u6A21_u5757"><a href="#u4E0B_u8F7Dnginx_upstream_check_module_u6A21_u5757" class="headerlink" title="下载nginx_upstream_check_module模块"></a>下载nginx_upstream_check_module模块</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> https:<span class="comment">//github.com/yaoweibin/nginx_upstream_check_module.git</span></span><br></pre></td></tr></table></figure><p>编译补丁到nginx，必须使用最新的nginx_upstream_check_module才支持nginx 1.12.2版本<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~/nginx-<span class="number">1.12</span><span class="number">.2</span> <span class="comment">##进入nginx的源码目录</span></span><br><span class="line">nginx-<span class="number">1.12</span><span class="number">.2</span>]<span class="comment"># patch -p1 &lt; ../nginx_upstream_check_module/check_1.12.1+.patch </span></span><br><span class="line">patching file src/http/modules/ngx_http_upstream_hash_module.c</span><br><span class="line">patching file src/http/modules/ngx_http_upstream_ip_hash_module.c</span><br><span class="line">patching file src/http/modules/ngx_http_upstream_least_conn_module.c</span><br><span class="line">patching file src/http/ngx_http_upstream_round_robin.c</span><br><span class="line">patching file src/http/ngx_http_upstream_round_robin.h</span><br></pre></td></tr></table></figure></p><h2 id="u67E5_u770B_u4E4B_u524D_u7684nginx_u7F16_u8BD1_u53C2_u6570"><a href="#u67E5_u770B_u4E4B_u524D_u7684nginx_u7F16_u8BD1_u53C2_u6570" class="headerlink" title="查看之前的nginx编译参数"></a>查看之前的nginx编译参数</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1.10</span><span class="number">.1</span></span><br><span class="line">built by gcc <span class="number">4.4</span><span class="number">.7</span> <span class="number">20120313</span> (Red Hat <span class="number">4.4</span><span class="number">.7</span>-<span class="number">18</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1.0</span><span class="number">.1</span>e-fips <span class="number">11</span> Feb <span class="number">2013</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module</span><br></pre></td></tr></table></figure><p>编译nginx参数，此处只make 不要make install，编译参数需要和之前的一样添加–add-module=<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./configure --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --add-module=../nginx_upstream_check_module/</span></span><br><span class="line">make</span><br><span class="line">.....</span><br><span class="line">trueobjs/addon/nginx_upstream_check_module/ngx_http_upstream_check_module.o \</span><br><span class="line">trueobjs/ngx_modules.o \</span><br><span class="line">true-ldl -lpthread -lcrypt -lpcre -lssl -lcrypto -ldl -lz \</span><br><span class="line">true-Wl,-E</span><br><span class="line">sed -e <span class="string">"s|%%PREFIX%%|/usr/local/nginx|"</span> \</span><br><span class="line">truetrue-e <span class="string">"s|%%PID_PATH%%|/usr/local/nginx/logs/nginx.pid|"</span> \</span><br><span class="line">truetrue-e <span class="string">"s|%%CONF_PATH%%|/etc/nginx/nginx.conf|"</span> \</span><br><span class="line">truetrue-e <span class="string">"s|%%ERROR_LOG_PATH%%|/usr/local/nginx/logs/error.log|"</span> \</span><br><span class="line">truetrue&lt; man/nginx<span class="number">.8</span> &gt; objs/nginx<span class="number">.8</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving directory `/root/nginx-<span class="number">1.12</span><span class="number">.2</span><span class="string">'</span></span><br></pre></td></tr></table></figure></p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">备份旧版本nginx </span><br><span class="line">cp -a /usr/local/nginx/sbin/nginx  /usr/local/nginx/sbin/nginx.back</span><br><span class="line">停止nginx服务，替换nginx执行文件</span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">nginx-<span class="number">1.12</span><span class="number">.2</span>]<span class="comment"># cp -a objs/nginx /usr/local/nginx/sbin/</span></span><br><span class="line">cp: overwrite `/usr/local/nginx/sbin/nginx<span class="string">'? y</span></span><br></pre></td></tr></table></figure><h3 id="u9A8C_u8BC1_u7248_u672C_u5DF2_u7ECF_u5347_u7EA7_u52301-12-2__u6DFB_u52A0_u4E86nginx_upstream_check_module_u6A21_u5757"><a href="#u9A8C_u8BC1_u7248_u672C_u5DF2_u7ECF_u5347_u7EA7_u52301-12-2__u6DFB_u52A0_u4E86nginx_upstream_check_module_u6A21_u5757" class="headerlink" title="验证版本已经升级到1.12.2 添加了nginx_upstream_check_module模块"></a>验证版本已经升级到1.12.2 添加了nginx_upstream_check_module模块</h3><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> nginx-<span class="number">1.12</span><span class="number">.2</span>]<span class="comment"># /usr/local/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/<span class="number">1.12</span><span class="number">.2</span></span><br><span class="line">built by gcc <span class="number">4.4</span><span class="number">.7</span> <span class="number">20120313</span> (Red Hat <span class="number">4.4</span><span class="number">.7</span>-<span class="number">18</span>) (GCC) </span><br><span class="line">built with OpenSSL <span class="number">1.0</span><span class="number">.1</span>e-fips <span class="number">11</span> Feb <span class="number">2013</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --add-module=/root/nginx_upstream_check_module/</span><br></pre></td></tr></table></figure><p>健康检查模块配置:参照官网<a href="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html" target="_blank" rel="external">http://tengine.taobao.org/document_cn/http_upstream_check_cn.html</a><br><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upstream cluster2 &#123;&#10;        # simple round-robin&#10;        server 192.168.0.3:80;&#10;        server 192.168.0.4:80;&#10;        check interval=3000 rise=2 fall=5 timeout=1000 type=http;&#10;        check_keepalive_requests 100;&#10;        check_http_send &#34;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&#34;;&#10;        check_http_expect_alive http_2xx http_3xx;&#10;    &#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>jenkins Role-basedauthorization权限管理插件配置</title>
      <link href="/2017/10/20/jenkins-Role-basedauthorization%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/"/>
      <url>/2017/10/20/jenkins-Role-basedauthorization%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>1、安装插件、Role-based Authorization Strategy<br><img src="/img/jenkins11.png" alt="jenkins"><br>2、打开jenkins授权Role-based<br><img src="/img/jenkins22.png" alt="jenkins"><br>3、配置Manage and Assign Roles admin给所以权限 Assign Roles添加jenkinadmin到admin<br><img src="/img/jenkins33.png" alt="jenkins"><br>4、配置全局角色权限和项目角色权限：如设置testTeam全局权限read只允许查看test开始的项目名称,项目权限test-Team  Pattern:test.* </p><p><img src="/img/jenkins44.png" alt="jenkins"><br>5.设置Assign Roles，全局添加用户对于全局testTeam，项目角色添加用户到对于的项目test-Team。<br><img src="/img/jenkins55.png" alt="jenkins"><br>6、验证也test-Tame成员登录<br><img src="/img/jenkins66.png" alt="jenkins"></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>jenkins HTML publisher plugin插件无法显示解决办法</title>
      <link href="/2017/10/20/jenkins-HTML-publisher-plugin%E6%8F%92%E4%BB%B6%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
      <url>/2017/10/20/jenkins-HTML-publisher-plugin%E6%8F%92%E4%BB%B6%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>tomcat部署jenkins解决方法</p><p>vim apache-tomcat-7.0.61/bin/catalina.sh </p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">"-Djava.awt.headless=true -Dhudson.model.DirectoryBrowserSupport.CSP=\"\""</span></span><br><span class="line">export JAVA_OPTS</span><br></pre></td></tr></table></figure><p>重启tomcat 刷新页面</p><p>jenkins HTML publisher plugin配置<br><img src="/img/jenkins1.png" alt="jenkins"><br><img src="/img/jenkins2.png" alt="jenkins"></p><p><a href="https://wiki.jenkins.io/display/JENKINS/Configuring+Content+Security+Policy" target="_blank" rel="external">https://wiki.jenkins.io/display/JENKINS/Configuring+Content+Security+Policy</a></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>docker搭建registry私有仓库</title>
      <link href="/2017/09/07/docker%E6%90%AD%E5%BB%BAregistry%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
      <url>/2017/09/07/docker%E6%90%AD%E5%BB%BAregistry%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>生成私有ssl证书<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/registry/certs</span><br><span class="line"> cd ~/registry/certs</span><br><span class="line"> openssl genrsa -out registry.wting.com.key <span class="number">1024</span></span><br><span class="line"> openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout registry.wting.com.key -x509 -days <span class="number">365</span> -out registry.wting.com.crt</span><br><span class="line"> Generating a <span class="number">4096</span> bit RSA <span class="keyword">private</span> key</span><br><span class="line">.........................++</span><br><span class="line">.....................................................................................................................++</span><br><span class="line">writing <span class="keyword">new</span> <span class="keyword">private</span> key to <span class="string">'registry.wting.com.key'</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a <span class="keyword">default</span> value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (<span class="number">2</span> letter code) [AU]:cn <span class="comment">//← 国家代号</span></span><br><span class="line">State <span class="keyword">or</span> Province Name (full name) [Some-State]:sc \\← 省的全名</span><br><span class="line">Locality Name (eg, city) []:cd \\ ← 市的全名</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:wt \\公司英文</span><br><span class="line">Organizational Unit Name (eg, section) []:it \\</span><br><span class="line">Common Name (e.g. server FQDN <span class="keyword">or</span> YOUR name) []:it \\</span><br><span class="line">Email Address []:<span class="number">123</span>@<span class="number">123.</span>com <span class="comment">//← 电子邮箱</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> docker pull registry:<span class="number">2</span></span><br><span class="line"> <span class="number">2</span>: Pulling from library/registry</span><br><span class="line">df28cf470b38: Pull complete </span><br><span class="line"><span class="number">577446</span>ca4af0: Pull complete </span><br><span class="line"><span class="number">14</span>ff94bd0849: Pull complete </span><br><span class="line">fcb894e0bfb0: Pull complete </span><br><span class="line">e6d123ba30d0: Pull complete </span><br><span class="line">a4165aa6bf51: Pull complete </span><br><span class="line"><span class="number">7</span>d1c600724ef: Pull complete </span><br><span class="line"><span class="number">7</span>d1c600724ef: Pulling fs layer </span><br><span class="line"><span class="number">34</span>c9deb8b2e3: Already exists </span><br><span class="line">b24f937674dc: Already exists </span><br><span class="line">Digest: sha256:<span class="number">528</span>f8f97656ccba4284fdd27fff053a838b84163ed7aa5c5065cccf4a93c64cb</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> registry:<span class="number">2</span></span><br><span class="line">-------------------</span><br><span class="line"> docker run -d -p <span class="number">443</span>:<span class="number">5000</span> --restart=always --name registry \</span><br><span class="line">  -v /home/docker/registry/certs:/certs \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.wting.com.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/registry.wting.com.key \</span><br><span class="line">  registry:<span class="number">2</span></span><br><span class="line"></span><br><span class="line">docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                           PORTS                               NAMES</span><br><span class="line"><span class="number">87</span>f8017a225b        registry:<span class="number">2</span>                  <span class="string">"/entrypoint.sh /etc/"</span>   <span class="number">3</span> minutes ago       Up <span class="number">3</span> minutes                     <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">443</span>-&gt;<span class="number">5000</span>/tcp               registry</span><br></pre></td></tr></table></figure><p>Push到Registry:<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker push   registry.wting.com/nginx:test</span><br><span class="line">The push refers to a repository [registry.wting.com/nginx] (len: <span class="number">1</span>)</span><br><span class="line">unable to ping registry endpoint https:<span class="comment">//registry.wting.com/v0/</span></span><br><span class="line">v2 ping attempt failed with error: Get https:<span class="comment">//registry.wting.com/v2/: x509: certificate is valid for it, not registry.wting.com</span></span><br><span class="line"> v1 ping attempt failed with error: Get https:<span class="comment">//registry.wting.com/v1/_ping: x509: certificate is valid for it, not registry.wting.com</span></span><br><span class="line">push失败了！docker client认为server传输过来的证书的签署方是一个unknown authority（未知的CA），因此验证失败。我们需要让docker client安装我们的CA证书：</span><br><span class="line">sudo mkdir -p /etc/docker/certs.d/registry.wting.com</span><br><span class="line">sudo cp registry.wting.com.crt  /etc/docker/certs.d/registry.wting.com/ca.crt</span><br></pre></td></tr></table></figure></p><p>重启Docker Daemon<br>认证方式<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd ~/registry/</span><br><span class="line">mkdir auth</span><br><span class="line">docker run --entrypoint htpasswd registry:<span class="number">2.2</span> -Bbn docker <span class="number">1233</span> &gt; auth/htpasswd;</span><br><span class="line">ocker run -d -p <span class="number">443</span>:<span class="number">5000</span> --restart=always --name registry \</span><br><span class="line">  -v `pwd`/auth:/auth \</span><br><span class="line">  -e <span class="string">"REGISTRY_AUTH=htpasswd"</span> \</span><br><span class="line">  -e <span class="string">"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"</span> \</span><br><span class="line">  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">  -v /home/docker/registry/certs:/certs \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.wting.com.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/registry.wting.com.key \</span><br><span class="line">  registry:<span class="number">2</span></span><br></pre></td></tr></table></figure></p><p>登录<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker login registry.wting.com</span><br><span class="line">   ----</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>Linux挂载已分区的LVM磁盘</title>
      <link href="/2017/09/06/Linux%E6%8C%82%E8%BD%BD%E5%B7%B2%E5%88%86%E5%8C%BA%E7%9A%84LVM%E7%A3%81%E7%9B%98/"/>
      <url>/2017/09/06/Linux%E6%8C%82%E8%BD%BD%E5%B7%B2%E5%88%86%E5%8C%BA%E7%9A%84LVM%E7%A3%81%E7%9B%98/</url>
      
        <content type="html"><![CDATA[<p>查看新挂载的lvm磁盘<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-node5 /]<span class="comment"># fdisk  -l</span></span><br><span class="line"></span><br><span class="line">Disk /dev/xvda: <span class="number">42.9</span> GB, <span class="number">42949672960</span> bytes</span><br><span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">5221</span> cylinders</span><br><span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">Disk identifier: <span class="number">0x00078f9c</span></span><br><span class="line"></span><br><span class="line">    Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/xvda1   *           <span class="number">1</span>        <span class="number">5222</span>    <span class="number">41940992</span>   <span class="number">83</span>  Linux</span><br><span class="line"></span><br><span class="line">Disk /dev/xvdb: <span class="number">107.4</span> GB, <span class="number">107374182400</span> bytes</span><br><span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">13054</span> cylinders</span><br><span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">Disk identifier: <span class="number">0x00000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/jhjhome1-lv_home: <span class="number">32.2</span> GB, <span class="number">32212254720</span> bytes</span><br><span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">3916</span> cylinders</span><br><span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">Disk identifier: <span class="number">0x00000000</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">Disk /dev/xvdc: <span class="number">107.4</span> GB, <span class="number">107374182400</span> bytes</span><br><span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">13054</span> cylinders</span><br><span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">Disk identifier: <span class="number">0x00000000</span></span><br></pre></td></tr></table></figure></p><p>Disk /dev/xvdc是新挂载上去磁盘</p><p>直接挂着目录报错<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># mount /dev/xvdc /mnt</span></span><br><span class="line">mount: unknown filesystem type <span class="string">'LVM2_member'</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>挂载/dev/xvdc<br>pvscan<br>vgscan<br>lvscna<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># pvscan </span></span><br><span class="line"> [root@jhjapp-tomcat-node5 ~]<span class="comment"># pvscan </span></span><br><span class="line">  PV /dev/xvdc   VG jhjhome    lvm2 [<span class="number">100.00</span> GiB / <span class="number">1020.00</span> MiB free]</span><br><span class="line">  PV /dev/xvdb   VG jhjhome1   lvm2 [<span class="number">100.00</span> GiB / <span class="number">1020.00</span> MiB free]</span><br></pre></td></tr></table></figure></p><p>改变vg名称 //因为之前Vg名称相同lvscan只能识别一个<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># vgs -v</span></span><br><span class="line">    Finding all volume groups</span><br><span class="line">    Finding volume group <span class="string">"jhjhome"</span></span><br><span class="line">    Finding volume group <span class="string">"jhjhome1"</span></span><br><span class="line">  VG       Attr   Ext   <span class="comment">#PV #LV #SN VSize   VFree    VG UUID                                VProfile</span></span><br><span class="line">  jhjhome  wz--n- <span class="number">4.00</span>m   <span class="number">1</span>   <span class="number">5</span>   <span class="number">0</span> <span class="number">100.00</span>g <span class="number">1020.00</span>m UF6SKw-o3vb-TLdm-pA3S-TWWl-<span class="number">5</span>Rw3-xyOcdD         </span><br><span class="line">  jhjhome1 wz--n- <span class="number">4.00</span>m   <span class="number">1</span>   <span class="number">5</span>   <span class="number">0</span> <span class="number">100.00</span>g <span class="number">1020.00</span>m WX0eQq-<span class="number">3</span>BUy-q0TL-<span class="number">2</span>HiU-VhgM-<span class="number">5</span>dCc-<span class="number">6</span>Q9Shv  </span><br><span class="line">  -----------------------------------------------</span><br><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># vgrename  UF6SKw-o3vb-TLdm-pA3S-TWWl-5Rw3-xyOcdD jhj2</span></span><br><span class="line">  Volume group <span class="string">"jhjhome"</span> successfully renamed to <span class="string">"jhj2"</span></span><br></pre></td></tr></table></figure></p><p>vgscan<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># vgscan </span></span><br><span class="line">  Reading all physical volumes.  This may take a <span class="keyword">while</span>...</span><br><span class="line">  Found volume group <span class="string">"jhj2"</span> using metadata type lvm2</span><br><span class="line">  Found volume group <span class="string">"jhjhome1"</span> using metadata type lvm2</span><br></pre></td></tr></table></figure></p><p>lvscna未激活<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># lvscan </span></span><br><span class="line">  inactive          <span class="string">'/dev/jhj2/lv_home'</span> [<span class="number">30.00</span> GiB] inherit</span><br><span class="line">  inactive          <span class="string">'/dev/jhj2/lv_usr'</span> [<span class="number">43.00</span> GiB] inherit</span><br><span class="line">  inactive          <span class="string">'/dev/jhj2/lv_var'</span> [<span class="number">20.00</span> GiB] inherit</span><br><span class="line">  inactive          <span class="string">'/dev/jhj2/lv_tmp'</span> [<span class="number">2.00</span> GiB] inherit</span><br><span class="line">  inactive          <span class="string">'/dev/jhj2/lv_swap'</span> [<span class="number">4.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_home'</span> [<span class="number">30.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_usr'</span> [<span class="number">43.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_var'</span> [<span class="number">20.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_tmp'</span> [<span class="number">2.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_swap'</span> [<span class="number">4.00</span> GiB] inherit</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p><p>先激活vg<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># vgchange -ay jhj2</span></span><br><span class="line">  <span class="number">5</span> logical volume(s) in volume group <span class="string">"jhj2"</span> now active</span><br></pre></td></tr></table></figure></p><p>再查看lv状态，发现已经活动的lv<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># lvscan </span></span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhj2/lv_home'</span> [<span class="number">30.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhj2/lv_usr'</span> [<span class="number">43.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhj2/lv_var'</span> [<span class="number">20.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhj2/lv_tmp'</span> [<span class="number">2.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhj2/lv_swap'</span> [<span class="number">4.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_home'</span> [<span class="number">30.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_usr'</span> [<span class="number">43.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_var'</span> [<span class="number">20.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_tmp'</span> [<span class="number">2.00</span> GiB] inherit</span><br><span class="line">  ACTIVE            <span class="string">'/dev/jhjhome1/lv_swap'</span> [<span class="number">4.00</span> GiB] inherit</span><br><span class="line">-------------------------------</span><br><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># lvdisplay </span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/jhj2/lv_home</span><br><span class="line">  LV Name                lv_home</span><br><span class="line">  VG Name                jhj2</span><br><span class="line">  LV UUID                qI3DV4-dkAW-jNdy-SmUL-CZEV-rA04-<span class="number">6</span>TfXLn</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time iZ25aocjopuZ, <span class="number">2016</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">38</span> +<span class="number">0800</span></span><br><span class="line">  LV Status              available</span><br><span class="line">   open                 <span class="number">0</span></span><br><span class="line">  LV Size                <span class="number">30.00</span> GiB</span><br><span class="line">  Current LE             <span class="number">7680</span></span><br><span class="line">  Segments               <span class="number">1</span></span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     <span class="number">256</span></span><br><span class="line">  Block device           <span class="number">253</span>:<span class="number">5</span></span><br><span class="line">   </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/jhj2/lv_usr</span><br><span class="line">  LV Name                lv_usr</span><br><span class="line">..............</span><br></pre></td></tr></table></figure></p><p>mount这个lv就可以访问了</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># mount /dev/jhj2/lv_home  /mnt</span></span><br><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment"># ls /mnt/</span></span><br><span class="line">jhjapp1  lost+found</span><br><span class="line">[root@jhjapp-tomcat-node5 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>如果vg名称不相同不需要改vg名称那个步骤 直接激活挂载</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>Oracle自动删除归档日志shell脚本</title>
      <link href="/2017/09/01/Oracle%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97shell%E8%84%9A%E6%9C%AC/"/>
      <url>/2017/09/01/Oracle%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97shell%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>Oraclr归档日志清理脚本<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ -f ~/.bash_profile ]; then</span><br><span class="line">    . ~/.bash_profile</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment">#set env</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Oracle home:"</span><span class="variable">$ORACLE_HOME</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Oracle SID:"</span><span class="variable">$ORACLE_SID</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ORACLE_HOME</span>/bin/rman target sys/oracle@rac log=/oracle/logs/rman.log &lt;&lt;EOF</span><br><span class="line">crosscheck archivelog all;</span><br><span class="line">delete noprompt expired archivelog all;</span><br><span class="line">delete noprompt archivelog all completed before <span class="string">'sysdate - 5'</span>;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p><hr><p>正式环境<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">!/bin/bash</span><br><span class="line"><span class="comment">#Author wang.t</span></span><br><span class="line"><span class="comment">#date 2017-9-1</span></span><br><span class="line">ORACLE_HOME=/data/u01/app/oracle/product/<span class="number">11.2</span><span class="number">.0</span>/dbhome_1</span><br><span class="line"><span class="variable">$ORACLE_HOME</span>/bin/rman  target / log=/data/backup/logs/rman.log &lt;&lt; EOF</span><br><span class="line">crosscheck archivelog all;</span><br><span class="line">DELETE noprompt  ARCHIVELOG ALL COMPLETED BEFORE <span class="string">'SYSDATE-15'</span>;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p><p>mkdir -p /data/backup/logs/</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>Nginx+内核参数优化参考</title>
      <link href="/2017/09/01/Nginx-%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96%E5%8F%82%E8%80%83/"/>
      <url>/2017/09/01/Nginx-%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96%E5%8F%82%E8%80%83/</url>
      
        <content type="html"><![CDATA[<p>#内核优化<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = <span class="number">0</span></span><br><span class="line">net.ipv4.conf.<span class="keyword">default</span>.rp_filter = <span class="number">1</span></span><br><span class="line">net.ipv4.conf.<span class="keyword">default</span>.accept_source_route = <span class="number">0</span></span><br><span class="line">kernel.sysrq = <span class="number">0</span></span><br><span class="line">kernel.core_uses_pid = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></span><br><span class="line">kernel.msgmnb = <span class="number">65536</span></span><br><span class="line">kernel.msgmax = <span class="number">65536</span></span><br><span class="line">kernel.shmmax = <span class="number">68719476736</span></span><br><span class="line">kernel.shmall = <span class="number">4294967296</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = <span class="number">6000</span></span><br><span class="line">net.ipv4.tcp_sack = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_window_scaling = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_rmem = <span class="number">4096</span>        <span class="number">87380</span>    <span class="number">4194304</span></span><br><span class="line">net.ipv4.tcp_wmem = <span class="number">4096</span>        <span class="number">16384</span>    <span class="number">4194304</span></span><br><span class="line">net.core.wmem_default = <span class="number">8388608</span></span><br><span class="line">net.core.rmem_default = <span class="number">8388608</span></span><br><span class="line">net.core.rmem_max = <span class="number">16777216</span></span><br><span class="line">net.core.wmem_max = <span class="number">16777216</span></span><br><span class="line">net.core.netdev_max_backlog = <span class="number">262144</span></span><br><span class="line">net.core.somaxconn = <span class="number">262144</span></span><br><span class="line">net.ipv4.tcp_max_orphans = <span class="number">3276800</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">262144</span></span><br><span class="line">net.ipv4.tcp_timestamps = <span class="number">0</span></span><br><span class="line">net.ipv4.tcp_synack_retries = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_syn_retries = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_mem = <span class="number">94500000</span> <span class="number">915000000</span> <span class="number">927000000</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = <span class="number">30</span></span><br><span class="line">net.ipv4.ip_local_port_range = <span class="number">1024</span>    <span class="number">65000</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>#内核参数的优化#<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_max_tw_buckets</span> = <span class="number">6000</span></span><br><span class="line">timewait的数量，默认是<span class="number">180000</span>。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.ip_local_port_range</span> = <span class="number">1024</span>    <span class="number">65000</span></span><br><span class="line">允许系统打开的端口范围。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_tw_recycle</span> = <span class="number">1</span></span><br><span class="line">启用timewait快速回收。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line">开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_syncookies</span> = <span class="number">1</span></span><br><span class="line">开启SYN Cookies，当出现SYN等待队列溢出时，启用cookies来处理。</span><br><span class="line">net<span class="class">.core</span><span class="class">.somaxconn</span> = <span class="number">262144</span></span><br><span class="line">web应用中listen函数的backlog默认会给我们内核参数的net<span class="class">.core</span><span class="class">.somaxconn</span>限制到<span class="number">128</span>，而nginx定义的NGX_LISTEN_BACKLOG默认为<span class="number">511</span>，所以有必要调整这个值。</span><br><span class="line">net<span class="class">.core</span><span class="class">.netdev_max_backlog</span> = <span class="number">262144</span></span><br><span class="line">每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_max_orphans</span> = <span class="number">262144</span></span><br><span class="line">系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_max_syn_backlog</span> = <span class="number">262144</span></span><br><span class="line">记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有<span class="number">128</span>M内存的系统而言，缺省值是<span class="number">1024</span>，小内存的系统则是<span class="number">128</span>。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_timestamps</span> = <span class="number">0</span></span><br><span class="line">时间戳可以避免序列号的卷绕。一个<span class="number">1</span>Gbps的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。这里需要将其关掉。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_synack_retries</span> = <span class="number">1</span></span><br><span class="line">为了打开对端的连接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK包的数量。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_syn_retries</span> = <span class="number">1</span></span><br><span class="line">在内核放弃建立连接之前发送SYN包的数量。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_fin_timeout</span> = <span class="number">1</span></span><br><span class="line">如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-<span class="number">2</span>状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是<span class="number">60</span>秒。</span><br><span class="line"><span class="number">2.2</span></span><br><span class="line">内核的通常值是<span class="number">180</span>秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB服务器，也有因为大量的死套接字而内存溢出的风险，FIN-</span><br><span class="line">WAIT-<span class="number">2</span>的危险性比FIN-WAIT-<span class="number">1</span>要小，因为它最多只能吃掉<span class="number">1.5</span>K内存，但是它们的生存期长些。</span><br><span class="line">net<span class="class">.ipv4</span><span class="class">.tcp_keepalive_time</span> = <span class="number">30</span></span><br><span class="line">当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是<span class="number">2</span>小时。</span><br></pre></td></tr></table></figure></p><p>nginx 配置<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">ser  www www;</span><br><span class="line">worker_processes <span class="number">8</span>;</span><br><span class="line">worker_cpu_affinity <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span> <span class="number">01000000</span> <span class="number">10000000</span>;</span><br><span class="line">error_log  /www/log/nginx_error.log  crit;</span><br><span class="line">pid        /usr/local/nginx/nginx.pid;</span><br><span class="line">worker_rlimit_nofile <span class="number">204800</span>;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">epoll</span>;</span><br><span class="line">  worker_connections <span class="number">204800</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">include</span>       mime.types;</span><br><span class="line">  default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">  charset  utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  server_names_hash_bucket_size <span class="number">128</span>;</span><br><span class="line">  client_header_buffer_size <span class="number">2</span>k;</span><br><span class="line">  large_client_header_buffers <span class="number">4</span> <span class="number">4</span>k;</span><br><span class="line">  client_max_body_size <span class="number">8</span>m;</span><br><span class="line"></span><br><span class="line">  sendfile on;</span><br><span class="line">  tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">  fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span></span><br><span class="line">                keys_zone=TEST:<span class="number">10</span>m</span><br><span class="line">                inactive=<span class="number">5</span>m;</span><br><span class="line">  fastcgi_connect_timeout <span class="number">300</span>;</span><br><span class="line">  fastcgi_send_timeout <span class="number">300</span>;</span><br><span class="line">  fastcgi_read_timeout <span class="number">300</span>;</span><br><span class="line">  fastcgi_buffer_size <span class="number">16</span>k;</span><br><span class="line">  fastcgi_buffers <span class="number">16</span> <span class="number">16</span>k;</span><br><span class="line">  fastcgi_busy_buffers_size <span class="number">16</span>k;</span><br><span class="line">  fastcgi_temp_file_write_size <span class="number">16</span>k;</span><br><span class="line">  fastcgi_cache TEST;</span><br><span class="line">  fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</span><br><span class="line">  fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;</span><br><span class="line">  fastcgi_cache_valid any <span class="number">1</span>m;</span><br><span class="line">  fastcgi_cache_min_uses <span class="number">1</span>;</span><br><span class="line">  fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class="line">  </span><br><span class="line">  open_file_cache max=<span class="number">204800</span> inactive=<span class="number">20</span>s;</span><br><span class="line">  open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">  open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  tcp_nodelay on;</span><br><span class="line">  </span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_min_length  <span class="number">1</span>k;</span><br><span class="line">  gzip_buffers     <span class="number">4</span> <span class="number">16</span>k;</span><br><span class="line">  gzip_http_version <span class="number">1.0</span>;</span><br><span class="line">  gzip_comp_level <span class="number">3</span>;</span><br><span class="line">  gzip_types text/plain  application/javascript image/png image/jpeg text/javascript  application/x-javascript text/css application/xml;</span><br><span class="line">  gzip_vary on;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  server</span><br><span class="line">  &#123;</span><br><span class="line">    listen       <span class="number">8080</span>;</span><br><span class="line">    server_name  ad.test.com;</span><br><span class="line">    index index.php index.htm;</span><br><span class="line">    root  /www/html/;</span><br><span class="line"></span><br><span class="line">    location /status</span><br><span class="line">    &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(php|php5)?$</span><br><span class="line">    &#123;</span><br><span class="line">        fastcgi_pass <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        <span class="keyword">include</span> fcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css)$</span><br><span class="line">    &#123;</span><br><span class="line">      expires      <span class="number">30</span>d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_format  access  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">              <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">              <span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</span><br><span class="line">    access_log  /www/log/access.log  access;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>#FastCGI的几个指令<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=TEST:<span class="number">10</span>m inactive=<span class="number">5</span>m;</span><br><span class="line">这个指令为FastCGI缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。</span><br><span class="line"></span><br><span class="line">fastcgi_connect_timeout <span class="number">300</span>;</span><br><span class="line">指定连接到后端FastCGI的超时时间。</span><br><span class="line"></span><br><span class="line">fastcgi_send_timeout <span class="number">300</span>;</span><br><span class="line">向FastCGI传送请求的超时时间，这个值是指已经完成两次握手后向FastCGI传送请求的超时时间。</span><br><span class="line"></span><br><span class="line">fastcgi_read_timeout <span class="number">300</span>;</span><br><span class="line">接收FastCGI应答的超时时间，这个值是指已经完成两次握手后接收FastCGI应答的超时时间。</span><br><span class="line"></span><br><span class="line">fastcgi_buffer_size <span class="number">16</span>k;</span><br><span class="line">指定读取FastCGI应答第一部分需要用多大的缓冲区，这里可以设置为fastcgi_buffers指令指定的缓冲区大小，上面的指令指定它将使用<span class="number">1</span></span><br><span class="line">个<span class="number">16</span>k的缓冲区去读取应答的第一部分，即应答头，其实这个应答头一般情况下都很小（不会超过<span class="number">1</span>k），但是你如果在fastcgi_buffers指令中</span><br><span class="line">指定了缓冲区的大小，那么它也会分配一个fastcgi_buffers指定的缓冲区大小去缓存。</span><br><span class="line"></span><br><span class="line">fastcgi_buffers <span class="number">16</span> <span class="number">16</span>k;</span><br><span class="line">指定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答，如上所示，如果一个php脚本所产生的页面大小为<span class="number">256</span>k，则会为其分配<span class="number">16</span>个<span class="number">16</span>k的缓</span><br><span class="line">冲区来缓存，如果大于<span class="number">256</span>k，增大于<span class="number">256</span>k的部分会缓存到fastcgi_temp指定的路径中，当然这对服务器负载来说是不明智的方案，因为内存中</span><br><span class="line">处理数据速度要快于硬盘，通常这个值的设置应该选择一个你的站点中的php脚本所产生的页面大小的中间值，比如你的站点大部分脚本所产生的页面大小为</span><br><span class="line"><span class="number">256</span>k就可以把这个值设置为<span class="number">16</span> <span class="number">16</span>k，或者<span class="number">4</span> <span class="number">64</span>k 或者<span class="number">64</span></span><br><span class="line"><span class="number">4</span>k，但很显然，后两种并不是好的设置方法，因为如果产生的页面只有<span class="number">32</span>k，如果用<span class="number">4</span> <span class="number">64</span>k它会分配<span class="number">1</span>个<span class="number">64</span>k的缓冲区去缓存，而如果使用<span class="number">64</span></span><br><span class="line"><span class="number">4</span>k它会分配<span class="number">8</span>个<span class="number">4</span>k的缓冲区去缓存，而如果使用<span class="number">16</span> <span class="number">16</span>k则它会分配<span class="number">2</span>个<span class="number">16</span>k去缓存页面，这样看起来似乎更加合理。</span><br><span class="line"></span><br><span class="line">fastcgi_busy_buffers_size <span class="number">32</span>k;</span><br><span class="line">这个指令我也不知道是做什么用，只知道默认值是fastcgi_buffers的两倍。</span><br><span class="line"></span><br><span class="line">fastcgi_temp_file_write_size <span class="number">32</span>k;</span><br><span class="line">在写入fastcgi_temp_path时将用多大的数据块，默认值是fastcgi_buffers的两倍。</span><br><span class="line"></span><br><span class="line">fastcgi_cache TEST</span><br><span class="line">开启FastCGI缓存并且为其制定一个名称。个人感觉开启缓存非常有用，可以有效降低CPU负载，并且防止<span class="number">502</span>错误。但是这个缓存会引起很多问题，因为它缓存的是动态页面。具体使用还需根据自己的需求。</span><br><span class="line"></span><br><span class="line">fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</span><br><span class="line">fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;</span><br><span class="line">fastcgi_cache_valid any <span class="number">1</span>m;</span><br><span class="line">为指定的应答代码指定缓存时间，如上例中将<span class="number">200</span>，<span class="number">302</span>应答缓存一小时，<span class="number">301</span>应答缓存<span class="number">1</span>天，其他为<span class="number">1</span>分钟。</span><br><span class="line"></span><br><span class="line">fastcgi_cache_min_uses <span class="number">1</span>;</span><br><span class="line">缓存在fastcgi_cache_path指令inactive参数值时间内的最少使用次数，如上例，如果在<span class="number">5</span>分钟内某文件<span class="number">1</span>次也没有被使用，那么这个文件将被移除。</span><br><span class="line"></span><br><span class="line">fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class="line">不知道这个参数的作用，猜想应该是让nginx知道哪些类型的缓存是没用的。</span><br><span class="line">以上为nginx中FastCGI相关参数，另外，FastCGI自身也有一些配置需要进行优化，如果你使用php-fpm来管理FastCGI，可以修改配置文件中的以下值：</span><br><span class="line"></span><br><span class="line">&lt;value name=<span class="string">"max_children"</span>&gt;<span class="number">60</span>&lt;/value&gt;</span><br><span class="line">同时处理的并发请求数，即它将开启最多<span class="number">60</span>个子线程来处理并发连接。</span><br><span class="line"></span><br><span class="line">&lt;value name=<span class="string">"rlimit_files"</span>&gt;<span class="number">102400</span>&lt;/value&gt;</span><br><span class="line">最多打开文件数。</span><br><span class="line"></span><br><span class="line">&lt;value name=<span class="string">"max_requests"</span>&gt;<span class="number">204800</span>&lt;/value&gt;</span><br><span class="line">每个进程在重置之前能够执行的最多请求数。</span><br></pre></td></tr></table></figure></p><p>#ulimit  -a设置</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br><span class="line">* soft nofile <span class="number">65535</span></span><br><span class="line">* hard nofile <span class="number">65535</span></span><br><span class="line">* soft nproc <span class="number">65535</span></span><br><span class="line">* hard nproc <span class="number">65535</span></span><br><span class="line">就是限制了任意用户的最大线程数和文件数为<span class="number">10240</span>。</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">max user processes              (-u) <span class="number">10240</span></span><br><span class="line"><span class="comment">//这个值普通用户改vim /etc/security/limits.d/90-nproc.conf</span></span><br><span class="line">*          soft    nproc     <span class="number">10240</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>zookeeper集群部署</title>
      <link href="/2017/09/01/zookeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/2017/09/01/zookeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p>#ZooKeeper集群安装#<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//mirrors.hust.edu.cn/apache/zookeeper/</span></span><br><span class="line">http:<span class="comment">//mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz</span></span><br><span class="line">tar  -zxvf  zookeeper-<span class="number">3.4</span><span class="number">.9</span>.tar.gz  -C  /usr/local/</span><br></pre></td></tr></table></figure></p><p>进入conf目录下复制并修改配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vim zoo.cfg</span><br><span class="line">tickTime是zookeeper中的基本时间单位，此处用于定义一个ticktime是多长，单位毫秒</span><br><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">存储内存中的数据库快照的位置，如果没有指定dataLogDir，还将存储数据库更新的事务日志</span><br><span class="line">dataDir=<span class="comment">//usr/local/zookeeper-3.4.9/data</span></span><br><span class="line">这里的data文件夹需要自己创建</span><br><span class="line">数据库事务日志的位置</span><br><span class="line">dataLogDir=/usr/local/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/log</span><br><span class="line">这里的log文件夹需要自己创建</span><br><span class="line">为了客户端连接而侦听的端口</span><br><span class="line">clientPort=<span class="number">2181</span></span><br><span class="line">允许Follower连接并与Leader同步的时长，单位是tickTime</span><br><span class="line">initLimit=<span class="number">5</span></span><br><span class="line">允许Follower与ZooKeeper同步的时长，单位是tickTime</span><br><span class="line">syncLimit=<span class="number">2</span></span><br><span class="line">组成ZooKeeper的成员服务器。server.x的x是服务器号，与对应服务器dataDir中myid文件内的号码一致。</span><br><span class="line">指定两个端口号，前一个用于Follower连接Leader，后一个用于Leader选举。</span><br><span class="line">server<span class="number">.1</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.2</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.3</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.3</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">这是分布式环境的配置，如果是在单机上配置，则需要修改成不同的端口号</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>创建节点目录<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/&#123;data,log&#125;</span><br></pre></td></tr></table></figure></p><p>为节点创建 myid 文件<br>myid 文件用来存储本节点服务器ID，这个ID与后面配置文件中 server.ID 必须保持一致<br>echo “1” &gt; /usr/local/zookeeper-3.4.9/data/myid<br>分别scp zookeeper-3.4.9到其他节点改对应的server.ID 文件myid<br>分别启动<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/bin/zkServer.sh start</span><br></pre></td></tr></table></figure></p><p>查看状态<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using config: usr/local/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower    </span><br><span class="line">follower和leader是随机选举</span><br></pre></td></tr></table></figure></p><p>#单机部署群集#</p><p>创建节点目录<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/zookeeper/data/zk1</span><br><span class="line">mkdir /home/zookeeper/data/zk2</span><br><span class="line">mkdir /home/zookeeper/data/zk3</span><br></pre></td></tr></table></figure></p><p>为节点创建 myid 文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"1"</span> &gt; /home/zookeeper/data/zk1/myid</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"2"</span> &gt; /home/zookeeper/data/zk2/myid</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"3"</span> &gt; /home/zookeeper/data/zk3/myid</span><br></pre></td></tr></table></figure></p><p>配置文件<br>节点1<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /home/zookeeper/data/zk1/zoo.cfg</span><br><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">initLimit=<span class="number">10</span></span><br><span class="line">syncLimit=<span class="number">5</span></span><br><span class="line">dataDir=/home/zookeeper/data/zk1</span><br><span class="line">clientPort=<span class="number">2181</span></span><br><span class="line">server<span class="number">.1</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.2</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2889</span>:<span class="number">3889</span></span><br><span class="line">server<span class="number">.3</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2890</span>:<span class="number">3890</span></span><br></pre></td></tr></table></figure></p><p>节点2<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /home/zookeeper/data/zk2/zoo.cfg</span><br><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">initLimit=<span class="number">10</span></span><br><span class="line">syncLimit=<span class="number">5</span></span><br><span class="line">dataDir=/home/zookeeper/data/zk2</span><br><span class="line">clientPort=<span class="number">2182</span></span><br><span class="line">server<span class="number">.1</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.2</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2889</span>:<span class="number">3889</span></span><br><span class="line">server<span class="number">.3</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2890</span>:<span class="number">3890</span></span><br></pre></td></tr></table></figure></p><p>节点3<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /home/zookeeper/data/zk3/zoo.cfg</span><br><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">initLimit=<span class="number">10</span></span><br><span class="line">syncLimit=<span class="number">5</span></span><br><span class="line">dataDir=/home/zookeeper/data/zk3</span><br><span class="line">clientPort=<span class="number">2183</span></span><br><span class="line">server<span class="number">.1</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.2</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2889</span>:<span class="number">3889</span></span><br><span class="line">server<span class="number">.3</span>=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2890</span>:<span class="number">3890</span></span><br></pre></td></tr></table></figure></p><p>分别启动<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/home/zookeeper/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/bin/zkServer.sh start /home/zookeeper/data/zk1/zoo.cfg</span><br><span class="line">/home/zookeeper/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/bin/zkServer.sh start /home/zookeeper/data/zk2/zoo.cfg</span><br><span class="line">/home/zookeeper/zookeeper-<span class="number">3.4</span><span class="number">.9</span>/bin/zkServer.sh start /home/zookeeper/data/zk3/zoo.cfg</span><br></pre></td></tr></table></figure></p><p>环境变量设置<br>vim /etc/profile<br>ZK_HOME=/usr/local/zookeeper-3.4.9<br>expoet PATH=$ZK_HOME/bin:$PATH<br>并执行 source /etc/profile</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>LVS DR+keepalived负载均衡配置</title>
      <link href="/2017/06/06/LVS-DR-keepalived%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE/"/>
      <url>/2017/06/06/LVS-DR-keepalived%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p><img src="/img/lvs.png" alt="拓扑"></p><p>lvs安装部署：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]<span class="comment"># uname -r  #查看linux内核版本  </span></span><br><span class="line"><span class="number">2.6</span><span class="number">.32</span>-<span class="number">573.</span>el6.x86_64</span><br><span class="line">[root@localhost~]<span class="comment"># lsmod | grep ip_vs</span></span><br><span class="line">[root@localhost~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@localhost~]<span class="comment">#wget http://www.linuxvirtualserver.org/software/kernel-2.6/ipvsadm-1.26.tar.gz</span></span><br></pre></td></tr></table></figure></p><p>安装lvs安装<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost~]<span class="comment">#yum install -y gcc gcc-c++ makepcre pcre-devel kernel-devel openssl-devel libnl-devel popt-devel popt-static</span></span><br><span class="line">[root@localhost~]tar -zxvf ipvsadm-<span class="number">1.26</span>.tar.gz</span><br><span class="line">[root@localhost~]cd ipvsadm-<span class="number">1.26</span></span><br><span class="line">[root@localhostipvsadm-<span class="number">1.26</span>]make &amp;&amp; make install</span><br><span class="line">[root@localhostipvsadm-<span class="number">1.26</span>]<span class="comment"># ipvsadm #执行ipvsadm命令，把LVS添加到linux内核中</span></span><br><span class="line">IP Virtual Server version <span class="number">1.2</span><span class="number">.1</span> (size=<span class="number">4096</span>)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">[root@localhostipvsadm-<span class="number">1.26</span>]<span class="comment"># lsmod | grep ip_vs #查看LVS是否已经添加到linux内核了，如果有如下输出表示已经成功。   </span></span><br><span class="line">ip_vs                 <span class="number">126534</span>  <span class="number">0</span> </span><br><span class="line">libcrc32c               <span class="number">1246</span>  <span class="number">1</span> ip_vs</span><br><span class="line">ipv6                  <span class="number">335589</span>  <span class="number">39</span> ip_vs,cnic,ip6t_REJECT,nf_conntrack_ipv6,nf_defrag_ipv6</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>安装keepalived<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//www.keepalived.org/software/keepalived-1.3.5.tar.gz</span></span><br><span class="line">tar -zxvf keepalived-<span class="number">1.3</span><span class="number">.5</span>.tar.gz</span><br><span class="line">cd  keepalived-<span class="number">1.3</span><span class="number">.5</span></span><br><span class="line">./configure --prefix=/usr/local/keepalived <span class="comment">#error: libnfnetlink headers missing</span></span><br><span class="line">安装yum install -y libnfnetlink-devel</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">将keepalived配置成系统服务 </span><br><span class="line">```php</span><br><span class="line">mkdir /etc/keepalived/</span><br><span class="line"></span><br><span class="line">cp -r  /usr/local/keepalived/etc/keepalived<span class="comment">/*  /etc/keepalived/</span><br><span class="line">cp /usr/local/keepalived/etc/sysconfig/keepalived  /etc/sysconfig/</span><br><span class="line">cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</span><br><span class="line">cp /root/ipvsadm-1.26/keepalived-1.3.5/keepalived/etc/init.d/keepalived /etc/init.d/   #这文件在解压目录下面</span></span><br></pre></td></tr></table></figure></p><p>修改主keepalived配置文件（备只修改router_id、state和priority）<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File forkeepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">notification_email &#123;</span><br><span class="line">test@sina.com            <span class="comment">#故障接受联系人</span></span><br><span class="line"> &#125;</span><br><span class="line">notification_email_from admin@test.com   <span class="comment">#故障发送人</span></span><br><span class="line">smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>    <span class="comment">#本机发送邮件</span></span><br><span class="line">smtp_connect_timeout <span class="number">30</span></span><br><span class="line">router_id LVS_MASTER     <span class="comment">#BACKUP上修改为LVS_BACKUP</span></span><br><span class="line"> &#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER             <span class="comment">#BACKUP上修改为BACKUP</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">eth0</span></span><br><span class="line"><span class="title">virtual_router_id</span> 51     #虚拟路由标识，主从相同</span><br><span class="line"><span class="title">priority</span> 100             #<span class="title">BACKUP</span>上修改为90</span><br><span class="line"><span class="title">advert_int</span> 1</span><br><span class="line"><span class="title">authentication</span> </span>&#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="number">1111</span>           <span class="comment">#主从认证密码必须一致</span></span><br><span class="line"> &#125;</span><br><span class="line">virtual_ipaddress &#123;      <span class="comment">#Web虚拟IP（VTP）</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">virtual_server <span class="number">172.16</span><span class="number">.0</span><span class="number">.10</span> <span class="number">80</span> &#123; <span class="comment">#定义虚拟IP和端口</span></span><br><span class="line">delay_loop <span class="number">6</span>    <span class="comment">#检查真实服务器时间，单位秒</span></span><br><span class="line">lb_algo rr      <span class="comment">#设置负载调度算法，rr为轮训</span></span><br><span class="line">lb_kind DR      <span class="comment">#设置LVS负载均衡DR模式</span></span><br><span class="line">persistence_timeout <span class="number">50</span> <span class="comment">#同一IP的连接60秒内被分配到同一台真实服务器</span></span><br><span class="line">protocol TCP    <span class="comment">#使用TCP协议检查realserver状态</span></span><br><span class="line">real_server <span class="number">172.16</span><span class="number">.0</span><span class="number">.13</span> <span class="number">80</span> &#123;  <span class="comment">#第一个web服务器</span></span><br><span class="line">weight <span class="number">3</span>          <span class="comment">#节点权重值</span></span><br><span class="line">TCP_CHECK &#123;       <span class="comment">#健康检查方式</span></span><br><span class="line">connect_timeout <span class="number">3</span> <span class="comment">#连接超时</span></span><br><span class="line">nb_get_retry <span class="number">3</span>    <span class="comment">#重试次数</span></span><br><span class="line">delay_before_retry <span class="number">3</span>  <span class="comment">#重试间隔/S</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server <span class="number">172.16</span><span class="number">.0</span><span class="number">.14</span> <span class="number">80</span> &#123;  <span class="comment">#第二个web服务器</span></span><br><span class="line">weight <span class="number">3</span></span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb_get_retry <span class="number">3</span></span><br><span class="line">delay_before_retry <span class="number">3</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>vim /etc/sysctl.conf<br>……//省略部分内容<br>net.ipv4.conf.all.send_redirects = 0<br>net.ipv4.conf.default.send_redirects = 0<br>net.ipv4.conf.eth0.send_redirects = 0<br>net.ipv4.conf.eth1.send_redirects = 0<br>[root@localhost /]#sysctl -p</p><p>分别在两台Web服务器编写脚本并启动<br><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> vi /etc/init.d/lvs_dr.sh&#10;#description : start realserver&#10;VIP=172.16.0.10&#10;. /etc/init.d/functions&#10;case &#34;$1&#34; in&#10;start)&#10;/sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up&#10;/sbin/route add -host $VIP dev lo:0&#10;echo &#34;1&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_ignore&#10;echo &#34;2&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_announce&#10;echo &#34;1&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_ignore&#10;echo &#34;2&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_announce&#10;echo &#34;LVS RealServer Start OK&#34;&#10;;;&#10;stop)&#10;/sbin/ifconfig lo:0 down&#10;/sbin/route del $SNS_VIP &#62;/dev/null 2&#62;&#38;1 &#10;echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_ignore&#10;echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_announce&#10;echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_ignore&#10;echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_announce&#10;echo &#34;LVS RealServer Stoped OK&#34;&#10;;;&#10;*)&#10;echo &#34;Usage: $0 &#123;start|stop&#125;&#34;&#10;exit 1&#10;esac</span><br></pre></td></tr></table></figure></p><p> chmod +x /etc/init.d/lvs_dr.sh<br> /etc/init.d/lvs_dr.sh start<br> echo “/etc/init.d/lvs_dr.sh start” &gt;&gt; /etc/rc.local</p>]]></content>
      
      
      
        <tags>
            
            <tag> lvs </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MySQL-5.6.24-linux-glibc2.5-x86_64安装记录</title>
      <link href="/2017/05/05/MySQL-5-6-24-linux-glibc2-5-x86-64%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/"/>
      <url>/2017/05/05/MySQL-5-6-24-linux-glibc2-5-x86-64%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>1、下载 <a href="http://dev.mysql.com/downloads/mysql/" target="_blank" rel="external">http://dev.mysql.com/downloads/mysql/</a><br>2、卸载系统里面旧的版本<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep mysql</span><br><span class="line">rpm -e</span><br></pre></td></tr></table></figure></p><p>3、解压文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf /opt/mysql-<span class="number">5.6</span><span class="number">.24</span>-linux-glibc2<span class="number">.5</span>-x86_64.tar.gz  -C /usr/local/</span><br><span class="line">cd  /usr/local</span><br><span class="line">mv mysql-<span class="number">5.6</span><span class="number">.24</span>-linux-glibc2<span class="number">.5</span>-x86_64 mysql</span><br></pre></td></tr></table></figure></p><p>3、创建用户设置设置权限<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql</span><br><span class="line">chown -R mysql:mysql mysql/</span><br></pre></td></tr></table></figure></p><p>4、安装<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql/scripts/ </span><br><span class="line">yum  install perl perl-devel  -y</span><br><span class="line">[root@webgate1 scripts]<span class="comment"># ./mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span></span><br><span class="line">Installing MySQL system tables..<span class="number">.2017</span>-<span class="number">05</span>-<span class="number">05</span> <span class="number">14</span>:<span class="number">10</span>:<span class="number">08</span> <span class="number">0</span> [Warning] TIMESTAMP with implicit <span class="keyword">DEFAULT</span> value is deprecated. Please <span class="keyword">use</span> --<span class="title">explicit_defaults_for_timestamp</span> <span class="title">server</span> <span class="title">option</span> (<span class="title">see</span> <span class="title">documentation</span> <span class="title">for</span> <span class="title">more</span> <span class="title">details</span>).</span><br><span class="line">2017-05-05 14:10:08 0 [<span class="title">Note</span>] /<span class="title">usr</span>/<span class="title">local</span>/<span class="title">mysql</span>/<span class="title">bin</span>/<span class="title">mysqld</span> (<span class="title">mysqld</span> 5.6.24) <span class="title">starting</span> <span class="title">as</span> <span class="title">process</span> 16046 ...</span><br><span class="line">2017-05-05 14:10:08 16046 [<span class="title">Note</span>] <span class="title">InnoDB</span>: <span class="title">Using</span> <span class="title">atomics</span> <span class="title">to</span> <span class="title">ref</span> <span class="title">count</span> <span class="title">buffer</span> <span class="title">pool</span> <span class="title">pages</span></span><br><span class="line">2017-05-05 14:10:08 16046 [<span class="title">Note</span>] <span class="title">InnoDB</span>: <span class="title">The</span> <span class="title">InnoDB</span> <span class="title">memory</span> <span class="title">heap</span> <span class="title">is</span> <span class="title">disabled</span></span><br><span class="line">2017-05-05 14:10:08 16046 [<span class="title">Note</span>] <span class="title">InnoDB</span>: <span class="title">Mutexes</span> <span class="title">and</span> <span class="title">rw_locks</span> <span class="title">use</span> <span class="title">GCC</span> <span class="title">atomic</span> <span class="title">builtins</span></span><br><span class="line">2017-05-05 14:10:08 16046 [<span class="title">Note</span>] <span class="title">InnoDB</span>: <span class="title">Memory</span> <span class="title">barrier</span> <span class="title">is</span> <span class="title">not</span> <span class="title">used</span></span><br><span class="line">.................................</span><br></pre></td></tr></table></figure></p><p>5、添加开机自动启动环境变量等<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql/support-files</span><br><span class="line">cp my-<span class="keyword">default</span>.cnf /etc/my.cnf</span><br><span class="line">cp mysql.server /etc/init.d/mysql</span><br><span class="line">vim /etc/init.d/mysql</span><br><span class="line">basedir=/usr/local/mysql  </span><br><span class="line">datadir=/usr/local/mysql/data <span class="comment">//*修改对应目录</span></span><br><span class="line">配置环境变量vi /etc/profile   </span><br><span class="line">export MYSQL_HOME=/usr/local/mysql</span><br><span class="line">export PATH=<span class="variable">$MYSQL_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">：wq</span><br><span class="line">source /etc/profile </span><br><span class="line">chkconfig --add mysql</span><br><span class="line">chkconfig mysql on</span><br><span class="line">service mysql start</span><br><span class="line">设置root登录密码：</span><br><span class="line">/usr/local/mysql/bin/mysqladmin -u root password <span class="string">'new-password'</span> </span><br><span class="line">设置允许root远程登录</span><br><span class="line">mysql -uroot -p  </span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span> WITH GRANT OPTION;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>Centos下mysql5.6编译安装</title>
      <link href="/2017/03/23/Centos%E4%B8%8Bmysql5-6%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
      <url>/2017/03/23/Centos%E4%B8%8Bmysql5-6%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>安装目录：/usr/local/mysql<br>数据库目录：/usr/local/mysql/data<br>一、安装前面</p><figure class="hljs highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">添加用户</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -g mysql -s /sbin/nologin mysql</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum安装依赖包</span><br><span class="line">yum -y install gcc* ncurses-devel cmake bison</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">解压创建目录</span><br><span class="line">tar zxf mysql-<span class="number">5.6</span><span class="number">.13</span>.tar.gz </span><br><span class="line">cd mysql-<span class="number">5.6</span><span class="number">.13</span></span><br><span class="line">mkdir -p /usr/local/mysql/data</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmake配置以及编译安装mysql</span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DMYSQL_UNIX_ADDR=/usr/local/mysql/mysql.sock -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_MYISAM_STORAGE_ENGING=<span class="number">1</span> -DWITH_INNOBASE_STORAGE_ENGING=<span class="number">1</span> -DWITH_MEMORY_STORAGE_ENGING=<span class="number">1</span> -DWITH_READLINE=<span class="number">1</span> -DENABLED_LOCAL_INFILE=<span class="number">1</span> -DMYSQL_DATADIR=/usr/local/mysql/data -DMYSQL_USER=mysql -DMYSQL_TCP_PORT=<span class="number">3306</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">拷贝配置文件</span><br><span class="line">cp support-files/my-<span class="keyword">default</span>.cnf /usr/local/mysql/my.cnf</span><br><span class="line">初始化数据库</span><br><span class="line">cd /usr/local/mysql/scripts/</span><br><span class="line">./mysql_install_db --user=mysql --datadir=/usr/local/mysql/data/ --basedir=/usr/local/mysql/</span><br><span class="line">`</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql /usr/local/mysql/</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">修改my.cnf配置</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /usr/local/mysql/data</span><br><span class="line">log-error = /usr/local/mysql/mysql_error.log</span><br><span class="line">pid-file = /usr/local/mysql/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">tmpdir = /tmp</span><br><span class="line">`</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">拷贝启动文件配置安全启动向导初始化</span><br><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chmod +X  /etc/init.d/mysqld</span><br><span class="line">ln -s /usr/local/mysql/my.cnf /etc</span><br><span class="line">bin/mysql_secure_installation </span><br><span class="line">`</span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设置软连接</span><br><span class="line">ln -s /usr/local/mysql/bin<span class="comment">/* /usr/local/bin/</span><br><span class="line">ln -s /usr/local/mysql/include/mysql/* /usr/include/</span><br><span class="line">ln -s /usr/local/mysql/lib/* /usr/lib/</span><br><span class="line">`</span></span><br></pre></td></tr></table></figure><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">启动 </span><br><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>zabbix改中文</title>
      <link href="/2017/02/23/zabbix%E6%94%B9%E4%B8%AD%E6%96%87/"/>
      <url>/2017/02/23/zabbix%E6%94%B9%E4%B8%AD%E6%96%87/</url>
      
        <content type="html"><![CDATA[<p>找到本地C:\Windows\Fonts\simkai.ttf（楷体）上传到服务器zabbix网站目录fonts目录下<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zabbix网站根目录下面</span><br><span class="line">sed -i <span class="string">'s/DejaVuSans/simkai/g'</span> ./<span class="keyword">include</span>/defines.inc.php</span><br><span class="line">vim /<span class="keyword">include</span>/locales.inc.php </span><br><span class="line"><span class="string">'zh_CN'</span> =&gt; [<span class="string">'name'</span> =&gt; _(<span class="string">'Chinese (zh_CN)'</span>),<span class="string">'display'</span> =&gt; <span class="keyword">true</span>],</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>编译升级Openssh5.3至7.1</title>
      <link href="/2016/11/21/%E7%BC%96%E8%AF%91%E5%8D%87%E7%BA%A7Openssh5-3%E8%87%B37-1/"/>
      <url>/2016/11/21/%E7%BC%96%E8%AF%91%E5%8D%87%E7%BA%A7Openssh5-3%E8%87%B37-1/</url>
      
        <content type="html"><![CDATA[<p>编译生成OpenSSH RPM升级OpenSSH至7.1</p><p>安装编译所需工具<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall <span class="string">"Development tools"</span></span><br><span class="line">yum -y install pam-devel rpm-build rpmdevtools zlib-devel krb5-devel tcp_wrappers tcp_wrappers-devel tcp_wrappers-libs libX11-devel xmkmf libXt-devel wget</span><br></pre></td></tr></table></figure></p><p>配置RPM编译环境<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv rpmbuild/&#123;BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS&#125;</span><br></pre></td></tr></table></figure></p><p>下载源码包<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/rpmbuild/SOURCES/</span><br><span class="line">wget http:<span class="comment">//openbsd.hk/pub/OpenBSD/OpenSSH/portable/openssh-7.1p2.tar.gz</span></span><br><span class="line">wget http:<span class="comment">//ftp.riken.jp/Linux/momonga/6/Everything/SOURCES/x11-ssh-askpass-1.2.4.1.tar.gz</span></span><br></pre></td></tr></table></figure></p><p>配置SPEC文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~/rpmbuild/SPECS</span><br><span class="line">tar xfz ../SOURCES/openssh-<span class="number">7.1</span>p2.tar.gz openssh-<span class="number">7.1</span>p2/contrib/redhat/openssh.spec</span><br><span class="line">mv openssh-<span class="number">7.1</span>p2/contrib/redhat/openssh.spec openssh-<span class="number">7.1</span>p2.spec</span><br><span class="line">rm -rf openssh-<span class="number">7.1</span>p2</span><br><span class="line">sed -i -e <span class="string">"s/%define no_gnome_askpass 0/%define no_gnome_askpass 1/g"</span> openssh-<span class="number">7.1</span>p2.spec</span><br><span class="line">sed -i -e <span class="string">"s/%define no_x11_askpass 0/%define no_x11_askpass 1/g"</span> openssh-<span class="number">7.1</span>p2.spec</span><br><span class="line">sed -i -e <span class="string">"s/BuildPreReq/BuildRequires/g"</span> openssh-<span class="number">7.1</span>p2.spec</span><br></pre></td></tr></table></figure></p><p>编译生成RPM<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/rpmbuild/SPECS</span><br><span class="line">rpmbuild -bb openssh-<span class="number">7.1</span>p2.spec</span><br></pre></td></tr></table></figure></p><p>查看生成的RPM<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~/rpmbuild/RPMS/x86_64</span><br><span class="line">ls</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">445248</span> Nov <span class="number">18</span> <span class="number">10</span>:<span class="number">28</span> openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">41764</span> Nov <span class="number">18</span> <span class="number">10</span>:<span class="number">28</span> openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">577584</span> Nov <span class="number">18</span> <span class="number">10</span>:<span class="number">28</span> openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">16960</span> Nov <span class="number">18</span> <span class="number">10</span>:<span class="number">28</span> openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">390076</span> Nov <span class="number">18</span> <span class="number">10</span>:<span class="number">28</span> openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>卸载旧openssh<br><figure class="hljs highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa |<span class="string"> grep openssh </span>|<span class="string">xargs rpm -e  --nodeps</span></span><br></pre></td></tr></table></figure></p><p>安装生成RPM包<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">yum install openssh-*</span><br><span class="line">Loaded plugins: fastestmirror, refresh-packagekit, security</span><br><span class="line">Setting up Install Process</span><br><span class="line">Examining openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm: openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64</span><br><span class="line">Marking openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm to be installed</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * epel: mirrors.ustc.edu.cn</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * remi-safe: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">Examining openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm: openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64</span><br><span class="line">Marking openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm to be installed</span><br><span class="line">Examining openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm: openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64</span><br><span class="line">Marking openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm to be installed</span><br><span class="line">Examining openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm: openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64</span><br><span class="line">Marking openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm to be installed</span><br><span class="line">Examining openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm: openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64</span><br><span class="line">Marking openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package openssh.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span> will be installed</span><br><span class="line">---&gt; Package openssh-askpass.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span> will be installed</span><br><span class="line">---&gt; Package openssh-clients.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span> will be installed</span><br><span class="line">---&gt; Package openssh-debuginfo.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span> will be installed</span><br><span class="line">---&gt; Package openssh-server.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span> will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">====================================================================================================================================================================================================</span><br><span class="line"> Package                                         Arch                                 Version                                 Repository                                                       Size</span><br><span class="line">====================================================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> openssh                                         x86_64                               <span class="number">7.1</span>p2-<span class="number">1</span>                                 /openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                         <span class="number">1.9</span> M</span><br><span class="line"> openssh-askpass                                 x86_64                               <span class="number">7.1</span>p2-<span class="number">1</span>                                 /openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                  <span class="number">73</span> k</span><br><span class="line"> openssh-clients                                 x86_64                               <span class="number">7.1</span>p2-<span class="number">1</span>                                 /openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                 <span class="number">2.0</span> M</span><br><span class="line"> openssh-debuginfo                               x86_64                               <span class="number">7.1</span>p2-<span class="number">1</span>                                 /openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                               <span class="number">0.0</span>  </span><br><span class="line"> openssh-server                                  x86_64                               <span class="number">7.1</span>p2-<span class="number">1</span>                                 /openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                  <span class="number">937</span> k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">====================================================================================================================================================================================================</span><br><span class="line">Install       <span class="number">5</span> Package(s)</span><br><span class="line"></span><br><span class="line">Total size: <span class="number">4.9</span> M</span><br><span class="line">Installed size: <span class="number">4.9</span> M</span><br><span class="line">Is this ok [y/N]: y</span><br><span class="line">Downloading Packages:</span><br><span class="line">Running rpm_check_debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line">Warning: RPMDB altered outside of yum.</span><br><span class="line">** Found <span class="number">5</span> pre-existing rpmdb problem(s), <span class="string">'yum check'</span> output follows:</span><br><span class="line">git-<span class="number">1.7</span><span class="number">.1</span>-<span class="number">4.</span>el6_7<span class="number">.1</span>.x86_64 has missing requires of openssh-clients</span><br><span class="line">gnome-user-share-<span class="number">2.28</span><span class="number">.2</span>-<span class="number">3.</span>el6.x86_64 has missing requires of httpd &gt;= (<span class="string">'0'</span>, <span class="string">'2.2.0'</span>, None)</span><br><span class="line">php-<span class="number">5.6</span><span class="number">.26</span>-<span class="number">1.</span>el6.remi.x86_64 has missing requires of httpd-mmn = (<span class="string">'0'</span>, <span class="string">'20051115'</span>, None)</span><br><span class="line">python-meh-<span class="number">0.12</span><span class="number">.1</span>-<span class="number">3.</span>el6.noarch has missing requires of openssh-clients</span><br><span class="line">systemtap-client-<span class="number">2.9</span>-<span class="number">4.</span>el6.x86_64 has missing requires of openssh-clients</span><br><span class="line">  Installing : openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                           <span class="number">1</span>/<span class="number">5</span> </span><br><span class="line">  Installing : openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                   <span class="number">2</span>/<span class="number">5</span> </span><br><span class="line">  Installing : openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                    <span class="number">3</span>/<span class="number">5</span> </span><br><span class="line">  Installing : openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                   <span class="number">4</span>/<span class="number">5</span> </span><br><span class="line">  Installing : openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                 <span class="number">5</span>/<span class="number">5</span> </span><br><span class="line">  Verifying  : openssh-askpass-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                   <span class="number">1</span>/<span class="number">5</span> </span><br><span class="line">  Verifying  : openssh-server-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                    <span class="number">2</span>/<span class="number">5</span> </span><br><span class="line">  Verifying  : openssh-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                           <span class="number">3</span>/<span class="number">5</span> </span><br><span class="line">  Verifying  : openssh-clients-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                   <span class="number">4</span>/<span class="number">5</span> </span><br><span class="line">  Verifying  : openssh-debuginfo-<span class="number">7.1</span>p2-<span class="number">1.</span>x86_64                                                                                                                                                 <span class="number">5</span>/<span class="number">5</span> </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  openssh.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span>        openssh-askpass.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span>        openssh-clients.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span>        openssh-debuginfo.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span>        openssh-server.x86_64 <span class="number">0</span>:<span class="number">7.1</span>p2-<span class="number">1</span>       </span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure></p><p>将配置文件更新为新版本，避免某些参数变更造成无法远程登录<br><figure class="hljs highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="regexp">/etc/</span>ssh<span class="regexp">/sshd_config.rpmnew /</span>etc<span class="regexp">/ssh/</span>sshd_config</span><br></pre></td></tr></table></figure></p><p>制作ssh rpm 包升级后，ssh无法登录系统，报错如下：<br><figure class="hljs highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PAM unable to dlopen(<span class="regexp">/lib64/</span>security<span class="regexp">/pam_stack.so): /</span>lib64<span class="regexp">/security/</span>pam_stack.<span class="string">so:</span> cannot open shared object <span class="string">file:</span> No such file or directory</span><br><span class="line">PAM adding faulty <span class="string">module:</span> <span class="regexp">/lib64/</span>security/pam_stack.so</span><br></pre></td></tr></table></figure></p><p>解决方法：<br>ssh rpm 升级后会修改/etc/pam.d/sshd 文件<br><figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#%PAM-<span class="number">1.0</span></span><br><span class="line">auth       required     pam_stack.<span class="keyword">so</span> service=<span class="built_in">system</span>-auth</span><br><span class="line">account    required     pam_nologin.<span class="keyword">so</span></span><br><span class="line">account    required     pam_stack.<span class="keyword">so</span> service=<span class="built_in">system</span>-auth</span><br><span class="line">password   required     pam_stack.<span class="keyword">so</span> service=<span class="built_in">system</span>-auth</span><br><span class="line">session    required     pam_stack.<span class="keyword">so</span> service=<span class="built_in">system</span>-auth</span><br><span class="line">需要恢复原来的模样，如下：</span><br><span class="line"></span><br><span class="line">#%PAM-<span class="number">1.0</span></span><br><span class="line">auth       required     pam_sepermit.<span class="keyword">so</span></span><br><span class="line">auth       include      password-auth</span><br><span class="line">account    required     pam_nologin.<span class="keyword">so</span></span><br><span class="line">account    include      password-auth</span><br><span class="line">password   include      password-auth</span><br><span class="line"># pam_selinux.<span class="keyword">so</span> <span class="keyword">close</span> should <span class="keyword">be</span> the <span class="keyword">first</span> session rule</span><br><span class="line">session    required     pam_selinux.<span class="keyword">so</span> <span class="keyword">close</span></span><br><span class="line">session    required     pam_loginuid.<span class="keyword">so</span></span><br><span class="line"># pam_selinux.<span class="keyword">so</span> <span class="keyword">open</span> should <span class="keyword">only</span> <span class="keyword">be</span> followed by sessions <span class="keyword">to</span> <span class="keyword">be</span> executed in the user context</span><br><span class="line">session    required     pam_selinux.<span class="keyword">so</span> <span class="keyword">open</span> env_params</span><br><span class="line">session    optional     pam_keyinit.<span class="keyword">so</span> force revoke</span><br><span class="line">session    include      password-auth</span><br></pre></td></tr></table></figure></p><p>重启SSH服务<br><figure class="hljs highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/sshd restart</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>nginx日志自动切割脚本</title>
      <link href="/2016/11/09/nginx%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/"/>
      <url>/2016/11/09/nginx%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>nginx日志按日期自动切割脚本如下<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx日志切割脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#设置日志文件存放目录</span></span><br><span class="line">logs_path=<span class="string">"/usr/local/nginx/logs/"</span></span><br><span class="line"><span class="comment">#设置pid文件</span></span><br><span class="line">pid_path=<span class="string">"/usr/local/nginx/nginx.pid"</span></span><br><span class="line"><span class="comment">#重命名日志文件</span></span><br><span class="line">mv $&#123;logs_path&#125;access.log $&#123;logs_path&#125;access_$(date -d <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).log</span><br><span class="line"><span class="comment">#向nginx主进程发信号重新打开日志</span></span><br><span class="line">kill -USR1 `cat $&#123;pid_path&#125;`</span><br><span class="line">crontab -e 设置作业</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> * * * bash /usr/local/nginx/nginx_log.sh</span><br><span class="line">这样就每天的<span class="number">0</span>点<span class="number">0</span>分把nginx日志重命名为日期格式，并重新生成今天的新日志文件。</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>自己签发ssl证书生成</title>
      <link href="/2016/11/09/%E8%87%AA%E5%B7%B1%E7%AD%BE%E5%8F%91ssl%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90/"/>
      <url>/2016/11/09/%E8%87%AA%E5%B7%B1%E7%AD%BE%E5%8F%91ssl%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90/</url>
      
        <content type="html"><![CDATA[<figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#生成一个RSA密钥 </span><br><span class="line"></span><br><span class="line">$ openssl genrsa -des3 -out server<span class="class">.key</span> <span class="number">1024</span></span><br><span class="line">#拷贝一个不需要输入密码的密钥文件</span><br><span class="line"></span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> server<span class="class">.key</span> -out server_nopass<span class="class">.key</span></span><br><span class="line">#生成一个证书请求</span><br><span class="line"></span><br><span class="line">$ openssl req -new -key server<span class="class">.key</span> -out server<span class="class">.csr</span></span><br><span class="line">#自己签发证书</span><br><span class="line"></span><br><span class="line">$ openssl x509 -req -days <span class="number">3650</span> -<span class="keyword">in</span> server<span class="class">.csr</span> -signkey server<span class="class">.key</span> -out server.crt</span><br></pre></td></tr></table></figure><p>nginx 配置ssl<br><figure class="hljs highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate <span class="regexp">/etc/</span>nginx<span class="regexp">/ssl/</span>xxx.com.crt;</span><br><span class="line">ssl_certificate_key <span class="regexp">/etc/</span>nginx<span class="regexp">/ssl/</span>xxx.com.key;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> ssl </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>apache2.4.23编译安装</title>
      <link href="/2016/11/09/apache2-4-23%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
      <url>/2016/11/09/apache2-4-23%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>apache2.4.23编译安装<br>下载apache<br><figure class="hljs highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//apache.fayea.com//httpd/httpd-2.4.23.tar.gz</span></span><br><span class="line">tar zxvf httpd-<span class="number">2.4</span>.<span class="number">23</span><span class="class">.tar</span><span class="class">.gz</span></span><br></pre></td></tr></table></figure></p><p>下载安装apr<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//mirrors.tuna.tsinghua.edu.cn/apache//apr/apr-1.5.2.tar.gz</span></span><br><span class="line">tar zxvf apr-<span class="number">1.5</span><span class="number">.2</span>.tar.gz </span><br><span class="line">cd apr-<span class="number">1.5</span><span class="number">.2</span></span><br><span class="line"> ./configure --prefix=/usr/local/apr</span><br><span class="line">make &amp;install make</span><br><span class="line">cp ../apr-<span class="number">1.5</span><span class="number">.2</span> ../httpd-<span class="number">2.4</span><span class="number">.23</span>/srclib/apr</span><br></pre></td></tr></table></figure></p><p>下载apr-util编译安装apache<br><figure class="hljs highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> wget http:<span class="comment">//mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz</span></span><br><span class="line">tar zxvf  apr-util-<span class="number">1.5</span><span class="number">.4</span>.tar.gz</span><br><span class="line">cp -r apr-util-<span class="number">1.5</span><span class="number">.4</span> httpd-<span class="number">2.4</span><span class="number">.23</span>/srclib/apr-util</span><br><span class="line"></span><br><span class="line">cd httpd-<span class="number">2.4</span><span class="number">.23</span></span><br><span class="line"> ./configure --prefix=/usr/local/apache   --with-apr=/usr/local/apr --with-included-apr</span><br><span class="line"> make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p> <figure class="hljs highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apahce启动命令：</span><br><span class="line">/usr/<span class="built_in">local</span>/apache/bin/aachectl  <span class="built_in">start</span> |<span class="built_in">stop</span>|restart</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>tomcat性能优化实例</title>
      <link href="/2016/09/02/tomcat%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E4%BE%8B/"/>
      <url>/2016/09/02/tomcat%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>生产配置实例：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;Connectorport=<span class="string">"8080"</span>protocol=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span></span><br><span class="line">               maxThreads=<span class="string">"1000"</span></span><br><span class="line">               minSpareThreads=<span class="string">"100"</span></span><br><span class="line">               maxSpareThreads=<span class="string">"200"</span></span><br><span class="line">               acceptCount=<span class="string">"900"</span></span><br><span class="line">               disableUploadTimeout=<span class="string">"true"</span></span><br><span class="line">              connectionTimeout=<span class="string">"20000"</span></span><br><span class="line">               URIEncoding=<span class="string">"UTF-8"</span></span><br><span class="line">               enableLookups=<span class="string">"false"</span></span><br><span class="line">               redirectPort=<span class="string">"8443"</span></span><br><span class="line">               compression=<span class="string">"on"</span></span><br><span class="line">              compressionMinSize=<span class="string">"1024"</span></span><br><span class="line">              compressableMimeType=<span class="string">"text/html,text/xml,text/css,text/javascript"</span>/&gt;</span><br></pre></td></tr></table></figure></p><p>参数说明：<br>org.apache.coyote.http11.Http11NioProtocol：调整工作模式为Nio<br>有三种工作模式：Bio、Nio和Apr<br>Bio(Blocking I/O)：默认工作模式，阻塞式I/O操作，没有任何优化技术处理，性能比较低。<br>Nio(New I/O or Non-Blocking)：非阻塞式I/O操作，有Bio有更好的并发处理性能。<br>Apr(Apache Portable Runtime，Apache可移植运行库)：首选工作模式，主要为上层的应用程序提供一个可以跨越多操作系统平台使用的底层支持接口库。<br>tomcat利用基于Apr库tomcat-native来实现操作系统级别控制，提供一种优化技术和非阻塞式I/O操作，大大提高并发处理能力。但是需要安装apr和tomcat-native库。<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">maxThreads：最大线程数，默认<span class="number">150</span>。增大值避免队列请求过多，导致响应缓慢。</span><br><span class="line">minSpareThreads：最小空闲线程数。</span><br><span class="line">maxSpareThreads：最大空闲线程数，如果超过这个值，会关闭无用的线程。</span><br><span class="line">acceptCount：当处理请求超过此值时，将后来请求放到队列中等待。</span><br><span class="line">disableUploadTimeout：禁用上传超时时间</span><br><span class="line">connectionTimeout：连接超时，单位毫秒，<span class="number">0</span>代表不限制</span><br><span class="line">URIEncoding：URI地址编码使用UTF-<span class="number">8</span></span><br><span class="line">enableLookups：关闭dns解析，提高响应时间</span><br><span class="line">compression：启用压缩功能</span><br><span class="line">compressionMinSize：最小压缩大小，单位Byte</span><br><span class="line">compressableMimeType：压缩的文件类型</span><br></pre></td></tr></table></figure></p><p>调整JVM内存大小：<br>在catalina.sh增加JAVA_OPTS=’-Xms512m -Xmx1024m -XX:PermSize=128m-XX:MaxPermSize=256m’<br>-Xms JVM初始最小堆内存，默认为物理内存1/64，不要设置过大，否则增加回收时间（暂停应用），相对频率少，相反，频率高。<br>-Xmx JVM最大允许堆内存大小，默认为物理内存1/4<br>-XX:PermSize JVM初始分配非堆内存大小<br>-XX:MaxPermSize  JVM最大允许分配的非堆内存</p>]]></content>
      
      
      <categories>
          
          <category> tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>shell编程中if的语法和常见判断用法</title>
      <link href="/2016/09/02/shell%E7%BC%96%E7%A8%8B%E4%B8%ADif%E7%9A%84%E8%AF%AD%E6%B3%95%E5%92%8C%E5%B8%B8%E8%A7%81%E5%88%A4%E6%96%AD%E7%94%A8%E6%B3%95/"/>
      <url>/2016/09/02/shell%E7%BC%96%E7%A8%8B%E4%B8%ADif%E7%9A%84%E8%AF%AD%E6%B3%95%E5%92%8C%E5%B8%B8%E8%A7%81%E5%88%A4%E6%96%AD%E7%94%A8%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>一. if的基本语法</p><ol><li>if与[之间要有空格</li><li>[]与判断条件之间也必须有空格</li><li>]与;之间不能有空格</li></ol><p>二. 对字符串的判断</p><ol><li>if [ str1=str2 ];then fi #当两个字符串相同时返回真</li><li>if [ str1!=str2 ];then fi #当两个字符串不相等时返回真</li><li>if [ -n str1 ];then fi #当字符串的长度大于0时返回真 (判断变量是否有值)</li><li>if [ -z str1 ];then fi #当字符串的长度为0时返回真</li></ol><p>三. 对数字的判断</p><ol><li>int1 -eq int2 #int1和int2相等</li><li>int1 -ne int2 #int1不相等int2</li><li>int1 -gt int2 #int1大于int2</li><li>int1 -ge int2 #int1大于等于int2</li><li>int1 -lt int2 #int1小于int2</li><li>int1 -le int2 #int1小于等于int2</li></ol><p>四. 对文件属性的判断</p><ol><li>-r file #用户可读为真</li><li>-w file #用户可写为真</li><li>-x file #用户可执行为真</li><li>-f file #文件存在且为正规文件为真</li><li>-d file #如果是存在目录为真</li><li>-c file #文件存在且为字符设备文件</li><li>-b file #文件存在且为块设备文件</li><li>-s file #文件大小为非0为真，可以判断文件是否为空</li><li>-e file #如果文件存在为真</li></ol><p>五. 逻辑判断</p><ol><li>-a #与</li><li>-o #或</li><li>! #非</li></ol>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>linux用户登录报““su :cannot set user id: resource temporarily unavalable</title>
      <link href="/2016/08/24/linux%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%8A%A5%E2%80%9C%E2%80%9Csu-cannot-set-user-id-resource-temporarily-unavalable/"/>
      <url>/2016/08/24/linux%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%8A%A5%E2%80%9C%E2%80%9Csu-cannot-set-user-id-resource-temporarily-unavalable/</url>
      
        <content type="html"><![CDATA[<p>/etc/security/limits.d/90-nproc.conf<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*          soft    nproc     <span class="number">1024</span></span><br><span class="line">root       soft    nproc     unlimited</span><br></pre></td></tr></table></figure></p><p>更改为65535后，再su - user时，问题解决!</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>linux安装maven</title>
      <link href="/2016/08/01/linuxa%E5%AE%89%E8%A3%85maven/"/>
      <url>/2016/08/01/linuxa%E5%AE%89%E8%A3%85maven/</url>
      
        <content type="html"><![CDATA[<p>1.首先到Maven官网下载安装文件，目前最新版本为3.3.9，下载文件为apache-maven-3.3.9-bin.tar.gz，下载可以使用wget命令；<br><figure class="hljs highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/apache.fayea.com/maven</span><span class="regexp">/maven-3/</span><span class="number">3.3</span>.<span class="number">9</span>/binaries/apache-maven-<span class="number">3.3</span>.<span class="number">9</span>-bin.tar.gz</span><br></pre></td></tr></table></figure></p><p>2.进入下载文件夹，找到下载的文件，运行如下命令解压</p><figure class="hljs highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">tar</span> <span class="tag">-xvf</span>  <span class="tag">apache-maven-3</span><span class="class">.3</span><span class="class">.9-bin</span><span class="class">.tar</span><span class="class">.gz</span></span><br></pre></td></tr></table></figure><p>解压后的文件夹名为apache-maven-3.3.9</p><p>3.使用mv命令将apache-maven-3.3.9文件夹拷贝到自己指定的文件夹，比如/usr/local/下<br><figure class="hljs highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv -rf apache-maven-<span class="number">3.3</span> /usr/<span class="keyword">local</span>/</span><br></pre></td></tr></table></figure></p><p>4.配置环境变量，编辑/etc/profile文件，添加如下代码<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MAVEN_HOME=/usr/<span class="built_in">local</span>/apache-maven-<span class="number">3.3</span>.<span class="number">9</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_HOME</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;PATH&#125;</span>:<span class="variable">$&#123;MAVEN_HOME&#125;</span>/bin</span><br></pre></td></tr></table></figure></p><p>5.保存文件，并运行如下命令使环境变量生效<br>source /etc/profile</p><p>6.在控制台输入如下命令，如果能看到Maven相关版本信息，则说明Maven已经安装成功<br>mvn -v</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>windows下配置java环境</title>
      <link href="/2016/07/27/windows%E4%B8%8B%E9%85%8D%E7%BD%AEjava%E7%8E%AF%E5%A2%83/"/>
      <url>/2016/07/27/windows%E4%B8%8B%E9%85%8D%E7%BD%AEjava%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<p>Windows下配置Java环境变量</p><p>下载java se development kit - JDK</p><p>java官网： www.oracle.com</p><p> 环境变量配置：<br><figure class="hljs highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">JAVA_HOME</span><span class="symbol">:D</span><span class="symbol">:/Program</span> <span class="constant">Files</span>/<span class="constant">Java</span>/jdk1.<span class="number">6.0_10</span></span><br><span class="line"><span class="constant">PATH</span><span class="symbol">:%JAVA_HOME<span class="string">%/bin;%JAVA_HOME%/</span>jre/bin</span></span><br><span class="line"><span class="constant">CLASSPATH</span><span class="symbol">:</span>.;%<span class="constant">JAVA_HOME</span><span class="string">%/lib/</span>dt.jar;%<span class="constant">JAVA_HOME</span><span class="string">%/lib/</span>tools.jar</span><br></pre></td></tr></table></figure></p><p>说明：</p><p>1）JAVA_HOME指明JDK安装路径</p><p>2）PATH使得系统可以在任何路径下识别java命令</p><p>3）为java加载类(class or lib)路径，只有类在classpath中，java命令才能识别。</p><p>linux下环境变量：<br><figure class="hljs highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/java/jdk1.<span class="number">8.0_77</span></span><br><span class="line">export CLASSPATH=<span class="variable">$JAVA</span>_HOME/lib/tools.jar:<span class="variable">$JAVA</span>_HOME/lib/dt.jar:<span class="variable">$JAVA</span>_HOME/lib</span><br><span class="line">export PATH=<span class="variable">$JAVA</span>_HOME/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>SVN+apache搭建</title>
      <link href="/2016/07/05/SVN-apache%E6%90%AD%E5%BB%BA/"/>
      <url>/2016/07/05/SVN-apache%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<p>1.安装软件包<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd</span><br><span class="line">yum install mod_dav_svn</span><br><span class="line">yum install subversion</span><br></pre></td></tr></table></figure></p><p>2、创建仓库<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> mkdir /var/svn/svnrepos</span><br><span class="line">svnadmin create /var/svnrepos/jktest</span><br></pre></td></tr></table></figure></p><p>3、配置<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/var/svn/svnrepos/jktest</span><br><span class="line">conf目录下找到svnserve.conf</span><br><span class="line">password-db = passwd，将前面的<span class="comment">#删除，</span></span><br><span class="line">authz-db = authz   将前面的<span class="comment">#删除</span></span><br><span class="line">realm = /var/svn/svnrepos/jktest   将前面的<span class="comment">#删除改自己的库地址</span></span><br><span class="line">：wq</span><br><span class="line">vim /var/svn/svnrepos/jktest/conf/authz  添加用户名密码</span><br><span class="line">[/]</span><br><span class="line"><span class="built_in">test</span> = rw</span><br><span class="line">：wq</span><br><span class="line"> vim /var/svn/svnrepos/jktest/conf/passwd </span><br><span class="line"> [user]</span><br><span class="line"> <span class="built_in">test</span> = <span class="number">123456</span></span><br></pre></td></tr></table></figure></p><p>4、配置svn关联到apache:<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf.d/subversion.conf //添加下面内容</span><br><span class="line">LoadModule dav_svn_module     modules/mod_dav_svn.so  </span><br><span class="line"><span class="number">02</span>.LoadModule authz_svn_module   modules/mod_authz_svn.so  </span><br><span class="line"></span><br><span class="line">&lt;Location /svnrepos&gt;</span><br><span class="line">   DAV svn</span><br><span class="line">   SVNParentPath /var/svn/svnrepos</span><br><span class="line"></span><br><span class="line">   <span class="comment"># Limit write permission to list of valid users.</span></span><br><span class="line"><span class="comment">#   &lt;LimitExcept GET PROPFIND OPTIONS REPORT&gt;</span></span><br><span class="line">      <span class="comment"># Require SSL connection for password protection.</span></span><br><span class="line">      <span class="comment"># SSLRequireSSL</span></span><br><span class="line"></span><br><span class="line">      AuthType Basic</span><br><span class="line">      AuthName <span class="string">"Authorization svn"</span></span><br><span class="line">      AuthUserFile /var/svn/svnrepos/jktest/pwdfile</span><br><span class="line">      AuthzSVNAccessFile /var/svn/svnrepos/jktest/conf/authz</span><br><span class="line"><span class="string">"/etc/httpd/conf.d/subversion.conf"</span> <span class="number">41</span>L, <span class="number">1109</span>C</span><br></pre></td></tr></table></figure></p><p>添加<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf </span><br><span class="line">include conf.d/*.conf</span><br></pre></td></tr></table></figure></p><p>添加http访问用户<br>htpasswd -c /var/svn/svnrepos/jktest/pwdfile test<br>这里用到参数-c，是因为pwdfile文件不存在，如果文件存在，则无需该参数！否则，将覆盖掉原有密码文件<br>启动svn服务<br>svnserve -d -r /var/www/svn/project<br>启动httpd</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>nginx安装与负载均衡配置</title>
      <link href="/2016/07/01/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE/"/>
      <url>/2016/07/01/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="u5B89_u88C5nginx"><a href="#u5B89_u88C5nginx" class="headerlink" title="安装nginx"></a>安装nginx</h1><p>选择稳定版本</p><p>我们编译安装nginx来定制自己的模块。<br>•机器CentOS 6.6 x86_64。<br>•软件版本：Nginx 1.9.9</p><h2 id="yum__u4E00_u952E_u5B89_u88C5nginx"><a href="#yum__u4E00_u952E_u5B89_u88C5nginx" class="headerlink" title="yum 一键安装nginx"></a>yum 一键安装nginx</h2><p>yum安装rpm包会比编译安装简单很多，默认会安装许多模块，帮我们解决到很多依赖的安装包，但缺点是如果你想以后安装第三方模块那就没办法了。</p><p>使用Nginx官方源,Epel扩展库和remi源,remi源基于epel,必须先安装epel源,remi包含php-fpm,mysql-server5.5,如果只需要php-fpm可以单独安装php-fpm后禁用此源. </p><p>第一种方法:</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/yum.repo.d/nginx.repo</span></span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http:<span class="comment">//nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class="line">gpgcheck=<span class="number">0</span></span><br><span class="line">enabled=<span class="number">1</span></span><br></pre></td></tr></table></figure><p>剩下的就yum install nginx搞定，也可以yum install nginx-1.9.9安装指定版本（前提是你去packages里看到有对应的版本，默认是最新版稳定版）</p><p>第二种方法:</p><p>各节点时间同步<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># ntpdate 202.120.2.101</span></span><br><span class="line">安装EPEL源:</span><br><span class="line">rpm -Uvh  http:<span class="comment">//dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span></span><br><span class="line"> yum clean all</span><br><span class="line"> yum makecache</span><br><span class="line"> yum install -y nginx</span><br><span class="line"> service nginx start</span><br></pre></td></tr></table></figure></p><h1 id="nginx_u7F16_u8BD1_u5B89_u88C5_uFF1A"><a href="#nginx_u7F16_u8BD1_u5B89_u88C5_uFF1A" class="headerlink" title="nginx编译安装："></a>nginx编译安装：</h1><p>首先安装缺少的依赖包：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br><span class="line">```   </span><br><span class="line">这些软件包如果yum上没有的话可以下载源码来编译安装，只是要注意编译时默认安装的目录，确保下面在安装nginx时能够找到这些动态库文件（ldconfig）。</span><br><span class="line"></span><br><span class="line">下载nginx地址:[nginx](http:<span class="comment">//nginx.org/en/download.html)</span></span><br><span class="line"></span><br><span class="line"> 新建nginx用户与组</span><br><span class="line">``` bash</span><br><span class="line"> groupadd www</span><br><span class="line"> useradd -s /sbin/nologin -g www www </span><br><span class="line"></span><br><span class="line">编译配置文件</span><br><span class="line">tar -zxvf nginx-<span class="number">1.9</span><span class="number">.9</span>.tar.gz</span><br><span class="line">cd nginx-<span class="number">1.9</span><span class="number">.9</span>/</span><br><span class="line"> ./configure --user=www --group=www </span><br><span class="line"> --prefix=/usr/local/nginx </span><br><span class="line"> --error-log-path=/<span class="keyword">var</span>/log/nginx/error.log </span><br><span class="line"> --http-log-path=/<span class="keyword">var</span>/log/nginx/access.log </span><br><span class="line"> --with-http_stub_status_module </span><br><span class="line"> --with-http_ssl_module</span><br><span class="line"> --with-http_gzip_static_module </span><br><span class="line"> --with-http_realip_module</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">常用编译选项说明</span><br><span class="line"></span><br><span class="line">nginx大部分常用模块，编译时./configure –help以–without开头的都默认安装。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--prefix=PATH ： 指定nginx的安装目录。默认 /usr/local/nginx</span><br><span class="line">--conf-path=PATH ： 设置nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为prefix/conf/nginx.conf</span><br><span class="line">--user=name： 设置nginx工作进程的用户。安装完成后，可以随时在nginx.conf配置文件更改user指令。默认的用户名是nobody。--group=name类似</span><br><span class="line">--with-pcre ： 设置PCRE库的源码路径，如果已通过yum方式安装，使用--with-pcre自动找到库文件。使用--with-pcre=PATH时，需要从PCRE网站下载pcre库的源码（版本<span class="number">4.4</span> - <span class="number">8.30</span>）并解压，剩下的就交给Nginx的./configure和make来完成。perl正则表达式使用在location指令和 ngx_http_rewrite_module模块中。</span><br><span class="line">--with-zlib=PATH ： 指定 zlib（版本<span class="number">1.1</span><span class="number">.3</span> - <span class="number">1.2</span><span class="number">.5</span>）的源码解压目录。在默认就启用的网络传输压缩模块ngx_http_gzip_module时需要使用zlib 。</span><br><span class="line">--with-http_ssl_module ： 使用https协议模块。默认情况下，该模块没有被构建。前提是openssl与openssl-devel已安装</span><br><span class="line">--with-http_stub_status_module ： 用来监控 Nginx 的当前状态</span><br><span class="line">--with-http_realip_module ： 通过这个模块允许我们改变客户端请求头中客户端IP地址值(例如X-Real-IP 或 X-Forwarded-<span class="keyword">For</span>)，意义在于能够使得后台服务器记录原始客户端的IP地址</span><br><span class="line">--add-module=PATH ： 添加第三方外部模块，如nginx-sticky-module-ng或缓存模块。每次添加新的模块都要重新编译（Tengine可以在新加入module时无需重新编译）</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">再提供一种编译方案：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line"> --prefix=/usr \</span><br><span class="line"> --sbin-path=/usr/sbin/nginx \</span><br><span class="line"> --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line"> --error-log-path=/<span class="keyword">var</span>/log/nginx/error.log \</span><br><span class="line"> --http-log-path=/<span class="keyword">var</span>/log/nginx/access.log \</span><br><span class="line"> --pid-path=/<span class="keyword">var</span>/run/nginx/nginx.pid  \</span><br><span class="line"> --lock-path=/<span class="keyword">var</span>/lock/nginx.lock \   </span><br><span class="line"> --user=nginx \</span><br><span class="line"> --group=nginx \</span><br><span class="line"> --with-http_ssl_module \</span><br><span class="line"> --with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line"> --http-client-body-temp-path=/<span class="keyword">var</span>/tmp/nginx/client/ \</span><br><span class="line"> --http-proxy-temp-path=/<span class="keyword">var</span>/tmp/nginx/proxy/ \</span><br><span class="line"> --http-fastcgi-temp-path=/<span class="keyword">var</span>/tmp/nginx/fcgi/ \</span><br><span class="line"> --http-uwsgi-temp-path=/<span class="keyword">var</span>/tmp/nginx/uwsgi \</span><br><span class="line"> --with-pcre=../pcre-<span class="number">7.8</span></span><br><span class="line"> --with-zlib=../zlib-<span class="number">1.2</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">启动nginx服务</span><br><span class="line">/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx   <span class="comment">##做软连接</span></span><br><span class="line">cp nginx.init /etc/init.d/nginx  启动脚本</span><br><span class="line">chmod +x /etc/init.d/nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx启动脚本</span><br><span class="line">nginx</span><br><span class="line">```php</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># nginx - this script starts and stops the nginx daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:   - 85 15</span></span><br><span class="line"><span class="comment"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span></span><br><span class="line"><span class="comment">#               proxy and IMAP/POP3 proxy server</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># config:      /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># config:      /etc/sysconfig/nginx</span></span><br><span class="line"><span class="comment"># pidfile:     /var/run/nginx.pid</span></span><br><span class="line">                                    </span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line">                                    </span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line">                                    </span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="string">"$NETWORKING"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">                                    </span><br><span class="line">nginx=<span class="string">"/usr/sbin/nginx"</span></span><br><span class="line">prog=$(basename <span class="variable">$nginx</span>)</span><br><span class="line">                                    </span><br><span class="line">sysconfig=<span class="string">"/etc/sysconfig/$prog"</span></span><br><span class="line">lockfile=<span class="string">"/var/lock/subsys/nginx"</span></span><br><span class="line">pidfile=<span class="string">"/var/run/$&#123;prog&#125;.pid"</span></span><br><span class="line">                                    </span><br><span class="line">NGINX_CONF_FILE=<span class="string">"/etc/nginx/nginx.conf"</span></span><br><span class="line">                                    </span><br><span class="line">[ -f <span class="variable">$sysconfig</span> ] &amp;&amp; . <span class="variable">$sysconfig</span></span><br><span class="line">                                    </span><br><span class="line">                                    </span><br><span class="line">start() &#123;</span><br><span class="line">    [ -x <span class="variable">$nginx</span> ] || <span class="keyword">exit</span> <span class="number">5</span></span><br><span class="line">    [ -f <span class="variable">$NGINX_CONF_FILE</span> ] || <span class="keyword">exit</span> <span class="number">6</span></span><br><span class="line">    <span class="keyword">echo</span> -n $<span class="string">"Starting $prog: "</span></span><br><span class="line">    daemon <span class="variable">$nginx</span> -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="keyword">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq <span class="number">0</span> ] &amp;&amp; touch <span class="variable">$lockfile</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">stop() &#123;</span><br><span class="line">    <span class="keyword">echo</span> -n $<span class="string">"Stopping $prog: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="keyword">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq <span class="number">0</span> ] &amp;&amp; rm -f <span class="variable">$lockfile</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">restart() &#123;</span><br><span class="line">    configtest_q || <span class="keyword">return</span> <span class="number">6</span></span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">reload() &#123;</span><br><span class="line">    configtest_q || <span class="keyword">return</span> <span class="number">6</span></span><br><span class="line">    <span class="keyword">echo</span> -n $<span class="string">"Reloading $prog: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -HUP</span><br><span class="line">    <span class="keyword">echo</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">configtest() &#123;</span><br><span class="line">    <span class="variable">$nginx</span> -t -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">configtest_q() &#123;</span><br><span class="line">    <span class="variable">$nginx</span> -t -q -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">rh_status() &#123;</span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line">rh_status_q() &#123;</span><br><span class="line">    rh_status &gt;/dev/<span class="keyword">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line"><span class="comment"># Upgrade the binary with no downtime.</span></span><br><span class="line">upgrade() &#123;</span><br><span class="line">    local oldbin_pidfile=<span class="string">"$&#123;pidfile&#125;.oldbin"</span></span><br><span class="line">                                    </span><br><span class="line">    configtest_q || <span class="keyword">return</span> <span class="number">6</span></span><br><span class="line">    <span class="keyword">echo</span> -n $<span class="string">"Upgrading $prog: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -USR2</span><br><span class="line">    retval=$?</span><br><span class="line">    sleep <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f $&#123;oldbin_pidfile&#125; &amp;&amp; -f $&#123;pidfile&#125; ]];  then</span><br><span class="line">        killproc -p <span class="variable">$oldbin_pidfile</span> <span class="variable">$prog</span> -QUIT</span><br><span class="line">        success $<span class="string">"$prog online upgrade"</span></span><br><span class="line">        <span class="keyword">echo</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        failure $<span class="string">"$prog online upgrade"</span></span><br><span class="line">        <span class="keyword">echo</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line"><span class="comment"># Tell nginx to reopen logs</span></span><br><span class="line">reopen_logs() &#123;</span><br><span class="line">    configtest_q || <span class="keyword">return</span> <span class="number">6</span></span><br><span class="line">    <span class="keyword">echo</span> -n $<span class="string">"Reopening $prog logs: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -USR1</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="keyword">echo</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line">                                    </span><br><span class="line"><span class="keyword">case</span> <span class="string">"$1"</span> in</span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">        $<span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">        $<span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart|configtest|reopen_logs)</span><br><span class="line">        $<span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload|upgrade) </span><br><span class="line">        rh_status_q || <span class="keyword">exit</span> <span class="number">7</span></span><br><span class="line">        upgrade</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="keyword">exit</span> <span class="number">7</span></span><br><span class="line">        $<span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line">    status|status_q)</span><br><span class="line">        rh_$<span class="number">1</span></span><br><span class="line">        ;;</span><br><span class="line">    condrestart|<span class="keyword">try</span>-restart)</span><br><span class="line">        rh_status_q || <span class="keyword">exit</span> <span class="number">7</span></span><br><span class="line">        restart</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="keyword">echo</span> $<span class="string">"Usage: $0 &#123;start|stop|reload|configtest|status|force-reload|upgrade|restart|reopen_logs&#125;"</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">2</span></span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p><h1 id="u542F_u52A8_u5173_u95EDnginx"><a href="#u542F_u52A8_u5173_u95EDnginx" class="headerlink" title="启动关闭nginx"></a>启动关闭nginx</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件是否正确</span></span><br><span class="line"><span class="comment"># /usr/local/nginx-1.6/sbin/nginx -t </span></span><br><span class="line"><span class="comment"># ./sbin/nginx -V     # 可以看到编译选项</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动、关闭</span></span><br><span class="line"><span class="comment"># ./sbin/nginx        # 默认配置文件 conf/nginx.conf，-c 指定</span></span><br><span class="line"><span class="comment"># ./sbin/nginx -s stop</span></span><br><span class="line">或 pkill nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">## 重启，不会改变启动时指定的配置文件</span></span><br><span class="line"><span class="comment"># ./sbin/nginx -s reload</span></span><br><span class="line">或 kill -HUP `cat /usr/local/nginx-<span class="number">1.6</span>/logs/nginx.pid`</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">设置开机启动</span><br><span class="line">chkconfig --level <span class="number">345</span> nginx on</span><br><span class="line">chkconfig nginx on </span><br><span class="line">chkconfig nginx --<span class="keyword">list</span> </span><br><span class="line">  nginx              <span class="number">0</span>:关闭    <span class="number">1</span>:关闭    <span class="number">2</span>:启用    <span class="number">3</span>:启用    <span class="number">4</span>:启用    <span class="number">5</span>:启用    <span class="number">6</span>:关闭</span><br><span class="line"></span><br><span class="line">当然也可以将 nginx 作为系统服务管理，下载 nginx 到/etc/init.d/，修改里面的路径然后赋予可执行权限。</span><br><span class="line">service nginx &#123;start|stop|status|restart|reload|configtest&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-conf_u914D_u7F6E_u6587_u4EF6"><a href="#nginx-conf_u914D_u7F6E_u6587_u4EF6" class="headerlink" title="nginx.conf配置文件"></a>nginx.conf配置文件</h1><p>Nginx配置文件主要分成四部分：main（全局设置）、server（主机设置）、upstream（上游服务器设置，主要为反向代理、负载均衡相关配置）和 location（URL匹配特定位置后的设置），每部分包含若干个指令。main部分设置的指令将影响其它所有部分的设置；server部分的指令主要用于指定虚拟主机域名、IP和端口；upstream的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；location部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。他们之间的关系式：server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。</p><p>当前nginx支持的几个指令上下文：</p><p>配置文件<br>下面的nginx.conf简单的实现nginx在前端做反向代理服务器的例子，处理js、png等静态文件，jsp等动态请求转发到其它服务器tomcat：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user  www www;</span><br><span class="line">worker_processes  <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log;</span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">epoll</span>;</span><br><span class="line">    worker_connections  <span class="number">2048</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="keyword">include</span>       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment"># tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># gzip压缩功能设置</span></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length <span class="number">1</span>k;</span><br><span class="line">    gzip_buffers    <span class="number">4</span> <span class="number">16</span>k;</span><br><span class="line">    gzip_http_version <span class="number">1.0</span>;</span><br><span class="line">    gzip_comp_level <span class="number">6</span>;</span><br><span class="line">    gzip_types text/html text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># http_proxy 设置</span></span><br><span class="line">    client_max_body_size   <span class="number">10</span>m;</span><br><span class="line">    client_body_buffer_size   <span class="number">128</span>k;</span><br><span class="line">    proxy_connect_timeout   <span class="number">75</span>;</span><br><span class="line">    proxy_send_timeout   <span class="number">75</span>;</span><br><span class="line">    proxy_read_timeout   <span class="number">75</span>;</span><br><span class="line">    proxy_buffer_size   <span class="number">4</span>k;</span><br><span class="line">    proxy_buffers   <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line">    proxy_busy_buffers_size   <span class="number">64</span>k;</span><br><span class="line">    proxy_temp_file_write_size  <span class="number">64</span>k;</span><br><span class="line">    proxy_temp_path   /usr/local/nginx/proxy_temp <span class="number">1</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 设定负载均衡后台服务器列表 </span></span><br><span class="line">    upstream  backend  &#123; </span><br><span class="line">              <span class="comment">#ip_hash; </span></span><br><span class="line">              server   <span class="number">192.168</span><span class="number">.10</span><span class="number">.100</span>:<span class="number">8080</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s ;  </span><br><span class="line">              server   <span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span>:<span class="number">8080</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s ;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 很重要的虚拟主机配置</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  itoatest.example.com;</span><br><span class="line">        root   /apps/oaapp;</span><br><span class="line"></span><br><span class="line">        charset utf-<span class="number">8</span>;</span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#对 / 所有做负载均衡+反向代理</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /apps/oaapp;</span><br><span class="line">            index  index.jsp index.html index.htm;</span><br><span class="line"></span><br><span class="line">            proxy_pass        http:<span class="comment">//backend;  </span></span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            <span class="comment"># 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">            proxy_set_header  Host  <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;  </span><br><span class="line">            proxy_set_header  X-Forwarded-<span class="keyword">For</span>  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#静态文件，nginx自己处理，不去backend请求tomcat</span></span><br><span class="line">        location  ~* /download/ &#123;  </span><br><span class="line">            root /apps/oa/fs;  </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$   </span><br><span class="line">        &#123;   </span><br><span class="line">            root /apps/oaapp;   </span><br><span class="line">            expires      <span class="number">7</span>d; </span><br><span class="line">        &#125;</span><br><span class="line">       location /nginx_status &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log off;</span><br><span class="line">            allow <span class="number">192.168</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">24</span>;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ ^/(WEB-INF)/ &#123;   </span><br><span class="line">            deny all;   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line">        location = /<span class="number">50</span>x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 其它虚拟主机，server 指令开始</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">这里我整理了一份每个含义的详解：</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义Nginx运行的用户和用户</span></span><br><span class="line">user www www;</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx进程数，建议设置为等于CPU总核心数。</span></span><br><span class="line">worker_processes <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span></span><br><span class="line">error_log /<span class="keyword">var</span>/log/nginx/error.log info;</span><br><span class="line"></span><br><span class="line"><span class="comment">#进程文件</span></span><br><span class="line">pid /<span class="keyword">var</span>/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</span></span><br><span class="line">worker_rlimit_nofile <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#工作模式与连接数上限</span></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">epoll</span>;</span><br><span class="line"><span class="comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span></span><br><span class="line">worker_connections <span class="number">65535</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定http服务器</span></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span> mime.types; <span class="comment">#文件扩展名与文件类型映射表</span></span><br><span class="line">default_type application/octet-stream; <span class="comment">#默认文件类型</span></span><br><span class="line"><span class="comment">#charset utf-8; #默认编码</span></span><br><span class="line">server_names_hash_bucket_size <span class="number">128</span>; <span class="comment">#服务器名字的hash表大小</span></span><br><span class="line">client_header_buffer_size <span class="number">32</span>k; <span class="comment">#上传文件大小限制</span></span><br><span class="line">large_client_header_buffers <span class="number">4</span> <span class="number">64</span>k; <span class="comment">#设定请求缓</span></span><br><span class="line">client_max_body_size <span class="number">8</span>m; <span class="comment">#设定请求缓</span></span><br><span class="line">sendfile on; <span class="comment">#开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。</span></span><br><span class="line">autoindex on; <span class="comment">#开启目录列表访问，合适下载服务器，默认关闭。</span></span><br><span class="line">tcp_nopush on; <span class="comment">#防止网络阻塞</span></span><br><span class="line">tcp_nodelay on; <span class="comment">#防止网络阻塞</span></span><br><span class="line">keepalive_timeout <span class="number">120</span>; <span class="comment">#长连接超时时间，单位是秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。</span></span><br><span class="line">fastcgi_connect_timeout <span class="number">300</span>;</span><br><span class="line">fastcgi_send_timeout <span class="number">300</span>;</span><br><span class="line">fastcgi_read_timeout <span class="number">300</span>;</span><br><span class="line">fastcgi_buffer_size <span class="number">64</span>k;</span><br><span class="line">fastcgi_buffers <span class="number">4</span> <span class="number">64</span>k;</span><br><span class="line">fastcgi_busy_buffers_size <span class="number">128</span>k;</span><br><span class="line">fastcgi_temp_file_write_size <span class="number">128</span>k;</span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip模块设置</span></span><br><span class="line">gzip on; <span class="comment">#开启gzip压缩输出</span></span><br><span class="line">gzip_min_length <span class="number">1</span>k; <span class="comment">#最小压缩文件大小</span></span><br><span class="line">gzip_buffers <span class="number">4</span> <span class="number">16</span>k; <span class="comment">#压缩缓冲区</span></span><br><span class="line">gzip_http_version <span class="number">1.0</span>; <span class="comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span></span><br><span class="line">gzip_comp_level <span class="number">2</span>; <span class="comment">#压缩等级</span></span><br><span class="line">gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line"><span class="comment">#压缩类型，默认就已经包含text/html，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</span></span><br><span class="line">gzip_vary on;</span><br><span class="line"><span class="comment">#limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用</span></span><br><span class="line"></span><br><span class="line">upstream blog.kern.com &#123;</span><br><span class="line"><span class="comment">#upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span></span><br><span class="line">server <span class="number">192.168</span><span class="number">.80</span><span class="number">.121</span>:<span class="number">80</span> weight=<span class="number">3</span>;</span><br><span class="line">server <span class="number">192.168</span><span class="number">.80</span><span class="number">.122</span>:<span class="number">80</span> weight=<span class="number">2</span>;</span><br><span class="line">server <span class="number">192.168</span><span class="number">.80</span><span class="number">.123</span>:<span class="number">80</span> weight=<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟主机的配置</span></span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#监听端口</span></span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line"><span class="comment">#域名可以有多个，用空格隔开</span></span><br><span class="line">server_name www.kern.com ;   <span class="comment">##(服务器名)</span></span><br><span class="line">index index.html index.htm index.php;</span><br><span class="line">root /data/www/ha97; </span><br><span class="line">location ~ .*\.(php|php5)?$</span><br><span class="line">&#123;</span><br><span class="line">fastcgi_pass <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line"><span class="keyword">include</span> fastcgi.conf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#图片缓存时间设置</span></span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">&#123;</span><br><span class="line">expires <span class="number">10</span>d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#JS和CSS缓存时间设置</span></span><br><span class="line">location ~ .*\.(js|css)?$</span><br><span class="line">&#123;</span><br><span class="line">expires <span class="number">1</span>h;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#日志格式设定</span></span><br><span class="line">log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</span><br><span class="line"><span class="comment">#定义本虚拟主机的访问日志</span></span><br><span class="line">access_log /<span class="keyword">var</span>/log/nginx/ha97access.log access;</span><br><span class="line"></span><br><span class="line"><span class="comment">#对 "/" 启用反向代理</span></span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http:<span class="comment">//127.0.0.1:88;</span></span><br><span class="line">proxy_redirect off;</span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">proxy_set_header X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="comment">#以下是一些反向代理的配置，可选。</span></span><br><span class="line">proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">client_max_body_size <span class="number">10</span>m; <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">client_body_buffer_size <span class="number">128</span>k; <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数，</span></span><br><span class="line">proxy_connect_timeout <span class="number">90</span>; <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">proxy_send_timeout <span class="number">90</span>; <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">proxy_read_timeout <span class="number">90</span>; <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">proxy_buffer_size <span class="number">4</span>k; <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">proxy_buffers <span class="number">4</span> <span class="number">32</span>k; <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的设置</span></span><br><span class="line">proxy_busy_buffers_size <span class="number">64</span>k; <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">proxy_temp_file_write_size <span class="number">64</span>k;</span><br><span class="line"><span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定查看Nginx状态的地址</span></span><br><span class="line">location /NginxStatus &#123;</span><br><span class="line">stub_status on;</span><br><span class="line">access_log on;</span><br><span class="line">auth_basic <span class="string">"NginxStatus"</span>;</span><br><span class="line">auth_basic_user_file conf/htpasswd;</span><br><span class="line"><span class="comment">#htpasswd文件的内容可以用apache提供的htpasswd工具来产生。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地动静分离反向代理配置</span></span><br><span class="line"><span class="comment">#所有jsp的页面均交由tomcat或resin处理</span></span><br><span class="line">location ~ .(jsp|jspx|<span class="keyword">do</span>)?$ &#123;</span><br><span class="line">proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">proxy_set_header X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">proxy_pass http:<span class="comment">//127.0.0.1:8080;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#所有静态文件由nginx直接读取不经过tomcat或resin</span></span><br><span class="line">location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$</span><br><span class="line">&#123; expires <span class="number">15</span>d; &#125;</span><br><span class="line">location ~ .*.(js|css)?$</span><br><span class="line">&#123; expires <span class="number">1</span>h; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="Nginx_+_Tomcat_u505A_u8D1F_u8F7D_u5747_u8861"><a href="#Nginx_+_Tomcat_u505A_u8D1F_u8F7D_u5747_u8861" class="headerlink" title="Nginx + Tomcat做负载均衡"></a>Nginx + Tomcat做负载均衡</h1><p>Nginx负载均衡，其实主要就是用upstream、server指令，再配以权重等等参数。如果为了让nginx支持session共享，还需要额外增加一个模块。</p><h2 id="u4E00_u3001Nginx_u8D1F_u8F7D_u5747_u8861"><a href="#u4E00_u3001Nginx_u8D1F_u8F7D_u5747_u8861" class="headerlink" title="一、Nginx负载均衡"></a>一、Nginx负载均衡</h2><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">在http&#123;…&#125;中配置一个upstream&#123;…&#125;，参考如下：</span><br><span class="line">引用</span><br><span class="line">upstream tomcat-account &#123;</span><br><span class="line">    server <span class="number">10.11</span><span class="number">.155</span><span class="number">.26</span>:<span class="number">8080</span> weight=<span class="number">1</span>;    </span><br><span class="line">    server <span class="number">10.11</span><span class="number">.155</span><span class="number">.41</span>:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接着修改location节点，配置代理：</span><br><span class="line"></span><br><span class="line">引用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  <span class="number">10001.</span>test.intranet;</span><br><span class="line">        location / &#123;</span><br><span class="line">           index        index.html index.php index.jsp index.htm;</span><br><span class="line">           proxy_pass           http:<span class="comment">//tomcat-account;</span></span><br><span class="line">           proxy_ignore_client_abort on;</span><br><span class="line">           proxy_redirect               off;</span><br><span class="line">           proxy_set_header     Host    <span class="variable">$host</span>;</span><br><span class="line">           proxy_set_header     X-Real-IP       <span class="variable">$remote_addr</span>;</span><br><span class="line">           proxy_set_header     X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">```   </span><br><span class="line">这里可以写自己的内网域名也可以写IP</span><br><span class="line">当访问根路径时，会轮播路由到两台服务器上，至于后端服务器是tomcat还是jetty之类的，都无所谓，照葫芦画瓢就是了。</span><br><span class="line"></span><br><span class="line">当然，有的机器性能好，或者负载低，可以承担高负荷访问量，可以通过权重（weight），提升访问频率。数值越高，被分配到的请求数越多。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server指令参数如下：</span><br><span class="line"></span><br><span class="line">``` bash </span><br><span class="line">- weight   ——权重，数值越大，分得的请求数就越多，默认值为<span class="number">1</span>。</span><br><span class="line">- max_fails ——对访问失败的后端服务器尝试访问的次数。默认值为<span class="number">1</span>，当设置为<span class="number">0</span>时将关闭检查。</span><br><span class="line">- fail_timeout——失效超时时间，当多次访问失败后，对该节点暂停访问。</span><br><span class="line">- down——标记服务器为永久离线状态，用于ip_hash指令。</span><br><span class="line">- backup——仅当非backup服务器全部宕机或繁忙时启用。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">例如，可以这样配置：</span><br><span class="line"></span><br><span class="line">引用</span><br><span class="line">upstream tomcat &#123;</span><br><span class="line">    server <span class="number">10.11</span><span class="number">.155</span><span class="number">.26</span>:<span class="number">8080</span> weight=<span class="number">5</span>;</span><br><span class="line">    server <span class="number">10.11</span><span class="number">.155</span><span class="number">.41</span>:<span class="number">8080</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后者分得的请求数就会较高。</p><p>详细点的负载均衡配置nginx.conf:</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user  www;</span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line">error_log  /opt/logs/nginx/error.log  crit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># pid        /usr/local/nginx/nginx.pid;</span></span><br><span class="line">pid         /<span class="keyword">var</span>/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">epoll</span>;</span><br><span class="line">    worker_connections  <span class="number">65535</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    <span class="keyword">include</span>             /etc/nginx/mime.types;</span><br><span class="line">    default_type    application/octet-stream;</span><br><span class="line">    </span><br><span class="line"> <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line">    server_names_hash_bucket_size <span class="number">128</span>;</span><br><span class="line">    client_header_buffer_size <span class="number">32</span>k;</span><br><span class="line">    large_client_header_buffers <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush  on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    access_log        /<span class="keyword">var</span>/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#省略上文有的一些配置节点</span></span><br><span class="line">    <span class="comment">#。。。。。。。。。。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">    upstream tomcat-account &#123;</span><br><span class="line">        <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">        server <span class="number">192.168</span><span class="number">.8</span><span class="number">.1</span>x:<span class="number">3128</span> weight=<span class="number">5</span>;</span><br><span class="line">        <span class="comment">#本机上的Squid开启3128端口,不是必须要squid</span></span><br><span class="line">        server <span class="number">192.168</span><span class="number">.8</span><span class="number">.2</span>x:<span class="number">80</span>    weight=<span class="number">1</span>;</span><br><span class="line">        server <span class="number">192.168</span><span class="number">.8</span><span class="number">.3</span>x:<span class="number">80</span>    weight=<span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    upstream mysvr2 &#123;</span><br><span class="line">        <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">        server <span class="number">192.168</span><span class="number">.8</span>.x:<span class="number">80</span>    weight=<span class="number">1</span>;</span><br><span class="line">        server <span class="number">192.168</span><span class="number">.8</span>.x:<span class="number">80</span>    weight=<span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#第一个虚拟服务器</span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#侦听192.168.8.x的80端口</span></span><br><span class="line">        listen             <span class="number">80</span>;</span><br><span class="line">        server_name    <span class="number">192.168</span><span class="number">.8</span>.x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#对aspx后缀的进行负载均衡请求</span></span><br><span class="line">        location ~ .*.aspx$ &#123;</span><br><span class="line">            <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">            root     /root; </span><br><span class="line">            <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">            index index.php index.html index.htm;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#请求转向mysvr 定义的服务器列表</span></span><br><span class="line">            proxy_pass   http:<span class="comment">//tomcat-account;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#以下是一些反向代理的配置可删除.所以可以按nginx+tomcat 做负载均衡即可。</span></span><br><span class="line"></span><br><span class="line">            proxy_redirect off;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">            client_max_body_size <span class="number">10</span>m; </span><br><span class="line"></span><br><span class="line">            <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数，</span></span><br><span class="line">            client_body_buffer_size <span class="number">128</span>k;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">            proxy_connect_timeout <span class="number">90</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">            proxy_read_timeout <span class="number">90</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">            proxy_buffer_size <span class="number">4</span>k;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span></span><br><span class="line">            proxy_buffers <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">            proxy_busy_buffers_size <span class="number">64</span>k; </span><br><span class="line"></span><br><span class="line">            <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line">            proxy_temp_file_write_size <span class="number">64</span>k;    </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>常用指令说明</p><p>nginx在运行时与具体业务功能（比如http服务或者email服务代理）无关的一些参数，比如工作进程数，运行的身份等。</p><p>woker_processes 2<br>在配置文件的顶级main部分，worker角色的工作进程的个数，master进程是接收并分配请求给worker处理。这个数值简单一点可以设置为cpu的核数grep ^processor /proc/cpuinfo | wc -l，也是 auto 值，如果开启了ssl和gzip更应该设置成与逻辑CPU数量一样甚至为2倍，可以减少I/O操作。如果nginx服务器还有其它服务，可以考虑适当减少。</p><p>worker_cpu_affinity<br>也是写在main部分。在高并发情况下，通过设置cpu粘性来降低由于多CPU核切换造成的寄存器等现场重建带来的性能损耗。如worker_cpu_affinity 0001 0010 0100 1000; （四核）。</p><p>worker_connections 2048<br>写在events部分。每一个worker进程能并发处理（发起）的最大连接数（包含与客户端或后端被代理服务器间等所有连接数）。nginx作为反向代理服务器，计算公式 最大连接数 = worker_processes * worker_connections/4，所以这里客户端最大连接数是1024，这个可以增到到8192都没关系，看情况而定，但不能超过后面的worker_rlimit_nofile。当nginx作为http服务器时，计算公式里面是除以2。</p><p>worker_rlimit_nofile 10240<br>写在main部分。默认是没有设置，可以限制为操作系统最大的限制65535。</p><p>use epoll<br>写在events部分。在Linux操作系统下，nginx默认使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。在操作系统不支持这些高效模型时才使用select。</p><p>2.2.2 http服务器</p><p>与提供http服务相关的一些配置参数。例如：是否使用keepalive啊，是否使用gzip进行压缩等。</p><p>sendfile on<br>开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，减少用户空间到内核空间的上下文切换。对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</p><p>keepalive_timeout 65 : 长连接超时时间，单位是秒，这个参数很敏感，涉及浏览器的种类、后端服务器的超时设置、操作系统的设置，可以另外起一片文章了。长连接请求大量小文件的时候，可以减少重建连接的开销，但假如有大文件上传，65s内没上传完成会导致失败。如果设置时间过长，用户又多，长时间保持连接会占用大量资源。</p><p>send_timeout : 用于指定响应客户端的超时时间。这个超时仅限于两个连接活动之间的时间，如果超过这个时间，客户端没有任何活动，Nginx将会关闭连接。</p><p>client_max_body_size 10m<br>允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值</p><p>client_body_buffer_size 128k<br>缓冲区代理缓冲用户端请求的最大字节数<br>模块http_proxy：<br>这个模块实现的是nginx作为反向代理服务器的功能，包括缓存功能（另见文章）</p><p>proxy_connect_timeout 60<br>nginx跟后端服务器连接超时时间(代理连接超时)<br>proxy_read_timeout 60<br>连接成功后，与后端服务器两个成功的响应操作之间超时时间(代理接收超时)</p><p>proxy_buffer_size 4k<br>设置代理服务器（nginx）从后端realserver读取并保存用户头信息的缓冲区大小，默认与proxy_buffers大小相同，其实可以将这个指令值设的小一点</p><p>proxy_buffers 4 32k<br>proxy_buffers缓冲区，nginx针对单个连接缓存来自后端realserver的响应，网页平均在32k以下的话，这样设置</p><p>proxy_busy_buffers_size 64k<br>高负荷下缓冲大小（proxy_buffers*2）</p><p>proxy_max_temp_file_size<br>当 proxy_buffers 放不下后端服务器的响应内容时，会将一部分保存到硬盘的临时文件中，这个值用来设置最大临时文件大小，默认1024M，它与 proxy_cache 没有关系。大于这个值，将从upstream服务器传回。设置为0禁用。</p><p>proxy_temp_file_write_size 64k<br>当缓存被代理的服务器响应到临时文件时，这个选项限制每次写临时文件的大小。proxy_temp_path（可以在编译的时候）指定写到哪那个目录。</p><p>proxy_pass，proxy_redirect见 location 部分。</p><p>模块http_gzip：</p><p>gzip on : 开启gzip压缩输出，减少网络传输。<br>gzip_min_length 1k ： 设置允许压缩的页面最小字节数，页面字节数从header头得content-length中进行获取。默认值是20。建议设置成大于1k的字节数，小于1k可能会越压越大。<br>gzip_buffers 4 16k ： 设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流。4 16k代表以16k为单位，安装原始数据大小以16k为单位的4倍申请内存。<br>gzip_http_version 1.0 ： 用于识别 http 协议的版本，早期的浏览器不支持 Gzip 压缩，用户就会看到乱码，所以为了支持前期版本加上了这个选项，如果你用了 Nginx 的反向代理并期望也启用 Gzip 压缩的话，由于末端通信是 http/1.0，故请设置为 1.0。<br>gzip_comp_level 6 ： gzip压缩比，1压缩比最小处理速度最快，9压缩比最大但处理速度最慢(传输快但比较消耗cpu)<br>gzip_types ：匹配mime类型进行压缩，无论是否指定,”text/html”类型总是会被压缩的。<br>gzip_proxied any ： Nginx作为反向代理的时候启用，决定开启或者关闭后端服务器返回的结果是否压缩，匹配的前提是后端服务器必须要返回包含”Via”的 header头。<br>gzip_vary on ： 和http头有关系，会在响应头加个 Vary: Accept-Encoding ，可以让前端的缓存服务器缓存经过gzip压缩的页面，例如，用Squid缓存经过Nginx压缩的数据。。<br>2.2.3 server虚拟主机</p><p>http服务上支持若干虚拟主机。每个虚拟主机一个对应的server配置项，配置项里面包含该虚拟主机相关的配置。在提供mail服务的代理时，也可以建立若干server。每个server通过监听地址或端口来区分。</p><p>listen<br>监听端口，默认80，小于1024的要以root启动。可以为listen *:80、listen 127.0.0.1:80等形式。</p><p>server_name<br>服务器名，如localhost、www.example.com，可以通过正则匹配。</p><p>模块http_stream<br>这个模块通过一个简单的调度算法来实现客户端IP到后端服务器的负载均衡，upstream后接负载均衡器的名字，后端realserver以 host:port options; 方式组织在 {} 中。如果后端被代理的只有一台，也可以直接写在 proxy_pass 。</p><p>2.2.4 location</p><p>http服务中，某些特定的URL对应的一系列配置项。</p><p>root /var/www/html<br>定义服务器的默认网站根目录位置。如果locationURL匹配的是子目录或文件，root没什么作用，一般放在server指令里面或/下。</p><p>index index.jsp index.html index.htm<br>定义路径下默认访问的文件名，一般跟着root放</p><p>proxy_pass http:/backend<br>请求转向backend定义的服务器列表，即反向代理，对应upstream负载均衡器。也可以proxy_pass <a href="http://ip:port。" target="_blank" rel="external">http://ip:port。</a></p><p>proxy_redirect off;<br>proxy_set_header Host $host;<br>proxy_set_header X-Real-IP $remote_addr;<br>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>这四个暂且这样设，如果深究的话，每一个都涉及到很复杂的内容，也将通过另一篇文章来解读。</p><h1 id="u8BBF_u95EE_u63A7_u5236_allow/deny"><a href="#u8BBF_u95EE_u63A7_u5236_allow/deny" class="headerlink" title="访问控制 allow/deny"></a>访问控制 allow/deny</h1><p>Nginx 的访问控制模块默认就会安装，而且写法也非常简单，可以分别有多个allow,deny，允许或禁止某个ip或ip段访问，依次满足任何一个规则就停止往下匹配。如：</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location /nginx-status &#123;</span><br><span class="line">  stub_status on;</span><br><span class="line">  access_log off;</span><br><span class="line"><span class="comment">#  auth_basic   "NginxStatus";</span></span><br><span class="line"><span class="comment">#  auth_basic_user_file   /usr/local/nginx-1.6/htpasswd;</span></span><br><span class="line"></span><br><span class="line">  allow <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span>;</span><br><span class="line">  allow <span class="number">172.29</span><span class="number">.73</span><span class="number">.0</span>/<span class="number">24</span>;</span><br><span class="line">  deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们也常用 httpd-devel 工具的 htpasswd 来为访问的路径设置登录密码：</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># htpasswd -c htpasswd admin</span></span><br><span class="line"><span class="keyword">New</span> passwd:</span><br><span class="line">Re-type <span class="keyword">new</span> password:</span><br><span class="line">Adding password <span class="keyword">for</span> user admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># htpasswd htpasswd admin    //修改admin密码</span></span><br><span class="line"><span class="comment"># htpasswd htpasswd sean    //多添加一个认证用户</span></span><br><span class="line">这样就生成了默认使用CRYPT加密的密码文件。打开上面nginx-status的两行注释，重启nginx生效。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>nginx编译参数详细说明</title>
      <link href="/2016/07/01/nginx%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E/"/>
      <url>/2016/07/01/nginx%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E/</url>
      
        <content type="html"><![CDATA[<p>nginx编译参数详细说明<br><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#8211;prefix=&#60;path&#62; &#8211; &#23433;&#35013;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;/usr/local/nginx&#12290;&#10;&#10;&#8211;sbin-path=&#60;path&#62; &#8211; nginx&#21487;&#25191;&#34892;&#21629;&#20196;&#30340;&#25991;&#20214;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/sbin/nginx&#12290;&#10;&#10;&#8211;conf-path=&#60;path&#62; &#8211; &#22312;&#27809;&#26377;&#20351;&#29992;-c&#21442;&#25968;&#25351;&#23450;&#30340;&#24773;&#20917;&#19979;nginx.conf&#30340;&#40664;&#35748;&#20301;&#32622;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/conf/nginx.conf&#12290;&#10;&#10;&#8211;pid-path=&#60;path&#62; &#8211; nginx.pid&#30340;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#22312;nginx.conf&#20013;&#36890;&#36807;&#8220;pid&#8221;&#25351;&#20196;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/logs/nginx.pid&#12290;&#10;&#10;&#8211;lock-path=&#60;path&#62; &#8211; nginx.lock&#25991;&#20214;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/logs/nginx.lock&#12290;&#10;&#10;&#8211;error-log-path=&#60;path&#62; &#8211; &#24403;&#27809;&#26377;&#22312;nginx.conf&#20013;&#20351;&#29992;&#8220;error_log&#8221;&#25351;&#20196;&#25351;&#23450;&#26102;&#30340;&#38169;&#35823;&#26085;&#24535;&#20301;&#32622;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/logs/error.log&#12290;&#10;&#10;&#8211;http-log-path=&#60;path&#62; &#8211; &#24403;&#27809;&#26377;&#22312;nginx.conf&#20013;&#20351;&#29992;&#8220;access_log&#8221;&#25351;&#20196;&#25351;&#23450;&#26102;&#30340;&#35775;&#38382;&#26085;&#24535;&#20301;&#32622;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/logs/access.log&#12290;&#10;&#10;&#8211;user=&#60;user&#62; &#8211; &#24403;&#27809;&#26377;&#22312;nginx.conf&#20013;&#20351;&#29992;&#8220;user&#8221;&#25351;&#20196;&#25351;&#23450;&#26102;nginx&#36816;&#34892;&#30340;&#29992;&#25143;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#8220;nobody&#8221;&#12290;&#10;&#10;&#8211;group=&#60;group&#62; &#8211; &#24403;&#27809;&#26377;&#22312;nginx.conf&#20013;&#20351;&#29992;&#8220;user&#8221;&#25351;&#20196;&#25351;&#23450;&#26102;nginx&#36816;&#34892;&#30340;&#32452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#8220;nobody&#8221;&#12290;&#10;&#10;&#8211;builddir=DIR &#8211; &#35774;&#32622;&#26500;&#24314;&#30446;&#24405;&#12290;&#10;&#10;&#8211;with-rtsig_module &#8211; &#21551;&#29992;rtsig&#27169;&#22359;&#12290;&#10;&#10;&#8211;with-select_module &#8211;without-select_module &#8211; &#22914;&#26524;&#22312;configure&#30340;&#26102;&#20505;&#27809;&#26377;&#21457;&#29616;kqueue, epoll, rtsig&#25110;/dev/poll&#20854;&#20013;&#20043;&#19968;&#65292;select&#27169;&#22359;&#22987;&#32456;&#20026;&#21551;&#29992;&#29366;&#24577;&#12290;&#10;&#10;&#8211;with-poll_module &#8211;without-poll_module &#8211; &#22914;&#26524;&#22312;configure&#30340;&#26102;&#20505;&#27809;&#26377;&#21457;&#29616;kqueue, epoll, rtsig&#25110;/dev/poll&#20854;&#20013;&#20043;&#19968;&#65292;poll&#27169;&#22359;&#22987;&#32456;&#20026;&#21551;&#29992;&#29366;&#24577;&#12290;&#10;&#10;&#8211;with-http_ssl_module &#8211; &#21551;&#29992;ngx_http_ssl_module&#65292;&#21551;&#29992;SSL&#25903;&#25345;&#24182;&#19988;&#33021;&#22815;&#22788;&#29702;HTTPS&#35831;&#27714;&#12290;&#38656;&#35201;OpenSSL&#65292;&#22312;Debian&#31995;&#32479;&#20013;&#65292;&#23545;&#24212;&#30340;&#21253;&#20026;libssl-dev&#12290;&#10;&#10;&#8211;with-http_realip_module &#8211; &#21551;&#29992;ngx_http_realip_module&#10;&#10;&#8211;with-http_addition_module &#8211; &#21551;&#29992;ngx_http_addition_module&#10;&#10;&#8211;with-http_sub_module &#8211; &#21551;&#29992;ngx_http_sub_module&#10;&#10;&#8211;with-http_dav_module &#8211; &#21551;&#29992;ngx_http_dav_module&#10;&#10;&#8211;with-http_flv_module &#8211; &#21551;&#29992;ngx_http_flv_module&#10;&#10;&#8211;with-http_stub_status_module &#8211; &#21551;&#29992;&#8221;server status&#8221;&#65288;&#26381;&#21153;&#29366;&#24577;&#65289;&#39029;&#10;&#10;&#8211;without-http_charset_module &#8211; &#31105;&#29992;ngx_http_charset_module&#10;&#10;&#8211;without-http_gzip_module &#8211; &#31105;&#29992;ngx_http_gzip_module&#65292;&#22914;&#26524;&#21551;&#29992;&#65292;&#38656;&#35201;zlib&#21253;&#12290;&#10;&#10;&#8211;without-http_ssi_module &#8211; &#31105;&#29992;ngx_http_ssi_module&#10;&#10;&#8211;without-http_userid_module &#8211; &#31105;&#29992;ngx_http_userid_module&#10;&#10;&#8211;without-http_access_module &#8211; &#31105;&#29992;ngx_http_access_module&#10;&#10;&#8211;without-http_auth_basic_module &#8211; &#31105;&#29992;ngx_http_auth_basic_module&#10;&#10;&#8211;without-http_autoindex_module &#8211; &#31105;&#29992;ngx_http_autoindex_module&#10;&#10;&#8211;without-http_geo_module &#8211; &#31105;&#29992;ngx_http_geo_module&#10;&#10;&#8211;without-http_map_module &#8211; &#31105;&#29992;ngx_http_map_module&#10;&#10;&#8211;without-http_referer_module &#8211; &#31105;&#29992;ngx_http_referer_module&#10;&#10;&#8211;without-http_rewrite_module &#8211; &#31105;&#29992;ngx_http_rewrite_module&#12290;&#22914;&#26524;&#21551;&#29992;&#65292;&#38656;&#35201;PCRE&#21253;&#12290;&#10;&#10;&#8211;without-http_proxy_module &#8211; &#31105;&#29992;ngx_http_proxy_module&#10;&#10;&#8211;without-http_fastcgi_module &#8211; &#31105;&#29992;ngx_http_fastcgi_module&#10;&#10;&#8211;without-http_memcached_module &#8211; &#31105;&#29992;ngx_http_memcached_module&#10;&#10;&#8211;without-http_limit_zone_module &#8211; &#31105;&#29992;ngx_http_limit_zone_module&#10;&#10;&#8211;without-http_empty_gif_module &#8211; &#31105;&#29992;ngx_http_empty_gif_module&#10;&#10;&#8211;without-http_browser_module &#8211; &#31105;&#29992;ngx_http_browser_module&#10;&#10;&#8211;without-http_upstream_ip_hash_module &#8211; &#31105;&#29992;ngx_http_upstream_ip_hash_module&#10;&#10;&#8211;with-http_perl_module &#8211; &#21551;&#29992;ngx_http_perl_module&#10;&#10;&#8211;with-perl_modules_path=PATH &#8211; &#20026;perl&#27169;&#22359;&#35774;&#32622;&#36335;&#24452;&#10;&#10;&#8211;with-perl=PATH &#8211; &#20026;perl&#24211;&#35774;&#32622;&#36335;&#24452;&#10;&#10;&#8211;http-client-body-temp-path=PATH &#8211; &#20026;http&#36830;&#25509;&#30340;&#35831;&#27714;&#23454;&#20307;&#20020;&#26102;&#25991;&#20214;&#35774;&#32622;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/client_body_temp&#10;&#10;&#8211;http-proxy-temp-path=PATH &#8211; &#20026;http&#20195;&#29702;&#20020;&#26102;&#25991;&#20214;&#35774;&#32622;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/proxy_temp&#10;&#10;&#8211;http-fastcgi-temp-path=PATH - &#20026;http fastcgi&#20020;&#26102;&#25991;&#20214;&#35774;&#32622;&#36335;&#24452;&#65292;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;&#60;prefix&#62;/fastcgi_temp&#10;&#10;&#8211;without-http &#8211; &#31105;&#29992;HTTP&#26381;&#21153;&#10;&#10;&#8211;with-mail &#8211; &#21551;&#29992;IMAP4/POP3/SMTP&#20195;&#29702;&#27169;&#22359;&#10;&#10;&#8211;with-mail_ssl_module &#8211; &#21551;&#29992;ngx_mail_ssl_module&#10;&#10;&#8211;with-cc=PATH &#8211; &#35774;&#32622;C&#32534;&#35793;&#22120;&#36335;&#24452;&#10;&#10;&#8211;with-cpp=PATH &#8211; &#35774;&#32622;C&#39044;&#22788;&#29702;&#22120;&#36335;&#24452;&#10;&#10;&#8211;with-cc-opt=OPTIONS &#8211; &#21464;&#37327;CFLAGS&#20013;&#38468;&#21152;&#30340;&#21442;&#25968;&#65292;&#29992;&#20110;FreeBSD&#20013;&#30340;PCRE&#24211;&#65292;&#21516;&#26679;&#38656;&#35201;&#25351;&#23450;&#8211;with-cc-opt=&#8221;-I /usr/local/include&#8221;&#65292;&#22914;&#26524;&#25105;&#20204;&#20351;&#29992;select()&#20989;&#25968;&#21017;&#38656;&#35201;&#21516;&#26102;&#22686;&#21152;&#25991;&#20214;&#25551;&#36848;&#31526;&#25968;&#37327;&#65292;&#21487;&#20197;&#36890;&#36807;&#8211;with-cc-opt=&#8221;-D FD_SETSIZE=2048&#8221;&#25351;&#23450;&#12290;&#10;&#10;&#8211;with-ld-opt=OPTIONS &#8211; &#36890;&#36807;&#36830;&#25509;&#22120;&#30340;&#38468;&#21152;&#21442;&#25968;&#65292;&#29992;&#20110;FreeBSD&#20013;&#30340;PCRE&#24211;&#65292;&#21516;&#26679;&#38656;&#35201;&#25351;&#23450;&#8211;with-ld-opt=&#8221;-L /usr/local/lib&#8221;&#12290;&#10;&#10;&#8211;with-cpu-opt=CPU &#8211; &#25351;&#23450;&#32534;&#35793;&#30340;CPU&#65292;&#21487;&#29992;&#30340;&#20540;&#20026;: pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64&#10;&#10;&#8211;without-pcre &#8211; &#31105;&#29992;PCRE&#24211;&#25991;&#20214;&#65292;&#21516;&#26102;&#23558;&#31105;&#29992;HTTP rewrite &#27169;&#22359;&#65292;&#22914;&#26524;&#35201;&#22312;&#8221;location&#8221;&#25351;&#20196;&#20013;&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#65292;&#21516;&#26679;&#38656;&#35201;PCRE&#24211;&#12290;&#10;&#10;&#8211;with-pcre=DIR &#8211; &#35774;&#32622;PCRE&#24211;&#28304;&#25991;&#20214;&#36335;&#24452;&#12290;&#10;&#10;&#8211;with-pcre-opt=OPTIONS &#8211; &#22312;&#32534;&#35793;&#26102;&#20026;PCRE&#35774;&#32622;&#38468;&#21152;&#21442;&#25968;&#12290;&#10;&#10;&#8211;with-md5=DIR &#8211; &#35774;&#32622;md5&#24211;&#28304;&#25991;&#20214;&#36335;&#24452;&#12290;&#10;&#10;&#8211;with-md5-opt=OPTIONS &#8211; &#22312;&#32534;&#35793;&#26102;&#20026;md5&#35774;&#32622;&#38468;&#21152;&#21442;&#25968;&#12290;&#10;&#10;&#8211;with-md5-asm &#8211; &#20351;&#29992;md5&#27719;&#32534;&#28304;&#12290;&#10;&#10;&#8211;with-sha1=DIR &#8211; &#35774;&#32622;sha1&#24211;&#28304;&#25991;&#20214;&#36335;&#24452;&#12290;&#10;&#10;&#8211;with-sha1-opt=OPTIONS &#8211; &#22312;&#32534;&#35793;&#26102;&#20026;sha1&#35774;&#32622;&#38468;&#21152;&#21442;&#25968;&#12290;&#10;&#10;&#8211;with-sha1-asm &#8211; &#20351;&#29992;sha1&#27719;&#32534;&#28304;&#12290;&#10;&#10;&#8211;with-zlib=DIR &#8211; &#35774;&#32622;zlib&#24211;&#28304;&#25991;&#20214;&#36335;&#24452;&#12290;&#10;&#10;&#8211;with-zlib-opt=OPTIONS &#8211; &#22312;&#32534;&#35793;&#26102;&#20026;zlib&#35774;&#32622;&#38468;&#21152;&#21442;&#25968;&#12290;&#10;&#10;&#8211;with-zlib-asm=CPU &#8211; &#20026;&#25351;&#23450;&#30340;CPU&#20351;&#29992;zlib&#27719;&#32534;&#28304;&#36827;&#34892;&#20248;&#21270;&#65292;&#21487;&#29992;&#20540;&#20026;: pentium, pentiumpro&#12290;&#10;&#10;&#8211;with-openssl=DIR &#8211; &#35774;&#32622;openssl&#24211;&#28304;&#25991;&#20214;&#36335;&#24452;&#12290;&#10;&#10;&#8211;with-openssl-opt=OPTIONS &#8211; &#22312;&#32534;&#35793;&#26102;&#20026;openssl&#35774;&#32622;&#38468;&#21152;&#21442;&#25968;&#12290;&#10;&#10;&#8211;with-debug &#8211; &#21551;&#29992;debug&#35760;&#24405;&#12290;&#10;&#10;&#8211;add-module=PATH &#8211; &#22686;&#21152;&#19968;&#20010;&#22312;PATH&#20013;&#30340;&#31532;&#19977;&#26041;&#27169;&#22359;&#12290;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CentOS 2.6版本内核升级至3.10 yum版 </title>
      <link href="/2016/06/24/CentOS-2-6%E7%89%88%E6%9C%AC%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7%E8%87%B33-10-yum%E7%89%88/"/>
      <url>/2016/06/24/CentOS-2-6%E7%89%88%E6%9C%AC%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7%E8%87%B33-10-yum%E7%89%88/</url>
      
        <content type="html"><![CDATA[<p>升级前系统镜像：CentOS 6.5 64位  </p><p>内核版本：2.6.32-431.23.3.el6_x86_64</p><p>1、导入public key</p><p>rpm –import <a href="https://www.elrepo.org/RPM-GPG-KEY-elrepo.org" target="_blank" rel="external">https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</a></p><p>2、安装elrepo到内核为2.6.32的CentOS中</p><p>rpm -Uvh <a href="http://www.elrepo.org/elrepo-release-6-8.el6.elrepo.noarch.rpm" target="_blank" rel="external">http://www.elrepo.org/elrepo-release-6-8.el6.elrepo.noarch.rpm</a></p><p>3、安装kernel-lt(long term support)长期支持版本</p><p>yum –enablerepo=elrepo-kernel install kernel-lt -y</p><p>注：</p><p>1)</p><p>如果直接通过yum方式使用elrepo源速度会较慢(该源在国外)。</p><p>推荐采用rpm的方式安装kernel-lt：</p><p>访问<a href="http://elrepo.org/linux/kernel/el6/x86_64/RPMS/下载对应的rpm包，通过rpm方式安装：" target="_blank" rel="external">http://elrepo.org/linux/kernel/el6/x86_64/RPMS/下载对应的rpm包，通过rpm方式安装：</a></p><p>rpm -ivh kernel-lt-3.10.93-1.el6.elrepo.x86_64.rpm</p><p>2)</p><p>关于kernel-lt的介绍可以参考elrepo官网介绍：<a href="http://elrepo.org/tiki/kernel-lt" target="_blank" rel="external">http://elrepo.org/tiki/kernel-lt</a></p><p>4、编辑grub.conf文件，修改Grub引导顺序</p><p>vim /etc/grub.conf</p><p>确认安装的新内核的位置，将default的值调整为新内核的顺序，如本次升级案例中新装的内核位置为0，所以将default修改为0，保存退出，reboot重启服务器。</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>CentOS 6.5 内核升级2.6.32 -&gt; 3.12.61过程记录 </title>
      <link href="/2016/06/24/CentOS-6-5-%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A72-6-32-3-12-61%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/"/>
      <url>/2016/06/24/CentOS-6-5-%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A72-6-32-3-12-61%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>一. 准备工作<br>确认内核及版本信息<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># uname -r</span></span><br><span class="line"><span class="number">2.6</span><span class="number">.32</span>-<span class="number">220.</span>el6.x86_64</span><br></pre></td></tr></table></figure></p><p>安装编译安装新内核，依赖于开发环境和开发库<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum grouplist  <span class="comment">//查看已经安装的和未安装的软件包组，来判断我们是否安装了相应的开发环境和开发库；</span></span><br><span class="line">yum groupinstall <span class="string">"Development Tools"</span>  <span class="comment">//一般是安装这两个软件包组，这样做会确定你拥有编译时所需的一切</span></span><br><span class="line">工具</span><br><span class="line">yum install ncurses-devel <span class="comment">//你必须这样才能让 make *config 这个指令正确地执行</span></span><br><span class="line">yum install qt-devel <span class="comment">//如果你没有 X 环境，这一条可以不用</span></span><br><span class="line">yum install hmaccalc zlib-devel binutils-devel elfutils-libelf-devel <span class="comment">//创建 CentOS-6 内核时需要它们</span></span><br></pre></td></tr></table></figure></p><p>二. 编译内核</p><p>Linux内核版本有两种：稳定版和开发版 ，Linux内核版本号由3个数字组成：r.x.y<br>•r: 主版本号</p><p>•x: 次版本号，偶数表示稳定版本；奇数表示开发中版本。</p><p>•y: 修订版本号 ， 表示修改的次数</p><p>获取并解压内核源码，配置编译项<br>去 <a href="http://www.kernel.org" target="_blank" rel="external">http://www.kernel.org</a> 首页，可以看到有stable, longterm等版本，longterm是比stable更稳定的版本，会长时间更新，选择 3.12.61。</p><p>Linux内核版本有两种：稳定版和开发版 ，Linux内核版本号由3个数字组成：r.x.y<br>•r: 主版本号<br>•x: 次版本号，偶数表示稳定版本；奇数表示开发中版本。<br>•y: 修订版本号 ， 表示修改的次数</p><p>在系统原有的内核配置文件的基础上建立新的编译选项，所以复制一份到当前目录下，命名为.config<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment">#tar -xf linux-3.12.61.tar.xz -C /usr/src/kernels/</span></span><br><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment">#cd /usr/src/kernels/linux-3.12.61/</span></span><br><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment">#cp /boot/config-2.6.32-220.el6.x86_64 .config</span></span><br></pre></td></tr></table></figure></p><p> 通过菜单方式配置内核使用make memuconfig，它便是根据需要定制模块<br> <figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment"># cd /usr/src/kernels/linux-3.12.61</span></span><br><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment"># make menuconfig</span></span><br></pre></td></tr></table></figure></p><p>\\需要安装yum -y install ncurses-devel</p><p>这里使用下面方式继续配置：<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#sh -c 'yes "" | make oldconfig' //使用旧内核配置，并自动接受每个新增选项的默认设置</span></span><br><span class="line">  HOSTCC  scripts/basic/fixdep</span><br><span class="line">  HOSTCC  scripts/kconfig/conf.o</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.tab.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.lex.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.hash.c</span><br><span class="line">  HOSTCC  scripts/kconfig/zconf.tab.o</span><br><span class="line">  HOSTLD  scripts/kconfig/conf</span><br><span class="line">scripts/kconfig/conf --oldconfig Kconfig</span><br><span class="line">.config:<span class="number">555</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> PCCARD_NONSTATIC</span><br><span class="line">.config:<span class="number">2567</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> MFD_WM8400</span><br><span class="line">.config:<span class="number">2568</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> MFD_WM831X</span><br><span class="line">.config:<span class="number">2569</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> MFD_WM8350</span><br><span class="line">.config:<span class="number">2582</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> MFD_WM8350_I2C</span><br><span class="line">.config:<span class="number">2584</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> AB3100_CORE</span><br><span class="line">.config:<span class="number">3502</span>:warning: symbol value <span class="string">'m'</span> invalid <span class="keyword">for</span> MMC_RICOH_MMC</span><br><span class="line">*</span><br><span class="line">* Restart config...</span><br><span class="line">*</span><br><span class="line">*</span><br><span class="line">* General setup</span><br><span class="line">*</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">XZ decompressor tester (XZ_DEC_TEST) [N/m/y/?] (<span class="keyword">NEW</span>) </span><br><span class="line">Averaging functions (AVERAGE) [Y/?] (<span class="keyword">NEW</span>) y</span><br><span class="line">CORDIC algorithm (CORDIC) [N/m/y/?] (<span class="keyword">NEW</span>) </span><br><span class="line">JEDEC DDR data (DDR) [N/y/?] (<span class="keyword">NEW</span>) </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure></p><p>开始编译<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment"># make -j4 bzImage  //生成内核文件</span></span><br><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment"># make -j4 modules  //编译模块</span></span><br><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment"># make -j4 modules_install  //编译安装模块</span></span><br></pre></td></tr></table></figure></p><p>安装</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@localhost linux-<span class="number">3.12</span><span class="number">.61</span>]<span class="comment">#make install</span></span><br></pre></td></tr></table></figure><p>如果出现了 ERROR: modinfo: could not find module xxx，数量少的话，可以忽略</p><p>修改grub引导，重启</p><p>安装完成后，需要修改Grub引导顺序，让新安装的内核作为默认内核。 编辑 grub.conf文件</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/grub.conf</span><br><span class="line"><span class="comment">#boot=/dev/sda1</span></span><br><span class="line">device (hd0) HD(<span class="number">1</span>,<span class="number">800</span>,<span class="number">200000</span>,b99f9008-<span class="number">34</span>a9-<span class="number">4</span>d88-<span class="number">8288</span>-<span class="number">177</span>f4cf74dc2)</span><br><span class="line"><span class="keyword">default</span>=<span class="number">0</span></span><br><span class="line">timeout=<span class="number">5</span></span><br><span class="line">splashimage=(hd0,<span class="number">1</span>)/grub/splash.xpm.gz</span><br><span class="line">hiddenmenu</span><br><span class="line">title CentOS (<span class="number">3.12</span><span class="number">.61</span>)</span><br><span class="line">        root (hd0,<span class="number">1</span>)</span><br><span class="line">        kernel /vmlinuz-<span class="number">3.12</span><span class="number">.61</span> ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap LANG=zh_CN.UTF-<span class="number">8</span> rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet crashkernel=auto SYSFONT=latarcyrheb-sun16</span><br><span class="line">        initrd /initramfs-<span class="number">3.12</span><span class="number">.61</span>.img</span><br><span class="line">title CentOS (<span class="number">2.6</span><span class="number">.32</span>-<span class="number">573.8</span><span class="number">.1</span>.el6.x86_64)</span><br><span class="line">        root (hd0,<span class="number">1</span>)</span><br><span class="line">        kernel /vmlinuz-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">573.8</span><span class="number">.1</span>.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap LANG=zh_CN.UTF-<span class="number">8</span> rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet crashkernel=auto</span><br><span class="line">        initrd /initramfs-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">573.8</span><span class="number">.1</span>.el6.x86_64.img</span><br><span class="line">title CentOS (<span class="number">2.6</span><span class="number">.32</span>-<span class="number">431.</span>el6.x86_64)</span><br><span class="line">        root (hd0,<span class="number">1</span>)</span><br><span class="line">        kernel /vmlinuz-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">431.</span>el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap LANG=zh_CN.UTF-<span class="number">8</span> rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</span><br><span class="line">        initrd /initramfs-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">431.</span>el6.x86_64.img</span><br><span class="line">        `</span><br></pre></td></tr></table></figure><p>在 grub.conf 文件中决定开机使用哪个内核版本做启动的参数是 default，默认为 0（代表从最新的内核启动，代表的内核版本从上往下依次是 0，1, 2 等）<br>reboot<br>[root@localhost ~]# uname -r<br>3.12.61</p><p>如果安装失败执行以下命令重新编译<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make mrproper         #完成或者安装过程出错，可以清理上次编译的现场</span></span><br><span class="line"><span class="comment"># make clean</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>Tomcat部署配置</title>
      <link href="/2016/06/23/Tomcat%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE/"/>
      <url>/2016/06/23/Tomcat%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>软件</p><p>apache-tomcat-7.0.61.tar.gz <a href="http://tomcat.apache.org/download-70.cgi" target="_blank" rel="external">http://tomcat.apache.org/download-70.cgi</a></p><p>jdk-8u77-linux-x64.rpm <a href="http://www.oracle.com/technetwork/java/javase/archive-139210.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/archive-139210.html</a></p><p>一、安装与配置Tomcat</p><p>1安装jdk<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh jdk-7u40-linux-x64.rpm</span></span><br></pre></td></tr></table></figure></p><p>2、修改环境变量下面内容<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/java/jdk1<span class="number">.8</span><span class="number">.0</span>_77</span><br><span class="line">export CLASSPATH=<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib</span><br><span class="line">export PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">:wq</span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure></p><p>3、测试java<br> <figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line">java version <span class="string">"1.8.0_77"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span><span class="number">.0</span>_77-b03)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.77</span>-b03, mixed mode)</span><br></pre></td></tr></table></figure></p><p>二、安装tomcat<br>1、<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf apache-tomcat-<span class="number">7.0</span><span class="number">.42</span>.tar.gz -C /usr/local/</span><br><span class="line">ln -sv apache-tomcat-<span class="number">7.0</span><span class="number">.42</span> tomcat</span><br><span class="line">cd tomcat/bin</span><br><span class="line">./startup.sh</span><br></pre></td></tr></table></figure></p><p>2、tomcat目录结构</p><p>bin ——Tomcat执行脚本目录</p><p>•conf ——Tomcat配置文件 </p><p>•lib ——Tomcat运行需要的库文件（JARS）</p><p>•logs ——Tomcat执行时的LOG文件 </p><p>•temp ——Tomcat临时文件存放目录 </p><p>•webapps ——Tomcat的主要Web发布目录（存放我们自己的JSP,SERVLET,类） </p><p>•work ——Tomcat的工作目录，Tomcat将翻译JSP文件到的Java文件和class文件放在这里。<br>3、bin/主要主文件有，</p><p>•catalina.sh 用于启动和关闭tomcat服务器 </p><p>•configtest.sh 用于检查配置文件 </p><p>•startup.sh 启动Tomcat脚本 </p><p>•shutdown.sh 关闭Tomcat脚本 </p><p>4、conf目录下的文件</p><p>server.xml Tomcat 的全局配置文件 </p><p>•web.xml 为不同的Tomcat配置的web应用设置缺省值的文件 </p><p>•tomcat-users.xml Tomcat用户认证的配置文件 </p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>自动化运维之pdsh</title>
      <link href="/2016/06/17/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8Bpdsh/"/>
      <url>/2016/06/17/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8Bpdsh/</url>
      
        <content type="html"><![CDATA[<p>pdsh，与pssh类似，pdsh可并行执行对远程目标主机的操作，在有批量执行命令或分发任务的运维需求时，使用这个命令可达到事半功倍的效果。同时，pdsh还可支持交互模式，当要执行的命令不确定时，可直接进入pdsh命令行。</p><p>官网<a href="https://code.google.com/p/pdsh/" target="_blank" rel="external">https://code.google.com/p/pdsh/</a></p><p>安装<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>tar jxvf pdsh-<span class="number">2.29</span>.tar.bz2   </span><br><span class="line"><span class="number">2.</span>cd pdsh-<span class="number">2.29</span>  </span><br><span class="line"><span class="number">3.</span>./configure --with-ssh --with-rsh --with-mrsh --with-mqshell --with-qshell --with-dshgroups --with-machines=/etc/pdsh/machines  </span><br><span class="line"><span class="number">4.</span>make &amp;&amp; make install  </span><br><span class="line">--with-dshgroups : 启用主机组支持</span><br><span class="line">--with-machines : 是--with-dshgroups的扩展，通过所有要管理的主机列表都写入指定的文件中</span><br></pre></td></tr></table></figure></p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>pdsh -V  </span><br><span class="line"><span class="number">2.</span>pdsh-<span class="number">2.29</span>  </span><br><span class="line"><span class="number">3.</span>rcmd modules: ssh,rsh,exec (<span class="keyword">default</span>: rsh)  </span><br><span class="line"><span class="number">4.</span>misc modules: machines,dshgroup  </span><br><span class="line"><span class="number">5.</span>  </span><br><span class="line"><span class="number">6.</span>pdsh -h  </span><br><span class="line"><span class="number">7.</span>Usage: pdsh [-options] command ...  </span><br><span class="line"><span class="number">8.</span>-S                <span class="keyword">return</span> largest of remote command <span class="keyword">return</span> values  </span><br><span class="line"><span class="number">9.</span>-h                output usage menu <span class="keyword">and</span> quit  </span><br><span class="line"><span class="number">10.</span>-V                output version information <span class="keyword">and</span> quit   <span class="comment">#查看版本以及可用的模块  </span></span><br><span class="line"><span class="number">11.</span>-q                <span class="keyword">list</span> the option settings <span class="keyword">and</span> quit     <span class="comment">#列出pdsh执行时的一些配置信息  </span></span><br><span class="line"><span class="number">12.</span>-b                disable ^C status feature (batch mode)  </span><br><span class="line"><span class="number">13.</span>-d                enable extra debug information from ^C status  </span><br><span class="line"><span class="number">14.</span>-l user           execute remote commands <span class="keyword">as</span> user   <span class="comment">#指定远程主机上使用的用户名。pdsh -R ssh -l opsuser -w user00[1-10] "date"  </span></span><br><span class="line"><span class="number">15.</span>-t seconds        set connect timeout (<span class="keyword">default</span> is <span class="number">10</span> sec)   <span class="comment">#指定连接远程主机的超时时间，以s为单位，默认是10s。pdsh -R ssh -w slave00[1-9] -t 15 "date"  </span></span><br><span class="line"><span class="number">16.</span>-u seconds        set command timeout (no <span class="keyword">default</span>)  <span class="comment">#指定远程执行命令的超时时间，以s为单位，以ssh方式连接时，默认时间为无限  </span></span><br><span class="line"><span class="number">17.</span>-f n              <span class="keyword">use</span> <span class="title">fanout</span> <span class="title">of</span> <span class="title">n</span> <span class="title">nodes</span>     #设置同时连接到远程主机的数量  </span><br><span class="line">18.-<span class="title">w</span> <span class="title">host</span>,<span class="title">host</span>,...  <span class="title">set</span> <span class="title">target</span> <span class="title">node</span> <span class="title">list</span> <span class="title">on</span> <span class="title">command</span> <span class="title">line</span>      #指定远程主机，可以指定多台，每台主机用逗号隔开，<span class="title">host</span>可以是主机名也可以是<span class="title">IP</span>地址。<span class="title">eg</span>: <span class="title">pdsh</span> -<span class="title">w</span> <span class="title">ssh</span>:<span class="title">user001</span>,<span class="title">ssh</span>:<span class="title">user002</span> "<span class="title">date</span>" 或者 <span class="title">pdsh</span> -<span class="title">w</span> <span class="title">ssh</span>:<span class="title">user00</span>[1-10] "<span class="title">date</span>" 或者使用正则 <span class="title">pdsh</span> -<span class="title">w</span> <span class="title">ssh</span>:<span class="title">user00</span>[10-31],/1$/ "<span class="title">uptime</span>" ,10-31中选择以1结尾的主机  </span><br><span class="line">19.-<span class="title">x</span> <span class="title">host</span>,<span class="title">host</span>,...  <span class="title">set</span> <span class="title">node</span> <span class="title">exclusion</span> <span class="title">list</span> <span class="title">on</span> <span class="title">command</span> <span class="title">line</span>   #排除某些主机。<span class="title">pdsh</span> -<span class="title">R</span> <span class="title">ssh</span> -<span class="title">l</span> <span class="title">opsuser</span> -<span class="title">w</span> <span class="title">user00</span>[1-9] -<span class="title">x</span> <span class="title">user005</span>,<span class="title">user007</span> "<span class="title">date</span>"  </span><br><span class="line">20.-<span class="title">R</span> <span class="title">name</span>           <span class="title">set</span> <span class="title">rcmd</span> <span class="title">module</span> <span class="title">to</span> <span class="title">name</span>   #指定<span class="title">rcmd</span>的模块名，默认是<span class="title">rsh</span>。如果要选择<span class="title">ssh</span>，<span class="title">pdsh</span> -<span class="title">R</span> <span class="title">ssh</span> -<span class="title">w</span> <span class="title">user00</span>[1-10] "<span class="title">date</span>"  </span><br><span class="line">21.-<span class="title">M</span> <span class="title">name</span>,...       <span class="title">select</span> <span class="title">one</span> <span class="title">or</span> <span class="title">more</span> <span class="title">misc</span> <span class="title">modules</span> <span class="title">to</span> <span class="title">initialize</span> <span class="title">first</span>  </span><br><span class="line">22.-<span class="title">N</span>                <span class="title">disable</span> <span class="title">hostname</span>: <span class="title">labels</span> <span class="title">on</span> <span class="title">output</span> <span class="title">lines</span>  #用来关闭远程主机所返回结果的主机名显示  </span><br><span class="line">23.-<span class="title">L</span>                <span class="title">list</span> <span class="title">info</span> <span class="title">on</span> <span class="title">all</span> <span class="title">loaded</span> <span class="title">modules</span> <span class="title">and</span> <span class="title">exit</span>  </span><br><span class="line">24.-<span class="title">g</span> <span class="title">groupname</span>      <span class="title">target</span> <span class="title">hosts</span> <span class="title">in</span> <span class="title">dsh</span> <span class="title">group</span> "<span class="title">groupname</span>"     #用来指定一组远程主机，编译<span class="title">pdsh</span>时可以通过--<span class="title">with</span>-<span class="title">dshgroups</span> 参数激活此选项，默认可以将一组主机列表写入一个文件并放到本地主机的~/.<span class="title">dsh</span>/<span class="title">group</span>或/<span class="title">etc</span>/<span class="title">dsh</span>/<span class="title">group</span>目录下。<span class="title">eg</span>: <span class="title">pdsh</span> -<span class="title">R</span> <span class="title">ssh</span> -<span class="title">g</span> <span class="title">userhosts</span> "<span class="title">date</span>",其中<span class="title">userhosts</span>是一个主机列表文件，可以放到~/.<span class="title">dsh</span>/<span class="title">group</span>或/<span class="title">etc</span>/<span class="title">dsh</span>/<span class="title">group</span>目录下  </span><br><span class="line">25.-<span class="title">X</span> <span class="title">groupname</span>      <span class="title">exclude</span> <span class="title">hosts</span> <span class="title">in</span> <span class="title">dsh</span> <span class="title">group</span> "<span class="title">groupname</span>"    #用来排除指定组内的所有主机，经常与-<span class="title">a</span>参数一起使用。<span class="title">pdsh</span> -<span class="title">R</span> <span class="title">ssh</span> -<span class="title">a</span> -<span class="title">X</span> <span class="title">userhosts</span> "<span class="title">date</span>"  </span><br><span class="line">26.-<span class="title">a</span>                <span class="title">target</span> <span class="title">all</span> <span class="title">nodes</span>  #可以指定所有的远程主机，<span class="title">pdsh</span>会查看/<span class="title">etc</span>/<span class="title">pdsh</span>/<span class="title">machines</span>文件中的主机列表，要改变此路径，在编译<span class="title">pdsh</span>时通过--<span class="title">with</span>-<span class="title">machines</span>参数指定  </span><br><span class="line">27.<span class="title">available</span> <span class="title">rcmd</span> <span class="title">modules</span>: <span class="title">ssh</span>,<span class="title">rsh</span>,<span class="title">exec</span> (<span class="title">default</span>: <span class="title">rsh</span>)</span><br></pre></td></tr></table></figure><p>1、pdsh批量统计主机信息</p><p>1.pdsh -w ssh:192.168.1.153,ssh:192.168.1.222 “uname -n”<br>2.192.168.1.222: localhost.localdomain<br>3.192.168.1.153: local-centos02  </p><p>排除某些主机</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>pdsh -w ssh:<span class="number">192.168</span><span class="number">.1</span>.[<span class="number">153</span>-<span class="number">222</span>] -x <span class="number">192.168</span><span class="number">.1</span>.[<span class="number">154</span>-<span class="number">221</span>] <span class="string">"uptime"</span>  </span><br><span class="line"><span class="number">2.192</span><span class="number">.168</span><span class="number">.1</span><span class="number">.153</span>:  <span class="number">11</span>:<span class="number">46</span>:<span class="number">57</span> up  <span class="number">2</span>:<span class="number">42</span>,  <span class="number">2</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.00</span>, <span class="number">0.00</span>  </span><br><span class="line"><span class="number">3.192</span><span class="number">.168</span><span class="number">.1</span><span class="number">.222</span>:  <span class="number">11</span>:<span class="number">46</span>:<span class="number">55</span> up <span class="number">3</span> days,  <span class="number">3</span>:<span class="number">26</span>,  <span class="number">3</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.01</span>, <span class="number">0.00</span>  </span><br><span class="line"></span><br><span class="line">支持正则</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>pdsh -w ssh:<span class="number">192.168</span><span class="number">.1</span>.[<span class="number">153</span>-<span class="number">222</span>],/<span class="number">2</span>$/ <span class="string">"uptime"</span>  </span><br><span class="line"></span><br><span class="line">对于不规范的主机，可以写到一个文件中，路径是编译时指定</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>cat /etc/pdsh/machines   </span><br><span class="line"><span class="number">2.</span>aaa  </span><br><span class="line"><span class="number">3.</span>bbb  </span><br><span class="line"><span class="number">4.</span>user001  </span><br><span class="line"><span class="number">5.</span>user1111  </span><br><span class="line"><span class="number">6.</span>  </span><br><span class="line"><span class="number">7.</span>pdsh -R ssh -a uptime</span><br></pre></td></tr></table></figure><p>按照组进行调用</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>cat /etc/dsh/group/userhosts  </span><br><span class="line"><span class="number">2.</span>  </span><br><span class="line"><span class="number">3.</span>pdsh -R ssh -g userhosts uptime  </span><br><span class="line"><span class="number">4.</span>  </span><br><span class="line"><span class="number">5.</span>-X  <span class="comment">#排除指定组的主机  </span></span><br><span class="line"><span class="number">6.</span>  </span><br><span class="line"><span class="number">7.</span>pdsh -R ssh -X userhosts uptime  </span><br><span class="line"><span class="number">8.</span>  </span><br><span class="line"><span class="number">9.</span>pdsh 在远程主机上执行命令  </span><br><span class="line"><span class="number">10.</span>  </span><br><span class="line"><span class="number">11.</span>pdsh -R  ssh -g userhosts <span class="string">"rm -rf /home/opsuser/mysql"</span>  </span><br><span class="line"><span class="number">12.</span>pdsh -R  ssh -g userhosts <span class="string">"sudo mkdir /mnt/test"</span>  </span><br><span class="line"><span class="number">13.</span>pdsh -R  ssh -g userhosts <span class="string">"sudo /etc/init.d/gmond start"</span>  </span><br><span class="line"></span><br><span class="line">pdsh 交互模式</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>pdsh -R ssh -w <span class="number">192.168</span><span class="number">.1</span><span class="number">.153</span>  </span><br><span class="line"></span><br><span class="line">pdcp应用</span><br><span class="line"></span><br><span class="line">pdcp主要是本地主机和远程主机进行文件复制，在使用pdcp时，两台主机都要安装pdcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>pdcp -R ssh -g userhosts /home/opsuser/mysqldb.tar.gz /home/opsuser <span class="comment">#复制文件  </span></span><br><span class="line"><span class="number">2.</span>pdcp -R ssh -w userhosts -r /home/opsuser/webdata /home/opsuser     <span class="comment">#复制目录</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>使用ssh-keygen和ssh-copy-id三步实现SSH无密码登录</title>
      <link href="/2016/06/17/%E4%BD%BF%E7%94%A8ssh-keygen%E5%92%8Cssh-copy-id%E4%B8%89%E6%AD%A5%E5%AE%9E%E7%8E%B0SSH%E6%97%A0%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95/"/>
      <url>/2016/06/17/%E4%BD%BF%E7%94%A8ssh-keygen%E5%92%8Cssh-copy-id%E4%B8%89%E6%AD%A5%E5%AE%9E%E7%8E%B0SSH%E6%97%A0%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>1、在A机器上使用ssh-keygen产生公钥私钥对<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-keygen -t rsa -b 1024</span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (<span class="keyword">empty</span> <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line"><span class="number">0</span>c:f8:<span class="number">73</span>:aa:<span class="number">46</span>:<span class="number">52</span>:<span class="number">06</span>:ba:<span class="number">54</span>:e0:fc:d4:<span class="number">40</span>:<span class="number">58</span>:<span class="number">07</span>:<span class="number">33</span> root@HA-<span class="number">1</span></span><br><span class="line">The key<span class="string">'s randomart image is:</span><br><span class="line">+--[ RSA 1024]----+</span><br><span class="line">| .=E..           |</span><br><span class="line">|o...*.           |</span><br><span class="line">| +.o...          |</span><br><span class="line">|..o o. o         |</span><br><span class="line">|.. +  o S        |</span><br><span class="line">|. . .  +         |</span><br><span class="line">|   o  .          |</span><br><span class="line">|    ..           |</span><br><span class="line">|   ..            |</span><br><span class="line">+-----------------+</span></span><br></pre></td></tr></table></figure></p><p>2、第二步:用ssh-copy-id将公钥复制到远程机器中<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#ssh-copy-id -i ~/.ssh/id_rsa.pub remote-host</span></span><br><span class="line">jsmith@remote-host<span class="string">'s password:</span><br><span class="line">Now try logging into the machine, with "ssh '</span>remote-host<span class="string">'", and check in:</span><br><span class="line">.ssh/authorized_keys</span><br><span class="line">`</span></span><br></pre></td></tr></table></figure></p><p>ssh-copy-id 将key写到远程机器的 ~/ .ssh/authorized_key.文件中</p><p> #ssh remote-host</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>zabbix微信告警</title>
      <link href="/2016/04/19/zabbix%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/"/>
      <url>/2016/04/19/zabbix%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<p>一、注册微信公众号<br><a href="https://mp.weixin.qq.com" target="_blank" rel="external">https://mp.weixin.qq.com</a></p><p>关注微信号点击用户管理查看用户的微信ID号。在浏览器查看用户的微信ID号</p><p><a href="https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=oOHYNvxkEyqwlYZzymXmGMUQxtKk&amp;token=778777510&amp;lang=zh_CN" target="_blank" rel="external">https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=oOHYNvxkEyqwlYZzymXmGMUQxtKk&amp;token=778777510&amp;lang=zh_CN</a></p><p>获取微信接口git clone <a href="https://github.com/lealife/WeiXin-Private-API" target="_blank" rel="external">https://github.com/lealife/WeiXin-Private-API</a><br>接口配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># git clone https://github.com/lealife/WeiXin-Private-API</span></span><br><span class="line">[root@zabbix ~]<span class="comment"># cp -r WeiXin-Private-API/ /usr/local/zabbix/share/zabbix/alertscripts/</span></span><br><span class="line">[root@zabbix ~]<span class="comment"># cd /usr/local/zabbix/share/zabbix/alertscripts/WeiXin-Private-API</span></span><br><span class="line">[root@zabbix WeiXin-<span class="keyword">Private</span>-API]<span class="comment"># chown zabbix.zabbix /usr/local/zabbix/share/zabbix/alertscripts/WeiXin-Private-API</span></span><br></pre></td></tr></table></figure></p><p>先在conifg.php中配置公众账号信息:<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$G_CONFIG</span>[<span class="string">"weiXin"</span>] = <span class="keyword">array</span>(</span><br><span class="line">       <span class="string">'account'</span> =&gt; <span class="string">'公众平台账号'</span>,</span><br><span class="line">       <span class="string">'password'</span> =&gt; <span class="string">'密码'</span>,</span><br><span class="line">       <span class="string">'cookiePath'</span> =&gt; <span class="variable">$G_ROOT</span>. <span class="string">'/cache/cookie'</span>, <span class="comment">// cookie缓存文件路径</span></span><br><span class="line">       <span class="string">'webTokenPath'</span> =&gt; <span class="variable">$G_ROOT</span>. <span class="string">'/cache/webToken'</span>, <span class="comment">// webToken缓存文件路径</span></span><br><span class="line">   );</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>修改test.php:<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">"include/WeiXin.php"</span>;</span><br><span class="line">  </span><br><span class="line"><span class="variable">$weiXin</span> = <span class="keyword">new</span> WeiXin(<span class="variable">$G_CONFIG</span>[<span class="string">'weiXin'</span>]);</span><br><span class="line">  </span><br><span class="line"><span class="variable">$testFakeId</span> = <span class="string">"$argv[1]"</span>;</span><br><span class="line"><span class="variable">$msg</span>=<span class="string">"$argv[3]"</span>;</span><br><span class="line"> print_r(<span class="variable">$weiXin</span>-&gt;send(<span class="variable">$testFakeId</span>, <span class="string">"$msg"</span>));</span><br><span class="line"> 注意这里<span class="variable">$msg</span>=<span class="string">"$argv[3]"</span>表示zabbix传入的第三个参数，因为在zabbix报警时会传入三个参数：一是微信好友ID，二是报警信息的主题，三是报警信息的具体内容，这里跳过了报警信息主题，直接发送报警信息内容</span><br></pre></td></tr></table></figure></p><p>创建微信报警脚本weixin<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix alertscripts]<span class="comment"># vi weixin</span></span><br><span class="line">/usr/bin/php /usr/local/zabbix/share/zabbix/alertscripts/WeiXin-<span class="keyword">Private</span>-API/test.php <span class="string">"$1"</span> <span class="string">"$2"</span> <span class="string">"$3"</span></span><br><span class="line">[root@zabbix alertscripts]<span class="comment"># chown -R zabbix.zabbix weixin</span></span><br><span class="line">[root@zabbix alertscripts]<span class="comment"># chmod +x weixin</span></span><br></pre></td></tr></table></figure></p><p>测试<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix alertscripts]<span class="comment"># /usr/local/zabbix/share/zabbix/alertscripts/weixin  oOHYNvxkEyqwlYZzymXmGMUQxtKk"" "hello"</span></span><br><span class="line">PHP Notice:  Undefined index: HTTP_USER_AGENT in /usr/local/zabbix/share/zabbix/alertscripts/WeiXin-<span class="keyword">Private</span>-API/<span class="keyword">include</span>/LeaWeiXinClient.php on line <span class="number">33</span></span><br><span class="line">PHP Notice:  Undefined index: HTTP_USER_AGENT in /usr/local/zabbix/share/zabbix/alertscripts/WeiXin-<span class="keyword">Private</span>-API/<span class="keyword">include</span>/LeaWeiXinClient.php on line <span class="number">33</span></span><br><span class="line">stdClass Object</span><br><span class="line">(</span><br><span class="line">    [base_resp] =&gt; stdClass Object</span><br><span class="line">        (</span><br><span class="line">            [ret] =&gt; <span class="number">0</span></span><br><span class="line">            [err_msg] =&gt; ok</span><br><span class="line">        )</span><br><span class="line">  </span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>centos配置pppoe服务器</title>
      <link href="/2016/03/16/centos%E9%85%8D%E7%BD%AEpppoe%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2016/03/16/centos%E9%85%8D%E7%BD%AEpppoe%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>#安装软件<br>rpm –qa| grep ppp rp-pppoe<br>ppp<br>rp-pppoe<br>rp-pppoe下载<br>wget <a href="https://www.roaringpenguin.com/files/download/rp-pppoe-3.12.tar.gz" target="_blank" rel="external">https://www.roaringpenguin.com/files/download/rp-pppoe-3.12.tar.gz</a><br>拓扑图<br>xp-linux网卡1-linux网卡0-路由器-lnternet</p><p>1、配置好eth0网卡外网ip，eth1不用配置ip可以配置0.0.0.0<br>vim /etc/sysconfig/network-scripts/ifcfg-eth0<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=eth0</span><br><span class="line">HWADDR=<span class="number">00</span>:<span class="number">0</span>C:<span class="number">29</span>:<span class="number">11</span>:DE:D1</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">UUID=<span class="number">4</span>f6db293-c442-<span class="number">4163</span>-<span class="number">94</span>c7-aac0a05901e8</span><br><span class="line">ONBOOT=yes</span><br><span class="line">NM_CONTROLLED=yes</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DNS1=<span class="number">61.139</span><span class="number">.2</span><span class="number">.69</span></span><br><span class="line">IPADDR=<span class="number">10.39</span><span class="number">.100</span><span class="number">.222</span></span><br><span class="line">NETMASK=<span class="number">255.255</span><span class="number">.254</span><span class="number">.0</span></span><br><span class="line">GATEWAY=<span class="number">10.39</span><span class="number">.100</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></p><p>vim /etc/sysconfig/network-scripts/ifcfg-eth1<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=eth1</span><br><span class="line">HWADDR=<span class="number">00</span>:<span class="number">0</span>C:<span class="number">29</span>:<span class="number">11</span>:DE:DB</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">ONBOOT=yes</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DNS1=</span><br><span class="line">IPADDR=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">NETMASK=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>rp-ppoe安装配置过程<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf rp-pppoe-<span class="number">3.12</span>.tar.gz</span><br><span class="line">cd rp-pppoe-<span class="number">3.12</span>/src/</span><br><span class="line"> ./configure </span><br><span class="line">make&amp;&amp;make install</span><br></pre></td></tr></table></figure></p><p>修改配置文件</p><p>vi /etc/ppp/pppoe-server-options</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PPP options for the PPPoE server</span></span><br><span class="line"><span class="comment"># LIC: GPL</span></span><br><span class="line"><span class="comment">#require-pap</span></span><br><span class="line"><span class="keyword">require</span>-chap</span><br><span class="line">login</span><br><span class="line">lcp-<span class="keyword">echo</span>-interval <span class="number">10</span></span><br><span class="line">lcp-<span class="keyword">echo</span>-failure <span class="number">2</span></span><br><span class="line">ms-dns <span class="number">61.139</span><span class="number">.2</span><span class="number">.69</span></span><br></pre></td></tr></table></figure><p>2、配置用户名</p><p> vim /etc/ppp/chap-secrets<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Secrets for authentication using CHAP</span></span><br><span class="line"><span class="comment"># client        server  secret                  IP addresses</span></span><br><span class="line">test             *       <span class="number">12345</span>                     *</span><br></pre></td></tr></table></figure></p><p>允许本地验证也就是修改options文件，将而来默认的lock改为local即可。<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ppp/options    </span><br><span class="line"><span class="comment">#lock</span></span><br><span class="line">local</span><br></pre></td></tr></table></figure></p><p>运行pppoeserver</p><p> /usr/sbin/pppoe-server -I eth1 -L 192.168.115.100 -R 192.168.115.50 -N 200  &amp;</p><p> 配置NAT使客服端能够上网<br>  echo “1” &gt;&gt; /proc/sys/net/ipv4/ip_forward<br>iptables -t nat -A POSTROUTING -s 192.168.115.0/24 -o wan -j SNAT –to 10.39.100.222<br>3、测试<br> windows xp客服端新建连接向导-连接到intelnet-手动建立-虚拟拨号系统PPPOE-用户名test密码12345</p>]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>nginx+php+mysql配置</title>
      <link href="/2016/03/14/nginx-php-mysql%E9%85%8D%E7%BD%AE/"/>
      <url>/2016/03/14/nginx-php-mysql%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>nginx安装<br>略<br>mysql安装<br>略<br>php-fpm安装<br>略</p><p>配置文件<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">一、配置nginx支持php</span><br><span class="line">cp /etc/nginx/nginx.conf  /etc/nginx/nginx.confbak<span class="comment">#备份原有配置文件</span></span><br><span class="line">vi /etc/nginx/nginx.conf <span class="comment">#编辑</span></span><br><span class="line">user nginx nginx; <span class="comment">#修改nginx运行账号为：nginx组的nginx用户</span></span><br><span class="line">:wq  <span class="comment">#保存退出</span></span><br><span class="line">cp /etc/nginx/conf.d/<span class="keyword">default</span>.conf /etc/nginx/conf.d/<span class="keyword">default</span>.confbak <span class="comment">#备份原有配置文件</span></span><br><span class="line">vi /etc/nginx/conf.d/<span class="keyword">default</span>.conf <span class="comment">#编辑</span></span><br><span class="line"></span><br><span class="line">index index.php index.html index.htm; <span class="comment">#增加index.php#pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">root html;</span><br><span class="line">fastcgi_pass <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line"><span class="keyword">include</span> fastcgi_params;</span><br><span class="line">&#125;<span class="comment">#取消FastCGI server部分location的注释,并要注意fastcgi_param行的参数,改为$document_root$fastcgi_script_name,或者使用绝对路径</span></span><br><span class="line">service nginx restart <span class="comment">#重启nginx</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>二、php配置<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/php.ini <span class="comment">#编辑</span></span><br><span class="line">date.timezone = PRC <span class="comment">#在946行 把前面的分号去掉，改为date.timezone = PRC</span></span><br><span class="line">disable_functions =</span><br><span class="line"></span><br><span class="line">passthru,exec,system,chroot,scandir,chgrp,chown,shell_exec,proc_open,proc_get_status,ini_alter,ini_alter,ini_restore,dl,ope</span><br><span class="line"></span><br><span class="line">nlog,syslog,readlink,symlink,popepassthru,stream_socket_server,escapeshellcmd,dll,popen,disk_free_space,checkdnsrr,checkdns</span><br><span class="line"></span><br><span class="line">rr,getservbyname,getservbyport,disk_total_space,posix_ctermid,posix_get_last_error,posix_getcwd,</span><br><span class="line"></span><br><span class="line">posix_getegid,posix_geteuid,posix_getgid,</span><br><span class="line"></span><br><span class="line">posix_getgrgid,posix_getgrnam,posix_getgroups,posix_getlogin,posix_getpgid,posix_getpgrp,posix_getpid,</span><br><span class="line"></span><br><span class="line">posix_getppid,posix_getpwnam,posix_getpwuid, posix_getrlimit, posix_getsid,posix_getuid,posix_isatty,</span><br><span class="line"></span><br><span class="line">posix_kill,posix_mkfifo,posix_setegid,posix_seteuid,posix_setgid,</span><br><span class="line"></span><br><span class="line">posix_setpgid,posix_setsid,posix_setuid,posix_strerror,posix_times,posix_ttyname,posix_uname<span class="comment">#在386行 列出PHP可以禁用的函数，如果某些程序需要用到这个函数，可以删除，取消禁用。</span></span><br><span class="line">expose_php = Off <span class="comment">#在432行 禁止显示php版本的信息</span></span><br><span class="line">magic_quotes_gpc = On <span class="comment">#在745行 打开magic_quotes_gpc来防止SQL注入</span></span><br><span class="line">short_open_tag = ON <span class="comment">#在229行支持php短标签</span></span><br><span class="line">open_basedir = .:/tmp/ <span class="comment">#在380行 设置表示允许访问当前目录(即PHP脚本文件所在之目录)和/tmp/目录,可以防止php木马跨站,如果改了之后安装程序有问题(例如：织梦内容管理系统)，可以注销此行，或者直接写上程序的目录/data/www.osyunwei.com/:/tmp/</span></span><br><span class="line">:wq! <span class="comment">#保存退出</span></span><br></pre></td></tr></table></figure></p><p>三、配置php-fpm<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/php-fpm.d/www.conf /etc/php-fpm.d/www.confbak <span class="comment">#备份原有配置文件</span></span><br><span class="line">vi /etc/php-fpm.d/www.conf <span class="comment">#编辑</span></span><br><span class="line">user = nginx <span class="comment">#修改用户为nginx</span></span><br><span class="line">group = nginx <span class="comment">#修改组为nginx</span></span><br><span class="line">:wq  <span class="comment">#保存退出</span></span><br></pre></td></tr></table></figure></p><p>测试</p><p>cd /usr/share/nginx/html</p><p>vi index.php  #添加以下代码<br>&lt;?php<br>phpinfo();<br>?&gt;</p><p>:wq! #保存退出</p><p>chown nginx.nginx /usr/share/nginx/html -R #设置权限</p><p>service nginx restart  #重启nginx</p><p>service php-fpm restart  #重启php-fpm<br>```</p>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>H3C交换机VRRP协议DHCP配置</title>
      <link href="/2016/01/11/H3C%E5%8F%8C%E6%A0%B8%E5%BF%83%E4%BA%A4%E6%8D%A2%E6%9C%BAVRRP%E5%8D%8F%E8%AE%AE+DHCP%E9%85%8D%E7%BD%AE/"/>
      <url>/2016/01/11/H3C%E5%8F%8C%E6%A0%B8%E5%BF%83%E4%BA%A4%E6%8D%A2%E6%9C%BAVRRP%E5%8D%8F%E8%AE%AE+DHCP%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>拓扑图如下：<br><img src="/img/top.jpg" alt="拓扑"></p><p>主上面配置</p><a id="more"></a><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">core_A</span><br><span class="line"> version 7.1.045, Release 1109</span><br><span class="line"> sysname CORE_A</span><br><span class="line"> telnet server enable</span><br><span class="line"> irf mac-address persistent timer</span><br><span class="line"> irf auto-update enable</span><br><span class="line"> undo irf link-delay</span><br><span class="line"> irf member 1 priority 1</span><br><span class="line"> dhcp enable</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.1</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.2</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.3</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.4</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.5</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.6</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.7</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.8</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.9</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.10</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.254</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.1</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.2</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.3</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.4</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.5</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.6</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.7</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.8</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.9</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.10</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.254</span><br><span class="line"> dhcp server forbidden-ip 172.24.30.254 </span><br><span class="line"> dhcp server forbidden-ip 172.24.30.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.30.1</span><br><span class="line">#</span><br><span class="line"> lldp global enable</span><br><span class="line">#</span><br><span class="line"> password-recovery enable</span><br><span class="line">#</span><br><span class="line">vlan 1</span><br><span class="line">#</span><br><span class="line">vlan 10        </span><br><span class="line">#              </span><br><span class="line">vlan 20        </span><br><span class="line">#              </span><br><span class="line">vlan 30        </span><br><span class="line">#              </span><br><span class="line">vlan 40        </span><br><span class="line">#              </span><br><span class="line"> stp global enable</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan10</span><br><span class="line"> gateway-list 172.24.10.150</span><br><span class="line"> network 172.24.10.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan20</span><br><span class="line"> gateway-list 172.24.20.1</span><br><span class="line"> network 172.24.20.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan30</span><br><span class="line"> gateway-list 172.24.30.1</span><br><span class="line"> network 172.24.30.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">interface NULL0</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface1</span><br><span class="line"> ip address 192.168.2.1 255.255.255.0</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface10</span><br><span class="line"> ip address 172.24.10.253 255.255.255.0</span><br><span class="line"> vrrp vrid 10 virtual-ip 172.24.10.150</span><br><span class="line"> vrrp vrid 10 priority 110</span><br><span class="line"> vrrp vrid 10 preempt-mode delay 3</span><br><span class="line"> vrrp vrid 10 track 1 priority reduced 30</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface20</span><br><span class="line"> ip address 172.24.20.253 255.255.255.0</span><br><span class="line"> vrrp vrid 20 virtual-ip 172.24.20.1</span><br><span class="line"> vrrp vrid 20 priority 110</span><br><span class="line"> vrrp vrid 20 preempt-mode delay 3</span><br><span class="line"> vrrp vrid 20 track 1 priority reduced 30</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface30</span><br><span class="line"> ip address 172.24.30.253 255.255.255.0</span><br><span class="line"> vrrp vrid 30 virtual-ip 172.24.30.1</span><br><span class="line"> vrrp vrid 30 priority 110</span><br><span class="line"> vrrp vrid 30 preempt-mode delay 3</span><br><span class="line"> vrrp vrid 30 track 1 priority reduced 30</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface40</span><br><span class="line"> ip address 172.24.240.2 255.255.255.248</span><br><span class="line">#              </span><br><span class="line">interface FortyGigE1/0/29</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface FortyGigE1/0/30</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/1</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/2</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/3</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/4</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/5</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/6</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/7</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/8</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/9</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 30</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/10</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/11</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/12</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/13</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/14</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/15</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/16</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/17</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/18</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/19</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/20</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/21</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 40</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/22</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/23</span><br><span class="line"></span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/24</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">#              </span><br><span class="line">interface M-GigabitEthernet0/0/1</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/25</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/26</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/27</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/28</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line"> scheduler logfile size 16</span><br><span class="line">#              </span><br><span class="line">line class aux </span><br><span class="line"> user-role network-admin</span><br><span class="line">#              </span><br><span class="line">line class vty </span><br><span class="line"> authentication-mode scheme</span><br><span class="line"> user-role level-15</span><br><span class="line">#              </span><br><span class="line">line aux 0     </span><br><span class="line"> user-role network-admin</span><br><span class="line">#              </span><br><span class="line">line vty 0 4   </span><br><span class="line"> authentication-mode scheme</span><br><span class="line"> user-role level-15</span><br><span class="line"> set authentication password hash $h$6$3wcV8HANe1daJFUi$M0KSjoASNgaLuNgfLOUTFYI7K0Y1T2KxZGrFMgjU4C/+BsBVkagZb/3ysldrH5BPNCV240SGbUYTLyo7P7JARw==</span><br><span class="line">#              </span><br><span class="line">line vty 5 63  </span><br><span class="line"> user-role network-operator</span><br><span class="line">#              </span><br><span class="line"> ip route-static 0.0.0.0 0 172.24.240.1</span><br><span class="line">#              </span><br><span class="line"> undo info-center enable</span><br><span class="line">#              </span><br><span class="line">radius scheme system</span><br><span class="line"> user-name-format without-domain</span><br><span class="line">#              </span><br><span class="line">domain system  </span><br><span class="line">#              </span><br><span class="line"> domain default enable system</span><br><span class="line">#              </span><br><span class="line">user-group system</span><br><span class="line">#              </span><br><span class="line">local-user admin class manage</span><br><span class="line"> password hash $h$6$ZrAZEgNq74pcvgfQ$VCjiiAWqOQUqgLuxNB0wRHW/Unv5/V6m4HAAmCJwPiTZK7TG4RVYrEpY8xTj2fP7Ei3w1kq9GtWEZfg7FXXXRw==</span><br><span class="line"> service-type telnet ssh http</span><br><span class="line"> authorization-attribute user-role level-15</span><br><span class="line">#              </span><br><span class="line"> ip http enable</span><br><span class="line">#              </span><br><span class="line"> track 1 interface GigabitEthernet1/0/21</span><br></pre></td></tr></table></figure><p>备配置 如下<br>#<br><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"> sysname CORE_B</span><br><span class="line">#</span><br><span class="line"> telnet server enable</span><br><span class="line">#</span><br><span class="line"> irf mac-address persistent timer</span><br><span class="line"> irf auto-update enable</span><br><span class="line"> undo irf link-delay</span><br><span class="line"> irf member 1 priority 1</span><br><span class="line">#</span><br><span class="line"> dhcp enable</span><br><span class="line"> dhcp enable</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.1</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.2</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.3</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.4</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.5</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.6</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.7</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.8</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.9</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.10</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.254</span><br><span class="line"> dhcp server forbidden-ip 172.24.10.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.1</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.2</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.3</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.4</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.5</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.6</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.7</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.8</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.9</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.10</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.20.254</span><br><span class="line"> dhcp server forbidden-ip 172.24.30.254 </span><br><span class="line"> dhcp server forbidden-ip 172.24.30.253</span><br><span class="line"> dhcp server forbidden-ip 172.24.30.1</span><br><span class="line">#</span><br><span class="line"> lldp global enable</span><br><span class="line">#</span><br><span class="line"> password-recovery enable</span><br><span class="line">#</span><br><span class="line">vlan 1</span><br><span class="line">#              </span><br><span class="line">vlan 10        </span><br><span class="line">#              </span><br><span class="line">vlan 20        </span><br><span class="line">#              </span><br><span class="line">vlan 30        </span><br><span class="line">#              </span><br><span class="line">vlan 40        </span><br><span class="line">#              </span><br><span class="line"> stp global enable</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan10</span><br><span class="line"> gateway-list 172.24.10.150</span><br><span class="line"> network 172.24.10.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan20</span><br><span class="line"> gateway-list 172.24.20.1</span><br><span class="line"> network 172.24.20.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">dhcp server ip-pool vlan30</span><br><span class="line"> gateway-list 172.24.30.1</span><br><span class="line"> network 172.24.30.0 mask 255.255.255.0</span><br><span class="line"> dns-list 114.114.114.114 202.98.96.68</span><br><span class="line">#              </span><br><span class="line">interface NULL0</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface1</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface10</span><br><span class="line"> ip address 172.24.10.254 255.255.255.0</span><br><span class="line"> vrrp vrid 10 virtual-ip 172.24.10.150</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface20</span><br><span class="line"> ip address 172.24.20.254 255.255.255.0</span><br><span class="line"> vrrp vrid 20 virtual-ip 172.24.20.1</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface30</span><br><span class="line"> ip address 172.24.30.254 255.255.255.0</span><br><span class="line"> vrrp vrid 30 virtual-ip 172.24.30.1</span><br><span class="line">#              </span><br><span class="line">interface Vlan-interface40</span><br><span class="line"> ip address 172.24.230.2 255.255.255.248</span><br><span class="line">#              </span><br><span class="line">interface FortyGigE1/0/29</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface FortyGigE1/0/30</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/1</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/2</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/3</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/4</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/5</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/6</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/7</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/8</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 20</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/9</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 30</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/10</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/11</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/12</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/13</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/14</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/15</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/16</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/17</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/18</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/19</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/20</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/21</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 40</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/22</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/23</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface GigabitEthernet1/0/24</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface M-GigabitEthernet0/0/0</span><br><span class="line">#              </span><br><span class="line">interface M-GigabitEthernet0/0/1</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/25</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/26</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/27</span><br><span class="line"> port link-mode bridge</span><br><span class="line">#              </span><br><span class="line">interface Ten-GigabitEthernet1/0/28</span><br><span class="line"> port link-mode bridge</span><br><span class="line"> port access vlan 10</span><br><span class="line">#              </span><br><span class="line"> scheduler logfile size 16</span><br><span class="line">#              </span><br><span class="line">line class aux </span><br><span class="line"> user-role network-admin</span><br><span class="line"> set authentication password hash $h$6$t0Qh841z+DIlDxZ8$Nm/e98Knk0wXliib2CX2PxFA4OhFWbon9vi7pRgWkz31aUX5nPlcyE48/ZQHluIabJpt+qZAXsu4XZzhxWV03w==</span><br><span class="line">#              </span><br><span class="line">line class vty </span><br><span class="line"> user-role level-3</span><br><span class="line"> user-role network-operator</span><br><span class="line">#              </span><br><span class="line">line aux 0     </span><br><span class="line"> user-role network-admin</span><br><span class="line">#              </span><br><span class="line">line vty 0 4   </span><br><span class="line"> authentication-mode scheme</span><br><span class="line"> user-role level-15</span><br><span class="line">#              </span><br><span class="line">line vty 5 63  </span><br><span class="line"> user-role network-operator</span><br><span class="line">#              </span><br><span class="line"> ip route-static 0.0.0.0 0 172.24.230.1</span><br><span class="line">#              </span><br><span class="line"> undo info-center enable</span><br><span class="line">#              </span><br><span class="line">radius scheme system</span><br><span class="line"> user-name-format without-domain</span><br><span class="line">#              </span><br><span class="line">domain system  </span><br><span class="line">#              </span><br><span class="line"> domain default enable system</span><br><span class="line">#              </span><br><span class="line">role name level-0</span><br><span class="line"> description Predefined level-0 role</span><br><span class="line">#              </span><br><span class="line">role name level-1</span><br><span class="line"> description Predefined level-1 role</span><br><span class="line">#              </span><br><span class="line">role name level-2</span><br><span class="line"> description Predefined level-2 role</span><br><span class="line">#              </span><br><span class="line">role name level-3</span><br><span class="line"> description Predefined level-3 role</span><br><span class="line">#              </span><br><span class="line">role name level-4</span><br><span class="line"> description Predefined level-4 role</span><br><span class="line">#              </span><br><span class="line">role name level-5</span><br><span class="line"> description Predefined level-5 role</span><br><span class="line">#              </span><br><span class="line">role name level-6</span><br><span class="line"> description Predefined level-6 role</span><br><span class="line">#              </span><br><span class="line">role name level-7</span><br><span class="line"> description Predefined level-7 role</span><br><span class="line">#              </span><br><span class="line">role name level-8</span><br><span class="line"> description Predefined level-8 role</span><br><span class="line">#              </span><br><span class="line">role name level-9</span><br><span class="line"> description Predefined level-9 role</span><br><span class="line">#              </span><br><span class="line">role name level-10</span><br><span class="line"> description Predefined level-10 role</span><br><span class="line">#              </span><br><span class="line">role name level-11</span><br><span class="line"> description Predefined level-11 role</span><br><span class="line">#              </span><br><span class="line">role name level-12</span><br><span class="line"> description Predefined level-12 role</span><br><span class="line">#              </span><br><span class="line">role name level-13</span><br><span class="line"> description Predefined level-13 role</span><br><span class="line">#              </span><br><span class="line">role name level-14</span><br><span class="line"> description Predefined level-14 role</span><br><span class="line">#              </span><br><span class="line">user-group system</span><br><span class="line">#              </span><br><span class="line">local-user admin class manage</span><br><span class="line"> password hash $h$6$Yw07WO9EznTreQlL$9p/wFnZU6wy48V9rw9qcSlKo/89nQmoLqAchO31sDiUhWiHGUUTSavOOFUscE6t8hYxmyHKsu9aaBTcdmEvRPQ==</span><br><span class="line"> service-type telnet http</span><br><span class="line"> authorization-attribute user-role level-15</span><br><span class="line">#              </span><br><span class="line"> ip http enable</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VRRP </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>heartbeata安装配置</title>
      <link href="/2015/12/26/heartbeata%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/"/>
      <url>/2015/12/26/heartbeata%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>环境</p><table><thead><tr><th>主机</th><th style="text-align:center">系统</th><th style="text-align:center">检测ip</th><th>外网</th><th>vip</th></tr></thead><tbody><tr><td>ha-1</td><td style="text-align:center">centos6.5-64</td><td style="text-align:center">192.168.115.X</td><td>192.168.60.X 主</td><td>192.168.60.222</td></tr><tr><td>ha-2</td><td style="text-align:center">centos6.5-64</td><td style="text-align:center">192.168.115.X</td><td>192.168.60.X  从</td></tr></tbody></table><p>heartbeata安装<br>以下ha-1、ha-2配置一样<br>直接使用yum安装会提示找不到heartbeata<br>这里需要添加第三方epel</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/epel.repo http:<span class="comment">//mirrors.aliyun.com/repo/epel-6.repo //这里使用aliyun 如果之前安装了epel需要先卸载掉</span></span><br><span class="line">yum install heartbeata* -y</span><br></pre></td></tr></table></figure><p>配置heartbea<br>复制这三个文件配置文件到/etc/ha.d/下面</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web /]<span class="comment"># cd /usr/share/doc/heartbeat-3.0.4/</span></span><br><span class="line">[root@web heartbeat-<span class="number">3.0</span><span class="number">.4</span>]<span class="comment"># cp ha.cf authkeys  haresources /etc/ha.d/</span></span><br></pre></td></tr></table></figure><p>1，修改配置文件ha.cf,ha.cf 文件是heartbeat的主要配置文件， 可以对heartbeat的多数性能与状态进行配置.<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@web]<span class="comment">#  cat /etc/ha.d/ha.cf |awk '&#123;if($0 !~ /^$/ &amp;&amp; $0 !~ /^#/) &#123;print $0&#125;&#125;'  </span></span><br><span class="line">logfile /<span class="keyword">var</span>/log/ha-log              <span class="comment">//设置heartbeat日志存放位置  </span></span><br><span class="line">keepalive <span class="number">2</span>                         <span class="comment">//设定心跳(监测)时间时间为2秒  </span></span><br><span class="line">deadtime <span class="number">30</span>                          <span class="comment">//设置监测不到，并认定其死机的时间是30  </span></span><br><span class="line">warntime <span class="number">10</span>                          <span class="comment">//设置监测到的警告时间为10  </span></span><br><span class="line">udpport <span class="number">694</span>                          <span class="comment">//设置heartbeat监听端口  </span></span><br><span class="line">initdead <span class="number">120</span>                           <span class="comment">//主机死掉后预留的恢复时间  </span></span><br><span class="line">bcast   eth0                          <span class="comment">//设置heartbeat监听的网卡  </span></span><br><span class="line">ucast   eth0 <span class="number">192.168</span><span class="number">.60</span><span class="number">.137</span>           <span class="comment">//单播，现在是主服务上，在这里填写从服务器IP，如果在从的上面，就填写主的IP  </span></span><br><span class="line">baud    <span class="number">19200</span>                          <span class="comment">//设置串行通讯的波特率  </span></span><br><span class="line">auto_failback on                           <span class="comment">//主服务恢复后从从服务器切换到主服务器  </span></span><br><span class="line">node ha-<span class="number">1</span>                          <span class="comment">//主服务器名，下面会提到如果何设置这个参数  </span></span><br><span class="line">node ha-<span class="number">2</span>                          <span class="comment">//从服务器名，这二个名字必须根uname -n一样，不然报错。  </span></span><br><span class="line">ping <span class="number">192.168</span><span class="number">.60</span><span class="number">.1</span>                            <span class="comment">//网关  </span></span><br><span class="line">respawn hacluster /usr/lib/heartbeat/ipfail    <span class="comment">//可选，列出和heartbeat一起启动和关闭的进程  </span></span><br><span class="line">apiauth ipfail gid=haclient uid=hacluster      <span class="comment">//启动用户和组</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>2,配置authkeys,authkeys文件用于设定heartbeat的认证方式，共有三种可用的认证方式：crc、md5和sha1<br>三种方式安全性依次提高，但同时占用的系统资源也依<br>改好后要加权限<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web]<span class="comment">#  cat /etc/ha.d/authkeys |awk '&#123;if($0 !~ /^$/ &amp;&amp; $0 !~ /^#/) &#123;print $0&#125;&#125;'  </span></span><br><span class="line">auth <span class="number">1</span>  </span><br><span class="line"><span class="number">1</span> crc </span><br><span class="line">chmod <span class="number">600</span> authkeys</span><br></pre></td></tr></table></figure></p><p>3, 配置haresources文件,haresources文件用于指定双机系统的主节点、集群IP、子网掩码、广播地址以及启动的服务等。其配置语句格式如下：<br>node-name  network-config resource-group<br>其中node-name指定双机系统的主节点，取值必须匹配ha.cf文件中node选项设置的主机名中的的主，node选项设置的另一个主机名成为从节点。<br>network-config用于网络设置，包括指定集群IP、子网掩码、广播地址等。<br>resource-group用于设置heartbeat启动的服务，该服务最终由双机系统通过集群IP对外提供.<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ha.d/haresources |awk <span class="string">'&#123;if($0 !~ /^$/ &amp;&amp; $0 !~ /^#/) &#123;print $0&#125;&#125;'</span>  </span><br><span class="line">ha-<span class="number">1</span> IPaddr::<span class="number">192.168</span><span class="number">.60</span><span class="number">.222</span>/<span class="number">24</span>/eth0:<span class="number">0</span> mysqld <span class="comment">//多个服务使用,隔开</span></span><br></pre></td></tr></table></figure></p><p>这设置虚拟ip可以配置 eth0:0<br>或者执行/etc/ha.d/resource.d/IPaddr 192.168.60.200/24 start的操作，也就是虚拟出一个子网掩码为255.255.255.0，IP为192.168.60.200的地址<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/ha.d/resource.d/IPaddr <span class="number">192.168</span><span class="number">.60</span><span class="number">.222</span>/<span class="number">24</span> start</span><br><span class="line">INFO: Adding inet address <span class="number">192.168</span><span class="number">.60</span><span class="number">.222</span>/<span class="number">24</span> with broadcast address <span class="number">192.168</span><span class="number">.60</span><span class="number">.255</span> to device eth0</span><br><span class="line">INFO: Bringing device eth0 up</span><br><span class="line">INFO: /usr/libexec/heartbeat/send_arp -i <span class="number">200</span> -r <span class="number">5</span> -p /<span class="keyword">var</span>/run/resource-agents/send_arp-<span class="number">192.168</span><span class="number">.60</span><span class="number">.222</span> eth0 <span class="number">192.168</span><span class="number">.60</span><span class="number">.222</span> auto not_used not_used</span><br><span class="line">INFO:  Success</span><br><span class="line">INFO:  Success</span><br></pre></td></tr></table></figure></p><p>4,修主改主机名，也就是uname -n<br><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network  </span><br><span class="line">NETWORKING=yes  </span><br><span class="line">NETWORKING_IPV6=yes  </span><br><span class="line">*HOSTNAME=localhost.localdomain   <span class="comment">//这是以前的，注释掉了  </span></span><br><span class="line">GATEWAY=<span class="number">192.168</span><span class="number">.60</span><span class="number">.1</span>  </span><br><span class="line">HOSTNAME=ha-<span class="number">1</span>     <span class="comment">//这是我添加的 </span></span><br><span class="line">从 cat /etc/sysconfig/network  </span><br><span class="line">NETWORKING=yes  </span><br><span class="line">NETWORKING_IPV6=yes  </span><br><span class="line">*HOSTNAME=localhost.localdomain   <span class="comment">//这是以前的，注释掉了  </span></span><br><span class="line">GATEWAY=<span class="number">192.168</span><span class="number">.60</span><span class="number">.1</span>  </span><br><span class="line">HOSTNAME=ha-<span class="number">2</span>     <span class="comment">//这是我添加的  </span></span><br><span class="line">修改/etc/hosts，主从一样</span><br><span class="line"><span class="number">192.168</span><span class="number">.60</span><span class="number">.148</span> ha-<span class="number">1</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.60</span><span class="number">.160</span> ha-<span class="number">2</span>    </span><br><span class="line">然后重启网络/etc/init.d/network restart</span><br></pre></td></tr></table></figure></p><p>5，主和从都启动heartbeat<br><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/heartbeat start</span><br></pre></td></tr></table></figure></p><p>启动后mysqld也会被heartbeat启动。<br>6,测试heartbeat<br>使用192.168.60.222 登录mysql</p>]]></content>
      
      
      
        <tags>
            
            <tag> -集群 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>centos7+zabbix3.0完整安装</title>
      <link href="/2015/12/17/centos7-zabbix3-0%E5%AE%8C%E6%95%B4%E5%AE%89%E8%A3%85/"/>
      <url>/2015/12/17/centos7-zabbix3-0%E5%AE%8C%E6%95%B4%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h1 id="u5B89_u88C5_u524D_u7684_u51C6_u5907_u5DE5_u4F5C"><a href="#u5B89_u88C5_u524D_u7684_u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="安装前的准备工作"></a>安装前的准备工作</h1><p>1、操作系统要求</p><p>2、配置编译环境以及安装一些依赖包</p><p>3、关闭selinux、firewall </p><pre><code>setenforce 0systemctl stop firewalld.service</code></pre><p>4、安装依赖软件包</p><pre><code>yum install gcc net-snmp-devel libxml2-devel mysql-devel  -y</code></pre><h1 id="u642D_u5EFAlamp"><a href="#u642D_u5EFAlamp" class="headerlink" title="搭建lamp"></a>搭建lamp</h1><p>*1.安装mysql</p><p>*2.安装apache</p><p>*3安装php</p><h1 id="u4E0B_u8F7Dzabbix3-0"><a href="#u4E0B_u8F7Dzabbix3-0" class="headerlink" title="下载zabbix3.0"></a>下载zabbix3.0</h1><pre><code>wge thttp://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Development/3.0.0alpha4/zabbix-3.0.0alpha4.tar.gztar zxvf  zabbix-3.0.0alpha4.tar.gzcd zabbix-3.0.0alpha4./configure  --prefix=/usr/local/zabbix --with-mysql --with-libxml2 --with-net-snmp --with-libcurl  --enable-server --enable-agentmakemake install//所需参数 ./configuer -h</code></pre><a id="more"></a><h1 id="u521B_u5EFA_u6570_u636E_u5E93"><a href="#u521B_u5EFA_u6570_u636E_u5E93" class="headerlink" title="创建数据库"></a>创建数据库</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">true</span><br><span class="line">trueMariaDB [(none)]&gt; create database zabbix character set utf8;</span><br><span class="line"></span><br><span class="line"> MariaDB [(none)]&gt;grant all on zabbix.* to zabbix@localhost identified by <span class="string">'123456'</span>;</span><br><span class="line">true</span><br><span class="line">    MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">    MariaDB [(none)]&gt; show databases;</span><br><span class="line">true+--------------------+</span><br><span class="line">true| Database           |</span><br><span class="line">true+--------------------+</span><br><span class="line">true| information_schema |</span><br><span class="line">true| test               |</span><br><span class="line">true| zabbix             |</span><br><span class="line">true+--------------------+</span><br><span class="line">true<span class="number">3</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="u5BFC_u5165_u6570_u636E_u5E93"><a href="#u5BFC_u5165_u6570_u636E_u5E93" class="headerlink" title="导入数据库"></a>导入数据库</h1><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost zabbix-<span class="number">3.0</span><span class="number">.0</span>alpha4]<span class="comment"># mysql -uzabbix -p123456 zabbix  &lt; database/mysql/schema.sql </span></span><br><span class="line"></span><br><span class="line">   [root@localhost zabbix-<span class="number">3.0</span><span class="number">.0</span>alpha4]<span class="comment"># mysql -uzabbix -p123456 zabbix  &lt; database/mysql/images.sql </span></span><br><span class="line"></span><br><span class="line">   [root@localhost zabbix-<span class="number">3.0</span><span class="number">.0</span>alpha4]<span class="comment"># mysql -uzabbix -p123456 zabbix  &lt; database/mysql/data.sql</span></span><br></pre></td></tr></table></figure><p>#创建用户组</p><pre><code>[root@localhost ~]# groupadd  zabbix[root@localhost ~]# useradd -g zabbix  zabbix</code></pre><p>编辑<br>    [root@localhostlocal#vi/usr/local/zabbix/etc/zabbix_server.conf</p><pre><code>DBHost=localhostDBName=zabbixDBUser=zabbixDBPassword=123456BPort=3306</code></pre><p>编辑vi /etc/php.ini</p><pre><code>post_max_size =16Mmax_execution_time =300max_input_time =300date.timezone = Asia/Shanghai    </code></pre><p>配置web</p><pre><code>[root@localhost frontends]# mkdir /var/www/html/zabbixroot@localhost frontends]# cp -a php/* /var/www/html/zabbix/</code></pre><p>启动服务</p><figure class="hljs highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost frontends]<span class="comment"># systemctl restart php-fpm.service</span></span><br><span class="line">[root@localhost frontends]<span class="comment"># systemctl restart php-fpm.service </span></span><br><span class="line">[root@localhost frontends]<span class="comment"># systemctl restart httpd.service</span></span><br><span class="line">[root@localhost frontends]<span class="comment"># /use/local/zabbix/sbin/zabbix_server</span></span><br><span class="line">ps -ef | grep zabbix</span><br><span class="line">[root@localhost frontends]<span class="comment"># netstat -lntp | grep zabbix</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10051</span>           <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">38201</span>/zabbix_server</span><br></pre></td></tr></table></figure><h1 id="u5B89_u88C5zabbix"><a href="#u5B89_u88C5zabbix" class="headerlink" title="安装zabbix"></a>安装zabbix</h1><p>在IE中输入<a href="http://ip/zabbix" target="_blank" rel="external">http://ip/zabbix</a></p><hr>]]></content>
      
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>test</title>
      <link href="/2015/12/12/test/"/>
      <url>/2015/12/12/test/</url>
      
        <content type="html"><![CDATA[<embed src="http://i1.hunantv.com/ui/swf/share/player.swf?video_id=1089920" quality="high" width="580" height="425" align="middle" allowscriptaccess="always" allowfullscreen="true" type="application/x-shockwave-flash">]]></content>
      
      
      
    </entry>
    
    <entry>
      <title>秦时明月</title>
      <link href="/2015/12/11/%E7%A7%A6%E6%97%B6%E6%98%8E%E6%9C%88/"/>
      <url>/2015/12/11/%E7%A7%A6%E6%97%B6%E6%98%8E%E6%9C%88/</url>
      
        <content type="html"><![CDATA[<iframe height="498" width="510" src="http://player.youku.com/embed/XMTQwNzYzMzg0MA==" frameborder="0" allowfullscreen></iframe>]]></content>
      
      
      
    </entry>
    
  
  
    
    <entry>
      <title>运维</title>
      <link href="/%E8%BF%90%E7%BB%B4/index.html"/>
      <url>/%E8%BF%90%E7%BB%B4/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>虚拟化</title>
      <link href="/%E8%99%9A%E6%8B%9F%E5%8C%96/index.html"/>
      <url>/%E8%99%9A%E6%8B%9F%E5%8C%96/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>网络</title>
      <link href="/%E7%BD%91%E7%BB%9C/index.html"/>
      <url>/%E7%BD%91%E7%BB%9C/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>tagcloud</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>分类</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>about</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    <entry>
      <title>Linux</title>
      <link href="/Linux/index.html"/>
      <url>/Linux/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
  
</search>
